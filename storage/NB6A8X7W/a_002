(()=>{function e(e,n){for(var t=0;t<n.length;t++){var s=n[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var n=function(){function n(e){!
/*!**********************************************!*\
  !*** ../assets/src/scripts/utils/fpstats.js ***!
  \**********************************************/
function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,n),this.config={endpoint:e.endpoint,sessionDomain:e.sessionDomain||window.location.hostname,sessionPath:e.sessionPath||"/",sessionPrefix:e.sessionPrefix||"__FP_SESS",sessionTimeout:e.sessionTimeout||30,debug:-1!==window.location.href.search("[?&]fpstatsDebug="),referrer:document.referrer}}var t,s,o;return t=n,s=[{key:"page",value:function(){this.push({type:"view"})}},{key:"track",value:function(e){this.push({type:"event",label:e.label,action:e.action||null,category:e.category||null,value:e.value||null})}},{key:"getIp",value:function(e){var n=new XMLHttpRequest;n.open("GET","https://ifconfig.me/ip",!0),n.setRequestHeader("Content-Type","application/json"),n.send(),n.onreadystatechange=function(){4==n.readyState&&e(n.response)}}},{key:"hash",value:function(e){for(var n=0,t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n&=n;return Math.abs(n)}},{key:"trackSearch",value:function(e){return e.type="event",e.category="Forms",e.label="Search",e.value=this.getParam("s"),e}},{key:"getParam",value:function(e){var n=null,t=[];return location.search.substr(1).split("&").forEach((function(s){(t=s.split("="))[0]===e&&(n=decodeURIComponent(t[1]).replace("+"," "))})),n}},{key:"addUAparams",value:function(e){if("function"==typeof UAParser){var n=(new UAParser).getResult();e.os_name=n.os.name||null,e.os_version=n.os.version||null,e.device_vendor=n.device.vendor||null,e.device_type=n.device.type||null,e.device_model=n.device.model||null,e.browser_name=n.browser.name||null,e.browser_version=n.browser.major||null}return e}},{key:"addUTMparams",value:function(e){for(var n=window.location.search.substring(1).split("&"),t=0;t<n.length;t++){var s=n[t].split("=");decodeURIComponent(s[0]).includes("utm_")&&(e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]))}return e}},{key:"addContext",value:function(e){var n=this,t=n.getUser(),s=n.extendSession();return e.env=window.oPageData.env||null,e.post_id=window.oPageData.post_id||null,e.post_type=window.oPageData.post_type||null,e.href=window.location.href,e.profile_uid=t,e.session_uuid=s.uuid,e.url=window.oPageData.url||null,e.referrer_url=n.config.referrer||"Direct",e.created_at=(new Date).toISOString().slice(0,19).replace("T"," "),e=n.addUAparams(e),"search"===(e=n.addUTMparams(e)).post_type&&(e=n.trackSearch(e)),e}},{key:"push",value:function(e){var n=this;if(!1!==n.getUser()){var t=new XMLHttpRequest;e=n.addContext(e),n.config.debug&&(console.log("FP Stats Push: ",n.getSession(),e,window.oPageData),t.addEventListener("error",(function(e){console.log("FP Stats Push: Ajax Error ",e)}))),t.open("POST",n.config.endpoint,!0),t.setRequestHeader("Content-Type","application/json"),t.send(JSON.stringify(e))}else n.config.debug&&console.log("FP Stats Push: Failed (User not available)")}},{key:"getUser",value:function(){var e=this;return e.propertyExists(window,"FP","Singletons","UserAltAccess","ipAccessData","client_guid")?window.FP.Singletons.UserAltAccess.ipAccessData.client_guid:e.propertyExists(window,"FP","Singletons","User","userData","uid")?FP.Singletons.User.userData.uid:(e.removeSession(),!1)}},{key:"genSessionId",value:function(){var e,n=this,t=Date.now(),s=n.getUser();return null!==(e=t.toString().replace(".","")+"-"+s+"-"+n.hash(JSON.stringify(n.addUAparams({}))))&&void 0!==e?e:"-"}},{key:"extendSession",value:function(){var e=this;if(e.sessionExists()){var n=e.getSession();if(e.getUser()!==n.uid)return e.newSession();var t=new Date,s=new Date(t.getTime());return s.setMinutes(s.getMinutes()+e.config.sessionTimeout),n.updatedAt=t.getTime(),n.expiresAt=s.getTime(),e.saveSession(n,s)}return e.newSession()}},{key:"getSession",value:function(){var e=decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(this.config.sessionPrefix).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null;return null!==e?JSON.parse(e):void 0}},{key:"saveSession",value:function(e,n){var t=this,s="; expires="+n.toUTCString(),o=encodeURIComponent(t.config.sessionPrefix)+"="+encodeURIComponent(JSON.stringify(e))+s+(t.config.sessionDomain?"; domain="+t.config.sessionDomain:"")+(t.config.sessionPath?"; path="+t.config.sessionPath:"");return document.cookie=o,t.getSession()}},{key:"newSession",value:function(){var e=this;if(!e.config.sessionPrefix||/^(?:expires|max\-age|path|domain|secure)$/i.test(e.config.sessionPrefix))return!1;var n=new Date,t=new Date(n.getTime()),s=e.getUser(),o=e.genSessionId();t.setMinutes(t.getMinutes()+e.config.sessionTimeout);var i={uuid:o,createdAt:n.getTime(),expiresAt:t.getTime(),updatedAt:n.getTime(),uid:s};return e.saveSession(i,t)}},{key:"removeSession",value:function(){var e=this;return!(!e.config.sessionPrefix||!e.sessionExists()||(document.cookie=encodeURIComponent(e.config.sessionPrefix)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(e.config.sessionDomain?"; domain="+e.config.sessionDomain:"")+(e.config.sessionPath?"; path="+e.config.sessionPath:""),0))}},{key:"sessionExists",value:function(){return new RegExp("(?:^|;\\s*)"+encodeURIComponent(this.config.sessionPrefix).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)}},{key:"propertyExists",value:function(e){for(var n=Array.prototype.slice.call(arguments,1),t=0;t<n.length;t++){if(!e||!Object.prototype.hasOwnProperty.call(e,n[t]))return!1;e=e[n[t]]}return!0}}],s&&e(t.prototype,s),o&&e(t,o),Object.defineProperty(t,"prototype",{writable:!1}),n}(),t=0,s=setInterval((function(){t>=15&&clearInterval(s),void 0!==window.pianoReady&&window.pianoReady&&(clearInterval(s),window.fpstats=new n({endpoint:"/endpoint/fpstats?__fp_endpoint_fpstats=1"}),window.fpstats.page()),t++}),500)})();;
!function(s){s(document).ready(function(){var e={authorWrapper:s(".calerts-authors"),tagWrapper:s(".calerts-tags"),wrappers:s(".calerts-authors, .calerts-tags"),authorHeadline:s(".calerts-authors__alert-headline"),authorBody:s(".calerts-authors__alert-body"),tagHeadline:s(".calerts-tags__alert-headline"),tagBody:s(".calerts-tags__alert-body"),authorChkWrappers:s(".calerts-authors__author-wrapper"),tagChkWrappers:s(".calerts-tags__tag-wrapper"),checkmarkToggles:s("input.calerts-checkbox"),authorInputs:s('input[data-type="author_tag_alerts"]'),topicInputs:s('input[data-type="topic_tag_alerts"]'),regionalInputs:s('input[data-type="regional_tag_alerts"]'),email:"",uid:"",requests:[],tid:"",running:!1,init:function(){var e=this;if((window.customAlerts=e).wrappers.length&&!e.running){e.running=!0;var t="none";switch(e.propertyExists(window,"FP","Singletons","User","isReg")&&window.FP.Singletons.User.isReg&&(t="registered"),e.propertyExists(window,"FP","Singletons","User","isSub")&&window.FP.Singletons.User.isSub&&(t="subscriber"),t=e.propertyExists(window,"FP","Singletons","User","isIPAccess")&&window.FP.Singletons.User.isIPAccess?"ipaccess":t){case"none":var a=1<parseInt(e.authorWrapper.data("num-authors"))?" these authors are published. ":" this author are published. ";e.showAlert(["NEW EMAIL ALERTS","NEW EMAIL ALERTS"],["FP subscribers can now receive alerts when new stories written by"+a,"FP subscribers can now receive alerts when new stories on these topics and regions are published. "],"all").map(function(e){e.after(s("<a />",{text:"Sign in",href:"#",class:"-user -signin FP-paywall--login"}).click(function(e){e.preventDefault(),tp.pianoId.show({displayMode:"modal",screen:"login"})})).after(" | ").after(s("<a />",{text:"Subscribe now",href:"#",class:""}).click(function(e){e.preventDefault(),tp.offer.show({offerId:"OFJ7T1Z58NES",templateId:"OTQ3CIY6MBHM",displayMode:"modal"})}))}),e.wrappers.css({display:"inline"});break;case"registered":a=1<parseInt(e.authorWrapper.data("num-authors"))?" these authors are published. ":" this author are published. ";e.showAlert(["NEW EMAIL ALERTS","NEW EMAIL ALERTS"],["FP subscribers can now receive alerts when new stories written by"+a,"FP subscribers can now receive alerts when new stories on these topics and regions are published. "],"all").map(function(e){e.after(s("<a />",{text:"Subscribe now",href:"#",class:""}).click(function(e){e.preventDefault(),tp.offer.show({offerId:"OFJ7T1Z58NES",templateId:"OTQ3CIY6MBHM",displayMode:"modal"})}))}),e.wrappers.css({display:"inline"});break;case"subscriber":e.email=window.FP.Singletons.User.userData.email||"",e.uid=window.FP.Singletons.User.userData.uid||"",e.checkSubscription(),e.addEventListeners(),e.getAllSubscriptions(),e.amRun();break;case"ipaccess":e.wrappers.css({display:"none"})}}},addEventListeners:function(){var a=this;a.checkmarkToggles.on("click",function(e){e.preventDefault(),e.stopPropagation(),a.toggleSubscription(this)}),window.addEventListener("beforeunload",function(e){var t;if(a.requests.length)return t="We are still updating your preferences, leaving the page now will result in unsaved changes. Are you sure you want to leave the page?",(e||window.event).returnValue=t})},handleDisplay:function(){var e=this,t=!1,a=!1;e.authorInputs.each(function(){s(this).prop("checked")||(t=!0)}),e.topicInputs.each(function(){s(this).prop("checked")||(a=!0)}),e.regionalInputs.each(function(){s(this).prop("checked")||(a=!0)}),e.authorWrapper.css({display:t||e.authorWrapper.hasClass("message")?"inline":"none"}),e.tagWrapper.css({display:a||e.tagWrapper.hasClass("message")?"block":"none"})},getAllSubscriptions:function(){var t=this,e={customAlerts:{email:t.email,uid:t.uid,method:"get",wpnonce:customAlertsLocal.wpNonce||""}};t.amAddReq({type:"POST",url:"/endpoint/custom-alerts/?__fp_endpoint_custom_alerts=1",data:e,success:function(e){e.hasOwnProperty("data")&&!e.data.hasOwnProperty("code")?t.updateDom(e):t.errorHandler(e)},error:function(e){t.errorHandler(e)}})},updateDom:function(e){var t=this;for(alertType in e.data)t.updateSwitches(alertType,e.data[alertType]);t.handleDisplay(),t.wrappers.removeClass("loading")},updateSwitches:function(e,a){var t=this,r=!1;switch(e){case"author_tag_alerts":r=t.authorInputs;break;case"topic_tag_alerts":r=t.topicInputs;break;case"regional_tag_alerts":r=t.regionalInputs}!1!==r&&r.length&&r.each(function(e,t){s(t).parent().removeClass("loading"),s(t).removeAttr("disabled"),s(t).attr("name").split(",").filter(function(e){return""!==e&&null!=e}).every(function(e){return-1!==a.indexOf(e)})?s(t).prop("checked",!0):s(t).prop("checked",!1)})},toggleSubscription:function(t){var a=this,e={customAlerts:{email:a.email,uid:a.uid,method:s(t).is(":checked")?"add_subscription":"remove_subscription",wpnonce:customAlertsLocal.wpNonce||"",subject:s(t).attr("name"),type:s(t).data("type")}};s(t).parent().addClass("loading"),s(t).attr("disabled","disabled"),a.amAddReq({type:"POST",url:"/endpoint/custom-alerts/?__fp_endpoint_custom_alerts=1",data:e,success:function(e){e.hasOwnProperty("data")&&e.data.hasOwnProperty(s(t).data("type"))?(s(t).parent().removeClass("loading"),s(t).removeAttr("disabled"),setTimeout(function(){s(t).is(":checked")?s(t).prop("checked",!1):s(t).prop("checked",!0)},100)):a.errorHandler(e,t)},error:function(e){a.errorHandler(e,t)}})},checkSubscription:function(t){var a=this,e={customAlerts:{email:a.email,uid:a.uid,method:"is_subscribed",wpnonce:customAlertsLocal.wpNonce||""}};a.amAddReq({type:"POST",url:"/endpoint/custom-alerts/?__fp_endpoint_custom_alerts=1",data:e,success:function(e){if(e.hasOwnProperty("data")){switch(e.data){case"normal":case"error":a.wrappers.removeClass("message");break;case"unsub":a.showAlert("DISABLED","You have opted out of receiving all news alerts. To begin receiving alerts and manage your settings, ","all").map(function(e){e.siblings("a").remove(),e.after(s("<a />",{text:"click here.",href:"#",class:""}).click(function(e){e.preventDefault(),s(this).text("please wait..."),a.manageSubscription("subscribe",function(){})}))})}void 0!==t&&t()}else a.errorHandler(e)},error:function(e){a.errorHandler(e)}})},manageSubscription:function(e,t){var a=this,e={customAlerts:{email:a.email,uid:a.uid,method:e,wpnonce:customAlertsLocal.wpNonce||""}};a.amAddReq({type:"POST",url:"/endpoint/custom-alerts/?__fp_endpoint_custom_alerts=1",data:e,success:function(e){e.hasOwnProperty("data")?a.checkSubscription(t):a.errorHandler(e)},error:function(e){a.errorHandler(e)}})},errorHandler:function(e,t){if(e.hasOwnProperty("data")&&e.data.hasOwnProperty("message")&&e.data.hasOwnProperty("code"))switch(e.data.code){case 100:case 101:case 102:case 103:case 106:case 109:case 110:case 111:case 112:this.showAlert("Error! ",e.data.message,"all");break;case 104:case 105:void 0!==t&&(s(t).parent().removeClass("loading"),s(t).removeAttr("disabled"),setTimeout(function(){s(t).is(":checked")?s(t).prop("checked",!1):s(t).prop("checked",!0)},100))}else this.showAlert("Error!","An unkown serious error has occured, please report to support@foreignpolicy.com","all")},showAlert:function(e,t,a){var r=this;if(0===e.length||0===t.length||0===a.length)return!1;switch(r.wrappers.css({display:"block"}),r.wrappers.addClass("message"),a){case"all":return Array.isArray(e)?(r.authorHeadline.text(e[0]),r.authorBody.text(t[0]),r.tagHeadline.text(e[1]),r.tagBody.text(t[1])):(r.authorHeadline.text(e),r.authorBody.text(t),r.tagHeadline.text(e),r.tagBody.text(t)),[r.authorBody,r.tagBody];case"author":return r.authorHeadline.text(e),r.authorBody.text(t),r.authorBody;case"tag":return r.tagHeadline.text(e),r.tagBody.text(t),r.tagBody}return!1},amAddReq:function(e){this.requests.push(e)},amRemoveReq:function(e){-1<s.inArray(e,self.requests)&&self.requests.splice(s.inArray(e,self.requests),1)},amRun:function(){var e,t=this;t.requests.length?(e=t.requests[0].complete,t.requests[0].complete=function(){"function"==typeof e&&e(),t.requests.shift(),t.amRun.apply(t,[])},s.ajax(t.requests[0])):t.tid=setTimeout(function(){t.amRun.apply(t,[])},1e3)},amStop:function(){this.requests=[],clearTimeout(this.tid)},propertyExists:function(e){for(var t=Array.prototype.slice.call(arguments,1),a=0;a<t.length;a++){if(!e||!e.hasOwnProperty(t[a]))return!1;e=e[t[a]]}return!0}},t=setInterval(function(){void 0!==window.pianoReady&&window.pianoReady&&(e.init(),clearInterval(t))},300)})}(jQuery);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImN1c3RvbS1hbGVydHMtYXJ0aWNsZS5qcyJdLCJuYW1lcyI6WyIkIiwiZG9jdW1lbnQiLCJyZWFkeSIsImN1c3RvbUFsZXJ0cyIsImF1dGhvcldyYXBwZXIiLCJ0YWdXcmFwcGVyIiwid3JhcHBlcnMiLCJhdXRob3JIZWFkbGluZSIsImF1dGhvckJvZHkiLCJ0YWdIZWFkbGluZSIsInRhZ0JvZHkiLCJhdXRob3JDaGtXcmFwcGVycyIsInRhZ0Noa1dyYXBwZXJzIiwiY2hlY2ttYXJrVG9nZ2xlcyIsImF1dGhvcklucHV0cyIsInRvcGljSW5wdXRzIiwicmVnaW9uYWxJbnB1dHMiLCJlbWFpbCIsInVpZCIsInJlcXVlc3RzIiwidGlkIiwicnVubmluZyIsImluaXQiLCJzZWxmIiwidGhpcyIsIndpbmRvdyIsImxlbmd0aCIsInVzZXIiLCJwcm9wZXJ0eUV4aXN0cyIsIkZQIiwiU2luZ2xldG9ucyIsIlVzZXIiLCJpc1JlZyIsImlzU3ViIiwiaXNJUEFjY2VzcyIsImF1dGhvclF1YW50aWZpZXIiLCJwYXJzZUludCIsImRhdGEiLCJzaG93QWxlcnQiLCJtYXAiLCJib2R5IiwiYWZ0ZXIiLCJ0ZXh0IiwiaHJlZiIsImNsYXNzIiwiY2xpY2siLCJlIiwicHJldmVudERlZmF1bHQiLCJ0cCIsInBpYW5vSWQiLCJzaG93IiwiZGlzcGxheU1vZGUiLCJzY3JlZW4iLCJvZmZlciIsIm9mZmVySWQiLCJ0ZW1wbGF0ZUlkIiwiY3NzIiwiZGlzcGxheSIsInVzZXJEYXRhIiwiY2hlY2tTdWJzY3JpcHRpb24iLCJhZGRFdmVudExpc3RlbmVycyIsImdldEFsbFN1YnNjcmlwdGlvbnMiLCJhbVJ1biIsIm9uIiwic3RvcFByb3BhZ2F0aW9uIiwidG9nZ2xlU3Vic2NyaXB0aW9uIiwiYWRkRXZlbnRMaXN0ZW5lciIsImNvbmZpcm1hdGlvbk1lc3NhZ2UiLCJldmVudCIsInJldHVyblZhbHVlIiwiaGFuZGxlRGlzcGxheSIsInNob3dBdXRob3JVSSIsInNob3dUYWdVSSIsImVhY2giLCJwcm9wIiwiaGFzQ2xhc3MiLCJwYXlsb2FkIiwibWV0aG9kIiwid3Bub25jZSIsImN1c3RvbUFsZXJ0c0xvY2FsIiwid3BOb25jZSIsImFtQWRkUmVxIiwidHlwZSIsInVybCIsInN1Y2Nlc3MiLCJyZXMiLCJoYXNPd25Qcm9wZXJ0eSIsInVwZGF0ZURvbSIsImVycm9ySGFuZGxlciIsImVycm9yIiwiYWxlcnRUeXBlIiwidXBkYXRlU3dpdGNoZXMiLCJyZW1vdmVDbGFzcyIsImFsZXJ0SWRzIiwiaW5wdXRzIiwiaSIsImVsIiwicGFyZW50IiwicmVtb3ZlQXR0ciIsImF0dHIiLCJzcGxpdCIsImZpbHRlciIsImV2ZXJ5IiwidmFsIiwiaW5kZXhPZiIsImlzIiwic3ViamVjdCIsImFkZENsYXNzIiwic2V0VGltZW91dCIsImNhbGxiYWNrIiwic2libGluZ3MiLCJyZW1vdmUiLCJtYW5hZ2VTdWJzY3JpcHRpb24iLCJhY3Rpb24iLCJjb2RlIiwibWVzc2FnZSIsInVuZGVmaW5lZCIsImhlYWRsaW5lIiwibG9jYXRpb24iLCJBcnJheSIsImlzQXJyYXkiLCJvcHQiLCJwdXNoIiwiYW1SZW1vdmVSZXEiLCJpbkFycmF5Iiwic3BsaWNlIiwib3JpU3VjIiwiY29tcGxldGUiLCJzaGlmdCIsImFwcGx5IiwiYWpheCIsImFtU3RvcCIsImNsZWFyVGltZW91dCIsIm9iaiIsImFyZ3MiLCJwcm90b3R5cGUiLCJzbGljZSIsImNhbGwiLCJhcmd1bWVudHMiLCJpc1JlYWR5Iiwic2V0SW50ZXJ2YWwiLCJwaWFub1JlYWR5IiwiY2xlYXJJbnRlcnZhbCIsImpRdWVyeSJdLCJtYXBwaW5ncyI6IkNBQUEsU0FBQUEsR0FDQUEsRUFBQUMsVUFBQUMsTUFBQSxXQUNBLElBQUFDLEVBQUEsQ0FDQUMsY0FBQUosRUFBQSxvQkFDQUssV0FBQUwsRUFBQSxpQkFDQU0sU0FBQU4sRUFBQSxtQ0FHQU8sZUFBQVAsRUFBQSxvQ0FDQVEsV0FBQVIsRUFBQSxnQ0FDQVMsWUFBQVQsRUFBQSxpQ0FDQVUsUUFBQVYsRUFBQSw2QkFHQVcsa0JBQUFYLEVBQUEsb0NBQ0FZLGVBQUFaLEVBQUEsOEJBR0FhLGlCQUFBYixFQUFBLDBCQUNBYyxhQUFBZCxFQUFBLHdDQUNBZSxZQUFBZixFQUFBLHVDQUNBZ0IsZUFBQWhCLEVBQUEsMENBR0FpQixNQUFBLEdBQ0FDLElBQUEsR0FDQUMsU0FBQSxHQUNBQyxJQUFBLEdBQ0FDLFNBQUEsRUFVQUMsS0FBQSxXQUNBLElBQUFDLEVBQUFDLEtBR0EsSUFGQUMsT0FBQXRCLGFBQUFvQixHQUVBakIsU0FBQW9CLFNBQUFILEVBQUFGLFFBQUEsQ0FDQUUsRUFBQUYsU0FBQSxFQUVBLElBQUFNLEVBQUEsT0FXQSxPQVRBSixFQUFBSyxlQUFBSCxPQUFBLEtBQUEsYUFBQSxPQUFBLFVBQUFBLE9BQUFJLEdBQUFDLFdBQUFDLEtBQUFDLFFBQ0FMLEVBQUEsY0FFQUosRUFBQUssZUFBQUgsT0FBQSxLQUFBLGFBQUEsT0FBQSxVQUFBQSxPQUFBSSxHQUFBQyxXQUFBQyxLQUFBRSxRQUNBTixFQUFBLGNBR0FBLEVBREFKLEVBQUFLLGVBQUFILE9BQUEsS0FBQSxhQUFBLE9BQUEsZUFBQUEsT0FBQUksR0FBQUMsV0FBQUMsS0FBQUcsV0FDQSxXQUVBUCxHQUNBLElBQUEsT0FDQSxJQUFBUSxFQUFBLEVBQUFDLFNBQUFiLEVBQUFuQixjQUFBaUMsS0FBQSxnQkFBQSxpQ0FBQSwrQkFFQWQsRUFBQWUsVUFDQSxDQUNBLG1CQUNBLG9CQUVBLENBQ0Esb0VBQUFILEVBQ0Esc0dBQ0EsT0FDQUksSUFBQSxTQUFBQyxHQUNBQSxFQUFBQyxNQUNBekMsRUFBQSxRQUFBLENBQ0EwQyxLQUFBLFVBQ0FDLEtBQUEsSUFDQUMsTUFBQSxvQ0FDQUMsTUFBQSxTQUFBQyxHQUNBQSxFQUFBQyxpQkFFQUMsR0FBQUMsUUFBQUMsS0FBQSxDQUNBQyxZQUFBLFFBQ0FDLE9BQUEsYUFJQVgsTUFBQSxPQUNBQSxNQUNBekMsRUFBQSxRQUFBLENBQ0EwQyxLQUFBLGdCQUNBQyxLQUFBLElBQ0FDLE1BQUEsS0FDQUMsTUFBQSxTQUFBQyxHQUNBQSxFQUFBQyxpQkFFQUMsR0FBQUssTUFBQUgsS0FBQSxDQUNBSSxRQUFBLGVBQ0FDLFdBQUEsZUFDQUosWUFBQSxlQU9BNUIsRUFBQWpCLFNBQUFrRCxJQUFBLENBQUFDLFFBQUEsV0FDQSxNQUVBLElBQUEsYUFFQXRCLEVBQUEsRUFBQUMsU0FBQWIsRUFBQW5CLGNBQUFpQyxLQUFBLGdCQUFBLGlDQUFBLCtCQUVBZCxFQUFBZSxVQUNBLENBQ0EsbUJBQ0Esb0JBRUEsQ0FDQSxvRUFBQUgsRUFDQSxzR0FDQSxPQUNBSSxJQUFBLFNBQUFDLEdBQ0FBLEVBQUFDLE1BQ0F6QyxFQUFBLFFBQUEsQ0FDQTBDLEtBQUEsZ0JBQ0FDLEtBQUEsSUFDQUMsTUFBQSxLQUNBQyxNQUFBLFNBQUFDLEdBQ0FBLEVBQUFDLGlCQUVBQyxHQUFBSyxNQUFBSCxLQUFBLENBQ0FJLFFBQUEsZUFDQUMsV0FBQSxlQUNBSixZQUFBLGVBT0E1QixFQUFBakIsU0FBQWtELElBQUEsQ0FBQUMsUUFBQSxXQUVBLE1BRUEsSUFBQSxhQUdBbEMsRUFBQU4sTUFBQVEsT0FBQUksR0FBQUMsV0FBQUMsS0FBQTJCLFNBQUF6QyxPQUFBLEdBQ0FNLEVBQUFMLElBQUFPLE9BQUFJLEdBQUFDLFdBQUFDLEtBQUEyQixTQUFBeEMsS0FBQSxHQUdBSyxFQUFBb0Msb0JBR0FwQyxFQUFBcUMsb0JBR0FyQyxFQUFBc0Msc0JBR0F0QyxFQUFBdUMsUUFFQSxNQUVBLElBQUEsV0FFQXZDLEVBQUFqQixTQUFBa0QsSUFBQSxDQUFBQyxRQUFBLFlBZUFHLGtCQUFBLFdBQ0EsSUFBQXJDLEVBQUFDLEtBR0FELEVBQUFWLGlCQUFBa0QsR0FBQSxRQUFBLFNBQUFqQixHQUNBQSxFQUFBQyxpQkFDQUQsRUFBQWtCLGtCQUNBekMsRUFBQTBDLG1CQUFBekMsUUFJQUMsT0FBQXlDLGlCQUFBLGVBQUEsU0FBQXBCLEdBQ0EsSUFDQXFCLEVBREEsR0FBQTVDLEVBQUFKLFNBQUFPLE9BSUEsT0FIQXlDLEVBQUEseUlBRUFyQixHQUFBckIsT0FBQTJDLE9BQUFDLFlBQUFGLEtBaUJBRyxjQUFBLFdBQ0EsSUFBQS9DLEVBQUFDLEtBQ0ErQyxHQUFBLEVBQ0FDLEdBQUEsRUFFQWpELEVBQUFULGFBQUEyRCxLQUFBLFdBQ0F6RSxFQUFBd0IsTUFBQWtELEtBQUEsYUFDQUgsR0FBQSxLQUlBaEQsRUFBQVIsWUFBQTBELEtBQUEsV0FDQXpFLEVBQUF3QixNQUFBa0QsS0FBQSxhQUNBRixHQUFBLEtBSUFqRCxFQUFBUCxlQUFBeUQsS0FBQSxXQUNBekUsRUFBQXdCLE1BQUFrRCxLQUFBLGFBQ0FGLEdBQUEsS0FJQWpELEVBQUFuQixjQUFBb0QsSUFBQSxDQUNBQyxRQUFBYyxHQUFBaEQsRUFBQW5CLGNBQUF1RSxTQUFBLFdBQUEsU0FBQSxTQUdBcEQsRUFBQWxCLFdBQUFtRCxJQUFBLENBQ0FDLFFBQUFlLEdBQUFqRCxFQUFBbEIsV0FBQXNFLFNBQUEsV0FBQSxRQUFBLFVBYUFkLG9CQUFBLFdBQ0EsSUFBQXRDLEVBQUFDLEtBRUFvRCxFQUFBLENBQ0F6RSxhQUFBLENBQ0FjLE1BQUFNLEVBQUFOLE1BQ0FDLElBQUFLLEVBQUFMLElBQ0EyRCxPQUFBLE1BQ0FDLFFBQUFDLGtCQUFBQyxTQUFBLEtBSUF6RCxFQUFBMEQsU0FBQSxDQUNBQyxLQUFBLE9BQ0FDLElBQUEseURBQ0E5QyxLQUFBdUMsRUFFQVEsUUFBQSxTQUFBQyxHQUNBQSxFQUFBQyxlQUFBLFVBQUFELEVBQUFoRCxLQUFBaUQsZUFBQSxRQUNBL0QsRUFBQWdFLFVBQUFGLEdBRUE5RCxFQUFBaUUsYUFBQUgsSUFJQUksTUFBQSxTQUFBSixHQUNBOUQsRUFBQWlFLGFBQUFILE9BZUFFLFVBQUEsU0FBQUYsR0FDQSxJQUFBOUQsRUFBQUMsS0FFQSxJQUFBa0UsYUFBQUwsRUFBQWhELEtBQ0FkLEVBQUFvRSxlQUFBRCxVQUFBTCxFQUFBaEQsS0FBQXFELFlBSUFuRSxFQUFBK0MsZ0JBRUEvQyxFQUFBakIsU0FBQXNGLFlBQUEsWUFlQUQsZUFBQSxTQUFBRCxFQUFBRyxHQUNBLElBQUF0RSxFQUFBQyxLQUNBc0UsR0FBQSxFQUVBLE9BQUFKLEdBQ0EsSUFBQSxvQkFDQUksRUFBQXZFLEVBQUFULGFBQ0EsTUFDQSxJQUFBLG1CQUNBZ0YsRUFBQXZFLEVBQUFSLFlBQ0EsTUFDQSxJQUFBLHNCQUNBK0UsRUFBQXZFLEVBQUFQLGdCQUlBLElBQUE4RSxHQUFBQSxFQUFBcEUsUUFDQW9FLEVBQUFyQixLQUFBLFNBQUFzQixFQUFBQyxHQUNBaEcsRUFBQWdHLEdBQUFDLFNBQUFMLFlBQUEsV0FDQTVGLEVBQUFnRyxHQUFBRSxXQUFBLFlBRUFsRyxFQUFBZ0csR0FBQUcsS0FBQSxRQUNBQyxNQUFBLEtBQ0FDLE9BQUEsU0FBQUwsR0FBQSxNQUFBLEtBQUFBLEdBQUFBLE1BQUFBLElBRUFNLE1BQUEsU0FBQUMsR0FBQSxPQUFBLElBQUFWLEVBQUFXLFFBQUFELEtBQUF2RyxFQUFBZ0csR0FBQXRCLEtBQUEsV0FBQSxHQUFBMUUsRUFBQWdHLEdBQUF0QixLQUFBLFdBQUEsTUFjQVQsbUJBQUEsU0FBQStCLEdBQ0EsSUFBQXpFLEVBQUFDLEtBRUFvRCxFQUFBLENBQ0F6RSxhQUFBLENBQ0FjLE1BQUFNLEVBQUFOLE1BQ0FDLElBQUFLLEVBQUFMLElBQ0EyRCxPQUFBN0UsRUFBQWdHLEdBQUFTLEdBQUEsWUFBQSxtQkFBQSxzQkFDQTNCLFFBQUFDLGtCQUFBQyxTQUFBLEdBQ0EwQixRQUFBMUcsRUFBQWdHLEdBQUFHLEtBQUEsUUFDQWpCLEtBQUFsRixFQUFBZ0csR0FBQTNELEtBQUEsVUFLQXJDLEVBQUFnRyxHQUFBQyxTQUFBVSxTQUFBLFdBQ0EzRyxFQUFBZ0csR0FBQUcsS0FBQSxXQUFBLFlBRUE1RSxFQUFBMEQsU0FBQSxDQUNBQyxLQUFBLE9BQ0FDLElBQUEseURBQ0E5QyxLQUFBdUMsRUFFQVEsUUFBQSxTQUFBQyxHQUNBQSxFQUFBQyxlQUFBLFNBQ0FELEVBQUFoRCxLQUFBaUQsZUFBQXRGLEVBQUFnRyxHQUFBM0QsS0FBQSxVQUVBckMsRUFBQWdHLEdBQUFDLFNBQUFMLFlBQUEsV0FDQTVGLEVBQUFnRyxHQUFBRSxXQUFBLFlBRUFVLFdBQUEsV0FDQTVHLEVBQUFnRyxHQUFBUyxHQUFBLFlBQUF6RyxFQUFBZ0csR0FBQXRCLEtBQUEsV0FBQSxHQUFBMUUsRUFBQWdHLEdBQUF0QixLQUFBLFdBQUEsSUFDQSxNQUVBbkQsRUFBQWlFLGFBQUFILEVBQUFXLElBSUFQLE1BQUEsU0FBQUosR0FDQTlELEVBQUFpRSxhQUFBSCxFQUFBVyxPQWdCQXJDLGtCQUFBLFNBQUFrRCxHQUNBLElBQUF0RixFQUFBQyxLQUVBb0QsRUFBQSxDQUNBekUsYUFBQSxDQUNBYyxNQUFBTSxFQUFBTixNQUNBQyxJQUFBSyxFQUFBTCxJQUNBMkQsT0FBQSxnQkFDQUMsUUFBQUMsa0JBQUFDLFNBQUEsS0FJQXpELEVBQUEwRCxTQUFBLENBQ0FDLEtBQUEsT0FDQUMsSUFBQSx5REFDQTlDLEtBQUF1QyxFQUVBUSxRQUFBLFNBQUFDLEdBQ0EsR0FBQUEsRUFBQUMsZUFBQSxRQUFBLENBQ0EsT0FBQUQsRUFBQWhELE1BQ0EsSUFBQSxTQUNBLElBQUEsUUFDQWQsRUFBQWpCLFNBQUFzRixZQUFBLFdBQ0EsTUFDQSxJQUFBLFFBQ0FyRSxFQUFBZSxVQUFBLFdBQUEsd0dBQUEsT0FBQUMsSUFBQSxTQUFBQyxHQUNBQSxFQUFBc0UsU0FBQSxLQUFBQyxTQUNBdkUsRUFBQUMsTUFDQXpDLEVBQUEsUUFBQSxDQUNBMEMsS0FBQSxjQUNBQyxLQUFBLElBQ0FDLE1BQUEsS0FDQUMsTUFBQSxTQUFBQyxHQUNBQSxFQUFBQyxpQkFDQS9DLEVBQUF3QixNQUFBa0IsS0FBQSxrQkFDQW5CLEVBQUF5RixtQkFBQSxZQUFBLHdCQU9BLElBQUFILEdBQ0FBLFNBRUF0RixFQUFBaUUsYUFBQUgsSUFJQUksTUFBQSxTQUFBSixHQUNBOUQsRUFBQWlFLGFBQUFILE9BZ0JBMkIsbUJBQUEsU0FBQUMsRUFBQUosR0FDQSxJQUFBdEYsRUFBQUMsS0FFQW9ELEVBQUEsQ0FDQXpFLGFBQUEsQ0FDQWMsTUFBQU0sRUFBQU4sTUFDQUMsSUFBQUssRUFBQUwsSUFDQTJELE9BQUFvQyxFQUNBbkMsUUFBQUMsa0JBQUFDLFNBQUEsS0FJQXpELEVBQUEwRCxTQUFBLENBQ0FDLEtBQUEsT0FDQUMsSUFBQSx5REFDQTlDLEtBQUF1QyxFQUVBUSxRQUFBLFNBQUFDLEdBQ0FBLEVBQUFDLGVBQUEsUUFDQS9ELEVBQUFvQyxrQkFBQWtELEdBRUF0RixFQUFBaUUsYUFBQUgsSUFJQUksTUFBQSxTQUFBSixHQUNBOUQsRUFBQWlFLGFBQUFILE9BMEJBRyxhQUFBLFNBQUFILEVBQUFXLEdBR0EsR0FBQVgsRUFBQUMsZUFBQSxTQUNBRCxFQUFBaEQsS0FBQWlELGVBQUEsWUFDQUQsRUFBQWhELEtBQUFpRCxlQUFBLFFBRUEsT0FBQUQsRUFBQWhELEtBQUE2RSxNQUVBLEtBQUEsSUFDQSxLQUFBLElBQ0EsS0FBQSxJQUNBLEtBQUEsSUFDQSxLQUFBLElBQ0EsS0FBQSxJQUNBLEtBQUEsSUFDQSxLQUFBLElBQ0EsS0FBQSxJQWhCQTFGLEtBa0JBYyxVQUFBLFVBQUErQyxFQUFBaEQsS0FBQThFLFFBQUEsT0FDQSxNQUdBLEtBQUEsSUFDQSxLQUFBLFNBQ0FDLElBQUFwQixJQUNBaEcsRUFBQWdHLEdBQUFDLFNBQUFMLFlBQUEsV0FDQTVGLEVBQUFnRyxHQUFBRSxXQUFBLFlBRUFVLFdBQUEsV0FDQTVHLEVBQUFnRyxHQUFBUyxHQUFBLFlBQUF6RyxFQUFBZ0csR0FBQXRCLEtBQUEsV0FBQSxHQUFBMUUsRUFBQWdHLEdBQUF0QixLQUFBLFdBQUEsSUFDQSxXQTlCQWxELEtBcUNBYyxVQUFBLFNBQUEsa0ZBQUEsUUFpQkFBLFVBQUEsU0FBQStFLEVBQUFGLEVBQUFHLEdBQ0EsSUFBQS9GLEVBQUFDLEtBRUEsR0FBQSxJQUFBNkYsRUFBQTNGLFFBQUEsSUFBQXlGLEVBQUF6RixRQUFBLElBQUE0RixFQUFBNUYsT0FDQSxPQUFBLEVBS0EsT0FIQUgsRUFBQWpCLFNBQUFrRCxJQUFBLENBQUFDLFFBQUEsVUFDQWxDLEVBQUFqQixTQUFBcUcsU0FBQSxXQUVBVyxHQUNBLElBQUEsTUFhQSxPQVpBQyxNQUFBQyxRQUFBSCxJQUNBOUYsRUFBQWhCLGVBQUFtQyxLQUFBMkUsRUFBQSxJQUNBOUYsRUFBQWYsV0FBQWtDLEtBQUF5RSxFQUFBLElBQ0E1RixFQUFBZCxZQUFBaUMsS0FBQTJFLEVBQUEsSUFDQTlGLEVBQUFiLFFBQUFnQyxLQUFBeUUsRUFBQSxNQUVBNUYsRUFBQWhCLGVBQUFtQyxLQUFBMkUsR0FDQTlGLEVBQUFmLFdBQUFrQyxLQUFBeUUsR0FDQTVGLEVBQUFkLFlBQUFpQyxLQUFBMkUsR0FDQTlGLEVBQUFiLFFBQUFnQyxLQUFBeUUsSUFHQSxDQUFBNUYsRUFBQWYsV0FBQWUsRUFBQWIsU0FFQSxJQUFBLFNBSUEsT0FIQWEsRUFBQWhCLGVBQUFtQyxLQUFBMkUsR0FDQTlGLEVBQUFmLFdBQUFrQyxLQUFBeUUsR0FFQTVGLEVBQUFmLFdBRUEsSUFBQSxNQUlBLE9BSEFlLEVBQUFkLFlBQUFpQyxLQUFBMkUsR0FDQTlGLEVBQUFiLFFBQUFnQyxLQUFBeUUsR0FFQTVGLEVBQUFiLFFBSUEsT0FBQSxHQWFBdUUsU0FBQSxTQUFBd0MsR0FDQWpHLEtBRUFMLFNBQUF1RyxLQUFBRCxJQWFBRSxZQUFBLFNBQUFGLElBQ0EsRUFBQXpILEVBQUE0SCxRQUFBSCxFQUFBbEcsS0FBQUosV0FDQUksS0FBQUosU0FBQTBHLE9BQUE3SCxFQUFBNEgsUUFBQUgsRUFBQWxHLEtBQUFKLFVBQUEsSUFhQTJDLE1BQUEsV0FDQSxJQUFBZ0UsRUFBQXZHLEVBQUFDLEtBRUFELEVBQUFKLFNBQUFPLFFBQ0FvRyxFQUFBdkcsRUFBQUosU0FBQSxHQUFBNEcsU0FFQXhHLEVBQUFKLFNBQUEsR0FBQTRHLFNBQUEsV0FDQSxtQkFBQSxHQUFBRCxJQUNBdkcsRUFBQUosU0FBQTZHLFFBQ0F6RyxFQUFBdUMsTUFBQW1FLE1BQUExRyxFQUFBLEtBR0F2QixFQUFBa0ksS0FBQTNHLEVBQUFKLFNBQUEsS0FFQUksRUFBQUgsSUFBQXdGLFdBQUEsV0FDQXJGLEVBQUF1QyxNQUFBbUUsTUFBQTFHLEVBQUEsS0FDQSxNQVNBNEcsT0FBQSxXQUNBM0csS0FFQUwsU0FBQSxHQUNBaUgsYUFIQTVHLEtBR0FKLE1BY0FRLGVBQUEsU0FBQXlHLEdBR0EsSUFGQSxJQUFBQyxFQUFBZixNQUFBZ0IsVUFBQUMsTUFBQUMsS0FBQUMsVUFBQSxHQUVBM0MsRUFBQSxFQUFBQSxFQUFBdUMsRUFBQTVHLE9BQUFxRSxJQUFBLENBQ0EsSUFBQXNDLElBQUFBLEVBQUEvQyxlQUFBZ0QsRUFBQXZDLElBQ0EsT0FBQSxFQUVBc0MsRUFBQUEsRUFBQUMsRUFBQXZDLElBRUEsT0FBQSxJQUtBNEMsRUFBQUMsWUFBQSxnQkFDQXhCLElBQUEzRixPQUFBb0gsWUFBQXBILE9BQUFvSCxhQUNBMUksRUFBQW1CLE9BQUF3SCxjQUFBSCxLQUlBLE9BM3RCQSxDQTh0QkFJIiwiZmlsZSI6ImNvbXBvbmVudC1jdXN0b20tYWxlcnRzLWFydGljbGUubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiIWZ1bmN0aW9uKCAkICl7XG4gICQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgY3VzdG9tQWxlcnRzID0gY3VzdG9tQWxlcnRzIHx8IHtcbiAgICAgIGF1dGhvcldyYXBwZXIgICAgOiAkKCcuY2FsZXJ0cy1hdXRob3JzJyksXG4gICAgICB0YWdXcmFwcGVyICAgICAgIDogJCgnLmNhbGVydHMtdGFncycpLFxuICAgICAgd3JhcHBlcnMgICAgICAgICA6ICQoJy5jYWxlcnRzLWF1dGhvcnMsIC5jYWxlcnRzLXRhZ3MnKSxcbiAgICAgIFxuICAgICAgLy8gSGVhZGxpbmVzICYgQm9keVxuICAgICAgYXV0aG9ySGVhZGxpbmUgICA6ICQoJy5jYWxlcnRzLWF1dGhvcnNfX2FsZXJ0LWhlYWRsaW5lJyksXG4gICAgICBhdXRob3JCb2R5ICAgICAgIDogJCgnLmNhbGVydHMtYXV0aG9yc19fYWxlcnQtYm9keScpLFxuICAgICAgdGFnSGVhZGxpbmUgICAgICA6ICQoJy5jYWxlcnRzLXRhZ3NfX2FsZXJ0LWhlYWRsaW5lJyksXG4gICAgICB0YWdCb2R5ICAgICAgICAgIDogJCgnLmNhbGVydHMtdGFnc19fYWxlcnQtYm9keScpLFxuXG4gICAgICAvLyBDaGVja21hcmsgd3JhcHBlcnNcbiAgICAgIGF1dGhvckNoa1dyYXBwZXJzIDogJCgnLmNhbGVydHMtYXV0aG9yc19fYXV0aG9yLXdyYXBwZXInKSxcbiAgICAgIHRhZ0Noa1dyYXBwZXJzICAgIDogJCgnLmNhbGVydHMtdGFnc19fdGFnLXdyYXBwZXInKSxcblxuICAgICAgLy8gVGhlIGFjdHVhbCBpbnB1dHNcbiAgICAgIGNoZWNrbWFya1RvZ2dsZXMgOiAkKCdpbnB1dC5jYWxlcnRzLWNoZWNrYm94JyksXG4gICAgICBhdXRob3JJbnB1dHMgICAgIDogJCgnaW5wdXRbZGF0YS10eXBlPVwiYXV0aG9yX3RhZ19hbGVydHNcIl0nKSxcbiAgICAgIHRvcGljSW5wdXRzICAgICAgOiAkKCdpbnB1dFtkYXRhLXR5cGU9XCJ0b3BpY190YWdfYWxlcnRzXCJdJyksXG4gICAgICByZWdpb25hbElucHV0cyAgIDogJCgnaW5wdXRbZGF0YS10eXBlPVwicmVnaW9uYWxfdGFnX2FsZXJ0c1wiXScpLFxuICAgICAgXG4gICAgICAvLyBVdGlsc1xuICAgICAgZW1haWwgICAgICAgICAgICA6ICcnLFxuICAgICAgdWlkICAgICAgICAgICAgICA6ICcnLFxuICAgICAgcmVxdWVzdHMgICAgICAgICA6IFtdLFxuICAgICAgdGlkICAgICAgICAgICAgICA6ICcnLFxuICAgICAgcnVubmluZyAgICAgICAgICA6IGZhbHNlLFxuXG4gICAgICAvKipcbiAgICAgICAqIEBzdW1tYXJ5IEluaXRpYWxpemVzIHRoZSBjdXN0b20gYWxlcnRzIGZ1bmN0aW9uYWxpdHlcbiAgICAgICAqIFxuICAgICAgICogQGRlc2NyaXB0aW9uIFdhaXRzIG9uIHBpYW5vQWNjZXNzQ2hlY2tDb21wbGV0ZSB0byBkZXRlcm1pbmVcbiAgICAgICAqIHdoZXRoZXIgdG8gcHJvY2VlZCBvciBub3QuXG4gICAgICAgKlxuICAgICAgICogQHJldHVybiAge3ZvaWR9XG4gICAgICAgKi9cbiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICAgIHdpbmRvdy5jdXN0b21BbGVydHMgPSBzZWxmOyAvLyBleHBvc2UgdG8gZ2xvYmFsXG5cbiAgICAgICAgaWYoIHNlbGYud3JhcHBlcnMubGVuZ3RoICYmICFzZWxmLnJ1bm5pbmcgKSB7XG4gICAgICAgICAgc2VsZi5ydW5uaW5nID0gdHJ1ZTtcblxuICAgICAgICAgIHZhciB1c2VyID0gJ25vbmUnO1xuICAgICAgICAgIFxuICAgICAgICAgIGlmKCBzZWxmLnByb3BlcnR5RXhpc3RzKHdpbmRvdywgJ0ZQJywgJ1NpbmdsZXRvbnMnLCAnVXNlcicsICdpc1JlZycpICYmIHdpbmRvdy5GUC5TaW5nbGV0b25zLlVzZXIuaXNSZWcgKVxuICAgICAgICAgICAgdXNlciA9ICdyZWdpc3RlcmVkJztcblxuICAgICAgICAgIGlmKCBzZWxmLnByb3BlcnR5RXhpc3RzKHdpbmRvdywgJ0ZQJywgJ1NpbmdsZXRvbnMnLCAnVXNlcicsICdpc1N1YicpICYmIHdpbmRvdy5GUC5TaW5nbGV0b25zLlVzZXIuaXNTdWIgKVxuICAgICAgICAgICAgdXNlciA9ICdzdWJzY3JpYmVyJztcblxuICAgICAgICAgIGlmKCBzZWxmLnByb3BlcnR5RXhpc3RzKHdpbmRvdywgJ0ZQJywgJ1NpbmdsZXRvbnMnLCAnVXNlcicsICdpc0lQQWNjZXNzJykgJiYgd2luZG93LkZQLlNpbmdsZXRvbnMuVXNlci5pc0lQQWNjZXNzIClcbiAgICAgICAgICAgIHVzZXIgPSAnaXBhY2Nlc3MnO1xuXG4gICAgICAgICAgc3dpdGNoICh1c2VyKSB7XG4gICAgICAgICAgICBjYXNlICdub25lJzpcbiAgICAgICAgICAgICAgdmFyIGF1dGhvclF1YW50aWZpZXIgPSAoIHBhcnNlSW50KCBzZWxmLmF1dGhvcldyYXBwZXIuZGF0YSgnbnVtLWF1dGhvcnMnKSApID4gMSApID8gJyB0aGVzZSBhdXRob3JzIGFyZSBwdWJsaXNoZWQuICcgOiAnIHRoaXMgYXV0aG9yIGFyZSBwdWJsaXNoZWQuICc7XG5cbiAgICAgICAgICAgICAgc2VsZi5zaG93QWxlcnQoXG4gICAgICAgICAgICAgICAgWyBcbiAgICAgICAgICAgICAgICAgICdORVcgRU1BSUwgQUxFUlRTJywgXG4gICAgICAgICAgICAgICAgICAnTkVXIEVNQUlMIEFMRVJUUydcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgICdGUCBzdWJzY3JpYmVycyBjYW4gbm93IHJlY2VpdmUgYWxlcnRzIHdoZW4gbmV3IHN0b3JpZXMgd3JpdHRlbiBieScgKyBhdXRob3JRdWFudGlmaWVyLFxuICAgICAgICAgICAgICAgICAgJ0ZQIHN1YnNjcmliZXJzIGNhbiBub3cgcmVjZWl2ZSBhbGVydHMgd2hlbiBuZXcgc3RvcmllcyBvbiB0aGVzZSB0b3BpY3MgYW5kIHJlZ2lvbnMgYXJlIHB1Ymxpc2hlZC4gJ1xuICAgICAgICAgICAgICAgIF0sICdhbGwnKVxuICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24oYm9keSkge1xuICAgICAgICAgICAgICAgICAgYm9keS5hZnRlcihcbiAgICAgICAgICAgICAgICAgICAgJCgnPGEgLz4nLCB7XG4gICAgICAgICAgICAgICAgICAgICAgJ3RleHQnICA6ICdTaWduIGluJyxcbiAgICAgICAgICAgICAgICAgICAgICAnaHJlZicgIDogJyMnLFxuICAgICAgICAgICAgICAgICAgICAgICdjbGFzcycgOiAnLXVzZXIgLXNpZ25pbiBGUC1wYXl3YWxsLS1sb2dpbidcbiAgICAgICAgICAgICAgICAgICAgfSkuY2xpY2soZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgXG4gICAgICAgICAgICAgICAgICAgICAgdHAucGlhbm9JZC5zaG93KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlNb2RlOiAnbW9kYWwnLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2NyZWVuOiAnbG9naW4nXG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAuYWZ0ZXIoJyB8ICcpXG4gICAgICAgICAgICAgICAgICAuYWZ0ZXIoXG4gICAgICAgICAgICAgICAgICAgICQoJzxhIC8+Jywge1xuICAgICAgICAgICAgICAgICAgICAgICd0ZXh0JyAgOiAnU3Vic2NyaWJlIG5vdycsXG4gICAgICAgICAgICAgICAgICAgICAgJ2hyZWYnICA6ICcjJyxcbiAgICAgICAgICAgICAgICAgICAgICAnY2xhc3MnIDogJydcbiAgICAgICAgICAgICAgICAgICAgfSkuY2xpY2soZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICB0cC5vZmZlci5zaG93KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9mZmVySWQgICAgIDogJ09GSjdUMVo1OE5FUycsXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZUlkICA6ICdPVFEzQ0lZNk1CSE0nLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheU1vZGUgOiAnbW9kYWwnLFxuICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgLy8gRGlzcGxheSB3cmFwcGVycyBvbmNlIGxvYWRlZFxuICAgICAgICAgICAgICBzZWxmLndyYXBwZXJzLmNzcyh7J2Rpc3BsYXknOiAnaW5saW5lJ30pO1xuICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAncmVnaXN0ZXJlZCc6XG4gICAgICAgICAgICAgIC8vIFNob3cgbG9naW4gLyBzdWJzY3JpYmVcbiAgICAgICAgICAgICAgdmFyIGF1dGhvclF1YW50aWZpZXIgPSAoIHBhcnNlSW50KCBzZWxmLmF1dGhvcldyYXBwZXIuZGF0YSgnbnVtLWF1dGhvcnMnKSApID4gMSApID8gJyB0aGVzZSBhdXRob3JzIGFyZSBwdWJsaXNoZWQuICcgOiAnIHRoaXMgYXV0aG9yIGFyZSBwdWJsaXNoZWQuICc7XG5cbiAgICAgICAgICAgICAgc2VsZi5zaG93QWxlcnQoXG4gICAgICAgICAgICAgICAgWyBcbiAgICAgICAgICAgICAgICAgICdORVcgRU1BSUwgQUxFUlRTJywgXG4gICAgICAgICAgICAgICAgICAnTkVXIEVNQUlMIEFMRVJUUydcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIFtcbiAgICAgICAgICAgICAgICAgICdGUCBzdWJzY3JpYmVycyBjYW4gbm93IHJlY2VpdmUgYWxlcnRzIHdoZW4gbmV3IHN0b3JpZXMgd3JpdHRlbiBieScgKyBhdXRob3JRdWFudGlmaWVyLFxuICAgICAgICAgICAgICAgICAgJ0ZQIHN1YnNjcmliZXJzIGNhbiBub3cgcmVjZWl2ZSBhbGVydHMgd2hlbiBuZXcgc3RvcmllcyBvbiB0aGVzZSB0b3BpY3MgYW5kIHJlZ2lvbnMgYXJlIHB1Ymxpc2hlZC4gJ1xuICAgICAgICAgICAgICAgIF0sICdhbGwnKVxuICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24oYm9keSkge1xuICAgICAgICAgICAgICAgICAgYm9keS5hZnRlcihcbiAgICAgICAgICAgICAgICAgICAgJCgnPGEgLz4nLCB7XG4gICAgICAgICAgICAgICAgICAgICAgJ3RleHQnICA6ICdTdWJzY3JpYmUgbm93JyxcbiAgICAgICAgICAgICAgICAgICAgICAnaHJlZicgIDogJyMnLFxuICAgICAgICAgICAgICAgICAgICAgICdjbGFzcycgOiAnJ1xuICAgICAgICAgICAgICAgICAgICB9KS5jbGljayhmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgIHRwLm9mZmVyLnNob3coe1xuICAgICAgICAgICAgICAgICAgICAgICAgb2ZmZXJJZCAgICAgOiAnT0ZKN1QxWjU4TkVTJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlSWQgIDogJ09UUTNDSVk2TUJITScsXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5TW9kZSA6ICdtb2RhbCcsXG4gICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAvLyBEaXNwbGF5IHdyYXBwZXJzIG9uY2UgbG9hZGVkXG4gICAgICAgICAgICAgIHNlbGYud3JhcHBlcnMuY3NzKHsnZGlzcGxheSc6ICdpbmxpbmUnfSk7XG5cbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNhc2UgJ3N1YnNjcmliZXInOlxuICAgICAgICAgICAgICAvLyBCdXNpbmVzcyBhcyB1c3VhbFxuICAgICAgICAgICAgICAvLyBTZXQgdGhlIHVzZXIgZW1haWwgZm9yIGVhc3kgYWNjZXNzXG4gICAgICAgICAgICAgIHNlbGYuZW1haWwgPSB3aW5kb3cuRlAuU2luZ2xldG9ucy5Vc2VyLnVzZXJEYXRhLmVtYWlsIHx8ICcnO1xuICAgICAgICAgICAgICBzZWxmLnVpZCAgID0gd2luZG93LkZQLlNpbmdsZXRvbnMuVXNlci51c2VyRGF0YS51aWQgfHwgJyc7XG4gICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAvLyBDaGVjayBpZiBzdWJzY3JpYmVkXG4gICAgICAgICAgICAgIHNlbGYuY2hlY2tTdWJzY3JpcHRpb24oKTtcblxuICAgICAgICAgICAgICAvLyBBZGQgZXZlbnQgbGlzdGVuZXJzXG4gICAgICAgICAgICAgIHNlbGYuYWRkRXZlbnRMaXN0ZW5lcnMoKTtcbiAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgIC8vIFB1bGwgYWxsIHN1YnNjcmlwdGlvbnMgYXQgb25jZVxuICAgICAgICAgICAgICBzZWxmLmdldEFsbFN1YnNjcmlwdGlvbnMoKTtcbiAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgIC8vIFN0YXJ0IHRoZSBhamF4IG1hbmFnZXJcbiAgICAgICAgICAgICAgc2VsZi5hbVJ1bigpO1xuICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2lwYWNjZXNzJzpcbiAgICAgICAgICAgICAgLy8gSGlkZSBmcm9tIElQIGFuZCBwcm94eSBhY2Nlc3MgdXNlcnNcbiAgICAgICAgICAgICAgc2VsZi53cmFwcGVycy5jc3MoeydkaXNwbGF5JzogJ25vbmUnfSk7XG5cbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuXG4gICAgICAvKipcbiAgICAgICAqIEBzdW1tYXJ5IFJlc3BvbnNpYmxlIGZvciBhZGRpbmcgZXZlbnQgbGlzdGVuZXJzXG4gICAgICAgKiBcbiAgICAgICAqIEBkZXNjcmlwdGlvbiBBZGRzIHRoZSB2YXJpb3VzIGV2ZW50IGxpc3RlbmVyc1xuICAgICAgICogdXNlZCB3aXRoaW4gYWxlcnRzXG4gICAgICAgKlxuICAgICAgICogQHJldHVybiAge3ZvaWR9XG4gICAgICAgKi9cbiAgICAgIGFkZEV2ZW50TGlzdGVuZXJzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgICAgICBcbiAgICAgICAgLy8gQWRkIGV2ZW50IGxpc3RlbmVyc1xuICAgICAgICBzZWxmLmNoZWNrbWFya1RvZ2dsZXMub24oJ2NsaWNrJywgZnVuY3Rpb24oZSkge1xuICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyBcbiAgICAgICAgICBzZWxmLnRvZ2dsZVN1YnNjcmlwdGlvbih0aGlzKTsgXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIExlYXZlIHdhcm5pbmdcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2JlZm9yZXVubG9hZCcsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICBpZiggc2VsZi5yZXF1ZXN0cy5sZW5ndGggKSB7XG4gICAgICAgICAgICB2YXIgY29uZmlybWF0aW9uTWVzc2FnZSA9ICdXZSBhcmUgc3RpbGwgdXBkYXRpbmcgeW91ciBwcmVmZXJlbmNlcywgbGVhdmluZyB0aGUgcGFnZSBub3cgd2lsbCByZXN1bHQgaW4gdW5zYXZlZCBjaGFuZ2VzLiBBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gbGVhdmUgdGhlIHBhZ2U/JztcbiAgICAgICAgXG4gICAgICAgICAgICAoZSB8fCB3aW5kb3cuZXZlbnQpLnJldHVyblZhbHVlID0gY29uZmlybWF0aW9uTWVzc2FnZTsgLy9HZWNrbyArIElFXG4gICAgICAgICAgICByZXR1cm4gY29uZmlybWF0aW9uTWVzc2FnZTsgLy9HZWNrbyArIFdlYmtpdCwgU2FmYXJpLCBDaHJvbWUgZXRjLlxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9LFxuXG4gICAgICAvKipcbiAgICAgICAqIEBzdW1tYXJ5IFJlc3BvbnNpYmxlIGZvciBVSSBkaXNwbGF5IFxuICAgICAgICogXG4gICAgICAgKiBAZGVzY3JpcHRpb24gQ2hlY2tzIGlmIGEgdXNlciBpcyBzdWJzY3JpYmVkXG4gICAgICAgKiB0byBhbGwgdGFncy9hdXRob3JzIGFuZCBkaXNwbGF5cyB0aGUgd3JhcHBlcnNcbiAgICAgICAqIGFjY29yZGluZ2x5LiBJZiB1c2VyIGlzIHN1YnNjcmliZWQgdG8gYWxsIHRhZ3MvYXV0aG9ycyBcbiAgICAgICAqIG5vbmUgd2lsbCBiZSBzaG93bi4gSWYgYSB1c2UgaXMgbWlzc2luZyBhbiBhdXRob3Igb3IgYVxuICAgICAgICogdGFnIHRoZSBjb3JyZXNwb25kaW5nIFVJIHdpbGwgYmUgc2hvd24uXG4gICAgICAgKlxuICAgICAgICogQHJldHVybiAge3ZvaWR9XG4gICAgICAgKi9cbiAgICAgIGhhbmRsZURpc3BsYXk6IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgc2VsZiAgICAgICAgID0gdGhpcztcbiAgICAgICAgdmFyIHNob3dBdXRob3JVSSA9IGZhbHNlO1xuICAgICAgICB2YXIgc2hvd1RhZ1VJICAgID0gZmFsc2U7XG5cbiAgICAgICAgc2VsZi5hdXRob3JJbnB1dHMuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgaWYoICEkKHRoaXMpLnByb3AoJ2NoZWNrZWQnKSApIHtcbiAgICAgICAgICAgIHNob3dBdXRob3JVSSA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBzZWxmLnRvcGljSW5wdXRzLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGlmKCAhJCh0aGlzKS5wcm9wKCdjaGVja2VkJykgKSB7XG4gICAgICAgICAgICBzaG93VGFnVUkgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgc2VsZi5yZWdpb25hbElucHV0cy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBpZiggISQodGhpcykucHJvcCgnY2hlY2tlZCcpICkge1xuICAgICAgICAgICAgc2hvd1RhZ1VJID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgc2VsZi5hdXRob3JXcmFwcGVyLmNzcyh7XG4gICAgICAgICAgJ2Rpc3BsYXknIDogKHNob3dBdXRob3JVSSB8fCBzZWxmLmF1dGhvcldyYXBwZXIuaGFzQ2xhc3MoJ21lc3NhZ2UnKSkgPyAnaW5saW5lJyA6ICdub25lJ1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHNlbGYudGFnV3JhcHBlci5jc3Moe1xuICAgICAgICAgICdkaXNwbGF5JyA6IChzaG93VGFnVUkgfHwgc2VsZi50YWdXcmFwcGVyLmhhc0NsYXNzKCdtZXNzYWdlJykpID8gJ2Jsb2NrJyA6ICdub25lJ1xuICAgICAgICB9KTtcbiAgICAgIH0sXG5cbiAgICAgIC8qKlxuICAgICAgICogQHN1bW1hcnkgR2V0IHRoZSBjdXJyZW50IHVzZXJzIHN1YnNjcmlwdGlvbnNcbiAgICAgICAqIFxuICAgICAgICogQGRlc2NyaXB0aW9uIENvbm5lY3RzIHRvIHRoZSBQb3N0VXAgRW5kcG9pbnQgdGhyb3VnaFxuICAgICAgICogalF1ZXJ5IGFqYXggbWV0aG9kIGFuZCByZXRyaWV2ZXMgdGhlIGN1cnJlbnQgdXNlciBcbiAgICAgICAqIHN1YnNjcmlwdGlvbnMuXG4gICAgICAgKlxuICAgICAgICogQHJldHVybiAge3ZvaWR9XG4gICAgICAgKi9cbiAgICAgIGdldEFsbFN1YnNjcmlwdGlvbnM6IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgdmFyIHBheWxvYWQgID0ge1xuICAgICAgICAgIGN1c3RvbUFsZXJ0czoge1xuICAgICAgICAgICAgZW1haWwgICA6IHNlbGYuZW1haWwsXG4gICAgICAgICAgICB1aWQgICAgIDogc2VsZi51aWQsXG4gICAgICAgICAgICBtZXRob2QgIDogJ2dldCcsXG4gICAgICAgICAgICB3cG5vbmNlIDogY3VzdG9tQWxlcnRzTG9jYWwud3BOb25jZSB8fCAnJyxcbiAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgc2VsZi5hbUFkZFJlcSh7XG4gICAgICAgICAgdHlwZSAgICAgOiAnUE9TVCcsXG4gICAgICAgICAgdXJsICAgICAgOiAnL2VuZHBvaW50L2N1c3RvbS1hbGVydHMvP19fZnBfZW5kcG9pbnRfY3VzdG9tX2FsZXJ0cz0xJyxcbiAgICAgICAgICBkYXRhICAgICA6IHBheWxvYWQsXG5cbiAgICAgICAgICBzdWNjZXNzIDogZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgICAgICBpZiggcmVzLmhhc093blByb3BlcnR5KCdkYXRhJykgJiYgIXJlcy5kYXRhLmhhc093blByb3BlcnR5KCdjb2RlJykgKSB7XG4gICAgICAgICAgICAgIHNlbGYudXBkYXRlRG9tKHJlcyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBzZWxmLmVycm9ySGFuZGxlcihyZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG5cbiAgICAgICAgICBlcnJvciA6IGZ1bmN0aW9uKHJlcykge1xuICAgICAgICAgICAgc2VsZi5lcnJvckhhbmRsZXIocmVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSxcblxuICAgICAgLyoqXG4gICAgICAgKiBAc3VtbWFyeSBSZXNwb25zaWJsZSBmb3IgZG9tIHJlbGF0ZWQgdXBkYXRlZFxuICAgICAgICogXG4gICAgICAgKiBAZGVzY3JpcHRpb24gVXBkYXRlcyB0aGUgaW5wdXQgYm94ZXNcbiAgICAgICAqIGJveCBiYXNlZCBvbiBhamF4IHJlc3BvbnNlLlxuICAgICAgICpcbiAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXMgVGhlIGFqYXggcmVzcG9uc2VcbiAgICAgICAqIFxuICAgICAgICogQHJldHVybiAge3ZvaWR9XG4gICAgICAgKi9cbiAgICAgIHVwZGF0ZURvbTogZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcbiAgICAgICAgXG4gICAgICAgIGZvciAoYWxlcnRUeXBlIGluIHJlcy5kYXRhKSB7XG4gICAgICAgICAgc2VsZi51cGRhdGVTd2l0Y2hlcyhhbGVydFR5cGUsIHJlcy5kYXRhW2FsZXJ0VHlwZV0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gSGFuZGxlIERpc3BsYXkgYWZ0ZXIgY2hlY2tib3ggdXBkYXRlcyBjb21wbGV0ZWRcbiAgICAgICAgc2VsZi5oYW5kbGVEaXNwbGF5KCk7XG5cbiAgICAgICAgc2VsZi53cmFwcGVycy5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgfSxcblxuICAgICAgLyoqXG4gICAgICAgKiBAc3VtbWFyeSBQb3B1bGF0ZXMgc3dpdGNoZXMgd2l0aCBjaGVja2VkIHZhbHVlc1xuICAgICAgICogXG4gICAgICAgKiBAZGVzY3JpcHRpb24gVXBkYXRlcyB0aGUgY2hlY2tib3hlcyBiYXNlZCBvbiB0aGVcbiAgICAgICAqIGFqYXggcmVzcG9uc2UuXG4gICAgICAgKlxuICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGFsZXJ0VHlwZSBUaGUgdHlwZSBvZiBhbGVydCB3ZSBhcmUgd29ya2luZyBcbiAgICAgICAqIHdpdGggKGF1dGhvciwgdG9waWMgdGFnIG9yIHJlZ2lvbmFsIHRhZylcbiAgICAgICAqIEBwYXJhbSB7YXJyYXl9IGFsZXJ0SWRzIFRoZSBhcnJheSBvZiBJRHMgZm9yIHRoaXMgdHlwZVxuICAgICAgICogXG4gICAgICAgKiBAcmV0dXJuICB7dm9pZH1cbiAgICAgICAqL1xuICAgICAgdXBkYXRlU3dpdGNoZXM6IGZ1bmN0aW9uKGFsZXJ0VHlwZSwgYWxlcnRJZHMpIHtcbiAgICAgICAgdmFyIHNlbGYgICA9IHRoaXM7XG4gICAgICAgIHZhciBpbnB1dHMgPSBmYWxzZTtcblxuICAgICAgICBzd2l0Y2ggKGFsZXJ0VHlwZSkge1xuICAgICAgICAgIGNhc2UgJ2F1dGhvcl90YWdfYWxlcnRzJzpcbiAgICAgICAgICAgIGlucHV0cyA9IHNlbGYuYXV0aG9ySW5wdXRzO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAndG9waWNfdGFnX2FsZXJ0cyc6XG4gICAgICAgICAgICBpbnB1dHMgPSBzZWxmLnRvcGljSW5wdXRzO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAncmVnaW9uYWxfdGFnX2FsZXJ0cyc6XG4gICAgICAgICAgICBpbnB1dHMgPSBzZWxmLnJlZ2lvbmFsSW5wdXRzO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBpZiggaW5wdXRzICE9PSBmYWxzZSAmJiBpbnB1dHMubGVuZ3RoICkge1xuICAgICAgICAgIGlucHV0cy5lYWNoKGZ1bmN0aW9uKGksIGVsKSB7XG4gICAgICAgICAgICAkKGVsKS5wYXJlbnQoKS5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgJChlbCkucmVtb3ZlQXR0cignZGlzYWJsZWQnKTtcblxuICAgICAgICAgICAgdmFyIHN1YmplY3RzICA9ICQoZWwpLmF0dHIoJ25hbWUnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnNwbGl0KCcsJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGVsKSB7IHJldHVybiBlbCAhPT0gJycgJiYgZWwgIT09IG51bGwgJiYgZWwgIT09IHVuZGVmaW5lZDsgfSk7XG5cbiAgICAgICAgICAgIHN1YmplY3RzLmV2ZXJ5KGZ1bmN0aW9uKHZhbCkgeyByZXR1cm4gYWxlcnRJZHMuaW5kZXhPZih2YWwpICE9PSAtMSB9KSA/ICQoZWwpLnByb3AoICdjaGVja2VkJywgdHJ1ZSApIDogJChlbCkucHJvcCggJ2NoZWNrZWQnLCBmYWxzZSApO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9LFxuXG4gICAgICAvKipcbiAgICAgICAqIEBzdW1tYXJ5IFRvZ2dsZXMgdXNlciBzdWJzY3JpcHRpb24gdG8gc3ViamVjdFxuICAgICAgICogXG4gICAgICAgKiBAZGVzY3JpcHRpb24gVG9nZ2xlcyB0aGUgdXNlcnMgc3Vic2NyaXB0aW9uIHRvIGEgc3ViamVjdCBcbiAgICAgICAqIFxuICAgICAgICogQHBhcmFtIHtlbGVtZW50fSBlbCBUaGUgY2hlY2tib3ggYmVpbmcgbWFuaXB1bGF0ZWRcbiAgICAgICAqXG4gICAgICAgKiBAcmV0dXJuICB7dm9pZH1cbiAgICAgICAqL1xuICAgICAgdG9nZ2xlU3Vic2NyaXB0aW9uOiBmdW5jdGlvbihlbCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgdmFyIHBheWxvYWQgID0ge1xuICAgICAgICAgIGN1c3RvbUFsZXJ0czoge1xuICAgICAgICAgICAgZW1haWwgICA6IHNlbGYuZW1haWwsXG4gICAgICAgICAgICB1aWQgICAgIDogc2VsZi51aWQsXG4gICAgICAgICAgICBtZXRob2QgIDogJChlbCkuaXMoJzpjaGVja2VkJykgPyAnYWRkX3N1YnNjcmlwdGlvbicgOiAncmVtb3ZlX3N1YnNjcmlwdGlvbicsXG4gICAgICAgICAgICB3cG5vbmNlIDogY3VzdG9tQWxlcnRzTG9jYWwud3BOb25jZSB8fCAnJyxcbiAgICAgICAgICAgIHN1YmplY3QgOiAkKGVsKS5hdHRyKCduYW1lJyksXG4gICAgICAgICAgICB0eXBlICAgIDogJChlbCkuZGF0YSgndHlwZScpLFxuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8vIFZpc3VhbCB1cGRhdGVzIHRvIGluZGljYXRlIHdvcmtpbmdcbiAgICAgICAgJChlbCkucGFyZW50KCkuYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgJChlbCkuYXR0cignZGlzYWJsZWQnLCAnZGlzYWJsZWQnKTtcbiAgICAgICAgXG4gICAgICAgIHNlbGYuYW1BZGRSZXEoe1xuICAgICAgICAgIHR5cGUgIDogJ1BPU1QnLFxuICAgICAgICAgIHVybCAgIDogJy9lbmRwb2ludC9jdXN0b20tYWxlcnRzLz9fX2ZwX2VuZHBvaW50X2N1c3RvbV9hbGVydHM9MScsXG4gICAgICAgICAgZGF0YSAgOiBwYXlsb2FkLFxuXG4gICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgICAgICBpZiggcmVzLmhhc093blByb3BlcnR5KCdkYXRhJykgXG4gICAgICAgICAgICAgICAgJiYgcmVzLmRhdGEuaGFzT3duUHJvcGVydHkoJChlbCkuZGF0YSgndHlwZScpKSBcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICQoZWwpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgICAkKGVsKS5yZW1vdmVBdHRyKCdkaXNhYmxlZCcpO1xuICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAkKGVsKS5pcygnOmNoZWNrZWQnKSA/ICQoZWwpLnByb3AoICdjaGVja2VkJywgZmFsc2UgKSA6ICQoZWwpLnByb3AoICdjaGVja2VkJywgdHJ1ZSApO1xuICAgICAgICAgICAgICAgICAgfSwgMTAwKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgc2VsZi5lcnJvckhhbmRsZXIocmVzLCBlbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG5cbiAgICAgICAgICBlcnJvcjogZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgICAgICBzZWxmLmVycm9ySGFuZGxlcihyZXMsIGVsKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSxcblxuICAgICAgLyoqXG4gICAgICAgKiBAc3VtbWFyeSBDaGVja3Mgd2hldGhlciB0aGUgY3VycmVudCBlbWFpbCBhZGRyZXNzIGlzXG4gICAgICAgKiBzdWJzY3JpYmVkIHRvIHRoZSBjdXN0b20gYWxlcnRzIGxpc3QuXG4gICAgICAgKiBcbiAgICAgICAqIEBkZXNjcmlwdGlvbiBDaGVja3MgcG9zdHVwIGlmIHVzZXIgaXMgc3Vic2NyaWJlZCB0aGVuXG4gICAgICAgKiB1cGRhdGVzIHRoZSBkb20gd2l0aCB0aGUgcHJvcGVyIGNsYXNzZXMuXG4gICAgICAgKiBcbiAgICAgICAqIEBwYXJhbSB7Ym9vbH0gY2FsbGJhY2sgQ2FsbGJhY2sgZnVuY1xuICAgICAgICogXG4gICAgICAgKiBAcmV0dXJuICB7Ym9vbH0gVHJ1ZSBpZiBzdWJzY3JpYmVkLCBmYWxzZSBpZiBub3RcbiAgICAgICAqL1xuICAgICAgY2hlY2tTdWJzY3JpcHRpb246IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgICAgICB2YXIgcGF5bG9hZCAgPSB7XG4gICAgICAgICAgY3VzdG9tQWxlcnRzIDoge1xuICAgICAgICAgICAgZW1haWwgICA6IHNlbGYuZW1haWwsXG4gICAgICAgICAgICB1aWQgICAgIDogc2VsZi51aWQsXG4gICAgICAgICAgICBtZXRob2QgIDogJ2lzX3N1YnNjcmliZWQnLFxuICAgICAgICAgICAgd3Bub25jZSA6IGN1c3RvbUFsZXJ0c0xvY2FsLndwTm9uY2UgfHwgJycsXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgc2VsZi5hbUFkZFJlcSh7XG4gICAgICAgICAgdHlwZSAgOiAnUE9TVCcsXG4gICAgICAgICAgdXJsICAgOiAnL2VuZHBvaW50L2N1c3RvbS1hbGVydHMvP19fZnBfZW5kcG9pbnRfY3VzdG9tX2FsZXJ0cz0xJyxcbiAgICAgICAgICBkYXRhICA6IHBheWxvYWQsXG5cbiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihyZXMpIHtcbiAgICAgICAgICAgIGlmKCByZXMuaGFzT3duUHJvcGVydHkoJ2RhdGEnKSApIHtcbiAgICAgICAgICAgICAgc3dpdGNoIChyZXMuZGF0YSkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ25vcm1hbCcgOiAvLyBSZWd1bGFyIHVzZXJcbiAgICAgICAgICAgICAgICBjYXNlICdlcnJvcicgIDogLy8gTmV2ZXIgYWRkZWQgb24gdGhlIGxpc3RcbiAgICAgICAgICAgICAgICAgIHNlbGYud3JhcHBlcnMucmVtb3ZlQ2xhc3MoJ21lc3NhZ2UnKTtcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ3Vuc3ViJzogLy8gTmV2ZXIgc2lnbmVkIHVwXG4gICAgICAgICAgICAgICAgICBzZWxmLnNob3dBbGVydCgnRElTQUJMRUQnLCAnWW91IGhhdmUgb3B0ZWQgb3V0IG9mIHJlY2VpdmluZyBhbGwgbmV3cyBhbGVydHMuIFRvIGJlZ2luIHJlY2VpdmluZyBhbGVydHMgYW5kIG1hbmFnZSB5b3VyIHNldHRpbmdzLCAnLCAnYWxsJykubWFwKCBmdW5jdGlvbihib2R5KSB7XG4gICAgICAgICAgICAgICAgICAgIGJvZHkuc2libGluZ3MoJ2EnKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgYm9keS5hZnRlcihcbiAgICAgICAgICAgICAgICAgICAgICAkKCc8YSAvPicsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICd0ZXh0JyAgOiAnY2xpY2sgaGVyZS4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2hyZWYnICA6ICcjJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICdjbGFzcycgOiAnJ1xuICAgICAgICAgICAgICAgICAgICAgIH0pLmNsaWNrKGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykudGV4dCgncGxlYXNlIHdhaXQuLi4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubWFuYWdlU3Vic2NyaXB0aW9uKCdzdWJzY3JpYmUnLCBmdW5jdGlvbigpIHt9KVxuICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYoIHR5cGVvZiBjYWxsYmFjayAhPT0gJ3VuZGVmaW5lZCcgKVxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBzZWxmLmVycm9ySGFuZGxlcihyZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG5cbiAgICAgICAgICBlcnJvcjogZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgICAgICBzZWxmLmVycm9ySGFuZGxlcihyZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9LFxuXG4gICAgICAvKipcbiAgICAgICAqIEBzdW1tYXJ5IFN1YnNjcmliZS91bnN1YnNjcmliZSBhIHVzZXJcbiAgICAgICAqIFxuICAgICAgICogQGRlc2NyaXB0aW9uIFN1YnNjcmliZXMgb3IgdW5zdWJzY3JpYmVzIGEgdXNlciB0byB0aGUgXG4gICAgICAgKiBtYXN0ZXIgYWxlcnRzIGxpc3QgZGVmaW5lZCBpbiB0aGUgc2V0dGluZ3MuXG4gICAgICAgKiBcbiAgICAgICAqIEBwYXJhbSB7Ym9vbH0gYWN0aW9uIFRoZSBhY3Rpb24gdG8gcGVyZm9ybSAoc3Vic2NyaWJlL3Vuc3Vic2NyaWJlKVxuICAgICAgICogQHBhcmFtIHtib29sfSBjYWxsYmFjayBDYWxsYmFjayBmdW5jXG4gICAgICAgKiBcbiAgICAgICAqIEByZXR1cm4ge2Jvb2x9IFRydWUgaWYgc3VjY2VzcywgZmFsc2UgaWYgbm90XG4gICAgICAgKi9cbiAgICAgICBtYW5hZ2VTdWJzY3JpcHRpb246IGZ1bmN0aW9uKGFjdGlvbiwgY2FsbGJhY2spIHtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIHZhciBwYXlsb2FkICA9IHtcbiAgICAgICAgICBjdXN0b21BbGVydHMgOiB7XG4gICAgICAgICAgICBlbWFpbCAgIDogc2VsZi5lbWFpbCxcbiAgICAgICAgICAgIHVpZCAgICAgOiBzZWxmLnVpZCxcbiAgICAgICAgICAgIG1ldGhvZCAgOiBhY3Rpb24sXG4gICAgICAgICAgICB3cG5vbmNlIDogY3VzdG9tQWxlcnRzTG9jYWwud3BOb25jZSB8fCAnJyxcbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBzZWxmLmFtQWRkUmVxKHtcbiAgICAgICAgICB0eXBlICA6ICdQT1NUJyxcbiAgICAgICAgICB1cmwgICA6ICcvZW5kcG9pbnQvY3VzdG9tLWFsZXJ0cy8/X19mcF9lbmRwb2ludF9jdXN0b21fYWxlcnRzPTEnLFxuICAgICAgICAgIGRhdGEgIDogcGF5bG9hZCxcblxuICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHJlcykge1xuICAgICAgICAgICAgaWYoIHJlcy5oYXNPd25Qcm9wZXJ0eSgnZGF0YScpICkge1xuICAgICAgICAgICAgICBzZWxmLmNoZWNrU3Vic2NyaXB0aW9uKGNhbGxiYWNrKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNlbGYuZXJyb3JIYW5kbGVyKHJlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcblxuICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihyZXMpIHtcbiAgICAgICAgICAgIHNlbGYuZXJyb3JIYW5kbGVyKHJlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0sXG5cbiAgICAgIC8qKlxuICAgICAgICogQHN1bW1hcnkgQWpheCBlcnJvciBoYW5kbGVyXG4gICAgICAgKiBcbiAgICAgICAqIEBkZXNjcmlwdGlvbiBIYW5kbGVzIHRoZSB2YXJpb3VzIHR5cGVzIG9mIGVycm9ycyBzZW50IGJ5XG4gICAgICAgKiB0aGUgZW5kcG9pbnRcbiAgICAgICAqIFxuICAgICAgICogRXJyb3IgY29kZXMgYW5kIHRoZWlyIG1lc3NhZ2VzOlxuICAgICAgICogXG4gICAgICAgKiAxMDAgPT4gJ09vcHMhIFRoZXJlIHNlZW1zIHRvIGhhdmUgYmVlbiBhbiBlcnJvciBpbiByZXRyaWV2aW5nIHlvdXIgcHJvZmlsZSBhbmQgYWxlcnRzLiBQbGVhc2UgY29udGFjdCBzdXBwb3J0IGF0IHN1cHBvcnRAZm9yZWlnbnBvbGljeS5jb20uIFdlIGFwb2xvZ2l6ZSBmb3IgYW55IGluY29udmVuaWVuY2UuJywgLy8gRXJyb3IgcmV0cmlldmluZyB1c2VyIHByb2ZpbGUgZnJvbSBQb3N0VXAuXG5cdFx0XHQgKiAxMDIgPT4gJ0FuIGVycm9yIG9jY3VycmVkIHdoaWxlIGNvbW11bmljYXRpbmcgd2l0aCB0aGUgc2VydmVyLiBQbGVhc2UgdHJ5IGFnYWluIGluIGEgZmV3IG1pbnV0ZXMsIGlmIHRoaXMgZXJyb3IgcGVyc2lzdHMgcGxlYXNlIGNvbnRhY3Qgc3VwcG9ydCBhdCBzdXBwb3J0QGZvcmVpZ25wb2xpY3kuY29tJywgLy8gRXJyb3IgY29tbXVuaWNhdGluZyB3aXRoIFBvc3RVcCBzZXJ2ZXJzXG5cdFx0XHQgKiAxMDMgPT4gJ1RoZXJlIHdhcyBhbiBlcnJvciBpbiBjb25maWd1cmF0aW9uLCBwbGVhc2UgcmVwb3J0IHRvIHN1cHBvcnRAZm9yZWlnbnBvbGljeS5jb20uJywgLy8gUmFyZSBjYXNlIHdoZW4gYSB3cm9uZyB0eXBlIGlzIHN1cHBsaWVkIChhdXRob3IsIHRhZywgcmVnaW9uYWwgdGFnKVxuXHRcdFx0ICogMTA0ID0+ICdVc2VyIGlzIGFscmVhZHkgc3Vic2NyaWJlZC4nLCAvLyBNdWx0aXBsZSByZXF1ZXN0IHRvIHNhbWUgYWN0aW9uIG9yIGluY29ycmVjdCBpZFxuXHRcdFx0ICogMTA1ID0+ICdVc2VyIGlzIG5vdCBzdWJzY2liZWQuJywgLy8gTXVsdGlwbGUgcmVxdWVzdCB0byBzYW1lIGFjdGlvbiBvciBpbmNvcnJlY3QgaWRcblx0XHRcdCAqIDEwNiA9PiAnQSBzZXJpb3VzIGVycm9yIGhhcyBvY2N1cmVkLCBwbGVhc2UgcmVwb3J0IHRvIHN1cHBvcnRAZm9yZWlnbnBvbGljeS5jb20uJywgLy8gTWFsZm9ybWVkXG5cdFx0XHQgKiAxMDcgPT4gJ1JlcXVlc3Qgbm90IHZlcmlmaWVkLCByZXF1ZXN0IGhhcyBiZWVuIGxvZ2dlZC4nLCAvLyBNaXNzaW5nIG5vbmNlXG4gICAgICAgKiBcbiAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXMgVGhlIGFqYXggcmVzcG9uc2VcbiAgICAgICAqIEBwYXJhbSB7ZWxlbWVudH0gZWwgVGhlIGVsIGluIHF1ZXN0aW9uXG4gICAgICAgKlxuICAgICAgICogQHJldHVybiAge3ZvaWR9XG4gICAgICAgKi9cbiAgICAgIGVycm9ySGFuZGxlcjogZnVuY3Rpb24ocmVzLCBlbCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgaWYoIHJlcy5oYXNPd25Qcm9wZXJ0eSgnZGF0YScpIFxuICAgICAgICAgICYmIHJlcy5kYXRhLmhhc093blByb3BlcnR5KCdtZXNzYWdlJylcbiAgICAgICAgICAmJiByZXMuZGF0YS5oYXNPd25Qcm9wZXJ0eSgnY29kZScpXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBzd2l0Y2ggKHJlcy5kYXRhLmNvZGUpIHtcbiAgICAgICAgICAgICAgLy8gRGF0YSBicmVha2luZyBlcnJvcnMuXG4gICAgICAgICAgICAgIGNhc2UgMTAwOlxuICAgICAgICAgICAgICBjYXNlIDEwMTpcbiAgICAgICAgICAgICAgY2FzZSAxMDI6XG4gICAgICAgICAgICAgIGNhc2UgMTAzOlxuICAgICAgICAgICAgICBjYXNlIDEwNjpcbiAgICAgICAgICAgICAgY2FzZSAxMDk6XG4gICAgICAgICAgICAgIGNhc2UgMTEwOlxuICAgICAgICAgICAgICBjYXNlIDExMTpcbiAgICAgICAgICAgICAgY2FzZSAxMTI6XG4gICAgICAgICAgICAgICAgICAvLyBjYXNlIDEwNzogLy8gcmVtb3ZpbmcgZm9yIGFydGljbGUgZGlzcGxheXNcbiAgICAgICAgICAgICAgICAgIHNlbGYuc2hvd0FsZXJ0KCdFcnJvciEgJywgcmVzLmRhdGEubWVzc2FnZSwgJ2FsbCcpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgLy8gVXNlciBhbHJlYWR5IHN1YnNjcmliZWQvdW5zdWJzY3JpYmVkIGVycm9yc1xuICAgICAgICAgICAgICBjYXNlIDEwNDpcbiAgICAgICAgICAgICAgY2FzZSAxMDU6XG4gICAgICAgICAgICAgICAgICBpZiggZWwgIT09IHVuZGVmaW5lZCApIHtcbiAgICAgICAgICAgICAgICAgICAgJChlbCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgJChlbCkucmVtb3ZlQXR0cignZGlzYWJsZWQnKTtcbiAgXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgJChlbCkuaXMoJzpjaGVja2VkJykgPyAkKGVsKS5wcm9wKCAnY2hlY2tlZCcsIGZhbHNlICkgOiAkKGVsKS5wcm9wKCAnY2hlY2tlZCcsIHRydWUgKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgMTAwKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBVbmtub3duIEVycm9yXG4gICAgICAgICAgICBzZWxmLnNob3dBbGVydCggJ0Vycm9yIScsICdBbiB1bmtvd24gc2VyaW91cyBlcnJvciBoYXMgb2NjdXJlZCwgcGxlYXNlIHJlcG9ydCB0byBzdXBwb3J0QGZvcmVpZ25wb2xpY3kuY29tJywgJ2FsbCcgKTtcbiAgICAgICAgICB9XG4gICAgICB9LFxuXG4gICAgICAvKipcbiAgICAgICAqIEBzdW1tYXJ5IFNob3dzIGFuIGFsZXJ0IG1lc3NhZ2VcbiAgICAgICAqIFxuICAgICAgICogQGRlc2NyaXB0aW9uIFVwZGF0ZXMgdGhlIGFwcHJvcHJpYXRlIGFyZWFzIHdpdGhcbiAgICAgICAqIGEgaGVhZGxpbmUgJiBib2R5IHRleHQuIFJldHVybnMgdGhlIGJvZHkgZWwncyBcbiAgICAgICAqIGZvciB1c2UgbGF0ZXIuXG4gICAgICAgKiBcbiAgICAgICAqIEBwYXJhbSB7bWl4ZWR9IGhlYWRsaW5lIFRoZSBoZWFkbGluZSB0byBzaG93IHNpbmdsZSBzdHJpbmcgaWYgb25lIGFycmF5IGlmIG11bHRpcGxlXG4gICAgICAgKiBAcGFyYW0ge21peGVkfSBtZXNzYWdlIFRoZSBtZXNzYWdlIHRvIHNob3csIHNpbmdsZSBzdHJpbmcgaWYgb25lIGFycmF5IGlmIG11bHRpcGxlXG4gICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbG9jYXRpb24gV2hldGhlciBmb3IgdGFnIG9yIGF1dGhvciBvciBib3RoXG4gICAgICAgKlxuICAgICAgICogQHJldHVybiAge21peGVkfSBhcnJheSBvZiBvYmplY3RzIG9yIHNpbmdsZSBvYmplY3Qgb3IgZmFsc2VcbiAgICAgICAqL1xuICAgICAgc2hvd0FsZXJ0OiBmdW5jdGlvbihoZWFkbGluZSwgbWVzc2FnZSwgbG9jYXRpb24pIHtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIGlmKCBoZWFkbGluZS5sZW5ndGggPT09IDAgfHwgbWVzc2FnZS5sZW5ndGggPT09IDAgfHwgbG9jYXRpb24ubGVuZ3RoID09PSAwIClcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgc2VsZi53cmFwcGVycy5jc3MoeydkaXNwbGF5JzogJ2Jsb2NrJ30pO1xuICAgICAgICBzZWxmLndyYXBwZXJzLmFkZENsYXNzKCdtZXNzYWdlJyk7XG5cbiAgICAgICAgc3dpdGNoIChsb2NhdGlvbikge1xuICAgICAgICAgIGNhc2UgJ2FsbCc6XG4gICAgICAgICAgICBpZiggQXJyYXkuaXNBcnJheShoZWFkbGluZSkgKSB7XG4gICAgICAgICAgICAgIHNlbGYuYXV0aG9ySGVhZGxpbmUudGV4dChoZWFkbGluZVswXSk7XG4gICAgICAgICAgICAgIHNlbGYuYXV0aG9yQm9keS50ZXh0KG1lc3NhZ2VbMF0pO1xuICAgICAgICAgICAgICBzZWxmLnRhZ0hlYWRsaW5lLnRleHQoaGVhZGxpbmVbMV0pO1xuICAgICAgICAgICAgICBzZWxmLnRhZ0JvZHkudGV4dChtZXNzYWdlWzFdKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHNlbGYuYXV0aG9ySGVhZGxpbmUudGV4dChoZWFkbGluZSk7XG4gICAgICAgICAgICAgIHNlbGYuYXV0aG9yQm9keS50ZXh0KG1lc3NhZ2UpO1xuICAgICAgICAgICAgICBzZWxmLnRhZ0hlYWRsaW5lLnRleHQoaGVhZGxpbmUpO1xuICAgICAgICAgICAgICBzZWxmLnRhZ0JvZHkudGV4dChtZXNzYWdlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFtzZWxmLmF1dGhvckJvZHksIHNlbGYudGFnQm9keV07XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdhdXRob3InOlxuICAgICAgICAgICAgc2VsZi5hdXRob3JIZWFkbGluZS50ZXh0KGhlYWRsaW5lKTtcbiAgICAgICAgICAgIHNlbGYuYXV0aG9yQm9keS50ZXh0KG1lc3NhZ2UpO1xuXG4gICAgICAgICAgICByZXR1cm4gc2VsZi5hdXRob3JCb2R5O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAndGFnJzpcbiAgICAgICAgICAgIHNlbGYudGFnSGVhZGxpbmUudGV4dChoZWFkbGluZSk7XG4gICAgICAgICAgICBzZWxmLnRhZ0JvZHkudGV4dChtZXNzYWdlKTtcblxuICAgICAgICAgICAgcmV0dXJuIHNlbGYudGFnQm9keTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSxcblxuICAgICAgLyoqXG4gICAgICAgKiBAc3VtbWFyeSBBZGRzIGFuIGFqYXggcmVxdWVzdCB0byB0aGUgcXVldWVcbiAgICAgICAqIFxuICAgICAgICogQGRlc2NyaXB0aW9uIEFkZHMgYW4gYWpheCByZXF1ZXN0IHRvIHRoZSBhamF4IG1hbmFnZXJcbiAgICAgICAqIHF1ZXVlIHRvIGJlIHByb2Nlc3NlZC5cbiAgICAgICAqIFxuICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdCBUaGUgYWpheCBvcHRpb25zL2NvbmZpZ3VyYXRpb25zXG4gICAgICAgKlxuICAgICAgICogQHJldHVybiAge3ZvaWR9XG4gICAgICAgKi9cbiAgICAgIGFtQWRkUmVxOiBmdW5jdGlvbihvcHQpIHtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIHNlbGYucmVxdWVzdHMucHVzaChvcHQpO1xuICAgICAgfSxcbiAgICAgIFxuICAgICAgLyoqXG4gICAgICAgKiBAc3VtbWFyeSBSZW1vdmVzIGEgcmVxdWVzdCBmcm9tIHRoZSBxdWV1ZVxuICAgICAgICogXG4gICAgICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlcyBhbiBhamF4IGNvbmZpZ3VyYXRpb25zIG9iamVjdC9yZXF1ZXN0XG4gICAgICAgKiBmcm9tIHRoZSBhamF4IG1hbmFnZXIgcXVldWUuXG4gICAgICAgKiBcbiAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHQgVGhlIGFqYXggb3B0aW9ucy9jb25maWd1cmF0aW9uc1xuICAgICAgICpcbiAgICAgICAqIEByZXR1cm4gIHt2b2lkfVxuICAgICAgICovXG4gICAgICBhbVJlbW92ZVJlcTogZnVuY3Rpb24ob3B0KSB7XG4gICAgICAgIGlmKCAkLmluQXJyYXkob3B0LCBzZWxmLnJlcXVlc3RzKSA+IC0xICkge1xuICAgICAgICAgIHNlbGYucmVxdWVzdHMuc3BsaWNlKCQuaW5BcnJheShvcHQsIHNlbGYucmVxdWVzdHMpLCAxKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIFxuICAgICAgLyoqXG4gICAgICAgKiBAc3VtbWFyeSBJbml0aWFsaXplcyB0aGUgYWpheCBtYW5hZ2VyXG4gICAgICAgKiBcbiAgICAgICAqIEBkZXNjcmlwdGlvbiBBIHJ1bm5pbmcgbWFuYWdlciB0byBtYWludGFpbiBhbmQgcnVuXG4gICAgICAgKiBjb25zZWN1dGl2ZSBhamF4IHJlcXVlc3RzLiBUaGUgbWFuYWdlciBjaGVja3MgZm9yIFxuICAgICAgICogbmV3IHJlcXVlc3RzIGV2ZXJ5IHNlY29uZC5cbiAgICAgICAqIFxuICAgICAgICogQHJldHVybiAge3ZvaWR9XG4gICAgICAgKi9cbiAgICAgIGFtUnVuOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzLCBvcmlTdWM7XG5cbiAgICAgICAgaWYoIHNlbGYucmVxdWVzdHMubGVuZ3RoICkge1xuICAgICAgICAgICAgb3JpU3VjID0gc2VsZi5yZXF1ZXN0c1swXS5jb21wbGV0ZTtcblxuICAgICAgICAgICAgc2VsZi5yZXF1ZXN0c1swXS5jb21wbGV0ZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICBpZiggdHlwZW9mKG9yaVN1YykgPT09ICdmdW5jdGlvbicgKSBvcmlTdWMoKTtcbiAgICAgICAgICAgICAgICBzZWxmLnJlcXVlc3RzLnNoaWZ0KCk7XG4gICAgICAgICAgICAgICAgc2VsZi5hbVJ1bi5hcHBseShzZWxmLCBbXSk7XG4gICAgICAgICAgICB9OyAgIFxuXG4gICAgICAgICAgICAkLmFqYXgoc2VsZi5yZXF1ZXN0c1swXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2VsZi50aWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgc2VsZi5hbVJ1bi5hcHBseShzZWxmLCBbXSk7XG4gICAgICAgICAgfSwgMTAwMCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG5cbiAgICAgIC8qKlxuICAgICAgICogQHN1bW1hcnkgU3RvcHMgdGhlIGFqYXhNYW5hZ2VyXG4gICAgICAgKiBcbiAgICAgICAqIEByZXR1cm4gIHt2b2lkfVxuICAgICAgICovXG4gICAgICBhbVN0b3A6IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgc2VsZi5yZXF1ZXN0cyA9IFtdO1xuICAgICAgICBjbGVhclRpbWVvdXQoc2VsZi50aWQpO1xuICAgICAgfSxcblxuICAgICAgLyoqXG4gICAgICAgKiBAc3VtbWFyeSBHZW5lcmFsIHByb3BlcnR5IGV4aXN0cyBoZWxwZXIgZnVuY3Rpb24gXG4gICAgICAgKiBcbiAgICAgICAqIEBkZXNjcmlwdGlvbiBVdGlsaXR5IGZ1bmN0aW9uIHVzZWQgdG8gY2hlY2sgZm9yXG4gICAgICAgKiBuZXN0ZWQgbGV2ZWxzIG9mIHByb3Blcml0ZXMgb3IgdmFycy5cbiAgICAgICAqXG4gICAgICAgKiBAcGFyYW0gICB7b2JqfSAgICAgb2JqIFRoZSBvYmplY3QgdG8gY2hlY2tcbiAgICAgICAqIEBwYXJhbSAgIHtzdHJpbmd9ICAuLi4gVW5saW1pdGVkIG51bWJlciBvZiBsZXZlbHMgdG8gY2hlY2tcbiAgICAgICAqIFxuICAgICAgICogQHJldHVybiAge2Jvb2x9ICAgICAgICBJZiB0aGUgcHJvcGVydHkgd2FzIGZvdW5kIG9yIG5vdFxuICAgICAgICovXG4gICAgICBwcm9wZXJ0eUV4aXN0czogZnVuY3Rpb24ob2JqIC8qLCBsZXZlbDEsIGxldmVsMiwgLi4uIGxldmVsTiovKSB7ICAgICAgICBcbiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpO1xuICAgICAgXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGlmICghb2JqIHx8ICFvYmouaGFzT3duUHJvcGVydHkoYXJnc1tpXSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgb2JqID0gb2JqW2FyZ3NbaV1dO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdmFyIGNoZWNrTWF4ID0gMFxuICAgIHZhciBpc1JlYWR5ICA9IHNldEludGVydmFsKCBmdW5jdGlvbigpIHtcbiAgICAgIGlmICggd2luZG93LnBpYW5vUmVhZHkgIT09IHVuZGVmaW5lZCAmJiB3aW5kb3cucGlhbm9SZWFkeSApXG4gICAgICAgIChjdXN0b21BbGVydHMuaW5pdCgpLCBjbGVhckludGVydmFsKCBpc1JlYWR5ICkpO1xuXG4gICAgICBpZiAoIGNoZWNrTWF4ID49IDQ1IClcbiAgICAgICAgY2xlYXJJbnRlcnZhbCggaXNSZWFkeSApO1xuICAgIH0sIDMwMCk7XG4gIH0pO1xuXG59KGpRdWVyeSk7XG5cbiJdfQ==;
!function($){

  var _siteHeader = $( '.site-header' );

  var _hamburgerButton = $( '.hamburger-button' );

  var _headerNavWrapper = $( '.header-nav-wrapper' );

  var _headerNavParent = $( '.-parent' );
  
  var _headerNavParentLink = $( '.-parent > a' );

  var _headerNav = $( '.header-nav-main > .header-menu > li' );
  var _headerNavAlt = $( '.chinadaily-feed .header-menu > li' );

  var _headerNavNestedMenu = $( '.header-nav-main > .header-menu .header-menu' );
  
  var _headerSubNavWrapper = $( '.header-subnav-wrapper' );/* (user welcome message, sign in/manage link, search icon) */

  var _closeNav = $( '.close-nav' );/* "Close X" button for main nav items */


  function isMobileScreen() {
    if($( window ).width() > 979) return false;
    return true;
  }

  function isHeaderAltLayout() {
    return _siteHeader.hasClass('header-alt-layout');
  }


  function mobileNav() {
    _hamburgerButton.on( 'click', function() {
      /* set elements that should not be allowed to scroll while hamburger nav is open */
      var _elsNoScroll = $('.post-content, .grid--container');
      /* nav is currently open */
      if(_headerNavWrapper.is(':visible')) {
        /* hide nav */
        _headerNavWrapper.hide();
        /* update hamburger button to three horizontal lines */
        _hamburgerButton.removeClass('mobile-nav-open');
        /* hide header subnav */
        $('.header-subnav-wrapper').show();
        /* remove open class from open parents */
        $('.header-menu-item').removeClass('open');
        /* hide any open nested lists */
        _headerNavNestedMenu.hide();
        /* show all main level nav */
        _headerNav.removeAttr('style');
        _headerNavAlt.removeAttr('style');
        /* hide option to close nested children */
        _closeNav.hide();
        /* Enable scrolling */
        $('body').removeClass('overlay-no-scroll');
        _elsNoScroll.removeClass('overlay-no-scroll').attr('style','');
        _elsNoScroll.unbind('touchmove');
      /* nav is not currently open */
      } else {
        /* show nav */
        _headerNavWrapper.show();
        /* update hamburger button to "X" */
        _hamburgerButton.addClass('mobile-nav-open');
        /* hide header subnav */
        $('.header-subnav-wrapper').hide();
        /* Disable scrolling */
        $('body').addClass('overlay-no-scroll').attr('style','');
        _elsNoScroll.addClass('overlay-no-scroll');/* TO-DO - explore this solution to prohibit scrolling - .attr('style','height:0');*/
        _elsNoScroll.on("touchmove", function(e) {
          e.preventDefault();
        });
      }

    });

    _headerNavParentLink.on( 'click', function() {
      /* this code should not be run if not on mobile and if alternate condensed/mobile layout is not in place */
      if(!isMobileScreen() && !isHeaderAltLayout()) return false;
      /* get <li> parent of <a> element clicked */
      var _this = $(this).parent();
      /* hide all other main level nav items */
      _headerNav.not(_this).fadeTo(100, 0, function(){
        $(this).fadeOut(1, function(){
          $(this).hide();
        });
      });
      setTimeout( function(){ 
        /* add class to clicked element */
        _this.addClass('open');
        /* toggle display of child <ul> element */
        _this.children('ul').fadeIn();
        /* show close nav button */
        _closeNav.css('display','block');
      }, 110);
    });

  }
  mobileNav();


  function desktopNav() {
    /* toggle display of nested nav when parent is clicked */ 
    _headerNavParentLink.on( 'click', function() {
      /* this code should not be run if on mobile or if the alternate condensed/mobile layout is in place */
      if(isMobileScreen() || isHeaderAltLayout()) return false;
      /* set variables for use below */ 
      var _this = $(this).parent();
      var _offset = _this.offset();
      var _leftOffset = _offset.left - ( parseInt($('.logo').outerWidth()) + parseInt(_siteHeader.css('padding-left')) );
      /* add class to clicked element */
      _this.addClass('open');
      /* hide all other main level nav items */
      _headerNav.not('.open').fadeTo(100, 0, function(){
        $(this).fadeOut(1, function(){
          /* retain left position before animating */ 
          _this.css({
            'margin-left': _leftOffset
          });
          /* animate left position to 0 */
          _this.animate({
            'margin-left': 0 
          }, 200, function(){
            /* show nested children of clicked nav item */
            _this.children('ul').fadeIn();
            /* show option to close nested children */
            _closeNav.css('display','block');
          });
        });
      });

    });

    /* close nested nav children */
    _closeNav.on( 'click touchstart', function(){
      /* get open nav parent */ 
      var _open = $( '.open' );
      /* hide option to close nested children */
      _closeNav.hide();
      /* hide open nav item */
      _open.fadeOut(200, function(){
        /* hide nested nav uls */
        _headerNav.children('ul').hide();
        /* hide open nav parent */
        _open.removeClass('open').removeAttr('style').css('opacity','0');
        /* show main nav */
        _headerNav.removeAttr('style').fadeTo(200, 1);
        _headerNavAlt.removeAttr('style').fadeTo(200, 1);
      });
    });

  }
  desktopNav();


  /* hide nav when sign in is clicked to avoid z-index conflict */
  $('.header-mobile-subnav .FP-paywall--login').click(function() {
    _hamburgerButton.trigger('click');
  });


  /* handle nav display changes when window is resized */
  $( window ).resize(function() {
    /* check for any parent nav items that are open */
    var navItemIsOpen = $('.-parent.open').length;
    /* enable scrolling */
    $('body').removeClass('overlay-no-scroll');
    /* manage inline styles and display settings for screen specific nav */
    /* check if user on mobile */
    if(isMobileScreen() || FP.Config.context.is_chinadaily) {
      /* hide close button */
      if(navItemIsOpen < 0) _closeNav.hide();
      /* show subnav */
      _headerSubNavWrapper.removeAttr('style').show();
      /* ensure all main level nav items display */
      _headerNav.css({'opacity':'1'});
      /* set delay, set hamburger to "close" state if it is open */
      setTimeout( function(){ 
        if(_headerNavWrapper.is(':visible')) _hamburgerButton.addClass('mobile-nav-open'); 
      }, 250);
      /* hide nav if hamburger is closed */
      if(!_hamburgerButton.hasClass('mobile-nav-open')) _headerNavWrapper.hide();
    /* user is on desktop */
    } else {
      /* remove inline styles from nested menu items to ensure they display correctly for desktop */
      $('.header-nav > .header-menu .header-menu-item .header-menu-item').removeAttr('style');
      /* parent nav items are open */
      if(navItemIsOpen > 0) {
        /* if header is not using the condensed mobile/alternate layout */
        if( !_siteHeader.hasClass('header-alt-layout') ) {
          /* hide main level menu items that are not toggled open */
          _headerNav.not('.open').css('opacity','0').hide();
          /* show nested menu items of main level menu item that is open 
          $('.header-nav > .header-menu .header-menu-item.open .header-menu-item').css({'opacity':'1', 'display':'inline-block'}); */
        }
        /* show close button */
        _closeNav.css('display','block');
        /* hide subnav */
        _headerSubNavWrapper.removeAttr('style').hide();
      /* parent nav items are not open */
      } else {
        /* parent nav items are open */
        _headerNav.removeAttr('style');
        /* hide close button */
        _closeNav.hide();
        /* show subnav  */
        _headerSubNavWrapper.removeAttr('style').show();
      }
      
      if( !_siteHeader.hasClass('header-alt-layout') ) _headerNavWrapper.show();
    }
  });


  $( window ).scroll(function() {
    /* user is not at top of page */
    if( $( window ).scrollTop() > 0 ){
      /* apply condensed mobile/alternate layout to header */
      _siteHeader.addClass('header-alt-layout');
      /* ensure all first level nav items are set to display */
      _headerNav.removeAttr('style').removeClass('open');
      /* hide open nested lists */
      _headerNavNestedMenu.hide();
      /* hide close button */
      _closeNav.hide();
    /* user is at top of page */
    } else {
      if(!_headerNavWrapper.is(':visible')) {
        /* remove condensed mobile/alternate layout from header */
        _siteHeader.removeClass('header-alt-layout');
        if(!FP.Config.context.is_chinadaily) {
          _headerNavWrapper.removeAttr('style');
          /* show subnav */
          _headerSubNavWrapper.removeAttr('style').show();
        }
      }
    }
  });

}(jQuery);
;
function external_links_in_new_windows_loop() {
	var parent = '';
	var change_link = false;
	if ( $( 'article' ).length ) {
		parent = $( 'article' );
	}
	if ( $( '.wide_copy' ).length ) {
		parent = $( '.wide_copy' );
	}
	if ( parent != '' ) {
		parent.find('a').each(function() {
			change_link = false;
			if ( $( this ).attr( 'onClick' ) == undefined ) {
				// forced if the address starts with http (or also https), but does not link to the current domain
				if ( $( this ).prop( 'href' ).indexOf( 'http' ) != -1 && $( this ).prop( 'href' ).indexOf( 'foreignpolicy.test' ) == -1  && $( this ).prop( 'href' ).indexOf( 'foreignpolicy.com' ) == -1 && $( this ).prop( 'href' ).indexOf( 'go-vip.net' ) == -1 && $( this ).prop( 'href' ).indexOf( 'fp.local' ) == -1 ) {
					change_link = true;
				}
				if( change_link == true ) {
					$( this ).attr( 'onClick', 'javascript:window.open(\''+$( this ).prop( 'href' )+'\'); return false;' );
					$( this ).attr( 'target', '' );
				}
			}
		});
	}
}
// Load
function external_links_in_new_windows_load(func)
{	
	var oldonload = window.onload;
	if ( typeof window.onload != 'function' ){
		window.onload = func;
	} else {
		window.onload = function(){
			oldonload();
			func();
		}
	}
}

external_links_in_new_windows_load(external_links_in_new_windows_loop);
;
/**
 * JS helpers for image handling
 */
! function( $ ) {
	$( '.image-attachment .image' ).on( 'load', function( e ) {
		// Remove the ::before preload animation on article images, since they incur 
 		// * a performance penalty and are no longer needed after the image loads.
		$( e.target ).parent().addClass( 'image-loaded' );
	} );

	// Hack to stop Jetpack lazy loading alert() when printing
	function removeUnloadedImagesBeforePrint() {
		// Watch for attempts to print, and remove all unloaded lazy images. 
		// Most browsers support beforeprint, Safari needs a media listener. 
		// Will double-fire if a browser supports both.
		window.addEventListener( 'beforeprint', onPrint );
		if ( window.matchMedia ) {
			window.matchMedia( 'print' ).addListener( function ( mql ) {
				if ( mql.matches ) {
					onPrint();
				}
			} );
		}

		function onPrint() {
			// Remove this for now as it removed unloaded images after the user chose to print the page
			// $( 'img.jetpack-lazy-image:not(.jetpack-lazy-image--handled)' ).remove();

			// Reassign window.alert() to stop the 'Images are still loading...'
			// Jetpack lazy loading alert from firing since images are hidden from print with CSS
			window.alert = function() {};
		}
	}
	removeUnloadedImagesBeforePrint();
}( jQuery );
;
( function( $ ){
	jQuery( document ).ready( function() {
		// Lets remove the no-js class from html - testing if js is enabled
		$( 'html' ).removeClass( 'no-js' );

		// Stop default behavior on specific links
		$( 'a.no-link' ).on( 'click', function( e ){
			e.preventDefault();
		});

		// Track specific link clicks that have "track-download" class
		// e.g. <a href="/files/test.pdf" class="track-download">link text</a>
		$( 'a.track-download' ).on( 'click', function( e ){
			var url_string = $(this).attr('href');
			if(typeof url_string !== typeof undefined && url_string !== false) {
				var url_array = url_string.split('/');
				dataLayer.push({
					'event':'dl_event',
					'event_category':'download',
					'event_action':'click',
					'event_label':url_array[ url_array.length - 1 ],
					'event_value':''
				});
			}
		});

		// Handle fluid video resizing for YouTube and Vimeo
		var $allVideos = $(".post-content iframe[src^='//player.vimeo.com'], .post-content iframe[src^='http://www.youtube.com']");

		// Figure out and save aspect ratio for each video and remove the hardcoded width and height
		$allVideos.each(function() {
			$(this)
			.data('aspectRatio', this.height / this.width)
			.removeAttr('height')
			.removeAttr('width');
		});

		// When the window is resized, resize videos
		$(window).resize(function() {
			var newWidth = $('body').width();
			if ( newWidth > 1180 )
				newWidth = 700;
			else if ( newWidth >= 925 && newWidth <= 1180 )
				newWidth = 530;
			else if ( newWidth < 925 && newWidth > 768 )
				newWidth = 670;
			else
				newWidth = newWidth - 10;
			// Resize all videos according to their own aspect ratio
			$allVideos.each(function() {
				var $el = $(this);
				$el
				  .width(newWidth)
				  .height(newWidth * $el.data('aspectRatio'));
			});
		}).resize();

		// Function to go through each iframe and set a width and height which is called below
		function fpResponsiveIframes( target ) {
			var parentWidth = target.parent().width();
			var iframeHeigh = parentWidth * 0.56;
			target.attr( 'width', parentWidth ).attr( 'height', iframeHeigh );
		}

		// This will fire on load
		$( '.single article > p iframe' ).each( function() {
			fpResponsiveIframes( $( this ) );
		});

		// This will fire on window resize
		$( window ).resize( function() {
			$( '.single article > p iframe' ).each( function() {
				fpResponsiveIframes( $( this ) );
			});
		});
		// end iframe sizing

		/**
		 * Printing hack to accommodate `window.print` conflicting
		 * with Livefyre's long-polling. So far this has only been
		 * spotted in WebKit - hence the browser sniffing
		 */
		$(document).on('click', '.print', function(){
			// class handling for printing only the article intended
			var noPrintClassname = 'js-no-print';
			var postContent = $('.post-content').addClass(noPrintClassname);
			$(this).closest('.post-content').removeClass(noPrintClassname);

			// if webkit (namely safari), we want to avoid the print
			// dialog delay caused by conflicts with ajax requests
			if ($.browser.webkit) {
				// no livefyre widget, so use reload workaround to kill
				// requests and prompt dialog before actual reload (bad
				// experience)
				if (undefined === window.livefyreWidgets) {
					window.print();
					window.location.reload();
					return;
				}
			}

			window.print();
			postContent.removeClass(noPrintClassname);
		});

	} );
	$(document).bind('wapoLogout', function(){
	  //Clearing olivesoftware cookie to log out of archives
	  var url = 'https://digital.olivesoftware.com/Olive/APA/ForeignPolicy/logout.html';
	  $('<iframe>', {
   		  src: url,
   		  id:  'oliveFrame',
   		  frameborder: 0,
   		  scrolling: 'no',
   		  width: 0,
   		  height: 0
   	  }).appendTo('body');
   	  setTimeout(function() {
        $('#oliveFrame').remove();
      }, 2000);
	});
})( jQuery );;
"use strict";

/*! cash-dom 1.3.5, https://github.com/kenwheeler/cash @license MIT */
;(function (root, factory) {
  if (typeof define === "function" && define.amd) {
    define(factory);
  } else if (typeof exports !== "undefined") {
    module.exports = factory();
  } else {
    root.cash = root.$ = factory();
  }
})(this, function () {
  var doc = document, win = window, ArrayProto = Array.prototype, slice = ArrayProto.slice, filter = ArrayProto.filter, push = ArrayProto.push;

  var noop = function () {}, isFunction = function (item) {
    // @see https://crbug.com/568448
    return typeof item === typeof noop && item.call;
  }, isString = function (item) {
    return typeof item === typeof "";
  };

  var idMatch = /^#[\w-]*$/, classMatch = /^\.[\w-]*$/, htmlMatch = /<.+>/, singlet = /^\w+$/;

  function find(selector, context) {
    context = context || doc;
    var elems = (classMatch.test(selector) ? context.getElementsByClassName(selector.slice(1)) : singlet.test(selector) ? context.getElementsByTagName(selector) : context.querySelectorAll(selector));
    return elems;
  }

  var frag;
  function parseHTML(str) {
    if (!frag) {
      frag = doc.implementation.createHTMLDocument();
      var base = frag.createElement("base");
      base.href = doc.location.href;
      frag.head.appendChild(base);
    }

    frag.body.innerHTML = str;

    return frag.body.childNodes;
  }

  function onReady(fn) {
    if (doc.readyState !== "loading") {
      fn();
    } else {
      doc.addEventListener("DOMContentLoaded", fn);
    }
  }

  function Init(selector, context) {
    if (!selector) {
      return this;
    }

    // If already a cash collection, don't do any further processing
    if (selector.cash && selector !== win) {
      return selector;
    }

    var elems = selector, i = 0, length;

    if (isString(selector)) {
      elems = (idMatch.test(selector) ?
      // If an ID use the faster getElementById check
      doc.getElementById(selector.slice(1)) : htmlMatch.test(selector) ?
      // If HTML, parse it into real elements
      parseHTML(selector) :
      // else use `find`
      find(selector, context));

      // If function, use as shortcut for DOM ready
    } else if (isFunction(selector)) {
      onReady(selector);return this;
    }

    if (!elems) {
      return this;
    }

    // If a single DOM element is passed in or received via ID, return the single element
    if (elems.nodeType || elems === win) {
      this[0] = elems;
      this.length = 1;
    } else {
      // Treat like an array and loop through each item.
      length = this.length = elems.length;
      for (; i < length; i++) {
        this[i] = elems[i];
      }
    }

    return this;
  }

  function cash(selector, context) {
    return new Init(selector, context);
  }

  var fn = cash.fn = cash.prototype = Init.prototype = { // jshint ignore:line
    cash: true,
    length: 0,
    push: push,
    splice: ArrayProto.splice,
    map: ArrayProto.map,
    init: Init
  };

  Object.defineProperty(fn, "constructor", { value: cash });

  cash.parseHTML = parseHTML;
  cash.noop = noop;
  cash.isFunction = isFunction;
  cash.isString = isString;

  cash.extend = fn.extend = function (target) {
    target = target || {};

    var args = slice.call(arguments), length = args.length, i = 1;

    if (args.length === 1) {
      target = this;
      i = 0;
    }

    for (; i < length; i++) {
      if (!args[i]) {
        continue;
      }
      for (var key in args[i]) {
        if (args[i].hasOwnProperty(key)) {
          target[key] = args[i][key];
        }
      }
    }

    return target;
  };

  function each(collection, callback) {
    var l = collection.length, i = 0;

    for (; i < l; i++) {
      if (callback.call(collection[i], collection[i], i, collection) === false) {
        break;
      }
    }
  }

  function matches(el, selector) {
    var m = el && (el.matches || el.webkitMatchesSelector || el.mozMatchesSelector || el.msMatchesSelector || el.oMatchesSelector);
    return !!m && m.call(el, selector);
  }

  function getCompareFunction(selector) {
    return (
    /* Use browser's `matches` function if string */
    isString(selector) ? matches :
    /* Match a cash element */
    selector.cash ? function (el) {
      return selector.is(el);
    } :
    /* Direct comparison */
    function (el, selector) {
      return el === selector;
    });
  }

  function unique(collection) {
    return cash(slice.call(collection).filter(function (item, index, self) {
      return self.indexOf(item) === index;
    }));
  }

  cash.extend({
    merge: function (first, second) {
      var len = +second.length, i = first.length, j = 0;

      for (; j < len; i++, j++) {
        first[i] = second[j];
      }

      first.length = i;
      return first;
    },

    each: each,
    matches: matches,
    unique: unique,
    isArray: Array.isArray,
    isNumeric: function (n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    }

  });

  var uid = cash.uid = "_cash" + Date.now();

  function getDataCache(node) {
    return (node[uid] = node[uid] || {});
  }

  function setData(node, key, value) {
    return (getDataCache(node)[key] = value);
  }

  function getData(node, key) {
    var c = getDataCache(node);
    if (c[key] === undefined) {
      c[key] = node.dataset ? node.dataset[key] : cash(node).attr("data-" + key);
    }
    return c[key];
  }

  function removeData(node, key) {
    var c = getDataCache(node);
    if (c) {
      delete c[key];
    } else if (node.dataset) {
      delete node.dataset[key];
    } else {
      cash(node).removeAttr("data-" + name);
    }
  }

  fn.extend({
    data: function (name, value) {
      if (isString(name)) {
        return (value === undefined ? getData(this[0], name) : this.each(function (v) {
          return setData(v, name, value);
        }));
      }

      for (var key in name) {
        this.data(key, name[key]);
      }

      return this;
    },

    removeData: function (key) {
      return this.each(function (v) {
        return removeData(v, key);
      });
    }

  });

  var notWhiteMatch = /\S+/g;

  function getClasses(c) {
    return isString(c) && c.match(notWhiteMatch);
  }

  function hasClass(v, c) {
    return (v.classList ? v.classList.contains(c) : new RegExp("(^| )" + c + "( |$)", "gi").test(v.className));
  }

  function addClass(v, c, spacedName) {
    if (v.classList) {
      v.classList.add(c);
    } else if (spacedName.indexOf(" " + c + " ")) {
      v.className += " " + c;
    }
  }

  function removeClass(v, c) {
    if (v.classList) {
      v.classList.remove(c);
    } else {
      v.className = v.className.replace(c, "");
    }
  }

  fn.extend({
    addClass: function (c) {
      var classes = getClasses(c);

      return (classes ? this.each(function (v) {
        var spacedName = " " + v.className + " ";
        each(classes, function (c) {
          addClass(v, c, spacedName);
        });
      }) : this);
    },

    attr: function (name, value) {
      if (!name) {
        return undefined;
      }

      if (isString(name)) {
        if (value === undefined) {
          return this[0] ? this[0].getAttribute ? this[0].getAttribute(name) : this[0][name] : undefined;
        }

        return this.each(function (v) {
          if (v.setAttribute) {
            v.setAttribute(name, value);
          } else {
            v[name] = value;
          }
        });
      }

      for (var key in name) {
        this.attr(key, name[key]);
      }

      return this;
    },

    hasClass: function (c) {
      var check = false, classes = getClasses(c);
      if (classes && classes.length) {
        this.each(function (v) {
          check = hasClass(v, classes[0]);
          return !check;
        });
      }
      return check;
    },

    prop: function (name, value) {
      if (isString(name)) {
        return (value === undefined ? this[0][name] : this.each(function (v) {
          v[name] = value;
        }));
      }

      for (var key in name) {
        this.prop(key, name[key]);
      }

      return this;
    },

    removeAttr: function (name) {
      return this.each(function (v) {
        if (v.removeAttribute) {
          v.removeAttribute(name);
        } else {
          delete v[name];
        }
      });
    },

    removeClass: function (c) {
      if (!arguments.length) {
        return this.attr("class", "");
      }
      var classes = getClasses(c);
      return (classes ? this.each(function (v) {
        each(classes, function (c) {
          removeClass(v, c);
        });
      }) : this);
    },

    removeProp: function (name) {
      return this.each(function (v) {
        delete v[name];
      });
    },

    toggleClass: function (c, state) {
      if (state !== undefined) {
        return this[state ? "addClass" : "removeClass"](c);
      }
      var classes = getClasses(c);
      return (classes ? this.each(function (v) {
        var spacedName = " " + v.className + " ";
        each(classes, function (c) {
          if (hasClass(v, c)) {
            removeClass(v, c);
          } else {
            addClass(v, c, spacedName);
          }
        });
      }) : this);
    } });

  fn.extend({
    add: function (selector, context) {
      return unique(cash.merge(this, cash(selector, context)));
    },

    each: function (callback) {
      each(this, callback);
      return this;
    },

    eq: function (index) {
      return cash(this.get(index));
    },

    filter: function (selector) {
      if (!selector) {
        return this;
      }

      var comparator = (isFunction(selector) ? selector : getCompareFunction(selector));

      return cash(filter.call(this, function (e) {
        return comparator(e, selector);
      }));
    },

    first: function () {
      return this.eq(0);
    },

    get: function (index) {
      if (index === undefined) {
        return slice.call(this);
      }
      return (index < 0 ? this[index + this.length] : this[index]);
    },

    index: function (elem) {
      var child = elem ? cash(elem)[0] : this[0], collection = elem ? this : cash(child).parent().children();
      return slice.call(collection).indexOf(child);
    },

    last: function () {
      return this.eq(-1);
    }

  });

  var camelCase = (function () {
    var camelRegex = /(?:^\w|[A-Z]|\b\w)/g, whiteSpace = /[\s-_]+/g;
    return function (str) {
      return str.replace(camelRegex, function (letter, index) {
        return letter[index === 0 ? "toLowerCase" : "toUpperCase"]();
      }).replace(whiteSpace, "");
    };
  }());

  var getPrefixedProp = (function () {
    var cache = {}, doc = document, div = doc.createElement("div"), style = div.style;

    return function (prop) {
      prop = camelCase(prop);
      if (cache[prop]) {
        return cache[prop];
      }

      var ucProp = prop.charAt(0).toUpperCase() + prop.slice(1), prefixes = ["webkit", "moz", "ms", "o"], props = (prop + " " + (prefixes).join(ucProp + " ") + ucProp).split(" ");

      each(props, function (p) {
        if (p in style) {
          cache[p] = prop = cache[prop] = p;
          return false;
        }
      });

      return cache[prop];
    };
  }());

  cash.prefixedProp = getPrefixedProp;
  cash.camelCase = camelCase;

  fn.extend({
    css: function (prop, value) {
      if (isString(prop)) {
        prop = getPrefixedProp(prop);
        return (arguments.length > 1 ? this.each(function (v) {
          return v.style[prop] = value;
        }) : win.getComputedStyle(this[0])[prop]);
      }

      for (var key in prop) {
        this.css(key, prop[key]);
      }

      return this;
    }

  });

  function compute(el, prop) {
    return parseInt(win.getComputedStyle(el[0], null)[prop], 10) || 0;
  }

  each(["Width", "Height"], function (v) {
    var lower = v.toLowerCase();

    fn[lower] = function () {
      return this[0].getBoundingClientRect()[lower];
    };

    fn["inner" + v] = function () {
      return this[0]["client" + v];
    };

    fn["outer" + v] = function (margins) {
      return this[0]["offset" + v] + (margins ? compute(this, "margin" + (v === "Width" ? "Left" : "Top")) + compute(this, "margin" + (v === "Width" ? "Right" : "Bottom")) : 0);
    };
  });

  function registerEvent(node, eventName, callback) {
    var eventCache = getData(node, "_cashEvents") || setData(node, "_cashEvents", {});
    eventCache[eventName] = eventCache[eventName] || [];
    eventCache[eventName].push(callback);
    node.addEventListener(eventName, callback);
  }

  function removeEvent(node, eventName, callback) {
    var events = getData(node, "_cashEvents"), eventCache = (events && events[eventName]), index;

    if (!eventCache) {
      return;
    }

    if (callback) {
      node.removeEventListener(eventName, callback);
      index = eventCache.indexOf(callback);
      if (index >= 0) {
        eventCache.splice(index, 1);
      }
    } else {
      each(eventCache, function (event) {
        node.removeEventListener(eventName, event);
      });
      eventCache = [];
    }
  }

  fn.extend({
    off: function (eventName, callback) {
      return this.each(function (v) {
        return removeEvent(v, eventName, callback);
      });
    },

    on: function (eventName, delegate, callback, runOnce) {
      // jshint ignore:line

      var originalCallback;

      if (!isString(eventName)) {
        for (var key in eventName) {
          this.on(key, delegate, eventName[key]);
        }
        return this;
      }

      if (isFunction(delegate)) {
        callback = delegate;
        delegate = null;
      }

      if (eventName === "ready") {
        onReady(callback);
        return this;
      }

      if (delegate) {
        originalCallback = callback;
        callback = function (e) {
          var t = e.target;

          while (!matches(t, delegate)) {
            if (t === this) {
              return (t = false);
            }
            t = t.parentNode;
          }

          if (t) {
            originalCallback.call(t, e);
          }
        };
      }

      return this.each(function (v) {
        var finalCallback = callback;
        if (runOnce) {
          finalCallback = function () {
            callback.apply(this, arguments);
            removeEvent(v, eventName, finalCallback);
          };
        }
        registerEvent(v, eventName, finalCallback);
      });
    },

    one: function (eventName, delegate, callback) {
      return this.on(eventName, delegate, callback, true);
    },

    ready: onReady,

    trigger: function (eventName, data) {
      var evt = doc.createEvent("HTMLEvents");
      evt.data = data;
      evt.initEvent(eventName, true, false);
      return this.each(function (v) {
        return v.dispatchEvent(evt);
      });
    }

  });

  function encode(name, value) {
    return "&" + encodeURIComponent(name) + "=" + encodeURIComponent(value).replace(/%20/g, "+");
  }

  function getSelectMultiple_(el) {
    var values = [];
    each(el.options, function (o) {
      if (o.selected) {
        values.push(o.value);
      }
    });
    return values.length ? values : null;
  }

  function getSelectSingle_(el) {
    var selectedIndex = el.selectedIndex;
    return selectedIndex >= 0 ? el.options[selectedIndex].value : null;
  }

  function getValue(el) {
    var type = el.type;
    if (!type) {
      return null;
    }
    switch (type.toLowerCase()) {
      case "select-one":
        return getSelectSingle_(el);
      case "select-multiple":
        return getSelectMultiple_(el);
      case "radio":
        return (el.checked) ? el.value : null;
      case "checkbox":
        return (el.checked) ? el.value : null;
      default:
        return el.value ? el.value : null;
    }
  }

  fn.extend({
    serialize: function () {
      var query = "";

      each(this[0].elements || this, function (el) {
        if (el.disabled || el.tagName === "FIELDSET") {
          return;
        }
        var name = el.name;
        switch (el.type.toLowerCase()) {
          case "file":
          case "reset":
          case "submit":
          case "button":
            break;
          case "select-multiple":
            var values = getValue(el);
            if (values !== null) {
              each(values, function (value) {
                query += encode(name, value);
              });
            }
            break;
          default:
            var value = getValue(el);
            if (value !== null) {
              query += encode(name, value);
            }
        }
      });

      return query.substr(1);
    },

    val: function (value) {
      if (value === undefined) {
        return getValue(this[0]);
      } else {
        return this.each(function (v) {
          return v.value = value;
        });
      }
    }

  });

  function insertElement(el, child, prepend) {
    if (prepend) {
      var first = el.childNodes[0];
      el.insertBefore(child, first);
    } else {
      el.appendChild(child);
    }
  }

  function insertContent(parent, child, prepend) {
    var str = isString(child);

    if (!str && child.length) {
      each(child, function (v) {
        return insertContent(parent, v, prepend);
      });
      return;
    }

    each(parent, str ? function (v) {
      return v.insertAdjacentHTML(prepend ? "afterbegin" : "beforeend", child);
    } : function (v, i) {
      return insertElement(v, (i === 0 ? child : child.cloneNode(true)), prepend);
    });
  }

  fn.extend({
    after: function (selector) {
      cash(selector).insertAfter(this);
      return this;
    },

    append: function (content) {
      insertContent(this, content);
      return this;
    },

    appendTo: function (parent) {
      insertContent(cash(parent), this);
      return this;
    },

    before: function (selector) {
      cash(selector).insertBefore(this);
      return this;
    },

    clone: function () {
      return cash(this.map(function (v) {
        return v.cloneNode(true);
      }));
    },

    empty: function () {
      this.html("");
      return this;
    },

    html: function (content) {
      if (content === undefined) {
        return this[0].innerHTML;
      }
      var source = (content.nodeType ? content[0].outerHTML : content);
      return this.each(function (v) {
        return v.innerHTML = source;
      });
    },

    insertAfter: function (selector) {
      var _this = this;


      cash(selector).each(function (el, i) {
        var parent = el.parentNode, sibling = el.nextSibling;
        _this.each(function (v) {
          parent.insertBefore((i === 0 ? v : v.cloneNode(true)), sibling);
        });
      });

      return this;
    },

    insertBefore: function (selector) {
      var _this2 = this;
      cash(selector).each(function (el, i) {
        var parent = el.parentNode;
        _this2.each(function (v) {
          parent.insertBefore((i === 0 ? v : v.cloneNode(true)), el);
        });
      });
      return this;
    },

    prepend: function (content) {
      insertContent(this, content, true);
      return this;
    },

    prependTo: function (parent) {
      insertContent(cash(parent), this, true);
      return this;
    },

    remove: function () {
      return this.each(function (v) {
        return v.parentNode.removeChild(v);
      });
    },

    text: function (content) {
      if (content === undefined) {
        return this[0].textContent;
      }
      return this.each(function (v) {
        return v.textContent = content;
      });
    }

  });

  var docEl = doc.documentElement;

  fn.extend({
    position: function () {
      var el = this[0];
      return {
        left: el.offsetLeft,
        top: el.offsetTop
      };
    },

    offset: function () {
      var rect = this[0].getBoundingClientRect();
      return {
        top: rect.top + win.pageYOffset - docEl.clientTop,
        left: rect.left + win.pageXOffset - docEl.clientLeft
      };
    },

    offsetParent: function () {
      return cash(this[0].offsetParent);
    }

  });

  fn.extend({
    children: function (selector) {
      var elems = [];
      this.each(function (el) {
        push.apply(elems, el.children);
      });
      elems = unique(elems);

      return (!selector ? elems : elems.filter(function (v) {
        return matches(v, selector);
      }));
    },

    closest: function (selector) {
      if (!selector || this.length < 1) {
        return cash();
      }
      if (this.is(selector)) {
        return this.filter(selector);
      }
      return this.parent().closest(selector);
    },

    is: function (selector) {
      if (!selector) {
        return false;
      }

      var match = false, comparator = getCompareFunction(selector);

      this.each(function (el) {
        match = comparator(el, selector);
        return !match;
      });

      return match;
    },

    find: function (selector) {
      if (!selector || selector.nodeType) {
        return cash(selector && this.has(selector).length ? selector : null);
      }

      var elems = [];
      this.each(function (el) {
        push.apply(elems, find(selector, el));
      });

      return unique(elems);
    },

    has: function (selector) {
      var comparator = (isString(selector) ? function (el) {
        return find(selector, el).length !== 0;
      } : function (el) {
        return el.contains(selector);
      });

      return this.filter(comparator);
    },

    next: function () {
      return cash(this[0].nextElementSibling);
    },

    not: function (selector) {
      if (!selector) {
        return this;
      }

      var comparator = getCompareFunction(selector);

      return this.filter(function (el) {
        return !comparator(el, selector);
      });
    },

    parent: function () {
      var result = [];

      this.each(function (item) {
        if (item && item.parentNode) {
          result.push(item.parentNode);
        }
      });

      return unique(result);
    },

    parents: function (selector) {
      var last, result = [];

      this.each(function (item) {
        last = item;

        while (last && last.parentNode && last !== doc.body.parentNode) {
          last = last.parentNode;

          if (!selector || (selector && matches(last, selector))) {
            result.push(last);
          }
        }
      });

      return unique(result);
    },

    prev: function () {
      return cash(this[0].previousElementSibling);
    },

    siblings: function () {
      var collection = this.parent().children(), el = this[0];

      return collection.filter(function (i) {
        return i !== el;
      });
    }

  });


  return cash;
});

;
//** Small wrapper for using local storage *
!function(){
  var noop = function(){};

  //~ Global namespace
  window._ForeignPolicy_ = window._ForeignPolicy_ || {};

  window._ForeignPolicy_.localdata = {};

  //~ GET
  window._ForeignPolicy_.localdata.get = (window.localStorage && localStorage.getItem)
    ? function(key){
      return localStorage.getItem(key);
    }
    : noop;

  //~ SET
  window._ForeignPolicy_.localdata.set = (window.localStorage && localStorage.setItem)
    ? function(key, val){
      localStorage.setItem(key, val);
    }
    : noop;

  //~ DEL
  window._ForeignPolicy_.localdata.del = (window.localStorage && localStorage.removeItem)
    ? function(key){
      localStorage.removeItem(key);
    }
    : noop;
}();
;
// This is lifted from the FP Drupal JS stack as it's a dependency for the identity and livefyre scripts.

var utils = (function($){

  /**
   * Helpers
   *
   * `toString` does not implement a `call` method natively
   * in IE
   */

  var toString = ({}).toString;

  /**
   * Very simple templating function
   */

  var template = (function(){

    /**
     * Constants
     */

    var NO_MATCH = '';

    /**
     * Simple string replacement token (e.g., {{ url }})
     */

    var token = /\{\{ *(\w+) *\}\}/g;

    /**
     * Return a function that can obtain a template using jQ
     * selectors
     */

    return function(HTMLString){

      /**
       * First obtain the template and get its HTML
       *
       * Note: `$.trim` must be called to avoid a newline
       * error when creating a jQ object from an HTML
       * string
       */

      HTMLString = $.trim(HTMLString);

      /**
       * Simple helper function for string replacement
       */

      var interpolate = function(values) {

        /**
         * E.g., match = {{url}}, submatch = url
         */

        return HTMLString.replace(token, function(match, submatch){

          return (submatch in values ? values[submatch] : NO_MATCH);

        });

      };

      /**
       * Return a function that can perform simple string
       * replacement
       *
       * If an array is provided, it assumed it is an array
       * of objects using the same template
       */

      return function(values){

        var buffer, index, length;

        if ('[object Array]' !== toString.call(values)) {

          return interpolate(values);

        }

        buffer = '';

        index  = 0;

        length = values.length;

        while (index < length) {

          buffer += interpolate(values[index++]);

        }

        return buffer;

      }

    };

  })();


  /**
   * Simple sharing function
   *
   * Useful for directly embedding into the
   * `onclick` attribute
   */

  var share = (function(){

    /**
     * Just a shorthand alias
     */

    var esc = encodeURIComponent;

    /**
     * Predefined share URLs
     *
     * Uses the templating utility function
     * for string replacement
     */

    var redirectUri;
    if (window.fpUtilsLoc && window.fpUtilsLoc.redirectUri) {
      redirectUri = window.fpUtilsLoc.redirectUri;
    } else {
      redirectUri = 'https://foreignpolicy.com/share_redirect/';
    }

    var endpoints = {

      twitter      : template('https://twitter.com/intent/tweet?text={{text}}&url={{url}}'),
      facebook     : template('https://www.facebook.com/dialog/share?app_id=373958131177192&display=popup&href={{url}}&redirect_uri=' + esc(redirectUri)),
      google       : template('https://plus.google.com/share?url={{url}}'),
      'google-plus': template('https://plus.google.com/share?url={{url}}'),
      //~ NOTE: https://developer.linkedin.com/docs/share-on-linkedin
      linkedin     : template('https://www.linkedin.com/shareArticle?url={{url}}&mini=true&title={{title}}&summary={{text}}'),
      reddit       : template('http://www.reddit.com/submit?url={{url}}')

    };

    /**
     * Actual sharing function
     *
     * Opens a new window. Expects to be passed the
     * context of the sharing (i.e., `this`) so it
     * can obtain some `data-` values
     */

    return function(context){

      context = $(context);

      var endpoint = endpoints[context.data('endpoint')];

      if (!endpoint) return;

      var url = $.trim(context.data('url')) || 'https://foreignpolicy.com';

      //~ The updated Facebook share API seems to require https to match the
      //~ og:url, which is https
      //
      //~ Similar logic for testing LinkedIn shares...
      if ('facebook' === context.data('endpoint') || 'linkedin' === context.data('endpoint')) {
        url = url.replace('http://', 'https://');
        if (window.fpUtilsLoc && window.fpUtilsLoc.isDev) {
          url = url.replace(/\/\/(dev|sandbox|stg\d{2})\./, '//');
        }
      }

      var data = {

        title : esc(context.data('title') || 'Foreign Policy'),
        text  : esc(context.data('text')  || context.data('title') || 'Check this story out at ForeignPolicy.com!'),
        url   : esc(url)

      };

      window.open(endpoint(data), 'Share', 'toolbar=0, status=0, width=900, height=500');

    };

  })();


  /**
   * Print wrap function in case 
   * browser specific printing JS 
   * is required
   */

  var printer = function(){
    window.print();
  };


  return {

    template          : template,
    share             : share,
    printer           : printer

  };

})(jQuery);
;
/**
 * Cookie message for GDPR
 */

;(function(w, d, $, utils, _FP){

  /**
   * jQuery elements
   */

  var doc  = $(d)
    , body = $(d.body)
    , sticky_container = $('.sticky_content');

  /**
   * Cookie message
   */

  var htmlInfo = (
    '<div class="sticky_message cookie_message">' + 
    '<span class="cookie_message_close counter_close"><img draggable="false" class="emoji" alt="" src="https://www.foreignpolicy.com/wp-content/themes/foreign-policy-2017/assets/src/images/icons/close-white.svg" /></span>' +
    '<p>By using this website, you agree to our use of cookies. This use includes personalization of content and ads, and traffic analytics. Review our <a href="/privacy/">Privacy Policy</a> for more information.</p>' + 
    '</div>'
  )
    , infoTpl  = utils.template(htmlInfo);


  /**
   * Show cookie message
   */

  function show(e) {

    // If message has been seen and closed by user, exit
    if ( 'fp_cookie_message_acknowledged' === _FP.localdata.get('fp_cookie_message') ) {
      return;
    }

    // Show cookie message if it doesn't already appear in DOM
    if( $('.cookie_message').length < 1 ) {
      sticky_container.append( infoTpl() ).addClass('cookie_message_displayed');
      addFooterPadding();
      doc.on('click touchstart', '.cookie_message .cookie_message_close', hideMessage);
    }

  }
  show();


  /**
   * Add padding to footer to account for sticky message
   */
   function addFooterPadding() {
    var stickyHeight = sticky_container.outerHeight();
    if( stickyHeight < 1 ) stickyHeight = '1em';
    $('.site-footer').css( 'padding-bottom', stickyHeight );
   }


  /**
   * Hide the cookie message
   */

  function hideMessage() {
    //~ Save local storage/cookie for takeover view
    _FP.localdata.set('fp_cookie_message', 'fp_cookie_message_acknowledged');
    $('.cookie_message').hide();
    addFooterPadding();
  }


})(window, document, jQuery, utils, _ForeignPolicy_);
;
//~ Hack for links the proxy does not adjust
!function($){
  $(document).on('pianoAccessCheckComplete', function () {
    tp = window.tp || [];
    //~ Data is not ready
    if(typeof FP.Singletons.UserAltAccess === 'undefined') {
      return
    }
    //~ Does not apply to normal proxy access
    if (!FP.Singletons.UserAltAccess.isIPAccess || 'proxy_hosts' !== FP.Singletons.UserAltAccess.ipAccessData.access_type) {
      return;
    }
    $(document).on('click', 'a', function(e){
      var refLink = null;
      if (/^trc\.taboola\.com/) {
        var search = this.search.split('&');
        for (var i = 0, len = search.length; i < len; i++) {
          var query = search[i];
          if ('url=' === query.substr(0, 4)) {
            refLink = decodeURIComponent(query.substr(4));
            break;
          }
        }
      }
      var a;
      if (null === refLink) {
        a = this;
      } else {
        a = document.createElement('a');
        a.href = refLink;
      }
      //~ If it's not an internal link, not our problem
      if (!/^(www\.)?foreignpolicy.com$/.test(a.hostname)) {
        return;
      }
      //~ Stop the internal link
      e.preventDefault();
      document.location = (
        document.location.protocol + '//' +
        document.location.host +
        a.pathname +
        a.search +
        a.hash
      );
    });
  });
}(jQuery);
;
/*!
 * jQuery Cookie Plugin v1.3.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2013 Klaus Hartl
 * Released under the MIT license
 */
(function (factory) {
	if (typeof define === 'function' && define.amd) {
		// AMD. Register as anonymous module.
		define(['jquery'], factory);
	} else {
		// Browser globals.
		factory(jQuery);
	}
}(function ($) {

	var pluses = /\+/g;

	function decode(s) {
		if (config.raw) {
			return s;
		}
		try {
			// If we can't decode the cookie, ignore it, it's unusable.
			return decodeURIComponent(s.replace(pluses, ' '));
		} catch(e) {}
	}

	function decodeAndParse(s) {
		if (s.indexOf('"') === 0) {
			// This is a quoted cookie as according to RFC2068, unescape...
			s = s.slice(1, -1).replace(/\\"/g, '"').replace(/\\\\/g, '\\');
		}

		s = decode(s);

		try {
			// If we can't parse the cookie, ignore it, it's unusable.
			return config.json ? JSON.parse(s) : s;
		} catch(e) {}
	}

	var config = $.cookie = function (key, value, options) {

		// Write
		if (value !== undefined) {
			options = $.extend({}, config.defaults, options);

			if (typeof options.expires === 'number') {
				var days = options.expires, t = options.expires = new Date();
				t.setDate(t.getDate() + days);
			}

			value = config.json ? JSON.stringify(value) : String(value);

			return (document.cookie = [
				config.raw ? key : encodeURIComponent(key),
				'=',
				config.raw ? value : encodeURIComponent(value),
				options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
				options.path    ? '; path=' + options.path : '',
				options.domain  ? '; domain=' + options.domain : '',
				options.secure  ? '; secure' : ''
			].join(''));
		}

		// Read

		var result = key ? undefined : {};

		// To prevent the for loop in the first place assign an empty array
		// in case there are no cookies at all. Also prevents odd result when
		// calling $.cookie().
		var cookies = document.cookie ? document.cookie.split('; ') : [];

		for (var i = 0, l = cookies.length; i < l; i++) {
			var parts = cookies[i].split('=');
			var name = decode(parts.shift());
			var cookie = parts.join('=');

			if (key && key === name) {
				result = decodeAndParse(cookie);
				break;
			}

			// Prevent storing a cookie that we couldn't decode.
			if (!key && (cookie = decodeAndParse(cookie)) !== undefined) {
				result[name] = cookie;
			}
		}

		return result;
	};

	config.defaults = {};

	$.removeCookie = function (key, options) {
		if ($.cookie(key) !== undefined) {
			// Must not alter options, thus extending a fresh object...
			$.cookie(key, '', $.extend({}, options, { expires: -1 }));
			return true;
		}
		return false;
	};

}));
;
/**
 * Helpers for promises
 */
!function () {
  //=NS
  FP.Utils = FP.Utils || {};

  FP.Utils.promise = {
    /**
     * Promise executor wrapper for promises that only need to be run once (e.g.,
     * We only want to hit the IP access endpoint once, but the function itself
     * may be used in several locations)
     *
     * ```javascript
     * var p = FP.Utils.promise.once(function (resolve, reject) {
     *   console.log('Doing work!');
     *   setTimeout(function () {
     *     resolve('Hello world');
     *   }, 2e3);
     * });
     *
     * p().then(message => console.log('1:', message));
     * p().then(message => console.log('2:', message));
     * p().then(message => console.log('3:', message));
     *
     * // NOTE: 'Doing work!' is only logged once
     * // LOG=> Doing work!
     * // ...~2 seconds later...
     * // LOG=> 1: Hello world
     * // LOG=> 2: Hello world
     * // LOG=> 3: Hello world
     * ```
     *
     * @param {Function} executor Promise function w/ resolve/reject arguments
     *
     * @return {Promise}
     */
    once: function (executor) {
      var promise;
      return function () {
        return promise || (promise = new Promise(executor));
      };
    }
  };
}();
;
!function () {
  //=NS
  FP.Utils = FP.Utils || {};

  FP.Utils.string = {
    /**
     * Tiny helper for number based formatting in JavaScript strings
     *
     * E.g.,
     * ```
     * FP.Utils.string.format('Message: {0} {1}', 'Hello', 'World');
     * // 'Message: Hello World'
     * ```
     *
     * @param {String} format
     *
     * @return {String}
     */
    format: function (format) {
      var args = Array.prototype.slice.call(arguments, 1);
      return format.replace(/{(\d+)}/g, function (match, index) {
        return undefined === args[index] ? match : args[index];
      });
    }
  };
}();
;
/**
 * Helpers for urls
 */
!function () {
    //=NS
    FP.Utils = FP.Utils || {};

    FP.Utils.url = {
        /** 
         * Helper to parse URL
         */
        getUrlParameter: function(sParam) {
            var sPageURL = window.location.search.substring(1).toLowerCase();
            var sURLVariables = sPageURL.split("&");
            var ret = "not found";
            for (var i = 0; i < sURLVariables.length; i++) {
                var sParameterName = sURLVariables[i].split("=");
                if (sParameterName[0] == sParam) {
                    ret = sParameterName[1];
                }
            }
            return ret;
        }
    }
}();;
!function ($) {
  //=NS
  FP.Utils = FP.Utils || {};

  FP.Utils.stickyHeader = {
    /**
     * Helper for sticky headers
     */
    stickyHeadersAreSet : false,
    className : '.sticky-header',

    init: function() {
      FP.Utils.stickyHeader.setStickyHeaders(FP.Utils.stickyHeader.className);
    },

    setStickyHeaders: function( className ) { 
      $(window).scroll( function() {
        if( $(window).scrollTop() < 100 ) return;

        if( !FP.Utils.stickyHeader.stickyHeadersAreSet ) {
          if( $( className ).length ) {
            $( className ).each(function(index, el) {
              var stickyDate = $(el);
              stickyDate.css({ 'top': FP.Utils.stickyHeader.calculateTop() + 'px' });
              FP.Utils.stickyHeader.stickyHeadersAreSet = true;
            });
          }
        }
      });
    },

    calculateTop: function() {
      var navBar     = $('header.site-header');
      var wpAdminBar = $('#wpadminbar');
      var topOffset  = 0;

      // Adjust for navbar
      if ( navBar.length && navBar.is(':visible') ) {
        topOffset += navBar.innerHeight();
      }

      // Adjust for wpAdminBar
      if ( wpAdminBar.length && wpAdminBar.is(':visible') && window.innerWidth > 782 ) {
        topOffset += wpAdminBar.innerHeight();
      }

      return topOffset - 1;
    }

  };

  $(window).resize(function() {
    FP.Utils.stickyHeader.stickyHeadersAreSet = false;
    FP.Utils.stickyHeader.setStickyHeaders(FP.Utils.stickyHeader.className);
  });

}(jQuery);
;
!function ($) {
  //=NS
  FP.Utils = FP.Utils || {};

  FP.Utils.contentToggle = {
    /**
     * Helper for content toggle
     */
    classNameParent : '.content-toggle',
    classNameButtons : '.content-toggle--buttons > div',
    classNameContent : '.content-toggle--content > div',
    
    classNameActiveButton : 'active--button',
    classNameActiveContent : 'active--content',

    init: function() {
      var that = this;

      that.configureContentToggle();
    },

    configureContentToggle: function() {
      var that = this;

      // ensure parent container exists
      if( $( that.classNameParent ).length ) {
        
        // iterate through parents in case there is more than one content toggle area on the post/page
        $( that.classNameParent ).each( function( parentIndex, parentEl ) {
          
          // ensure button and content containers exist
          if( $( that.classNameButtons ).length && $( that.classNameContent ).length ) {
            
            // handle buttons
            that.toggleClassnames( $( this ).find( that.classNameButtons ), that.classNameActiveButton );
            that.addClassnameIdentifiers( $( that.classNameButtons ), parentIndex, 'button' );
            that.addClickHandlers( $( this ), that.classNameActiveButton, 'content' );
            
            // handle content containers
            that.toggleClassnames( $( this ).find( that.classNameContent ), that.classNameActiveContent );
            that.addClassnameIdentifiers( $( that.classNameContent ), parentIndex, 'content' );
          }
        });
      }
    },

    addClickHandlers: function( parentEl, activeClassName, contenttype ) {
      var that = this;

      parentEl.find( that.classNameButtons ).on('click', function(){
        // Remove active class name from all buttons
        parentEl.find( that.classNameButtons ).removeClass( activeClassName );

        // Toggle active class on clicked button
        $( this ).addClass( activeClassName );

        // Remove active class name for all content areas
        parentEl.find( that.classNameContent ).removeClass( that.classNameActiveContent );

        // Get index id for clicked content area
        // based on the id of the clicked element
        var idValue = $( this ).attr( 'id' );
        var indexValue = idValue.split( '--' );

        indexValue = indexValue[1];
        // Toggle active class for clicked content area
        $('#' + contenttype + '--' + indexValue).addClass( that.classNameActiveContent );
      });
    },

    toggleClassnames: function( els, activeClassName ) {
      var that = this;

      // Remove active class name from all elements
      $( els ).removeClass( activeClassName );
      // Add active class name to first element
      $( els ).each(function(index, el) {
        if( 0 === index ) {
          $( this ).addClass( activeClassName );
        }
      });
    },

    addClassnameIdentifiers: function( els, parentIndex, contenttype ) {
      // Add ids to elements to reference in click events
      $( els ).each(function( index, el ) {
        $( this ).attr( 'id', contenttype + '--' + parentIndex + '_' + index );
      });
    },

  };

  FP.Utils.contentToggle.init();

}(jQuery);
;
//~Singletons/User
//
// Helper funcs for interacting with identity provider
!function ($) {
  var usePianoProduction = window.pianoData.use_piano_environment;

  if( 'production' === usePianoProduction ) {
    // Production
    var pianoAid = 'beVmoi3WRm';
    var pianoEndpoint = 'https://buy.tinypass.com/api/v3';
    var pianoAPIFile = '//cdn.tinypass.com/api/tinypass.min.js';
  } else {
    // Sandbox
    var pianoAid = 'Q0Q1FMiXiK';
    var pianoEndpoint = 'https://sandbox.tinypass.com/api/v3';
    var pianoAPIFile = '//sandbox.tinypass.com/api/tinypass.min.js';
  }

  var doc = $(document);

  window.dataLayer = window.dataLayer || [];

  /* Toggle body class based on whether user is logged in/subscribed */
  function toggleBodyClass() {
    // Check if user is logged in
    if( FP.Singletons.User.isReg ) {

      // Check if user is subscribed
      if( FP.Singletons.User.isSub ) {
        $( 'body' ).addClass( 'sub_user' );
      } else {
        $( 'body' ).addClass( 'reg_user' );
      }

    } else {
      $( 'body' ).addClass( 'anon_user' );
    }
  }

  /* Toggle header content based on whether user is logged in */
  function toggleHeaderContent() {
    // If user is logged in
    if ( !FP.Singletons.User.isIPAccess && ( FP.Singletons.User.isSub || FP.Singletons.User.isReg ) ) {
      // Update header content to match logged in state    
      $('.header-subnav .navlink.-top.-signin.FP-paywall--login, .header-mobile-subnav .navlink.-top.-signin.FP-paywall--login')
        .html('My Account')
        .attr('href','/manage')
        .removeClass('FP-paywall--login');

      if ( FP.Singletons.User.isInsider ) {
        $('.header-subnav .subscribe-link').hide();
        $('.header-mobile-subnav .subscribe-link').hide();
        $('.insider-only-text').show();
      } else if( FP.Singletons.User.isSub || FP.Singletons.User.isPrem ) {
        $('.header-subnav .subscribe-prompt').hide();
        $('.header-subnav .upgrade-to-insider-prompt').show();
        $('.header-mobile-subnav .subscribe-prompt').hide();
        $('.header-mobile-subnav .upgrade-to-insider-prompt').show();
      } else if( FP.Singletons.User.isReg ) {
        $('.header-subnav .subscribe-prompt').show();
        $('.header-subnav .upgrade-to-insider-prompt').hide();
        $('.header-mobile-subnav .subscribe-prompt').show();
        $('.header-mobile-subnav .upgrade-to-insider-prompt').hide();
      }

    // If user is IP access client
    } else if( FP.Singletons.UserAltAccess && FP.Singletons.UserAltAccess.isIPAccess ) {
      // Update header content to match logged in state    
      $('.header-subnav .navlink.-top.-signin.FP-paywall--login')
        .text( FP.Singletons.UserAltAccess.ipAccessData.message )
        .attr('href','#')
        .removeClass('FP-paywall--login');

      $('.header-subnav .subscribe-link').hide();

    // If user is link access client
    } else if( FP.Singletons.UserAltAccess && FP.Singletons.UserAltAccess.isLinkAccess ) {
      // Update header content to match logged in state    
      $('.header-subnav .navlink.-top.-signin.FP-paywall--login')
        .text( FP.Singletons.UserAltAccess.linkAccessData.message )
        .attr('href','#')
        .removeClass('FP-paywall--login');

      $('.header-subnav .subscribe-link').hide();

    } else {
      // Update header content to match logged out state
      $('.header-subnav .navlink.-top.-signin')
        .html('Sign In')
        .attr('href','#')
        .addClass('FP-paywall--login');

      $('.header-subnav .subscribe-prompt').show();
      $('.header-subnav .upgrade-to-insider-prompt').hide();
      $('.header-mobile-subnav .subscribe-prompt').show();
      $('.header-mobile-subnav .upgrade-to-insider-prompt').hide();
    }

    // Show menu in header after user access level is evaluated
    $('.header-subnav .header-menu.-top').css('display','block');

    // Hide header for users viewing article in our app
    if( isUserFromApp() ) {
      $('.site-header').hide();
      $('body').css('padding-top','0');
    }

    // Hide header for users viewing article from Facebook Instant Articles
    if( isUserFromFBIA() ) {
      $('.header-nav-wrapper,.header-subnav-wrapper,.hamburger-button').hide();
      $('.site-header .logo').removeAttr('href');
      $('body').css('padding-top','0');
      $('body').addClass('no-piano-modal-margin');
    }
  }

  /* Determine whether user is coming to the page from our app by looking for ?app=true in the URL */
  function isUserFromApp() {
    var isFromApp = (
      'true' === FP.Utils.url.getUrlParameter('app')
    );
    return isFromApp;
  }

  /* Determine whether user is coming to the page from Facebook Instant Articles by looking for surface=meter_limit_reached in the URL */
  function isUserFromFBIA() {
    var isFromFBIA = (
      'not found' !== FP.Utils.url.getUrlParameter('account_linking_token')
    );

    return isFromFBIA;
  }

  /* Initialize Piano */
  function initializePiano( postDataPianoFinal ){

    tp = window.tp || [];

    /**
     * ------------------------------------------------------------------------
     * Pass article tag data to Piano
     * ------------------------------------------------------------------------
     */
    function passDataToPiano( postDataPianoFinal ) {
      tp.push(["setTags", postDataPianoFinal]);
    }
    passDataToPiano( postDataPianoFinal );

    function send_signed_fb_pixel( event_name, params ) {
      jQuery.ajax( {
        url: '/wp-json/fp/fb-pixel',
        data: {
          event_name: event_name,
          params: params
        },
        type: 'GET',
        async: false,
        success: function ( response ) {
          var image = jQuery( '<img style="display: none;" />' );
          image.attr( 'src', response.pixel_url );
          jQuery( 'body' ).append( image );
        },
        error: function( request, error ) {
          console.error( error )
        }
      } );
    }

    /**
     * ------------------------------------------------------------------------
     * Initialize Piano
     * ------------------------------------------------------------------------
     */

    // Initialize Piano ID
    tp.push(["setUsePianoIdUserProvider", true]);

    function onCheckoutComplete(data) {
      send_signed_fb_pixel( 'Subscribe', {
        subscription_id: data.uid,
        offer_code: data.rid,
        value: data.chargeAmount,
        currency: data.chargeCurrency
      } );
//
// TO-DO - verify the data.uid comes through correctly
//
      /* Reset user cache group in case they upgraded */
      FP.Singletons.User.setUserCacheGroup( data.uid );
    }

    function onCheckoutExternalEvent() {
    }

    function onCheckoutClose(event) {
        /* Default behavior is to refresh the page on successful checkout */
        if (event && event.state == "checkoutCompleted") {
            location.reload();
        }
    }

    function onCheckoutCancel() {
    }

    function onCheckoutError() {
    }

    function onCheckoutSubmitPayment() {
    }

    function onCheckoutStateChange( stateView ) {
      let stateName = stateView.stateName;
      let offerId   = stateView.offerId;

      if ( 'state1' === stateName || 'state2' === stateName ) {
        fbq( 'track', 'InitiateCheckout', {
          offer_code: offerId
        } );
      }
    }

    /**
     * Meter callback - fired when the meter has expired
     */
    function onMeterExpired( data ) {
      fbq( 'track', 'ViewPaywall', {
        surface: 'mWeb',
        meter_count: data.maxViews
      } );

      // The user's meter has expired.
      // Hide the full version of the article and show the truncated version.
      $( '.content-ungated' ).show();
      $( '.content-gated' ).hide();
      // Hide the author, tag, and alerts content that appears below the Piano offer
      $( '.bio-no-photo' ).hide();
      $( '.the-tags' ).hide();
      $( '.calerts-tags' ).hide();
      // Reduce min-height of sidebar sticky elements
      $('.sidebar .sticky-container--delay').removeClass('sticky-container--delay');
      // Add in-article subscribe prompt after fifth paragraph in the first free article
      $( '.post-content--sub-prompt-in-article' ).insertAfter( $( '.content-ungated' ) );
      // Restructure sidebar and show content below paywall
      $( '.post-content--after' ).show();
      $( '.post-content--after--final-post' ).show();
      $( '.hide-on-gated-post' ).remove();
    }

    /**
     * Meter callback - fired when the meter is active (i.e. user is not subscribed), but it has not expired yet
     */
    function onMeterActive( e ) {
      // This is a free article for the non-subscribed user.
      // Hide the truncated version of the article and show the full version.
      $( '.content-ungated' ).hide();
      $( '.content-gated' ).show();
      // Show content below paywall
      $( '.post-content--after' ).show();
      $( '.post-content--after--final-post' ).show();
      // Add in-article subscribe prompt after fifth paragraph in the first free article
      $( '.post-content--sub-prompt-in-article' ).insertAfter( $( '.content-gated p:nth-of-type(4)' ) );
      $( '.post-content--sub-prompt-in-article' ).show();
      // Add class to adjust spacing on custom feature templates
      $( '.piano-gating-offer-container--in-feature' ).addClass( 'piano-gating-offer-container--tighter-space' );
      // Add class to first article to toggle content within CSS
      $( '.post-content--after' ).addClass( 'hide-duplicate-content-on-mobile' );
    }

    /* Callback executed when a user must login */
    function onLoginRequired() {
        // this is a reference implementation only
        // your own custom login/registration implementation would
        // need to return the tinypass-compatible userRef inside the callback

        // mysite.showLoginRegistration(function (tinypassUserRef)
        // tp.push(["setUserRef", tinypassUserRef]); // tp.offer.startCheckout(params); // }
        // this will prevent the tinypass error screen from displaying

        return false;
    }

    /* Callback executed after an experience executed successfully */
    function onExperienceExecute(event) {
      // Subscribe page
      // Hide secondary subscription content if user is viewing 
      // the B version of the A/B test
      /* 2/11/21 - Remove this toggle until another A/B test is enabled
      if( $('.subscribe').length > 0 ) {
        var abTestCookie = tp.util.findCookieByName('_pc_variant');
        if( 'b' === abTestCookie ) {
          $('.subscribe .secondary-content').hide();
        }
      }*/
    }

    /* Callback executed after a response variable is sent from the experience */
    function onSetResponseVariable(eventParams){
      var responseVariables = eventParams.responseVariables

      if( typeof responseVariables.show_inline_sub_prompt !== 'undefined' ) {

        if( responseVariables.show_inline_sub_prompt ) {
          // Add in-article subscribe prompt after the truncated gated content
          $( '.post-content--sub-prompt-in-article' ).css('margin-top','1.5em').show();
        }

      }
    }

    /* Callback executed if experience execution has been failed */
    function onExperienceExecutionFailed(event) {
    }

    /* Callback executed if external checkout has been completed successfully */
    function onExternalCheckoutComplete(event) {
        /* Default behavior is to refresh the page on successful checkout */
        location.reload();
    }

    /* Determine if content should not be free in the app */
    function isInsiderContent() {
      return postDataPiano.includes("insider");
    }

    tp.push(["setAid", pianoAid]);
    tp.push(["setCxenseSiteId", "1139724983415417198"]);
    tp.push(["setEndpoint", pianoEndpoint]);
    tp.push(["setUseTinypassAccounts", false]);

    /* Piano cookie setting - first party */
    tp.push(["setCloudflareWorkerUrl", window.location.origin + "/endpoint/piano-cookies/?__fp_endpoint_piano_cookies=1"]);

    /* FB IA tracking (https://docs.piano.io/facebook-experiences/#IAscript) */
    tp.push(["setFbPixelId", "203988873637408"]);

    /* checkout related events */
    tp.push(["addHandler", "checkoutComplete", onCheckoutComplete]);
    tp.push(["addHandler", "checkoutClose", onCheckoutClose]);
    tp.push(["addHandler", "checkoutCustomEvent", onCheckoutExternalEvent]);
    tp.push(["addHandler", "checkoutCancel", onCheckoutCancel]);
    tp.push(["addHandler", "checkoutError", onCheckoutError]);
    tp.push(["addHandler", "checkoutSubmitPayment", onCheckoutSubmitPayment]);
    tp.push(["addHandler", "checkoutStateChange", onCheckoutStateChange]);

    /* user login events */
    tp.push(["addHandler", "loginRequired", onLoginRequired]);

    /* meter related */
    tp.push(["addHandler", "meterExpired", onMeterExpired]);
    tp.push(["addHandler", "meterActive", onMeterActive]);

    tp.push(["addHandler", "experienceExecute", onExperienceExecute]);
    tp.push(["addHandler", "experienceExecutionFailed", onExperienceExecutionFailed]);

    /* get response variable from experience */
    tp.push(["addHandler", "setResponseVariable", onSetResponseVariable]);

    /* external checkout related events */
    tp.push(["addHandler", "externalCheckoutComplete", onExternalCheckoutComplete]);
    
    /* handle user login, signup and logout button clicks - callback executed after a tinypassAccounts login */
    tp.push(["addHandler", "loginSuccess", function(data){
      // Any logic required after a successful login
      if ( tp.user.isUserValid() ) {
        send_signed_fb_pixel( 'LogIntoAccount', {
          subscription_id: data.params.uid,
          is_subscriber: true
        } );
      }

      // Toggle display of authenticated user content in header
      toggleHeaderContent();

      if( true === data.registration ) {
        // login came from registration
      } else if( "PIANOID" === data.source ) {
        // login came from standard login, not within an offer flow
        FP.Singletons.User.setUserCacheGroup( data.params.uid, true );
      }
    }]);

    // Initialize Piano
    tp.push(["init", function() {
      // ensure cross domain tracking
      tp.enableGACrossDomainLinking('UA-6874192-41');

      // If user is logged in
      if (tp.user.isUserValid()) {
        // Get the stored cookie value
        var paramsCookie = tp.util.findCookieByName('__pianoParams');
        var params;
        try {
          // Try to parse stored JSON data
          params = JSON.parse(paramsCookie);
          // Remove the old cookie
          document.cookie = "__pianoParams=null; expires=-1;" +
            " path=/; domain=.foreignpolicy.com";
        } catch (e) {
          params = false;
        }

        if ( $('#reset-password-page') ) {
          $('#reset-password-page').css('display','none');
          $('#reset-password-page-logged-in-user').css('display','block');
        }

      } else {

        /**
         * ------------------------------------------------------------------------
         * Password reset - can be reset only if user is anonymous
         * ------------------------------------------------------------------------
         */
        // Continue if user is on password reset page
        if ( $('#reset-password-page') ) {
          $('#reset-password-page').css('display','block');
          $('#reset-password-page-logged-in-user').css('display','none');
          // If URL has reset_token parameter
          var tokenMatch = location.search.match(/reset_token=([A-Za-z0-9]+)/);
          if (tokenMatch) {
            // Get value of the token
            var token = tokenMatch[1];
            // Present password reset form with the found token
            tp.pianoId.show({
              'resetPasswordToken': token, 
              displayMode: 'inline',
              containerSelector: '#reset-password-page',
              loggedIn: function () {
                // Once user logs in - refresh the page
                location.reload();
              }
            });
          }
        }
      }

      // Initialize Piano experience
      // unless user is viewing article in our app and the article is not insider only
      if( !isUserFromApp() || ( isUserFromApp() && isInsiderContent() ) ) tp.experience.init();

      // Ensure full article content displays in app
      if( isUserFromApp() && !isInsiderContent() ) {
        $( '.content-ungated' ).hide();
        $( '.content-gated' ).show();
      }

      /**
       * ------------------------------------------------------------------------
       * Manage page
       * ------------------------------------------------------------------------
       */

      function buildManagePage() {
        // Exit if user is not on Manage page
        if ( !$('.fp-manage-page') ) {
          return;
        }

        // Toggle display of FP manage content
        if ( FP.Singletons.User.isReg || FP.Singletons.User.isSub || FP.Singletons.User.isPrem ) {
          $('.fp-manage-anon').hide();
          // $('.fp-manage-menu').show();
        }
        if ( FP.Singletons.User.isReg && !FP.Singletons.User.isSub ) {
          $('.fp-manage-reg').each(function() {
            $( this ).show();
          });
        }
        if ( FP.Singletons.User.isSub || FP.Singletons.User.isPrem ) {
          $('.fp-manage-sub').each(function() {
            $( this ).show();
          });
        }
        if ( FP.Singletons.User.isPrem ) {
          $('.fp-manage-premium').each(function() {
            $( this ).show();
          });
        }

        // Show Piano manage content
        tp.myaccount.show({
          displayMode: "inline",
          containerSelector: "#piano-manage"
        });

      }

      /**
       * Enable commenting
       * 
       * Send a REST request with Piano UID, which will generate a JWT token
       * to pass to Coral, which will authenticate the user. 
       * 
       * Store the token in a cookie to avoid extra calls subsequent pageloads.
       */
      function enableCommenting() {
        if ( tp.user.isUserValid() && FP.Singletons.User.isSub ) {
          if ( FP.Singletons.User.userData.customFields.comments_username ) {
            $( '.username-placeholder' ).html( FP.Singletons.User.userData.customFields.comments_username );
            $( '.username-input' ).val( FP.Singletons.User.userData.customFields.comments_username );
          }

          var coral_token = $.cookie( 'fp-coral-token' );
          if ( coral_token && window.coral_embed ) {
            window.coral_embed.login( coral_token );
          } else {
            jQuery.ajax( {
              url: '/wp-json/fp/coral-jwt',
              data: {
                uid: tp.pianoId.getUser().uid,
                username: FP.Singletons.User.userData.customFields.comments_username
              },
              type: 'POST',
              async: true,
              success: function ( response ) {
                if ( response.token && window.coral_embed ) {
                  $.cookie( 'fp-coral-token', response.token, { expires: 2, path: '/' } );
                  window.coral_embed.login( response.token );
                }
              },
              error: function( request, error ) {
                console.error( error );
              }
            } );
          }
        }
      }


      // Trigger Piano login
      doc.on('click', 'a.navlink.FP-paywall--login, .FP-paywall--login.FP-paywall--login--login', function (event) {
        event.preventDefault();
        // show login
        tp.pianoId.show({
          displayMode: 'modal',
          screen: 'login',
          loggedIn: function(data) {
              toggleHeaderContent();
          },
          loggedOut: function() {
              toggleHeaderContent();
          }
        });
      });

      // Trigger Piano signup
      doc.on('click', 'a.FP-paywall--login--signup', function (event) {
        event.preventDefault();
        // show signup
        tp.pianoId.show({
          displayMode: 'modal',
          screen: 'register',
          loggedIn: function(data) {
              toggleHeaderContent();
          },
          loggedOut: function() {
              toggleHeaderContent();
          }
        });
      });

      // Trigger Piano logout
      doc.on('click', 'a.FP-paywall--logout', function (event) {
        tp.pianoId.logout();
        $.removeCookie( 'fp-coral-token', { path: '/' } );
        $.removeCookie( 'vip-go-seg', { path: '/' } );
        $.removeCookie( 'fp-user-data', { path: '/' } );
      });

      tp.pianoId.init({
        loggedOut: function() {
          // Reload the page after Piano has completed the logout process
          location.reload();
        }
      });

      // Trigger Insider offer button display on Future of Money Power Maps
      if( $('.insider-subscribe-prompt').length > 0 ) {
        tp.offer.show({
          offerId: 'OFY7IXJA0SO8',
          templateId: 'OTCYLY404315',
          displayMode: 'inline',
          containerSelector: '.insider-subscribe-button',
          termIds: [ 'TMKUNL72V9OZ' ],
        });
        tp.offer.show({
          offerId: 'OFY7IXJA0SO8',
          templateId: 'OTCYLY404315',
          displayMode: 'inline',
          containerSelector: '.insider-subscribe-button--larger',
          termIds: [ 'TMKUNL72V9OZ' ],
          templateVariantId: 'OTV91IYEQJSBE',
        });
        tp.offer.show({
          offerId: 'OFY7IXJA0SO8',
          templateId: 'OTMRS67TUUXD',
          displayMode: 'inline',
          containerSelector: '.insider-subscribe-button--subscribe-now',
          termIds: [ 'TMKUNL72V9OZ' ],
        });
      }


      /**
       * ------------------------------------------------------------------------
       * Check user access
       * ------------------------------------------------------------------------
       */

      // Check for FP.Singletons instance
      FP.Singletons = FP.Singletons || {};

      // Create User class
      FP.Singletons.User = {

        isInsider: false,
        isPrem: false,
        isSub: false,
        isISpyPlus: false,
        isReg: false,
        isIPAccess: false,
        isLinkAccess: false,
        userData: {
          customFields: {}
        },
        ipAccessData: {},

        /**
         * Listener for all subscription check events to finish
         */
        accessCheckCompleteListener: function () { 
          var that = this;

          // Listener
          var MyRequestsCompleted = (function() {
            var numRequestToComplete, requestsCompleted, callBacks, singleCallBack;

            return function(options) {
              if (!options) options = {};

              numRequestToComplete = options.numRequest || 0;
              requestsCompleted = options.requestsCompleted || 0;
              callBacks = [];
              var fireCallbacks = function() {
                for (var i = 0; i < callBacks.length; i++) callBacks[i]();
              };
              if (options.singleCallback) callBacks.push(options.singleCallback);

              this.addCallbackToQueue = function(isComplete, callback) {
                if (isComplete) requestsCompleted++;
                if (callback) callBacks.push(callback);
                if (requestsCompleted == numRequestToComplete) fireCallbacks();
              };
              this.requestComplete = function(isComplete) {
                if (isComplete) requestsCompleted++;
                if (requestsCompleted == numRequestToComplete) fireCallbacks();
              };
              this.setCallback = function(callback) {
                callBacks.push(callBack);
              };
            };
          })();

          // Set number of events and callback for listener
          that.requestCallback = new MyRequestsCompleted({
            numRequest: 2,
            singleCallback: function(){
              toggleBodyClass();
              toggleHeaderContent();
              buildManagePage();

              $.event.trigger('pianoAccessCheckComplete');
              FP.Singletons.User.trackLoginData();
            }
          })
        },


        setAccess: function () {
          var that = this;

          that.accessCheckCompleteListener();

          /**
           * Process the user access info that came from the server-side 
           * via Foreignpolicy_User_Cache_Group_Helper::get_user_access_levels
           */
          if ( window.pianoData.userLevels ) {
            var userLevels = window.pianoData.userLevels;

            FP.Singletons.User.isInsider  = userLevels.isInsider,
            FP.Singletons.User.isPrem     = userLevels.isPremium || userLevels.isInsider,
            FP.Singletons.User.isSub      = userLevels.isSub || userLevels.isPremium || userLevels.isInsider;
            FP.Singletons.User.isISpyPlus = userLevels.isIspyPlus || userLevels.isPremium || userLevels.isInsider;
            FP.Singletons.User.isReg      = userLevels.isReg || userLevels.isSub || userLevels.isPremium || userLevels.isInsider;

            if ( $.cookie( 'fp-user-data' ) ) {
              FP.Singletons.User.userData = JSON.parse( $.cookie( 'fp-user-data' ) );
              that.fetchCustomFields( 'comments_form', function() {
                enableCommenting();
              } );
            }
          }

          that.isPianoAccess();
          that.isOtherAccess();

          window.pianoReady = true;
        },

        fetchCustomFields: function( form_name, callback ) {
          tp.pianoId.loadExtendedUser( {
            extendedUserLoaded: function ( data ) {
              FP.Singletons.User.userData.customFields = [];

              for ( var i in data.custom_field_values ) {
                var fieldName  = data.custom_field_values[i].field_name;
                var fieldValue = data.custom_field_values[i].value;

                FP.Singletons.User.userData.customFields[fieldName] = fieldValue;
              }

              if ( FP.Singletons.User.isSub ) {
                var username_set = !!FP.Singletons.User.userData.customFields.comments_username;
                if ( ! username_set ) {
                  $( '.comment-username-text' ).hide();

                  FP.Singletons.User.userData.customFields.comments_username = FP.Singletons.User.userData.first_name + FP.Singletons.User.userData.last_name.charAt(0);
                  $( '.comment-username-form.user-content' ).show();
                }
              }

              if ( 'true' === FP.Singletons.User.userData.customFields.commenting_guidelines_consent ){
                $( 'input[name="commenting-guidelines-consent"]' ).attr( 'checked', 'checked' );
              }

              $.cookie( 'fp-user-data', JSON.stringify( FP.Singletons.User.userData ), { expires: 2, path: '/' } );

              if ( callback ) {
                callback();
              }
            }, formName: form_name
          } );
        },

        isPianoAccess: function() {
          var that = this;

          // VIP cache cookie has already been set
          // cookie duration is 2 days
          if ( typeof $.cookie( 'vip-go-seg' ) !== 'undefined' && ! FP.Singletons.UserAltAccess.isIPAccess ) {
            //
            // TO-DO
            // - set cookie with all the that.isInsider, etc. sub details and that.userData data as well
            //   this can be evaluated here to set all the data relative to the FP.Singletons.User object
            //
            if( tp.user.isUserValid() ) {
              var pianoUserData = tp.pianoId.getUser();
              // Set uid if not already present
              if ( ! that.userData.uid ) {
                that.userData.uid = pianoUserData.uid;
              }
              tpUserId = that.userData.uid;
              // Set remaining user data 
              that.userData.email = pianoUserData.email;
              that.userData.first_name = pianoUserData.firstName;
              that.userData.last_name = pianoUserData.lastName;
              that.userData.personal_name = that.userData.first_name + ' ' + that.userData.last_name;
            }

            that.requestCallback.requestComplete(true);
            return;
          } else if( tp.user.isUserValid() ) {
            // VIP cache cookie has not been set
            var pianoUserData = tp.pianoId.getUser();
            tpUserId = pianoUserData.uid;

            Promise.all([
              FP.Singletons.User.setUserCacheGroup( tpUserId ),
            ]).then(function (results) {
              that.requestCallback.requestComplete(true);
            }).catch(function (reason) {
              //reject(reason);
            });
          // User is not logged into Piano
          } else {
            that.requestCallback.requestComplete(true);
          }

        },


        /**
         * Helper to determine if user is coming from the app, 
         * or has either IP access or link access 
         */
        isOtherAccess: function () {
          var that = this;
          if( 
            that.isFromApp() 
            || FP.Singletons.UserAltAccess.isIPAccess 
            || FP.Singletons.UserAltAccess.isLinkAccess 
          ) {
            that.isPrem = true;
            that.isSub = true;
            that.isISpyPlus = true;

            // Workaround for IP access users coming from proxy URL
            // to ensure the full article content displays
            $( '.content-ungated' ).hide();
            $( '.content-gated' ).show();

            if( FP.Singletons.UserAltAccess.isIPAccess ) {
              that.isIPAccess = FP.Singletons.UserAltAccess.ipAccessData.access;
              that.ipAccessData = FP.Singletons.UserAltAccess.ipAccessData;
              if( 'Insider' === FP.Singletons.UserAltAccess.ipAccessData.access_level ) {
                that.isInsider = true;
                if( FP.Singletons.User.isInsider ) {
                  $( 'body' ).addClass( 'insider_user_ip' );
                }
              }

              // Hide comment-related elements from IP Access clients, for now
              $( '.hide-ip-access' ).remove();
            }

            if( FP.Singletons.UserAltAccess.isLinkAccess ) {
              that.isLinkAccess = FP.Singletons.UserAltAccess.isLinkAccess.access;
              that.linkAccessData = FP.Singletons.UserAltAccess.linkAccessData;
            }
          }

          that.requestCallback.requestComplete(true);
          return;
        },


        /**
         * Helper to set user cache group with VIP
         */
        setUserCacheGroup: function ( pianoUid, reload ) {
          var that = this;

          return new Promise( function( resolve, reject ) {
            $.ajax({
              type: 'POST',
              url: '/wp-admin/admin-ajax.php',
              data: {
                action: 'set_user_cache_group',
                uid: pianoUid,
                token: window.pianoData.cache_group_nonce
              },
              success: function( response ) {
                that.isInsider  = response.isInsider;
                that.isPrem     = response.isPremium || response.isInsider;
                that.isSub      = response.isSub || response.isPremium || response.isInsider;
                that.isISpyPlus = response.isIspyPlus || response.isPremium || response.isInsider;
                that.isReg      = response.isReg || response.isSub || response.isPremium || response.isInsider;

                var pianoUserData = tp.pianoId.getUser();
                // Set uid if not already present
                if( !that.userData.uid ) that.userData.uid = pianoUserData.uid;
                tpUserId = that.userData.uid;
                // Set remaining user data 
                that.userData.email = pianoUserData.email;
                that.userData.first_name = pianoUserData.firstName;
                that.userData.last_name = pianoUserData.lastName;
                that.userData.personal_name = that.userData.first_name + ' ' + that.userData.last_name;
                that.userData.customFields = {};

                // $.cookie( 'fp-user-data', JSON.stringify( that.userData ), { expires: 2, path: '/' } );
                that.fetchCustomFields( 'comments_form', function() {
                  enableCommenting();

                  if( true === reload ) {
                    location.reload();
                  }
                } );
              }
            }).done( resolve ).fail( reject );
          } );
        },


        /**
         * Helper to determine whether user is coming from app;
         * if `true` we don't want to gate
         *
         * E.g.,
         * ```javascript
         * console.log(FP.Singletons.User.isFromApp());
         * // `true` or `false`
         * ```
         *
         * @return {Boolean}
         */
        isFromApp: function () {
          return isUserFromApp();
        },


        trackLoginData: function() {
          var that = this;

          // Set user group per subscription level
          var user_group = '';
          var subscriber_state = '';
          
          if( that.isInsider ) {
            user_group = 'insider_subscriber';
            subscriber_state = 'Subscribed - Insider';
          } else if( that.isPrem ) {
            user_group = 'premium_subscriber';
            subscriber_state = 'Subscribed - Premium';
          } else if( that.isSub ) {
            user_group = 'basic_subscriber';
            subscriber_state = 'Subscribed - Basic';
          } else if( that.isISpyPlus ) {
            user_group = 'i_spy_plus_user';
            subscriber_state = 'Subscribed - I Spy Plus';
          } else if( that.isReg ) {
            user_group = 'registered_user';
            subscriber_state = 'Registered';
          }

          // Continue if user is authenticated via Piano or IP/Link access
          if( '' !== user_group ) {

            var user_id = '';
            var event_category = '';

            if( FP.Singletons.UserAltAccess.isIPAccess ) {
              user_id = that.ipAccessData.client_guid;
              user_group = 'default-IP_access';
              event_category = 'IP';
            
            } else if( FP.Singletons.UserAltAccess.isLinkAccess ) {
              user_id = that.linkAccessData.ID;
              user_group = 'default-link_access';
              event_category = 'LinkAccess';
            
            } else {
              user_id = that.userData.uid;
              event_category = 'Piano';
            }

            // Send data to GA
            gtag('event', 'track_login', {'LID': user_id});
            gtag('event', 'track_login', {'RGRP': user_group});
            gtag('event', 'track_login', {'VID': user_id});
            
            dataLayer.push({
              'subscriberState': subscriber_state,
              'accessId': user_id,
              'accessGroup': user_group
            });

            // Send data to GA
            gtag('event', 'matchedSubscriber', {
              'event_category': event_category
            });
          } else {
            $('body').addClass('anon_user');
          }

          // Only send the ViewContent event on article pages
          if ( -1 < postDataPiano.indexOf( 'article' ) ) {
            if ( window.fbq ) {
              fbq( 'track', 'ViewContent', {
                article_content_tier: 'metered',
                is_subscriber: ( '' !== user_group && 'registered_user' !== user_group )
              } );
            }
          }
        },

      };

      FP.Singletons.User.setAccess();

    }]);
  }

  doc.on('altAccessCheckComplete', function( event, postDataPianoFinal ) {
    initializePiano( postDataPianoFinal );
  });

  // |BEGIN INCLUDE TINYPASS JS|
  (function(src){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src=src;var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)})(pianoAPIFile);
  // |END   INCLUDE TINYPASS JS|

}(jQuery);
;
//~Singletons/UserAltAccess
//
// Helper funcs for evaluating alternate access - traffic from app, IP access, or link access
!function ($) {

  // Check for FP.Singletons instance
  FP.Singletons = FP.Singletons || {};

  FP.Singletons.UserAltAccess = {

    isIPAccess: false,
    isLinkAccess: false,
    ipAccessData: {},
    linkAccessData: {},

    isAltAccess: function () {
      var that = this; 

      new Promise(function (resolve, reject) {
        return Promise.all([
          that.getIpAccessData()
          /* that.getLinkAccessData() - REMOVED FOR NOW AS WE DON'T HAVE ANY LINK ACCESS CLIENTS */
        ])
          .then(function (results) {

            var ipAccessResults = results[0];
            that.isIPAccess = ipAccessResults.access;
            
            var postDataPianoFinal = postDataPiano;

            if( that.isIPAccess ) {
              // set user data
              that.ipAccessData = ipAccessResults;

              // Reset 'article' value to avoid triggering paywall
              for (var i = 0; i < postDataPianoFinal.length; i++) {
                if (postDataPianoFinal[i] == 'article') postDataPianoFinal[i] = 'article-ipaccess';
              }

              // Add a new Piano tag to allow user access to Insider content
              if( that.ipAccessData.access_level === 'Insider' ) {
                postDataPianoFinal.push('article-ipaccess-insider');
              }
            }

            /*
            REMOVED FOR NOW AS WE DON'T HAVE ANY LINK ACCESS CLIENTS

            var linkAccessResults = results[1];
            that.isLinkAccess = linkAccessResults.access;

            if( that.isLinkAccess ) {
              // set user data
              that.linkAccessData = linkAccessResults;
              // Reset 'article' value to avoid triggering paywall
              for (var i = 0; i < postDataPianoFinal.length; i++) {
                if (postDataPianoFinal[i] == 'article') postDataPianoFinal[i] = 'article-linkaccess';
              }
            }
            */

            $.event.trigger('altAccessCheckComplete', [ postDataPianoFinal ]);
            resolve(true);

          })
          .catch(function (results) {
            var ipAccessResults = results[0];
            that.isIPAccess = ipAccessResults.access;
            
            $.event.trigger('altAccessCheckComplete', [ postDataPiano ]);
            resolve(true);
          });
      });
      return;

    },


    /**
     * Get IP access data from server
     *
     * E.g.,
     * ```javascript
     * FP.Singletons.User.getIpAccessData(
     *   function (data) {
     *     // ...
     *   },
     *   function (reason) {
     *     // ...
     *   }
     * );
     * ```
     *
     * @return {Promise} {
     *   {Boolean}     access
     *   {null/String} access_type
     *   {Number}      expires
     *   {null/String} client_guid
     *   {null/String} message
     * }
     */
    getIpAccessData: FP.Utils.promise.once(getIpAccessDataHelper),


    /**
     * Get link access data from the server for the "Universal Link" concept
     *
     * E.g.,
     * ```javascript
     * FP.Singletons.User.getLinkAccessData().then(data => console.log(data));
     * // { access: false, message: '' }
     * ```
     *
     * @return {Promise} {
     *   {Number}  ID
     *   {Boolean} access
     *   {String}  message
     * }
     */
    getLinkAccessData: FP.Utils.promise.once(function (resolve, reject) {
      var accessToken = getLinkAccessToken();
      var cachedAccessToken = getCachedLinkAccessToken();
      if (!accessToken && !cachedAccessToken) {
        setTimeout(function () {
          resolve({
            ID: 0,
            access: false,
            message: '',
          });
        }, 10);
        return;
      }
      $.getJSON(FP.Utils.string.format(FP.Config.api.link_access, (accessToken || cachedAccessToken)))
        .done(function (data) {
          resolve(data);
          if (accessToken && accessToken !== cachedAccessToken) {
            setCachedLinkAccessToken(accessToken);
          }
        })
        .fail(reject);
    }),


    /**
     * Helper to determine whether user is coming from app;
     * if `true` we don't want to gate
     *
     * E.g.,
     * ```javascript
     * console.log(FP.Singletons.User.isFromApp());
     * // `true` or `false`
     * ```
     *
     * @return {Boolean}
     */
    isFromApp: (function () {
      var isFromApp = (
        'true' === FP.Utils.url.getUrlParameter('app')
      );
      return function () {
        return isFromApp;
      };
    })(),

  };

  FP.Singletons.UserAltAccess.isAltAccess();


  //=Constants
  var LOCALSTORAGE_ENC_KEY = 'FP-ip-access--enc';
  var LOCALSTORAGE_LINK_ACCESS_KEY = 'FP-link-access--data';
  var EXPIRATION_LINK_ACCESS_DATA = 1e3 * 60 * 60 * 24; //=24 hours in milliseconds
  
  /**
   * Helper to retrieve IP access data
   *
   * @param {Function} resolve
   * @param {Function} reject
   */
  function getIpAccessDataHelper (resolve, reject) {
    // Retrieve data from server
    var data = {};
    var enc = window.localStorage.getItem(LOCALSTORAGE_ENC_KEY);
    if (enc) {
      data.enc = enc;
    } else {
      data.proxy_host = document.location.hostname;
    }

    $.ajax({
      type: "POST",
      url: FP.Config.api.ip_access,
      data: data,    
      timeout: 3000,
      success: function( response ) {
        if (response.enc) {
          window.localStorage.setItem(LOCALSTORAGE_ENC_KEY, response.enc);
        } else {
          window.localStorage.removeItem(LOCALSTORAGE_ENC_KEY);
        }
        resolve(response.pay);
      },
      error: function( jqXHR, textStatus, errorThrown ) {
        window.localStorage.removeItem(LOCALSTORAGE_ENC_KEY);
      }
    })
    .done( resolve )
    .fail(function () {
      reject([{
        access: false,
        access_type: null,
        expires: -1,
        client_guid: null,
        message: null
      }]);
    });
  }


  /**
   * Helper to get link access token match from URL hash
   *
   * @return {String}
   */
  function getLinkAccessToken () {
    var result = /(?:^k|\Wk)\/([%.~\w-]+)\//.exec(document.location.hash);
    return (result !== null && result[1]) || '';
  }


  /**
   * Helper to get cached link access token if available
   *
   * @return {String}
   */
  function getCachedLinkAccessToken () {
    var cachedData = JSON.parse(window.localStorage.getItem(LOCALSTORAGE_LINK_ACCESS_KEY));
    if (
      !cachedData ||
      !cachedData.token ||
      !cachedData.expires ||
      (new Date()).getTime() >= cachedData.expires
    ) {
      window.localStorage.removeItem(LOCALSTORAGE_LINK_ACCESS_KEY);
      return '';
    }
    return cachedData.token;
  }


  /**
   * Helper to set cached link access token
   *
   * @param {String} accessToken
   */
  function setCachedLinkAccessToken (accessToken) {
    if (!accessToken) {
      return;
    }
    window.localStorage.setItem(LOCALSTORAGE_LINK_ACCESS_KEY, JSON.stringify({
      token: accessToken,
      expires: (new Date()).getTime() + EXPIRATION_LINK_ACCESS_DATA
    }));
  }


  /**
   * Helper to show IP message to specific users
   *
   * @param {String} ipAccessRecord
   */
  function showIPMessage (ipAccessRecord) {
    var guidsToTarget = [
      '02ec422849c64bce852ddd1d0fef7dc2', // Ministry of Defence UK
      '54635fd3a57e4780aa661658f73f4ad2', // Australian Department of Foreign Affairs
      'dbaeae4f0b5442ef8a26a5aaeb65f87c', // Congressional Research Service
      'e4f4504bcb754855a923152216edf04b', // Council de EU
      '30863845273342dcaee3e48f86ce4990', // Canadian Parliament
    ];
    if( guidsToTarget.indexOf(ipAccessRecord.client_guid) > -1 ) {
      $('.ip-access-note-in-post').show();
    }
  }

}(jQuery);;
!function(c){var u={ids:{werent_looking:"244",latin_america_brief:"530",africa_brief:"529",china:"82",south_asia:"83",morning_brief:"16",situation_report:"17",security_brief_plus:"65",editors_picks:"14",flash_points:"15",fp_this_week:"297",un_brief:"46",insider_email_capture:"169",news_alerts:"180",ispy_notify:"205",climate_security_report:"261",business:"424",events:"282",marketing:"45",globaloptout:"globaloptout"},messages:{alreadyThere:'<p class="success-message">Thank you for signing up to receive this newsletter.</p>',unsubscribe:'<p class="success-message">You have been unsubscribed from this newsletter.</p>',thanks:'<p class="success-message">Thank you for signing up to receive this newsletter.</p>',error:'<p class="error-message">There was an error subscribing you to this newsletter. Please contact web@foreignpolicy.com for assistance.</p>'},getUrlParam:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");e=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))},init:function(){u.isHomePage=!!c(".home").length,u.isManagePage=!!c(".email-address").length,u.isAlertsManagePage=!!c(".fp-manage-alerts-page").length,u.isEventsPage=!!c(".single-events").length,u.isNewslettersListPage=!!c(".newsletters-list-page").length,u.isNewsletterPage=!!c(".newsletters-page").length||u.isManagePage||u.isNewslettersListPage,u.loggedIn=void 0!==FP.Singletons.User.userData&&FP.Singletons.User.userData.email,u.isUnsub=u.isNewslettersListPage&&"1"===u.getUrlParam("unsub"),u.email=u.isUnsub?u.getEmailFromParam():u.loggedIn,u.checkLocation(),u.getSubscriber(u.email).then(function(){u.loadPage()})},checkLocation:function(){u.isNewslettersListPage&&!u.isUnsub&&(u.loggedIn?u.isManagePage||(window.location.href=window.location.origin+"/newsletters-manage"+document.location.search):u.isManagePage&&(window.location.href=window.location.origin+"/newsletters"+document.location.search))},getEmailFromParam:function(){return atob(u.getUrlParam("e"))},loadPage:function(){var e;u.isUnsub?u.User.recipientId?(e=u.email,u.unsubId=u.getUrlParam("newsletter_id"),e&&u.unsubId&&u.updateUserSubscription(e,u.unsubId,"UNSUB","").then(function(e){u.setLoggedInState()})):window.location.href=window.location.origin+window.location.pathname:u.loggedIn?u.setLoggedInState():u.setLoggedOutState(),(u.isNewslettersListPage||u.isEventsPage||u.isHomePage)&&u.newslettersListPageInit(),u.addEventListeners()},setLoggedInState:function(){u.setAccessLevelState(),u.setEmailState()},newslettersListPageInit:function(){var n;c(".newsletter-row").on("click",".newsletter-subscribe-toggle",function(e){u.handleSubscriptionClick(e,c(this).parent())}),c(".newsletters-unsub-confirm .close").on("click",function(e){c(".newsletters-unsub-confirm").remove()}),u.isHomePage&&(c(".newsletter-unit-signup input[type=email]").show(),c(".newsletter-unit-signup input[type=email]").on("focus",function(){c(this).parents(".newsletter-unit").find(".privacy-policy-acknowledge").css("display","flex")}),c(".newsletter-unit-signup .button--signup").on("click",function(){c(this).parents(".newsletter-unit").find(".privacy-policy-acknowledge").css("display","flex")}),c(".home.reg_user .required-checkbox, .home.sub_user .required-checkbox").attr("checked","checked")),u.isManagePage||(n=c("#primary-email-field"),c(".newsletter-enter-email form").on("submit",function(e){if(e.preventDefault(),!u.validateAccountForms(c(this)))return!1;var e=n.val(),t=(c('input[name="email"]').val(e),c(".newsletter-account-screen.active"));t.addClass("loading"),u.checkEmailHasSiteAccount(e).then(function(e){e=e.data.user_exists;t.removeClass("active loading"),e?u.promptSignIn():u.promptCreateAccount()})}),c(".newsletter-signin form").on("submit",function(e){e.preventDefault();var t=c(this);if(!u.validateAccountForms(t))return!1;var e=t.find("input[type=email]").val(),n=t.find("input[type=password]").val();u.userLogin(e,n).then(function(e){e=e.data;e.user_login?(document.cookie="__utp="+e.access_token+"; expires=-1; path=/; domain=."+encodeURI(hostURL),window.location.href=window.location.origin+"/newsletters-manage"+document.location.search):(u.showAccountFormErrors(t,['The information you entered does not match a <i>Foreign Policy</i> account. Please re-enter your information or <a class="create-account-link">create an account</a>.']),u.addEventListenersDynamic())})}),c(".newsletter-create-account form").on("submit",function(e){e.preventDefault();var t=c(this);if(!u.validateAccountForms(t))return!1;var e=t.find("input[type=email]").val(),n=t.find("input[type=password]").val(),s=t.find("input[name=firstname]").val(),i=t.find("input[name=lastname]").val(),a=t.find("input[name=org]").val(),r=t.find("input[name=jobtitle]").val();u.userRegister(e,n,s,i,a,r).then(function(e){e=e.data;e.user_created?(document.cookie="__utp="+e.access_token+"; expires=-1; path=/; domain=."+encodeURI(hostURL),window.location.href=window.location.origin+"/newsletters-manage"+document.location.search):"failed"===e.feedback?u.showAccountFormErrors(t,["Registration unsuccessful"]):"already_exists"===e.feedback&&(u.showAccountFormErrors(t,['This email is already associated with a <i>Foreign Policy</i> account. Please <a class="signin-account-link">login</a> to continue.']),u.addEventListenersDynamic())})}))},validateAccountForms:function(e){e.find(".form-feedback").find(".error-message").remove();var t=[],n=(e.closest(".newsletter-account-screen"),e.find('input[name="email"]')),s=e.find('input[name="password"]'),i=e.find('input[name="firstname"]'),a=e.find('input[name="lastname"]'),r=e.find('input[name="org"]'),o=e.find('input[name="jobtitle"]'),c=e.find('input[name="optin"]');return u.validateEmail(n.val())||t.push("Email address is invalid"),s.length&&s.val().length<8&&t.push("Password must be at least 8 characters"),[i,a,r,o].forEach(function(e){e.length&&(e.val()||t.push(e.attr("placeholder")+" is required"))}),c.length&&!c.is(":checked")&&t.push("Opt-in is required"),t&&u.showAccountFormErrors(e,t),!t.length},showAccountFormErrors:function(e,t){e=e.find(".form-feedback");""!==t.join("<br>")&&u.showError(e,null,null,'<span class="error-message">'+t.join("<br>")+"</span>")},checkEmailHasSiteAccount:function(e){return c.ajax({url:"/piano-user-check/results/",data:{__fp_endpoint_piano_ajax:1,__fp_endpoint_piano_action:"email",__fp_endpoint_piano_user_email:e},cache:!0})},userLogin:function(e,t){return c.ajax({url:"/piano-user-check/results/",data:{__fp_endpoint_piano_ajax:1,__fp_endpoint_piano_action:"login",__fp_endpoint_piano_user_email:e,__fp_endpoint_piano_user_password:t},cache:!0})},userRegister:function(e,t,n,s,i,a){return c.ajax({url:"/piano-user-check/results/",data:{__fp_endpoint_piano_ajax:1,__fp_endpoint_piano_action:"register",__fp_endpoint_piano_user_email:e,__fp_endpoint_piano_user_password:t,__fp_endpoint_piano_user_firstname:n,__fp_endpoint_piano_user_lastname:s,__fp_endpoint_piano_user_org:i,__fp_endpoint_piano_user_jobtitle:a,__fp_endpoint_piano_user_consent:!0},cache:!0})},promptSignIn:function(){c(".newsletter-enter-email").removeClass("active"),c(".newsletter-signin").addClass("active")},promptCreateAccount:function(){c(".newsletter-create-account").addClass("active")},setAccessLevelState:function(){var e="newsletters-"+u.getUserAccessLevel(),t=u.isNewslettersListPage?c(".newsletters-list-page"):u.isAlertsManagePage?c(".fp-manage-alerts-page"):c(".newsletters-page");t.addClass(e)},getUserAccessLevel:function(){var e="anon";return u.loggedIn&&u.loggedIn===u.email?FP.Singletons.User.isInsider||FP.Singletons.User.isPrem?e="premium":FP.Singletons.User.isSub?e="basic":FP.Singletons.User.isReg&&(e="registered"):u.User&&("FPINSIDER"===u.User.subscriber_status||"FPPREMIUM"===u.User.subscriber_status?e="premium":"FPDIGITAL"===u.User.subscriber_status?e="basic":u.isUnsub&&(e="unsub")),e},setEmailState:function(){var e=c(".home-content").length,t=u.getUserEmail();t&&(u.isAlertsManagePage||e||u.isNewsletterPage)&&(c('label[for^="email-"]').hide(),c("input[type=email]").hide().val(t)),u.setSubscriptionStates(t)},getUserEmail:function(){var e="",t=u.isManagePage?c(".email-address"):null;return u.isManagePage&&(e=t.html(),e=u.validateEmail(e)?e:""),e||(e=FP.Singletons.User.userData.email,u.isManagePage&&t.text(encodeURI(e)).animate({width:"auto"},10)),e},validateEmail:function(e){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)},setSubscriptionStates:function(e){u.getSubscriber(e).then(function(){var e=u.User,t=e.address,n=e.recipientId,s=e.status;if(t&&"[]"!=t)if(u.isNewslettersListPage)for(var i in u.ids){i=u.ids[i];i===u.ids.globaloptout?u.setUserOptOut(i,s):u.setNewsletterState(n,i)}else c("[data-newsletter-id]").each(function(){var e=c(this).data("newsletter-id");u.setNewsletterState(n,e)});else u.showSignUpButtons()})},showSignUpButtons:function(e){e=e?c(".newsletter-"+e).find(".buttons"):c(".buttons");c(".loading-placeholder-smaller").hide(),e.animate({opacity:1})},setNewsletterState:function(e,t){u.getSubscriptionStatus(e,t).then(function(e){0!==e.data&&u.setNewsletterIsSubscribedState(t),u.showSignUpButtons(t)})},setNewsletterIsSubscribedState:function(e){var t;-1<["169","205","261"].indexOf(e.toString())||((t=c(".newsletter-"+e)).find(".button--subscribe").hide(),t.find(".button.button--signup").hide(),t.find(".privacy-policy-acknowledge").hide(),t.find(".signed-up").show(),"244"==e&&t.find("input[type=email]").hide(),c(".newsletter-unit-signup").length&&c(".newsletter-unit-signup .newsletter-"+e+" .hide-from-newsletter-subscriber").hide())},setLoggedOutState:function(){c(".newsletters-page, .fp-manage-alerts-page, .newsletters-list-page").addClass("newsletters-anon"),u.showSignUpButtons()},addEventListeners:function(){u.isNewslettersListPage||c(".button--signup, .button--unsubscribe").on("click",function(e){u.handleSubscriptionClick(e)}),c(".button--subscribe").on("click",function(e){u.showPianoSubscriptionModal(e)}),c(".account-link a").on("click",function(e){u.promptSignIn(e)})},addEventListenersDynamic:function(){c(".create-account-link").on("click",function(e){e.preventDefault(),c(".newsletter-account-screen.active").removeClass("active loading"),u.promptCreateAccount()}),c(".signin-account-link").on("click",function(e){e.preventDefault(),c(".newsletter-create-account.active").removeClass("active loading"),c(".newsletter-signin input[type=email]").val(c(".newsletter-create-account input[type=email]").val()),u.promptSignIn(e)})},showPianoSubscriptionModal:function(e){e.preventDefault(),tp.push(["init",function(){tp.offer.show({offerId:"OFWUSFZOD5I1",templateId:"OTFTNEX7N0MK",displayMode:"modal"})}])},handleSubscriptionClick:function(e,n){e.preventDefault();var s=(n=n||c(e.target)).hasClass("button--unsubscribe")?"UNSUB":"NORMAL",i=n.html(),a=(n.html("Loading..."),n.data("newsletter-id")),r=n.data("sourceid")||"",o=n.siblings("input[type=email]").val()||c("#email-"+a).val(),e=u.getFormErrors(o);return e.length?(u.showError(c("#form-feedback-"+a),n,i,'<span class="error-message">'+e.join(" ")+"</span>"),!1):u.getSubscriber(o).then(function(){var e=u.User,t=e.address||o,e=e.recipientId;u.manageSubscription(t,e,s,a,r,n,i)})},getFormErrors:function(e){var t=[],n=c(".required-checkbox");return u.validateEmail(e)||t.push("You entered an invalid email address. Please try again."),n.length&&!u.validateCheckboxCheck(n)&&t.push("Please agree to the Privacy Policy and Terms of Use."),t},validateCheckboxCheck:function(e){return e.is(":checked")},getSubscriber:function(e){var t;return!u.User&&e&&(t=c.ajax({url:"/postup-email-check/results/",data:{s:e,__fp_endpoint_postup_email_check:1,__fp_endpoint_postup_email_address:1},cache:!0})),c.when(t).done(function(e){e&&e.success&&(e=e.data,u.User=e)})},getSubscriptionStatus:function(e,t){return u.isUnsub&&u.unsubId===t?(getStatus=c.Deferred()).resolve({success:!0,data:0}):getStatus=c.ajax({url:"/postup-newsletter-check/results/",data:{s:e,nl_id:t,__fp_endpoint_postup_newsletter_check:1,__fp_endpoint_postup_email_address:1},cache:!0}),getStatus},manageSubscription:function(t,e,n,s,i,a,r){e?"UNSUB"===n?u.manageUser(t,s,"",n,a,r):u.getSubscriptionStatus(e,s).then(function(e){0===e.data?u.manageUser(t,s,i,n,a,r):u.confirmAlreadySubscribed(s,a,r)}):u.manageUser(t,s,i,n,a,r)},manageUser:function(e,t,n,s,i,a){var r=t===u.ids.globaloptout,e=r?u.updateUserOptOut(e,s):u.updateUserSubscription(e,t,s,n);return e.then(function(e){e=e.data;(r?e.status&&"error"!==e.status:0<e.numNewsletters)?u.confirmSubscriptionChange(t,s,i,a):u.showError(c("#form-feedback-"+t),i,a,u.messages.error)})},updateUserOptOut:function(e,t){return c.ajax({url:"/postup-user-subscribe/results/",data:{s:e,subscribe_status:t,ip:"0.0.0.0",ip_org:"none",__fp_endpoint_postup_optout:1},cache:!0})},setUserOptOut:function(e,t){"U"===t&&u.setNewsletterIsSubscribedState(e),u.showSignUpButtons(e)},updateUserSubscription:function(e,t,n,s){return c.ajax({url:"/postup-user-subscribe/results/",data:{s:e,nl_id:t,subscribe_status:n,ip:"0.0.0.0",ip_org:"none",source_id:s,__fp_endpoint_postup_newsletter_subscribe:1,__fp_endpoint_postup_email_subscribe:1},cache:!0})},confirmAlreadySubscribed:function(e,t,n){var s=-1<["169","14","205","244","261"].indexOf(e)||c(".category-newsletter-signup").length;u.isNewslettersListPage?u.confirmSubscriptionChange(e,"NORMAL",t,n):s?u.confirmAlreadySubscribedSpecial(e):(u.isHomePage?(t.siblings(".form-feedback").html(u.messages.alreadyThere).fadeIn("fast"),setTimeout(function(){c(".newsletter-"+e).fadeOut()},1e3)):c("#form-feedback-"+e).html(u.messages.alreadyThere).fadeIn("fast"),t.html(n))},confirmAlreadySubscribedSpecial:function(e){var t=c(".newsletter-"+e);c("#form-feedback-"+e).hide(),t.find("input[type=email]").hide(),t.find(".button.button--signup").hide(),t.find(".privacy-policy-acknowledge").hide(),t.find(".signed-up").show()},confirmSubscriptionChange:function(e,t,n,s){c("#form-feedback-"+e).html("").fadeOut("fast"),"UNSUB"===t?u.confirmUnsub(e,n,s):u.confirmSub(e,n,s)},confirmUnsub:function(e,t,n){var s=c(".newsletter-"+e);s.find(".signed-up").fadeOut("fast",function(){s.find(".button--signup").fadeIn("fast").addClass("active"),t.html(n),FP.Singletons.User.userData.email||s.find("input[type=email]").fadeIn("fast")})},confirmSub:function(e,t,n){var s=c(".newsletter-"+e);s.find("input[type=email]").fadeOut("fast",function(){s.find(".button--signup").fadeOut("fast",function(){c("input[type=email]").val(s.find("input[type=email]").val()),s.find(".privacy-policy-acknowledge").hide(),s.find(".signed-up").fadeIn("fast"),t.html(n)}).removeClass("active")})},showError:function(e,t,n,s){e.html(s).fadeIn("fast"),t&&n&&t.html(n)}};function e(){(c("input[type=email]").length||c(".form-feedback").length)&&u.init()}FP.Newsletters=u,FP.Singletons.User?e():c(document).on("pianoAccessCheckComplete takeoverRendered",e)}(jQuery);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5ld3NsZXR0ZXItc2lnbnVwLmpzIl0sIm5hbWVzIjpbIiQiLCJOZXdzbGV0dGVycyIsImlkcyIsIndlcmVudF9sb29raW5nIiwibGF0aW5fYW1lcmljYV9icmllZiIsImFmcmljYV9icmllZiIsImNoaW5hIiwic291dGhfYXNpYSIsIm1vcm5pbmdfYnJpZWYiLCJzaXR1YXRpb25fcmVwb3J0Iiwic2VjdXJpdHlfYnJpZWZfcGx1cyIsImVkaXRvcnNfcGlja3MiLCJmbGFzaF9wb2ludHMiLCJmcF90aGlzX3dlZWsiLCJ1bl9icmllZiIsImluc2lkZXJfZW1haWxfY2FwdHVyZSIsIm5ld3NfYWxlcnRzIiwiaXNweV9ub3RpZnkiLCJjbGltYXRlX3NlY3VyaXR5X3JlcG9ydCIsImJ1c2luZXNzIiwiZXZlbnRzIiwibWFya2V0aW5nIiwiZ2xvYmFsb3B0b3V0IiwibWVzc2FnZXMiLCJhbHJlYWR5VGhlcmUiLCJ1bnN1YnNjcmliZSIsInRoYW5rcyIsImVycm9yIiwiZ2V0VXJsUGFyYW0iLCJuYW1lIiwicmVwbGFjZSIsInJlc3VsdHMiLCJSZWdFeHAiLCJleGVjIiwibG9jYXRpb24iLCJzZWFyY2giLCJkZWNvZGVVUklDb21wb25lbnQiLCJpbml0IiwiaXNIb21lUGFnZSIsImxlbmd0aCIsImlzTWFuYWdlUGFnZSIsImlzQWxlcnRzTWFuYWdlUGFnZSIsImlzRXZlbnRzUGFnZSIsImlzTmV3c2xldHRlcnNMaXN0UGFnZSIsImlzTmV3c2xldHRlclBhZ2UiLCJsb2dnZWRJbiIsIkZQIiwiU2luZ2xldG9ucyIsIlVzZXIiLCJ1c2VyRGF0YSIsImVtYWlsIiwiaXNVbnN1YiIsImdldEVtYWlsRnJvbVBhcmFtIiwiY2hlY2tMb2NhdGlvbiIsImdldFN1YnNjcmliZXIiLCJ0aGVuIiwibG9hZFBhZ2UiLCJ3aW5kb3ciLCJocmVmIiwib3JpZ2luIiwiZG9jdW1lbnQiLCJhdG9iIiwicmVjaXBpZW50SWQiLCJ1bnN1YklkIiwidXBkYXRlVXNlclN1YnNjcmlwdGlvbiIsInJlc3AiLCJzZXRMb2dnZWRJblN0YXRlIiwicGF0aG5hbWUiLCJzZXRMb2dnZWRPdXRTdGF0ZSIsIm5ld3NsZXR0ZXJzTGlzdFBhZ2VJbml0IiwiYWRkRXZlbnRMaXN0ZW5lcnMiLCJzZXRBY2Nlc3NMZXZlbFN0YXRlIiwic2V0RW1haWxTdGF0ZSIsIiRlbWFpbCIsIm9uIiwiZSIsImhhbmRsZVN1YnNjcmlwdGlvbkNsaWNrIiwidGhpcyIsInBhcmVudCIsInJlbW92ZSIsInNob3ciLCJwYXJlbnRzIiwiZmluZCIsImNzcyIsImF0dHIiLCJwcmV2ZW50RGVmYXVsdCIsInZhbGlkYXRlQWNjb3VudEZvcm1zIiwidmFsIiwiJGFjdGl2ZUFjY291bnRTY3JlZW4iLCJhZGRDbGFzcyIsImNoZWNrRW1haWxIYXNTaXRlQWNjb3VudCIsImhhc0FjY291bnQiLCJkYXRhIiwidXNlcl9leGlzdHMiLCJyZW1vdmVDbGFzcyIsInByb21wdFNpZ25JbiIsInByb21wdENyZWF0ZUFjY291bnQiLCIkZm9ybSIsInBhc3N3b3JkIiwidXNlckxvZ2luIiwidXNlcl9sb2dpbiIsImNvb2tpZSIsImFjY2Vzc190b2tlbiIsImVuY29kZVVSSSIsImhvc3RVUkwiLCJzaG93QWNjb3VudEZvcm1FcnJvcnMiLCJhZGRFdmVudExpc3RlbmVyc0R5bmFtaWMiLCJmaXJzdG5hbWUiLCJsYXN0bmFtZSIsIm9yZyIsImpvYnRpdGxlIiwidXNlclJlZ2lzdGVyIiwidXNlcl9jcmVhdGVkIiwiZmVlZGJhY2siLCJlcnJvcnMiLCJjbG9zZXN0IiwiJHBhc3N3b3JkIiwiJGZpcnN0bmFtZSIsIiRsYXN0bmFtZSIsIiRvcmciLCIkam9idGl0bGUiLCIkb3B0aW4iLCJ2YWxpZGF0ZUVtYWlsIiwicHVzaCIsImZvckVhY2giLCIkZWwiLCJpcyIsIiRlcnJvckNvbnRhaW5lciIsImpvaW4iLCJzaG93RXJyb3IiLCJhamF4IiwidXJsIiwiX19mcF9lbmRwb2ludF9waWFub19hamF4IiwiX19mcF9lbmRwb2ludF9waWFub19hY3Rpb24iLCJfX2ZwX2VuZHBvaW50X3BpYW5vX3VzZXJfZW1haWwiLCJjYWNoZSIsIl9fZnBfZW5kcG9pbnRfcGlhbm9fdXNlcl9wYXNzd29yZCIsIl9fZnBfZW5kcG9pbnRfcGlhbm9fdXNlcl9maXJzdG5hbWUiLCJfX2ZwX2VuZHBvaW50X3BpYW5vX3VzZXJfbGFzdG5hbWUiLCJfX2ZwX2VuZHBvaW50X3BpYW5vX3VzZXJfb3JnIiwiX19mcF9lbmRwb2ludF9waWFub191c2VyX2pvYnRpdGxlIiwiX19mcF9lbmRwb2ludF9waWFub191c2VyX2NvbnNlbnQiLCJjbGFzc05hbWUiLCJnZXRVc2VyQWNjZXNzTGV2ZWwiLCIkcGFyZW50UGFnZUNvbnRhaW5lciIsImFjY2VzcyIsImlzSW5zaWRlciIsImlzUHJlbSIsImlzU3ViIiwiaXNSZWciLCJzdWJzY3JpYmVyX3N0YXR1cyIsInVzZXJFbWFpbCIsImdldFVzZXJFbWFpbCIsImhpZGUiLCJzZXRTdWJzY3JpcHRpb25TdGF0ZXMiLCJodG1sIiwidGV4dCIsImFuaW1hdGUiLCJ3aWR0aCIsInRlc3QiLCJhZGRyZXNzIiwidXNlcklkIiwic3RhdHVzIiwia2V5IiwibmV3c2xldHRlcklkIiwic2V0VXNlck9wdE91dCIsInNldE5ld3NsZXR0ZXJTdGF0ZSIsImVhY2giLCJpZCIsInNob3dTaWduVXBCdXR0b25zIiwiJGJ1dHRvbnMiLCJvcGFjaXR5IiwiZ2V0U3Vic2NyaXB0aW9uU3RhdHVzIiwic2V0TmV3c2xldHRlcklzU3Vic2NyaWJlZFN0YXRlIiwiJG5ld3NsZXR0ZXIiLCJpbmRleE9mIiwidG9TdHJpbmciLCJzaG93UGlhbm9TdWJzY3JpcHRpb25Nb2RhbCIsInRwIiwib2ZmZXIiLCJvZmZlcklkIiwidGVtcGxhdGVJZCIsImRpc3BsYXlNb2RlIiwiJGNsaWNrZWRFbCIsInN1YnNjcmliZVN0YXR1cyIsInRhcmdldCIsImhhc0NsYXNzIiwib3JpZ2luYWxDbGlja2VkRWxUZXh0IiwibmV3c2xldHRlclNvdXJjZSIsImlucHV0RW1haWwiLCJzaWJsaW5ncyIsImZvcm1FcnJvcnMiLCJnZXRGb3JtRXJyb3JzIiwibWFuYWdlU3Vic2NyaXB0aW9uIiwiJGNoZWNrYm94IiwidmFsaWRhdGVDaGVja2JveENoZWNrIiwiZ2V0VXNlciIsInMiLCJfX2ZwX2VuZHBvaW50X3Bvc3R1cF9lbWFpbF9jaGVjayIsIl9fZnBfZW5kcG9pbnRfcG9zdHVwX2VtYWlsX2FkZHJlc3MiLCJ3aGVuIiwiZG9uZSIsInN1Y2Nlc3MiLCJnZXRTdGF0dXMiLCJEZWZlcnJlZCIsInJlc29sdmUiLCJubF9pZCIsIl9fZnBfZW5kcG9pbnRfcG9zdHVwX25ld3NsZXR0ZXJfY2hlY2siLCJtYW5hZ2VVc2VyIiwiY29uZmlybUFscmVhZHlTdWJzY3JpYmVkIiwiaXNPcHRPdXRVcGRhdGUiLCJtYW5hZ2VBY3Rpb24iLCJ1cGRhdGVVc2VyT3B0T3V0IiwibnVtTmV3c2xldHRlcnMiLCJjb25maXJtU3Vic2NyaXB0aW9uQ2hhbmdlIiwic3Vic2NyaWJlX3N0YXR1cyIsImlwIiwiaXBfb3JnIiwiX19mcF9lbmRwb2ludF9wb3N0dXBfb3B0b3V0Iiwic291cmNlSWQiLCJzb3VyY2VfaWQiLCJfX2ZwX2VuZHBvaW50X3Bvc3R1cF9uZXdzbGV0dGVyX3N1YnNjcmliZSIsIl9fZnBfZW5kcG9pbnRfcG9zdHVwX2VtYWlsX3N1YnNjcmliZSIsImlzU3BlY2lhbCIsImNvbmZpcm1BbHJlYWR5U3Vic2NyaWJlZFNwZWNpYWwiLCJmYWRlSW4iLCJzZXRUaW1lb3V0IiwiZmFkZU91dCIsImNvbmZpcm1VbnN1YiIsImNvbmZpcm1TdWIiLCJlcnJvck1zZyIsImpRdWVyeSJdLCJtYXBwaW5ncyI6IkNBQUEsU0FBQUEsR0FPQSxJQUFBQyxFQUFBLENBQ0FDLElBQUEsQ0FDQUMsZUFBQSxNQUNBQyxvQkFBQSxNQUNBQyxhQUFBLE1BQ0FDLE1BQUEsS0FDQUMsV0FBQSxLQUNBQyxjQUFBLEtBQ0FDLGlCQUFBLEtBQ0FDLG9CQUFBLEtBQ0FDLGNBQUEsS0FDQUMsYUFBQSxLQUNBQyxhQUFBLE1BQ0FDLFNBQUEsS0FDQUMsc0JBQUEs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N0YsWUFBQSxhQVdBbUMsVUFBQSxTQUFBRixFQUFBd0QsRUFBQUksRUFBQTJDLEdBQ0F2RyxFQUFBNEIsS0FBQTJFLEdBQUFMLE9BQUEsUUFFQTFDLEdBQUFJLEdBQ0FKLEVBQUE1QixLQUFBZ0MsS0FhQSxTQUFBdEosS0FDQXJDLEVBQUEscUJBQ0F1QyxRQUFBdkMsRUFBQSxrQkFBQXVDLFNBR0F0QyxFQUFBb0MsT0FiQVMsR0FBQTdDLFlBQUFBLEVBRUE2QyxHQUFBQyxXQUFBQyxLQUNBWCxJQUVBckMsRUFBQTRELFVBQUFjLEdBQUEsNENBQUFyQyxHQXZtQ0EsQ0FtbkNBa00iLCJmaWxlIjoibmV3c2xldHRlci1zaWdudXAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiIWZ1bmN0aW9uKCQpe1xuXHQvKipcblx0ICogTWFuYWdlIG5ld3NsZXR0ZXIgc3Vic2NyaXB0aW9ucy5cblx0ICogQG5hbWVzcGFjZVxuXHQgKiBAcHJvcGVydHkge29iamVjdH0gaWRzICAgICAgLSBOZXdzbGV0dGVycyBhbmQgdGhlaXIgUG9zdFVwIGlkcy5cblx0ICogQHByb3BlcnR5IHtvYmplY3R9IG1lc3NhZ2VzIC0gSFRNTCBzdHJpbmdzIHVzZWQgZm9yIGZlZWRiYWNrLlxuXHQgKi9cblx0dmFyIE5ld3NsZXR0ZXJzID0ge1xuXHRcdGlkczoge1xuXHRcdFx0d2VyZW50X2xvb2tpbmcgICAgICAgICA6ICcyNDQnLCAgIC8vIFdoaWxlIFlvdSBXZXJlbuKAmXQgTG9va2luZ1xuXHRcdFx0bGF0aW5fYW1lcmljYV9icmllZiAgICA6ICc1MzAnLCAgIC8vIExhdGluIEFtZXJpY2EgQnJpZWYgXG5cdFx0XHRhZnJpY2FfYnJpZWYgICAgICAgICAgIDogJzUyOScsICAgLy8gQWZyaWNhIEJyaWVmXG5cdFx0XHRjaGluYSAgICAgICAgICAgICAgICAgIDogJzgyJywgICAgLy8gQ2hpbmEgQnJpZWZcblx0XHRcdHNvdXRoX2FzaWEgICAgICAgICAgICAgOiAnODMnLCAgICAvLyBTb3V0aCBBc2lhIEJyaWVmXG5cdFx0XHRtb3JuaW5nX2JyaWVmICAgICAgICAgIDogJzE2JywgICAgLy8gTW9ybmluZyBCcmllZiAvLyAnMicgaXMgbm9uLU9DIGxpc3Rcblx0XHRcdHNpdHVhdGlvbl9yZXBvcnQgICAgICAgOiAnMTcnLCAgICAvLyBTaXR1YXRpb24gUmVwb3J0LCBmb3JtZXJseSBTZWN1cml0eSBCcmllZiAvLyAnMycgaXMgbm9uLU9DIGxpc3Rcblx0XHRcdHNlY3VyaXR5X2JyaWVmX3BsdXMgICAgOiAnNjUnLCAgICAvLyBTZWN1cml0eSBCcmllZiBQbHVzIC8vIG5vIG5vbi1PQyBsaXN0XG5cdFx0XHRlZGl0b3JzX3BpY2tzICAgICAgICAgIDogJzE0JywgICAgLy8gRWRpdG9ycycgUGlja3MgLy8gJzUnIGlzIG5vbi1PQyBsaXN0XG5cdFx0XHRmbGFzaF9wb2ludHMgICAgICAgICAgIDogJzE1JywgICAgLy8gRmxhc2ggUG9pbnRzIC8vICc0JyBpcyBub24tT0MgbGlzdFxuXHRcdFx0ZnBfdGhpc193ZWVrICAgICAgICAgICA6ICcyOTcnLCAgIC8vIEZQIFRoaXMgV2Vla1xuXHRcdFx0dW5fYnJpZWYgICAgICAgICAgICAgICA6ICc0NicsICAgIC8vIFVOIEJyaWVmXG5cdFx0XHRpbnNpZGVyX2VtYWlsX2NhcHR1cmUgIDogJzE2OScsICAgLy8gSW5zaWRlciBMUCBDYXB0dXJlLVExMjBcblx0XHRcdG5ld3NfYWxlcnRzICAgICAgICAgICAgOiAnMTgwJywgICAvLyBOZXdzIEFsZXJ0cy1TaWduIFVwcy0yMDIwXG5cdFx0XHRpc3B5X25vdGlmeSAgICAgICAgICAgIDogJzIwNScsICAgLy8gR2V0IG5vdGlmaWVkIGFib3V0IHVwY29taW5nIElTUFkgZXBpc29kZXNcblx0XHRcdGNsaW1hdGVfc2VjdXJpdHlfcmVwb3J0OiAnMjYxJywgICAvLyBGUEEgQ2xpbWF0ZSAmIFNlY3VyaXR5IHJlcG9ydFxuXHRcdFx0YnVzaW5lc3MgICAgICAgICAgICAgICA6ICc0MjQnLCAgIC8vIEJ1c2luZXNzIERldmVsb3BtZW50IENvbW11bmljYXRpb25zIFxuXHRcdFx0ZXZlbnRzICAgICAgICAgICAgICAgICA6ICcyODInLCAgIC8vIEV2ZW50IENvbW11bmljYXRpb25zXG5cdFx0XHRtYXJrZXRpbmcgICAgICAgICAgICAgIDogJzQ1JywgICAgLy8gR2VuZXJhbCBNYXJrZXRpbmcgQ29tbXVuaWNhdGlvbnPCuFxuXHRcdFx0Z2xvYmFsb3B0b3V0ICAgICAgICAgICA6ICdnbG9iYWxvcHRvdXQnLCAvLyBVc2VkIGludGVybmFsbHksIG5vdCBhIFBvc3RVcCBpZFxuXHRcdH0sXG5cblx0XHRtZXNzYWdlczoge1xuXHRcdFx0YWxyZWFkeVRoZXJlOiAnPHAgY2xhc3M9XCJzdWNjZXNzLW1lc3NhZ2VcIj5UaGFuayB5b3UgZm9yIHNpZ25pbmcgdXAgdG8gcmVjZWl2ZSB0aGlzIG5ld3NsZXR0ZXIuPC9wPicsXG5cdFx0XHR1bnN1YnNjcmliZSA6ICc8cCBjbGFzcz1cInN1Y2Nlc3MtbWVzc2FnZVwiPllvdSBoYXZlIGJlZW4gdW5zdWJzY3JpYmVkIGZyb20gdGhpcyBuZXdzbGV0dGVyLjwvcD4nLFxuXHRcdFx0dGhhbmtzICAgICAgOiAnPHAgY2xhc3M9XCJzdWNjZXNzLW1lc3NhZ2VcIj5UaGFuayB5b3UgZm9yIHNpZ25pbmcgdXAgdG8gcmVjZWl2ZSB0aGlzIG5ld3NsZXR0ZXIuPC9wPicsXG5cdFx0XHRlcnJvciAgICAgICA6ICc8cCBjbGFzcz1cImVycm9yLW1lc3NhZ2VcIj5UaGVyZSB3YXMgYW4gZXJyb3Igc3Vic2NyaWJpbmcgeW91IHRvIHRoaXMgbmV3c2xldHRlci4gUGxlYXNlIGNvbnRhY3Qgd2ViQGZvcmVpZ25wb2xpY3kuY29tIGZvciBhc3Npc3RhbmNlLjwvcD4nXG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIEdldCBhIHBhcmFtZXRlciBmcm9tIHRoZSBVUkwuXG5cdFx0ICogU2luY2UgSUUgZG9lc24ndCBzdXBwb3J0IFVSTFNlYXJjaFBhcmFtcywgaGVyZSdzIHRoaXMgaGVscGVyIG1ldGhvZFxuXHRcdCAqIGluc3RlYWQuXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBQYXJhbWV0ZXIgbmFtZSB0byBnZXQgZnJvbSBVUkwuXG5cdFx0ICogQHJldHVybnMge3N0cmluZ30gUGFyYW1ldGVyIG5hbWUgdmFsdWUuIEVtcHR5IHN0cmluZyBpZiBubyB2YWx1ZS5cblx0XHQgKi9cblx0XHRnZXRVcmxQYXJhbTogZnVuY3Rpb24obmFtZSkge1xuXHRcdFx0bmFtZSA9IG5hbWUucmVwbGFjZSgvW1xcW10vLCAnXFxcXFsnKS5yZXBsYWNlKC9bXFxdXS8sICdcXFxcXScpO1xuXHRcdFx0dmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnW1xcXFw/Jl0nICsgbmFtZSArICc9KFteJiNdKiknKTtcblx0XHRcdHZhciByZXN1bHRzID0gcmVnZXguZXhlYyhsb2NhdGlvbi5zZWFyY2gpO1xuXHRcdFx0cmV0dXJuIHJlc3VsdHMgPT09IG51bGwgPyAnJyA6IGRlY29kZVVSSUNvbXBvbmVudChyZXN1bHRzWzFdLnJlcGxhY2UoL1xcKy9nLCAnICcpKTtcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogQ2FsbGVkIHdoZW4gcGFnZSBsb2FkcyBpZiB0aGVyZSBhcmUgZW1haWwgZmllbGRzIHByZXNlbnQuXG5cdFx0ICogU2V0cyBhdHRyaWJ1dGVzIG9uIE5ld3NsZXR0ZXJzIG9iamVjdC5cblx0XHQgKiBcblx0XHQgKiBDYWxscyB7QGxpbmsgTmV3c2xldHRlcnMuZ2V0U3Vic2NyaWJlcn0gdGhlbiB7QGxpbmsgTmV3c2xldHRlcnMubG9hZFBhZ2V9XG5cdFx0ICovXG5cdFx0aW5pdDogZnVuY3Rpb24oKSB7XG5cdFx0XHROZXdzbGV0dGVycy5pc0hvbWVQYWdlICAgICAgICAgICAgPSAhISQoJy5ob21lJykubGVuZ3RoO1xuXHRcdFx0TmV3c2xldHRlcnMuaXNNYW5hZ2VQYWdlICAgICAgICAgID0gISEkKCcuZW1haWwtYWRkcmVzcycpLmxlbmd0aDtcblx0XHRcdE5ld3NsZXR0ZXJzLmlzQWxlcnRzTWFuYWdlUGFnZSAgICA9ICEhJCgnLmZwLW1hbmFnZS1hbGVydHMtcGFnZScpLmxlbmd0aDtcblx0XHRcdE5ld3NsZXR0ZXJzLmlzRXZlbnRzUGFnZSBcdFx0ICA9ICEhJCgnLnNpbmdsZS1ldmVudHMnKS5sZW5ndGg7XG5cdFx0XHROZXdzbGV0dGVycy5pc05ld3NsZXR0ZXJzTGlzdFBhZ2UgPSAhISQoJy5uZXdzbGV0dGVycy1saXN0LXBhZ2UnKS5sZW5ndGg7XG5cdFx0XHROZXdzbGV0dGVycy5pc05ld3NsZXR0ZXJQYWdlICAgICAgPSAhISQoJy5uZXdzbGV0dGVycy1wYWdlJykubGVuZ3RoIHx8IE5ld3NsZXR0ZXJzLmlzTWFuYWdlUGFnZSB8fCBOZXdzbGV0dGVycy5pc05ld3NsZXR0ZXJzTGlzdFBhZ2U7XG5cdFx0XHROZXdzbGV0dGVycy5sb2dnZWRJbiAgICAgICAgICAgICAgPSAodHlwZW9mIEZQLlNpbmdsZXRvbnMuVXNlci51c2VyRGF0YSAhPT0gJ3VuZGVmaW5lZCcgJiYgRlAuU2luZ2xldG9ucy5Vc2VyLnVzZXJEYXRhLmVtYWlsKTtcblx0XHRcdE5ld3NsZXR0ZXJzLmlzVW5zdWIgICAgICAgICAgICAgICA9IE5ld3NsZXR0ZXJzLmlzTmV3c2xldHRlcnNMaXN0UGFnZSAmJiBOZXdzbGV0dGVycy5nZXRVcmxQYXJhbSgndW5zdWInKSA9PT0gJzEnO1xuXHRcdFx0TmV3c2xldHRlcnMuZW1haWwgICAgICAgICAgICAgICAgID0gTmV3c2xldHRlcnMuaXNVbnN1YiA/IE5ld3NsZXR0ZXJzLmdldEVtYWlsRnJvbVBhcmFtKCkgOiBOZXdzbGV0dGVycy5sb2dnZWRJbjtcblxuXHRcdFx0TmV3c2xldHRlcnMuY2hlY2tMb2NhdGlvbigpO1xuXHRcdFx0XG5cdFx0XHROZXdzbGV0dGVycy5nZXRTdWJzY3JpYmVyKE5ld3NsZXR0ZXJzLmVtYWlsKVxuXHRcdFx0LnRoZW4oZnVuY3Rpb24oKSB7XG5cdFx0XHRcdE5ld3NsZXR0ZXJzLmxvYWRQYWdlKCk7XG5cdFx0XHR9KVx0XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIENoZWNrcyBpZiBwYWdlIHNob3VsZCByZWRpcmVjdCBhbmQgZG9lcyBzbyBpZiBuZWNlc3NhcnkuXG5cdFx0ICogSWYgbG9nZ2VkIGluIGFuZCBvbiB0aGUgbmV3c2xldHRlciBwYWdlLCBnbyB0byB0aGUgbWFuYWdlIHBhZ2UuXG5cdFx0ICogSWYgbG9nZ2VkIG91dCBhbmQgb24gdGhlIG1hbmFnZSBwYWdlLCBnbyB0byB0aGUgbmV3c2xldHRlciBwYWdlLlxuXHRcdCAqL1xuXHRcdGNoZWNrTG9jYXRpb246IGZ1bmN0aW9uKCkge1xuXHRcdFx0aWYgKE5ld3NsZXR0ZXJzLmlzTmV3c2xldHRlcnNMaXN0UGFnZSAmJiAhTmV3c2xldHRlcnMuaXNVbnN1Yikge1xuXHRcdFx0XHRpZiAoTmV3c2xldHRlcnMubG9nZ2VkSW4pIHtcblx0XHRcdFx0XHRpZiAoIU5ld3NsZXR0ZXJzLmlzTWFuYWdlUGFnZSkge1xuXHRcdFx0XHRcdFx0d2luZG93LmxvY2F0aW9uLmhyZWYgPSB3aW5kb3cubG9jYXRpb24ub3JpZ2luICsgJy9uZXdzbGV0dGVycy1tYW5hZ2UnICsgZG9jdW1lbnQubG9jYXRpb24uc2VhcmNoO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRpZiAoTmV3c2xldHRlcnMuaXNNYW5hZ2VQYWdlKSB7XG5cdFx0XHRcdFx0XHR3aW5kb3cubG9jYXRpb24uaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4gKyAnL25ld3NsZXR0ZXJzJyAgKyBkb2N1bWVudC5sb2NhdGlvbi5zZWFyY2g7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIEdldHMgYW5kIGRlY29kZXMgZW1haWwgc2V0IGluIHVybC5cblx0XHQgKiBcblx0XHQgKiBAcmV0dXJucyB7c3RyaW5nfSBlbWFpbCBhZGRyZXNzO1xuXHRcdCAqL1xuXHRcdGdldEVtYWlsRnJvbVBhcmFtOiBmdW5jdGlvbigpIHtcblx0XHRcdHJldHVybiBhdG9iKE5ld3NsZXR0ZXJzLmdldFVybFBhcmFtKCdlJykpO1xuXHRcdH0sXG5cblx0XHQvKipcblx0XHQgKiBIYW5kbGVzIGxvYWRpbmcgdGhlIHBhZ2UgYmFzZWQgb24gYXR0cmlidXRlIHNldHRpbmdzLlxuXHRcdCAqIFxuXHRcdCAqIENoZWNrcyB3aGF0IHBhZ2Ugd2UncmUgb24gYW5kIGNoZWNrcyBpZiB1c2VyIGlzIGxvZ2dlZCBpbi5cblx0XHQgKiBDaGVja3MgaWYgdGhpcyBpcyBhbiB1bnN1YnNjcmliZSBhY3Rpb24uXG5cdFx0ICogXG5cdFx0ICogSWYgYW4gdW5zdWIgYWN0aW9uOlxuXHRcdCAqIC0gSWYgYSBuZXdzbGV0dGVyIHVzZXIgZXhpc3RzOlxuXHRcdCAqIC0gR2V0IHRoZSByZWxldmFudCBkYXRhIGZyb20gdGhlIFVSTCBhbmQgbWFrZSBjYWxsIHRvIHVuc3Vic2NyaWJlIHVzZXIuXG5cdFx0ICogLSBMb2FkIHRoZSBwYWdlIGFzIHRob3VnaCB1c2VyIGlzIGxvZ2dlZCBpbiAoY2FuIGVkaXQgZXhpc3Rpbmcgc3Vic2NyaXB0aW9ucylcblx0XHQgKiAtIElmIG5vIG5ld3NsZXR0ZXIgdXNlciBleGlzdHMgcmVkaXJlY3QgYXdheSBmcm9tIHVuc3ViIGFjdGlvblxuXHRcdCAqIFxuXHRcdCAqIElmIGxvZ2dlZCBvdXQ6XG5cdFx0ICogLSBJZiBvbiBuZXdzbGV0dGVycy1tYW5hZ2UgcGFnZSwgcmVkaXJlY3QgdG8gbmV3c2xldHRlcnMuXG5cdFx0ICogLSBFbHNlLCBjYWxsIHtAbGluayBOZXdzbGV0dGVycy5zZXRMb2dnZWRPdXRTdGF0ZX0uXG5cdFx0ICogLSBJZiBvbiBuZXdzbGV0dGVyIHBhZ2UsIGFsc28gY2FsbCB7QGxpbmsgTmV3c2xldHRlcnMubmV3c2xldHRlcnNQYWdlSW5pdH0uXG5cdFx0ICpcblx0XHQgKiBJZiBsb2dnZWQgaW46XG5cdFx0ICogLSBJZiBvbiBuZXdzbGV0dGVycywgcmVkaXJlY3QgdG8gbmV3c2xldHRlcnMtbWFuYWdlLlxuXHRcdCAqIC0gRWxzZSwgY2FsbCB7QGxpbmsgTmV3c2xldHRlcnMuc2V0QWNjZXNzTGV2ZWxTdGF0ZX0gYW5kIHtAbGluayBOZXdzbGV0dGVycy5zZXRFbWFpbFN0YXRlfS5cblx0XHQgKiBFeGNlcHQgZm9yIHJlZGlyZWN0cywgYWx3YXlzIGNhbGxzIHtAbGluayBOZXdzbGV0dGVycy5hZGRFdmVudExpc3RlbmVyc30uXG5cdFx0ICovXG5cdFx0bG9hZFBhZ2U6IGZ1bmN0aW9uKCkge1xuXHRcdFx0aWYgKE5ld3NsZXR0ZXJzLmlzVW5zdWIpIHtcblx0XHRcdFx0aWYgKE5ld3NsZXR0ZXJzLlVzZXIucmVjaXBpZW50SWQpIHtcblx0XHRcdFx0XHR2YXIgZW1haWwgPSBOZXdzbGV0dGVycy5lbWFpbDtcblxuXHRcdFx0XHRcdE5ld3NsZXR0ZXJzLnVuc3ViSWQgPSBOZXdzbGV0dGVycy5nZXRVcmxQYXJhbSgnbmV3c2xldHRlcl9pZCcpO1xuXG5cdFx0XHRcdFx0aWYgKGVtYWlsICYmIE5ld3NsZXR0ZXJzLnVuc3ViSWQpIHtcblx0XHRcdFx0XHRcdE5ld3NsZXR0ZXJzLnVwZGF0ZVVzZXJTdWJzY3JpcHRpb24oZW1haWwsIE5ld3NsZXR0ZXJzLnVuc3ViSWQsICdVTlNVQicsICcnKVxuXHRcdFx0XHRcdFx0LnRoZW4oZnVuY3Rpb24ocmVzcCkge1xuXHRcdFx0XHRcdFx0XHROZXdzbGV0dGVycy5zZXRMb2dnZWRJblN0YXRlKCk7XG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR3aW5kb3cubG9jYXRpb24uaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4gKyB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWU7XG5cdFx0XHRcdH1cblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGlmIChOZXdzbGV0dGVycy5sb2dnZWRJbikge1xuXHRcdFx0XHRcdE5ld3NsZXR0ZXJzLnNldExvZ2dlZEluU3RhdGUoKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHROZXdzbGV0dGVycy5zZXRMb2dnZWRPdXRTdGF0ZSgpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGlmIChOZXdzbGV0dGVycy5pc05ld3NsZXR0ZXJzTGlzdFBhZ2UgfHwgTmV3c2xldHRlcnMuaXNFdmVudHNQYWdlIHx8IE5ld3NsZXR0ZXJzLmlzSG9tZVBhZ2UpIHtcblx0XHRcdFx0TmV3c2xldHRlcnMubmV3c2xldHRlcnNMaXN0UGFnZUluaXQoKTtcblx0XHRcdH1cblxuXHRcdFx0TmV3c2xldHRlcnMuYWRkRXZlbnRMaXN0ZW5lcnMoKTtcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogU2V0IHRoZSBwYWdlIHRvIGEgbG9nZ2VkIGluIHN0YXRlLiBcblx0XHQgKi9cblx0XHRzZXRMb2dnZWRJblN0YXRlOiBmdW5jdGlvbigpIHtcblx0XHRcdE5ld3NsZXR0ZXJzLnNldEFjY2Vzc0xldmVsU3RhdGUoKTtcblx0XHRcdE5ld3NsZXR0ZXJzLnNldEVtYWlsU3RhdGUoKTtcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogQXR0YWNoZXMgZXZlbnQgbGlzdGVuZXJzIGZvciB0aGUgbmV3c2xldHRlciBsaXN0IHBhZ2VzLlxuXHRcdCAqIElmIG5vdCBgaXNNYW5hZ2VQYWdlYCBwYWdlOlxuXHRcdCAqICogVmFsaWRhdGVzIGVtYWlsIHdpdGgge0BsaW5rIE5ld3NsZXR0ZXJzLmdldEZvcm1FcnJvcnN9IGFuZCBjYWxsc1xuXHRcdCAqIHtAbGluayBOZXdzbGV0dGVycy5zaG93RXJyb3J9LlxuXHRcdCAqICogQ2FsbHMge0BsaW5rIE5ld3NsZXR0ZXJzLmNoZWNrRW1haWxIYXNTaXRlQWNjb3VudH0gdG8gY2hlY2sgaWYgZW1haWxcblx0XHQgKiBoYXMgYSBQaWFubyBhY2NvdW50LiBJZiBzbywgaXQgY2FsbHMge0BsaW5rIE5ld3NsZXR0ZXJzLnByb21wdFNpZ25Jbn0sXG5cdFx0ICogb3RoZXJ3aXNlIHtAbGluayBOZXdzbGV0dGVycy5wcm9tcHRDcmVhdGVBY2NvdW50fS5cblx0XHQgKiBAcGFyYW0ge2Jvb2xlYW59IGlzTWFuYWdlUGFnZSAtIElzIHRoaXMgdGhlIG5ld3NsZXR0ZXIgbWFuYWdlIHBhZ2UuXG5cdFx0ICovXG5cdFx0bmV3c2xldHRlcnNMaXN0UGFnZUluaXQ6IGZ1bmN0aW9uKCkge1xuXHRcdFx0Ly8gU3Vic2NyaXB0aW9uIGNoZWNrYm94ZXMgZm9yIG5ld3NsZXR0ZXIgbGlzdCBwYWdlXG5cdFx0XHQkKCcubmV3c2xldHRlci1yb3cnKS5vbignY2xpY2snLCAnLm5ld3NsZXR0ZXItc3Vic2NyaWJlLXRvZ2dsZScsIGZ1bmN0aW9uKGUpIHtcblx0XHRcdFx0TmV3c2xldHRlcnMuaGFuZGxlU3Vic2NyaXB0aW9uQ2xpY2soZSwgJCh0aGlzKS5wYXJlbnQoKSk7XG5cdFx0XHR9KTtcblxuXHRcdFx0JCgnLm5ld3NsZXR0ZXJzLXVuc3ViLWNvbmZpcm0gLmNsb3NlJykub24oJ2NsaWNrJywgZnVuY3Rpb24oZSkge1xuXHRcdFx0XHQkKCcubmV3c2xldHRlcnMtdW5zdWItY29uZmlybScpLnJlbW92ZSgpO1xuXHRcdFx0fSk7XG5cblx0XHRcdGlmICggTmV3c2xldHRlcnMuaXNIb21lUGFnZSApIHtcblx0XHRcdFx0JCggJy5uZXdzbGV0dGVyLXVuaXQtc2lnbnVwIGlucHV0W3R5cGU9ZW1haWxdJyApLnNob3coKTtcblxuXHRcdFx0XHQkKCAnLm5ld3NsZXR0ZXItdW5pdC1zaWdudXAgaW5wdXRbdHlwZT1lbWFpbF0nICkub24oICdmb2N1cycsIGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHQkKCB0aGlzICkucGFyZW50cyggJy5uZXdzbGV0dGVyLXVuaXQnICkuZmluZCggJy5wcml2YWN5LXBvbGljeS1hY2tub3dsZWRnZScgKS5jc3MoICdkaXNwbGF5JywgJ2ZsZXgnICk7XG5cdFx0XHRcdH0gKTtcblx0XHRcdFx0JCggJy5uZXdzbGV0dGVyLXVuaXQtc2lnbnVwIC5idXR0b24tLXNpZ251cCcgKS5vbiggJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdCQoIHRoaXMgKS5wYXJlbnRzKCAnLm5ld3NsZXR0ZXItdW5pdCcgKS5maW5kKCAnLnByaXZhY3ktcG9saWN5LWFja25vd2xlZGdlJyApLmNzcyggJ2Rpc3BsYXknLCAnZmxleCcgKTtcblx0XHRcdFx0fSApO1xuXG5cdFx0XHRcdCQoICcuaG9tZS5yZWdfdXNlciAucmVxdWlyZWQtY2hlY2tib3gsIC5ob21lLnN1Yl91c2VyIC5yZXF1aXJlZC1jaGVja2JveCcgKS5hdHRyKCAnY2hlY2tlZCcsICdjaGVja2VkJyApO1xuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHRpZiAoIU5ld3NsZXR0ZXJzLmlzTWFuYWdlUGFnZSkge1xuXHRcdFx0XHR2YXIgJGVtYWlsID0gJCgnI3ByaW1hcnktZW1haWwtZmllbGQnKTtcblxuXHRcdFx0XHQkKCcubmV3c2xldHRlci1lbnRlci1lbWFpbCBmb3JtJykub24oJ3N1Ym1pdCcsIGZ1bmN0aW9uKGUpIHtcblx0XHRcdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdFx0XHRpZiAoIU5ld3NsZXR0ZXJzLnZhbGlkYXRlQWNjb3VudEZvcm1zKCQodGhpcykpKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdHZhciBlbWFpbCA9ICRlbWFpbC52YWwoKTtcblxuXHRcdFx0XHRcdFx0JCgnaW5wdXRbbmFtZT1cImVtYWlsXCJdJykudmFsKGVtYWlsKTtcblxuXHRcdFx0XHRcdFx0dmFyICRhY3RpdmVBY2NvdW50U2NyZWVuID0gJCgnLm5ld3NsZXR0ZXItYWNjb3VudC1zY3JlZW4uYWN0aXZlJyk7XG5cdFx0XHRcdFx0XHQkYWN0aXZlQWNjb3VudFNjcmVlbi5hZGRDbGFzcygnbG9hZGluZycpO1xuXG5cdFx0XHRcdFx0XHROZXdzbGV0dGVycy5jaGVja0VtYWlsSGFzU2l0ZUFjY291bnQoZW1haWwpXG5cdFx0XHRcdFx0XHQudGhlbihmdW5jdGlvbihyZXNwKSB7XG5cdFx0XHRcdFx0XHRcdHZhciByZXN1bHRzICAgID0gcmVzcC5kYXRhO1xuXHRcdFx0XHRcdFx0XHR2YXIgaGFzQWNjb3VudCA9IHJlc3VsdHMudXNlcl9leGlzdHM7XG5cblx0XHRcdFx0XHRcdFx0JGFjdGl2ZUFjY291bnRTY3JlZW4ucmVtb3ZlQ2xhc3MoJ2FjdGl2ZSBsb2FkaW5nJyk7XG5cblx0XHRcdFx0XHRcdFx0aWYgKGhhc0FjY291bnQpIHtcblx0XHRcdFx0XHRcdFx0XHROZXdzbGV0dGVycy5wcm9tcHRTaWduSW4oKTtcblx0XHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0XHROZXdzbGV0dGVycy5wcm9tcHRDcmVhdGVBY2NvdW50KCk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cblx0XHRcdFx0JCgnLm5ld3NsZXR0ZXItc2lnbmluIGZvcm0nKS5vbignc3VibWl0JywgZnVuY3Rpb24oZSkge1xuXHRcdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0XHRcdHZhciAkZm9ybSAgICA9ICQodGhpcyk7XG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0aWYgKCFOZXdzbGV0dGVycy52YWxpZGF0ZUFjY291bnRGb3JtcygkZm9ybSkpIHtcblx0XHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0XHR9IGVsc2Uge1x0XHRcdFx0XHRcblx0XHRcdFx0XHRcdHZhciBlbWFpbCAgICA9ICRmb3JtLmZpbmQoJ2lucHV0W3R5cGU9ZW1haWxdJykudmFsKCk7XG5cdFx0XHRcdFx0XHR2YXIgcGFzc3dvcmQgPSAkZm9ybS5maW5kKCdpbnB1dFt0eXBlPXBhc3N3b3JkXScpLnZhbCgpO1xuXG5cdFx0XHRcdFx0XHROZXdzbGV0dGVycy51c2VyTG9naW4oZW1haWwsIHBhc3N3b3JkKVxuXHRcdFx0XHRcdFx0LnRoZW4oZnVuY3Rpb24ocmVzcCkge1xuXHRcdFx0XHRcdFx0XHR2YXIgcmVzdWx0cyAgICAgID0gcmVzcC5kYXRhO1xuXHRcdFx0XHRcdFx0XHR2YXIgbG9naW5fc3RhdHVzID0gcmVzdWx0cy51c2VyX2xvZ2luO1xuXG5cdFx0XHRcdFx0XHRcdGlmICghbG9naW5fc3RhdHVzKSB7XG5cdFx0XHRcdFx0XHRcdFx0Ly8gdW5zdWNjZXNzZnVsIGxvZ2luXG5cdFx0XHRcdFx0XHRcdFx0TmV3c2xldHRlcnMuc2hvd0FjY291bnRGb3JtRXJyb3JzKCRmb3JtLCBbJ1RoZSBpbmZvcm1hdGlvbiB5b3UgZW50ZXJlZCBkb2VzIG5vdCBtYXRjaCBhIDxpPkZvcmVpZ24gUG9saWN5PC9pPiBhY2NvdW50LiBQbGVhc2UgcmUtZW50ZXIgeW91ciBpbmZvcm1hdGlvbiBvciA8YSBjbGFzcz1cImNyZWF0ZS1hY2NvdW50LWxpbmtcIj5jcmVhdGUgYW4gYWNjb3VudDwvYT4uJ10pO1xuXHRcdFx0XHRcdFx0XHRcdE5ld3NsZXR0ZXJzLmFkZEV2ZW50TGlzdGVuZXJzRHluYW1pYygpO1xuXHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdC8vIHJlZ2lzdGVyIGxvZ2luIHdpdGggUGlhbm8gYW5kIHNldCBjb29raWVcblx0XHRcdFx0XHRcdFx0XHRkb2N1bWVudC5jb29raWUgPSBcIl9fdXRwPVwiICsgcmVzdWx0cy5hY2Nlc3NfdG9rZW4gKyBcIjsgZXhwaXJlcz0tMTtcIiArXG5cdFx0XHRcdFx0XHRcdFx0XCIgcGF0aD0vOyBkb21haW49LlwiICsgZW5jb2RlVVJJKCBob3N0VVJMICk7XG5cdFx0XHRcdFx0XHRcdFx0Ly8gcmVkaXJlY3QgdXNlciB0byBtYW5hZ2UgcGFnZVxuXHRcdFx0XHRcdFx0XHRcdHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gd2luZG93LmxvY2F0aW9uLm9yaWdpbiArICcvbmV3c2xldHRlcnMtbWFuYWdlJyArIGRvY3VtZW50LmxvY2F0aW9uLnNlYXJjaDtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHQkKCcubmV3c2xldHRlci1jcmVhdGUtYWNjb3VudCBmb3JtJykub24oJ3N1Ym1pdCcsIGZ1bmN0aW9uKGUpIHtcblx0XHRcdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRcdFx0XHR2YXIgJGZvcm0gPSAkKHRoaXMpO1xuXG5cdFx0XHRcdFx0aWYgKCFOZXdzbGV0dGVycy52YWxpZGF0ZUFjY291bnRGb3JtcygkZm9ybSkpIHtcblx0XHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0dmFyIGVtYWlsIFx0ICA9ICRmb3JtLmZpbmQoJ2lucHV0W3R5cGU9ZW1haWxdJykudmFsKCk7XG5cdFx0XHRcdFx0XHR2YXIgcGFzc3dvcmQgID0gJGZvcm0uZmluZCgnaW5wdXRbdHlwZT1wYXNzd29yZF0nKS52YWwoKTtcblx0XHRcdFx0XHRcdHZhciBmaXJzdG5hbWUgPSAkZm9ybS5maW5kKCdpbnB1dFtuYW1lPWZpcnN0bmFtZV0nKS52YWwoKTtcblx0XHRcdFx0XHRcdHZhciBsYXN0bmFtZSAgPSAkZm9ybS5maW5kKCdpbnB1dFtuYW1lPWxhc3RuYW1lXScpLnZhbCgpO1xuXHRcdFx0XHRcdFx0dmFyIG9yZyBcdCAgPSAkZm9ybS5maW5kKCdpbnB1dFtuYW1lPW9yZ10nKS52YWwoKTtcblx0XHRcdFx0XHRcdHZhciBqb2J0aXRsZSAgPSAkZm9ybS5maW5kKCdpbnB1dFtuYW1lPWpvYnRpdGxlXScpLnZhbCgpO1xuXG5cdFx0XHRcdFx0XHROZXdzbGV0dGVycy51c2VyUmVnaXN0ZXIoZW1haWwsIHBhc3N3b3JkLCBmaXJzdG5hbWUsIGxhc3RuYW1lLCBvcmcsIGpvYnRpdGxlKVxuXHRcdFx0XHRcdFx0LnRoZW4oZnVuY3Rpb24ocmVzcCkge1xuXHRcdFx0XHRcdFx0XHR2YXIgcmVzdWx0cyAgICAgIFx0XHQ9IHJlc3AuZGF0YTtcblx0XHRcdFx0XHRcdFx0dmFyIHJlZ2lzdHJhdGlvbl9zdGF0dXMgPSByZXN1bHRzLnVzZXJfY3JlYXRlZDtcblxuXHRcdFx0XHRcdFx0XHRpZiAoIXJlZ2lzdHJhdGlvbl9zdGF0dXMpIHtcblx0XHRcdFx0XHRcdFx0XHQvLyB1bnN1Y2Nlc3NmdWwgcmVnaXN0cmF0aW9uXG5cdFx0XHRcdFx0XHRcdFx0aWYgKHJlc3VsdHMuZmVlZGJhY2sgPT09ICdmYWlsZWQnKSB7XG5cdFx0XHRcdFx0XHRcdFx0XHQvLyByZWdpc3RyYXRpb24gZmFpbGVkXG5cdFx0XHRcdFx0XHRcdFx0XHROZXdzbGV0dGVycy5zaG93QWNjb3VudEZvcm1FcnJvcnMoJGZvcm0sIFsnUmVnaXN0cmF0aW9uIHVuc3VjY2Vzc2Z1bCddKTtcblx0XHRcdFx0XHRcdFx0XHR9IGVsc2UgaWYgKHJlc3VsdHMuZmVlZGJhY2sgPT09ICdhbHJlYWR5X2V4aXN0cycpIHtcblx0XHRcdFx0XHRcdFx0XHRcdC8vIGFjY291bnQgYWxyZWFkeSBleGlzdHMgd2l0aCBlbWFpbCBhZGRyZXNzIGVudGVyZWRcblx0XHRcdFx0XHRcdFx0XHRcdE5ld3NsZXR0ZXJzLnNob3dBY2NvdW50Rm9ybUVycm9ycygkZm9ybSwgWydUaGlzIGVtYWlsIGlzIGFscmVhZHkgYXNzb2NpYXRlZCB3aXRoIGEgPGk+Rm9yZWlnbiBQb2xpY3k8L2k+IGFjY291bnQuIFBsZWFzZSA8YSBjbGFzcz1cInNpZ25pbi1hY2NvdW50LWxpbmtcIj5sb2dpbjwvYT4gdG8gY29udGludWUuJ10pO1xuXHRcdFx0XHRcdFx0XHRcdFx0TmV3c2xldHRlcnMuYWRkRXZlbnRMaXN0ZW5lcnNEeW5hbWljKCk7XG5cdFx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdFx0Ly8gcmVnaXN0ZXIgbG9naW4gd2l0aCBQaWFubyBhbmQgc2V0IGNvb2tpZVxuXHRcdFx0XHRcdFx0XHRcdGRvY3VtZW50LmNvb2tpZSA9IFwiX191dHA9XCIgKyByZXN1bHRzLmFjY2Vzc190b2tlbiArIFwiOyBleHBpcmVzPS0xO1wiICtcblx0XHRcdFx0XHRcdFx0XHRcIiBwYXRoPS87IGRvbWFpbj0uXCIgKyBlbmNvZGVVUkkoIGhvc3RVUkwgKTtcblx0XHRcdFx0XHRcdFx0XHQvLyByZWRpcmVjdCB1c2VyIHRvIG1hbmFnZSBwYWdlXG5cdFx0XHRcdFx0XHRcdFx0d2luZG93LmxvY2F0aW9uLmhyZWYgPSB3aW5kb3cubG9jYXRpb24ub3JpZ2luICsgJy9uZXdzbGV0dGVycy1tYW5hZ2UnICsgZG9jdW1lbnQubG9jYXRpb24uc2VhcmNoO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdH0sXG5cblx0XHQvKipcblx0XHQgKiBFcnJvciBoYW5kbGluZyBmb3IgYWNjb3VudC1yZWxhdGVkIGZvcm1zLlxuXHRcdCAqIEBwYXJhbSB7T2JqZWN0fSAkZm9ybSAtIGpRdWVyeSBmb3JtIG9iamVjdCB0byB2YWxpZGF0ZVxuXHRcdCAqL1xuXHRcdHZhbGlkYXRlQWNjb3VudEZvcm1zOiBmdW5jdGlvbigkZm9ybSkge1xuXHRcdFx0Ly8gQ2xlYXIgYW55IHByZXZpb3VzIGVycm9yc1xuXHRcdFx0dmFyICRlcnJvckNvbnRhaW5lciA9ICRmb3JtLmZpbmQoJy5mb3JtLWZlZWRiYWNrJyk7XG5cdFx0XHQkZXJyb3JDb250YWluZXIuZmluZCgnLmVycm9yLW1lc3NhZ2UnKS5yZW1vdmUoKTtcblxuXHRcdFx0dmFyIGVycm9ycyAgPSBbXTtcblx0XHRcdHZhciAkcGFyZW50ID0gJGZvcm0uY2xvc2VzdCgnLm5ld3NsZXR0ZXItYWNjb3VudC1zY3JlZW4nKTtcblxuXHRcdFx0dmFyICRlbWFpbCAgICAgPSAkZm9ybS5maW5kKCdpbnB1dFtuYW1lPVwiZW1haWxcIl0nKTtcblx0XHRcdHZhciAkcGFzc3dvcmQgID0gJGZvcm0uZmluZCgnaW5wdXRbbmFtZT1cInBhc3N3b3JkXCJdJyk7XG5cdFx0XHR2YXIgJGZpcnN0bmFtZSA9ICRmb3JtLmZpbmQoJ2lucHV0W25hbWU9XCJmaXJzdG5hbWVcIl0nKTtcblx0XHRcdHZhciAkbGFzdG5hbWUgID0gJGZvcm0uZmluZCgnaW5wdXRbbmFtZT1cImxhc3RuYW1lXCJdJyk7XG5cdFx0XHR2YXIgJG9yZyAgICAgICA9ICRmb3JtLmZpbmQoJ2lucHV0W25hbWU9XCJvcmdcIl0nKTtcblx0XHRcdHZhciAkam9idGl0bGUgID0gJGZvcm0uZmluZCgnaW5wdXRbbmFtZT1cImpvYnRpdGxlXCJdJyk7XG5cdFx0XHR2YXIgJG9wdGluICAgICA9ICRmb3JtLmZpbmQoJ2lucHV0W25hbWU9XCJvcHRpblwiXScpO1xuXHRcdFx0XG5cdFx0XHQvLyBFdmVyeSBzY3JlZW4gaGFzIGFuIGVtYWlsIGZpZWxkXG5cdFx0XHRpZiAoIU5ld3NsZXR0ZXJzLnZhbGlkYXRlRW1haWwoJGVtYWlsLnZhbCgpKSkge1xuXHRcdFx0XHRlcnJvcnMucHVzaCgnRW1haWwgYWRkcmVzcyBpcyBpbnZhbGlkJyk7XG5cdFx0XHR9XG5cblx0XHRcdGlmICgkcGFzc3dvcmQubGVuZ3RoKSB7XG5cdFx0XHRcdGlmICgkcGFzc3dvcmQudmFsKCkubGVuZ3RoIDwgOCkge1xuXHRcdFx0XHRcdGVycm9ycy5wdXNoKCdQYXNzd29yZCBtdXN0IGJlIGF0IGxlYXN0IDggY2hhcmFjdGVycycpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdFskZmlyc3RuYW1lLCAkbGFzdG5hbWUsICRvcmcsICRqb2J0aXRsZV0uZm9yRWFjaChmdW5jdGlvbigkZWwpIHtcblx0XHRcdFx0aWYgKCRlbC5sZW5ndGgpIHtcblx0XHRcdFx0XHRpZiAoISRlbC52YWwoKSkge1xuXHRcdFx0XHRcdFx0ZXJyb3JzLnB1c2goJGVsLmF0dHIoJ3BsYWNlaG9sZGVyJykgKyAnIGlzIHJlcXVpcmVkJyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblxuXHRcdFx0aWYgKCRvcHRpbi5sZW5ndGggJiYgISRvcHRpbi5pcygnOmNoZWNrZWQnKSkge1xuXHRcdFx0XHRlcnJvcnMucHVzaCgnT3B0LWluIGlzIHJlcXVpcmVkJyk7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChlcnJvcnMpIHtcblx0XHRcdFx0TmV3c2xldHRlcnMuc2hvd0FjY291bnRGb3JtRXJyb3JzKCRmb3JtLCBlcnJvcnMpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gIWVycm9ycy5sZW5ndGg7XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIFxuXHRcdCAqIEBwYXJhbSB7T2JqZWN0fSAkZm9ybSAtIGpRdWVyeSBvYmplY3Qgb2YgZm9ybVxuXHRcdCAqIEBwYXJhbSB7YXJyYXl9IGVycm9ycyAtIEFycmF5IG9mIGVycm9ycyB0byBzaG93XG5cdFx0ICovXG5cdFx0c2hvd0FjY291bnRGb3JtRXJyb3JzOiBmdW5jdGlvbigkZm9ybSwgZXJyb3JzKSB7XG5cdFx0XHR2YXIgJGVycm9yQ29udGFpbmVyID0gJGZvcm0uZmluZCgnLmZvcm0tZmVlZGJhY2snKTtcblx0XHRcdHZhciBlcnJvcl9saXN0ID0gZXJyb3JzLmpvaW4oJzxicj4nKTtcblx0XHRcdGlmKCcnICE9PSBlcnJvcl9saXN0KXtcblx0XHRcdFx0TmV3c2xldHRlcnMuc2hvd0Vycm9yKCRlcnJvckNvbnRhaW5lciwgbnVsbCwgbnVsbCwgJzxzcGFuIGNsYXNzPVwiZXJyb3ItbWVzc2FnZVwiPicgKyBlcnJvcnMuam9pbignPGJyPicpICsgJzwvc3Bhbj4nKTtcblx0XHRcdH1cblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogQ2hlY2sgaWYgdGhlIGVtYWlsIGFkZHJlc3MgaGFzIGEgUGlhbm8gYWNjb3VudC5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gZW1haWwgXG5cdFx0ICogQHJldHVybnMge09iamVjdH0galF1ZXJ5IGpxWEhSIG9iamVjdC5cblx0XHQgKi9cblx0XHRjaGVja0VtYWlsSGFzU2l0ZUFjY291bnQ6IGZ1bmN0aW9uKGVtYWlsKSB7XG5cdFx0XHRyZXR1cm4gJC5hamF4KHtcblx0XHRcdFx0dXJsOiAnL3BpYW5vLXVzZXItY2hlY2svcmVzdWx0cy8nLFxuXHRcdFx0XHRkYXRhOiB7XG5cdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcGlhbm9fYWpheCcgICAgICA6IDEsXG5cdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcGlhbm9fYWN0aW9uJyAgICA6ICdlbWFpbCcsXG5cdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcGlhbm9fdXNlcl9lbWFpbCc6IGVtYWlsXG5cdFx0XHRcdH0sXG5cdFx0XHRcdGNhY2hlOiB0cnVlXG5cdFx0XHR9KTtcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogTG9nIHVzZXIgaW50byBQaWFubyBhY2NvdW50LlxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBlbWFpbCBcblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gcGFzc3dvcmQgXG5cdFx0ICogQHJldHVybnMge09iamVjdH0galF1ZXJ5IGpxWEhSIG9iamVjdC5cblx0XHQgKi9cblx0XHR1c2VyTG9naW46IGZ1bmN0aW9uKGVtYWlsLCBwYXNzd29yZCkge1xuXHRcdFx0cmV0dXJuICQuYWpheCh7XG5cdFx0XHRcdHVybDogJy9waWFuby11c2VyLWNoZWNrL3Jlc3VsdHMvJyxcblx0XHRcdFx0ZGF0YToge1xuXHRcdFx0XHRcdCdfX2ZwX2VuZHBvaW50X3BpYW5vX2FqYXgnICAgICAgICAgOiAxLFxuXHRcdFx0XHRcdCdfX2ZwX2VuZHBvaW50X3BpYW5vX2FjdGlvbicgICAgICAgOiAnbG9naW4nLFxuXHRcdFx0XHRcdCdfX2ZwX2VuZHBvaW50X3BpYW5vX3VzZXJfZW1haWwnICAgOiBlbWFpbCxcblx0XHRcdFx0XHQnX19mcF9lbmRwb2ludF9waWFub191c2VyX3Bhc3N3b3JkJzogcGFzc3dvcmRcblx0XHRcdFx0fSxcblx0XHRcdFx0Y2FjaGU6IHRydWVcblx0XHRcdH0pO1xuXHRcdH0sXG5cblx0XHQvKipcblx0XHQgKiBSZWdpc3RlciB1c2VyIGFjY291bnQgaW4gUGlhbm8uXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IGVtYWlsIFxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBwYXNzd29yZCBcblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gZmlyc3RuYW1lIFxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBsYXN0bmFtZSBcblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gb3JnIFxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBqb2J0aXRsZSBcblx0XHQgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkganFYSFIgb2JqZWN0LlxuXHRcdCAqL1xuXHRcdHVzZXJSZWdpc3RlcjogZnVuY3Rpb24oZW1haWwsIHBhc3N3b3JkLCBmaXJzdG5hbWUsIGxhc3RuYW1lLCBvcmcsIGpvYnRpdGxlKSB7XG5cdFx0XHRyZXR1cm4gJC5hamF4KHtcblx0XHRcdFx0dXJsOiAnL3BpYW5vLXVzZXItY2hlY2svcmVzdWx0cy8nLFxuXHRcdFx0XHRkYXRhOiB7XG5cdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcGlhbm9fYWpheCcgICAgICAgICAgOiAxLFxuXHRcdFx0XHRcdCdfX2ZwX2VuZHBvaW50X3BpYW5vX2FjdGlvbicgICAgICAgIDogJ3JlZ2lzdGVyJyxcblx0XHRcdFx0XHQnX19mcF9lbmRwb2ludF9waWFub191c2VyX2VtYWlsJyAgICA6IGVtYWlsLFxuXHRcdFx0XHRcdCdfX2ZwX2VuZHBvaW50X3BpYW5vX3VzZXJfcGFzc3dvcmQnIDogcGFzc3dvcmQsXG5cdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcGlhbm9fdXNlcl9maXJzdG5hbWUnOiBmaXJzdG5hbWUsXG5cdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcGlhbm9fdXNlcl9sYXN0bmFtZScgOiBsYXN0bmFtZSxcblx0XHRcdFx0XHQnX19mcF9lbmRwb2ludF9waWFub191c2VyX29yZycgICAgICA6IG9yZyxcblx0XHRcdFx0XHQnX19mcF9lbmRwb2ludF9waWFub191c2VyX2pvYnRpdGxlJyA6IGpvYnRpdGxlLFxuXHRcdFx0XHRcdCdfX2ZwX2VuZHBvaW50X3BpYW5vX3VzZXJfY29uc2VudCcgIDogdHJ1ZVxuXHRcdFx0XHR9LFxuXHRcdFx0XHRjYWNoZTogdHJ1ZVxuXHRcdFx0fSk7XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIFByb21wdCB1c2VyIHNpZ24gaW4uXG5cdFx0ICovXG5cdFx0cHJvbXB0U2lnbkluOiBmdW5jdGlvbigpIHtcblx0XHRcdCQoJy5uZXdzbGV0dGVyLWVudGVyLWVtYWlsJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1x0XHRcblx0XHRcdCQoJy5uZXdzbGV0dGVyLXNpZ25pbicpLmFkZENsYXNzKCdhY3RpdmUnKTtcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogUHJvbXB0IHVzZXIgdG8gY3JlYXRlIGFjY291bnQuXG5cdFx0ICovXG5cdFx0cHJvbXB0Q3JlYXRlQWNjb3VudDogZnVuY3Rpb24oKSB7XG5cdFx0XHQkKCcubmV3c2xldHRlci1jcmVhdGUtYWNjb3VudCcpLmFkZENsYXNzKCdhY3RpdmUnKTtcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogQWRkIGNsYXNzZXMgdG8gcGFyZW50IGVsZW1lbnQgYmFzZWQgb24gdXNlciBzdGF0dXMuXG5cdFx0ICovXG5cdFx0c2V0QWNjZXNzTGV2ZWxTdGF0ZTogZnVuY3Rpb24oKSB7XG5cdFx0XHR2YXIgYWNjZXNzICAgID0gTmV3c2xldHRlcnMuZ2V0VXNlckFjY2Vzc0xldmVsKCk7XG5cdFx0XHR2YXIgY2xhc3NOYW1lID0gJ25ld3NsZXR0ZXJzLScgKyBhY2Nlc3M7XG5cdFx0XHR2YXIgJHBhcmVudFBhZ2VDb250YWluZXI7XG5cdFx0XHRcblx0XHRcdGlmIChOZXdzbGV0dGVycy5pc05ld3NsZXR0ZXJzTGlzdFBhZ2UpIHtcblx0XHRcdFx0JHBhcmVudFBhZ2VDb250YWluZXIgPSAkKCcubmV3c2xldHRlcnMtbGlzdC1wYWdlJyk7XG5cdFx0XHR9IGVsc2UgaWYgKE5ld3NsZXR0ZXJzLmlzQWxlcnRzTWFuYWdlUGFnZSkge1xuXHRcdFx0XHQkcGFyZW50UGFnZUNvbnRhaW5lciA9ICQoJy5mcC1tYW5hZ2UtYWxlcnRzLXBhZ2UnKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdCRwYXJlbnRQYWdlQ29udGFpbmVyID0gJCgnLm5ld3NsZXR0ZXJzLXBhZ2UnKTtcblx0XHRcdH1cblxuXHRcdFx0JHBhcmVudFBhZ2VDb250YWluZXIuYWRkQ2xhc3MoY2xhc3NOYW1lKTtcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogR2V0IHRoZSBhY2Nlc3MgbGV2ZWwgYmFzZWQgb24gdXNlciBzdGF0ZS5cblx0XHQgKiBJZiBhIHVzZXIgaXMgbG9nZ2VkIGluIGFuZCB0aGUgZW1haWwgYWRkcmVzcyBtYXRjaGVzIHRoZSBvbmUgc2V0IGluXG5cdFx0ICogYE5ld3NsZXR0ZXJzLmVtYWlsYCwgdGhlbiBnZXQgc3RhdHVzIGJhc2VkIG9mZiBsb2dnZWQgaW4gdXNlci5cblx0XHQgKiBPdGhlcndpc2UsIGlmIGBOZXdzbGV0dGVycy5Vc2VyYCBpcyBsb2FkZWQgY2hlY2sgYHN1YnNjcmliZXJfc3RhdHVzYFxuXHRcdCAqIGF0dHJpYnR1ZS5cblx0XHQgKiBcblx0XHQgKiBAcmV0dXJucyB7c3RyaW5nfSBhY2Nlc3MgbGV2ZWwgKGFub24sIHByZW1pdW0sIGJhc2ljLCByZWdpc3RlcmVkLCB1bnN1YikuXG5cdFx0ICovXG5cdFx0Z2V0VXNlckFjY2Vzc0xldmVsOiBmdW5jdGlvbigpIHtcblx0XHRcdHZhciBhY2Nlc3MgPSAnYW5vbic7XG5cblx0XHRcdC8vIEFuIHVuc3ViIGFjdGlvbiBjb3VsZCBoYXZlIGEgbG9nZ2VkIGluIHVzZXIgd2l0aCBhIGRpZmZlcmVudCBlbWFpbCBmb3IgbmV3c2xldHRlciBtZ210XG5cdFx0XHRpZiAoTmV3c2xldHRlcnMubG9nZ2VkSW4gJiYgTmV3c2xldHRlcnMubG9nZ2VkSW4gPT09IE5ld3NsZXR0ZXJzLmVtYWlsKSB7XG5cdFx0XHRcdGlmIChGUC5TaW5nbGV0b25zLlVzZXIuaXNJbnNpZGVyIHx8IEZQLlNpbmdsZXRvbnMuVXNlci5pc1ByZW0pIHtcblx0XHRcdFx0XHRhY2Nlc3MgPSAncHJlbWl1bSc7XG5cdFx0XHRcdH0gZWxzZSBpZiAoRlAuU2luZ2xldG9ucy5Vc2VyLmlzU3ViKSB7XG5cdFx0XHRcdFx0YWNjZXNzID0gJ2Jhc2ljJztcblx0XHRcdFx0fSBlbHNlIGlmIChGUC5TaW5nbGV0b25zLlVzZXIuaXNSZWcpIHtcblx0XHRcdFx0XHRhY2Nlc3MgPSAncmVnaXN0ZXJlZCc7XG5cdFx0XHRcdH1cblx0XHRcdH0gZWxzZSBpZiAoTmV3c2xldHRlcnMuVXNlcikge1xuXHRcdFx0XHRcblx0XHRcdFx0aWYgKE5ld3NsZXR0ZXJzLlVzZXIuc3Vic2NyaWJlcl9zdGF0dXMgPT09ICdGUElOU0lERVInIHx8IE5ld3NsZXR0ZXJzLlVzZXIuc3Vic2NyaWJlcl9zdGF0dXMgPT09ICdGUFBSRU1JVU0nKSB7XG5cdFx0XHRcdFx0YWNjZXNzID0gJ3ByZW1pdW0nO1xuXHRcdFx0XHR9IGVsc2UgaWYgKE5ld3NsZXR0ZXJzLlVzZXIuc3Vic2NyaWJlcl9zdGF0dXMgPT09ICdGUERJR0lUQUwnKSB7XG5cdFx0XHRcdFx0YWNjZXNzID0gJ2Jhc2ljJztcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRpZiAoTmV3c2xldHRlcnMuaXNVbnN1Yikge1xuXHRcdFx0XHRcdFx0YWNjZXNzID0gJ3Vuc3ViJztcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGFjY2Vzcztcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogR2V0cyB0aGUgdXNlcidzIGVtYWlsIHZpYSB7QGxpbmsgTmV3c2xldHRlcnMuZ2V0VXNlckVtYWlsfSBhbmQgdXBkYXRlc1xuXHRcdCAqIGVsZW1lbnRzIGlmIGFwcGxpY2FibGUuXG5cdFx0ICogQ2FsbHMge0BsaW5rIE5ld3NsZXR0ZXJzLnNldFN1YnNjcmlwdGlvblN0YXRlc30gcGFzc2luZyB1c2VyJ3MgZW1haWwuXG5cdFx0ICovXG5cdFx0c2V0RW1haWxTdGF0ZTogZnVuY3Rpb24oKSB7XG5cdFx0XHR2YXIgaXNIb21lUGFnZSA9ICQoJy5ob21lLWNvbnRlbnQnKS5sZW5ndGg7XG5cdFx0XHR2YXIgdXNlckVtYWlsICA9IE5ld3NsZXR0ZXJzLmdldFVzZXJFbWFpbCgpO1xuXG5cdFx0XHQvLyBIaWRlIGFsbCBlbWFpbCBpbnB1dHMgaWYgd2UgYWxyZWFkeSBoYXZlIHRoZSB1c2VyJ3MgZW1haWwgYWRkcmVzc1xuXHRcdFx0aWYgKHVzZXJFbWFpbCAmJiAoTmV3c2xldHRlcnMuaXNBbGVydHNNYW5hZ2VQYWdlIHx8IGlzSG9tZVBhZ2UgfHwgTmV3c2xldHRlcnMuaXNOZXdzbGV0dGVyUGFnZSkpIHtcblx0XHRcdFx0JCgnbGFiZWxbZm9yXj1cImVtYWlsLVwiXScpLmhpZGUoKTtcblx0XHRcdFx0JCgnaW5wdXRbdHlwZT1lbWFpbF0nKS5oaWRlKCkudmFsKHVzZXJFbWFpbCk7XG5cdFx0XHR9XG5cdFx0XG5cdFx0XHROZXdzbGV0dGVycy5zZXRTdWJzY3JpcHRpb25TdGF0ZXModXNlckVtYWlsKTtcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogR2V0cyB1c2VyJ3MgZW1haWwgZWl0aGVyIGZyb20gdGhlIHBhZ2UgKGlmIGBOZXdzbGV0dGVycy5pc01hbmFnZVBhZ2VgKSBvciBmcm9tIGxvZ2dlZCBpbiB1c2VyXG5cdFx0ICogQHJldHVybnMge3N0cmluZ30gVXNlciBlbWFpbCBhZGRyZXNzIG9yIGVtcHR5IHN0cmluZy5cblx0XHQgKiBAbGluayB7TmV3c2xldHRlcnMudmFsaWRhdGVFbWFpbH1cblx0XHQgKi9cblx0XHRnZXRVc2VyRW1haWw6IGZ1bmN0aW9uKCkge1xuXHRcdFx0dmFyIHVzZXJFbWFpbCA9ICcnO1xuXHRcdFx0dmFyICRlbWFpbCA9IE5ld3NsZXR0ZXJzLmlzTWFuYWdlUGFnZSA/ICQoJy5lbWFpbC1hZGRyZXNzJykgOiBudWxsO1xuXG5cdFx0XHRpZiAoTmV3c2xldHRlcnMuaXNNYW5hZ2VQYWdlKSB7XG5cdFx0XHRcdHVzZXJFbWFpbCA9ICRlbWFpbC5odG1sKCk7XG5cdFx0XHRcdHVzZXJFbWFpbCA9IE5ld3NsZXR0ZXJzLnZhbGlkYXRlRW1haWwodXNlckVtYWlsKSA/IHVzZXJFbWFpbCA6ICcnO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIXVzZXJFbWFpbCkge1xuXHRcdFx0XHR1c2VyRW1haWwgPSBGUC5TaW5nbGV0b25zLlVzZXIudXNlckRhdGEuZW1haWw7XG5cblx0XHRcdFx0aWYgKE5ld3NsZXR0ZXJzLmlzTWFuYWdlUGFnZSkge1xuXHRcdFx0XHRcdCRlbWFpbC50ZXh0KGVuY29kZVVSSSh1c2VyRW1haWwpKS5hbmltYXRlKHtcblx0XHRcdFx0XHRcdCd3aWR0aCc6J2F1dG8nXG5cdFx0XHRcdFx0fSwgMTApOyBcblx0XHRcdFx0XHQvLyBhbmltYXRlKCkgaXMgYSBoYWNrIHRvIGdldCB0aGUgYnJvd3NlciB0byByZWNvZ25pemUgdGhlIG5ldyB0ZXh0XG5cdFx0XHRcdFx0Ly8gd2hpY2ggbWF5IG9ubHkgYmUgYW4gaXNzdWUgb24gbG9jYWxcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gdXNlckVtYWlsO1xuXHRcdH0sXG5cblx0XHQvKipcblx0XHQgKiBWYWxpZGF0ZSBlbWFpbCBhZGRyZXNzXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IGVtYWlsXG5cdFx0ICogQHJldHVybnMge2Jvb2xlYW59IElzIHZhbGlkIGVtYWlsIHN0cmluZ1xuXHRcdCAqL1xuXHRcdHZhbGlkYXRlRW1haWw6IGZ1bmN0aW9uKGVtYWlsKSB7XG5cdFx0XHR2YXIgZW1haWxSZWcgPSAvXigoW148PigpW1xcXVxcXFwuLDs6XFxzQFxcXCJdKyhcXC5bXjw+KClbXFxdXFxcXC4sOzpcXHNAXFxcIl0rKSopfChcXFwiLitcXFwiKSlAKChcXFtbMC05XXsxLDN9XFwuWzAtOV17MSwzfVxcLlswLTldezEsM31cXC5bMC05XXsxLDN9XFxdKXwoKFthLXpBLVpcXC0wLTldK1xcLikrW2EtekEtWl17Mix9KSkkLztcblx0XG5cdFx0XHRyZXR1cm4gZW1haWxSZWcudGVzdChlbWFpbCk7XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIENoZWNrcyBpZiB1c2VyIGV4aXN0cyBhcyBlbWFpbCBzdWJzY3JpYmVyIHVzZXIgdmlhIHtAbGluayBOZXdzbGV0dGVycy5nZXRTdWJzY3JpYmVyfS5cblx0XHQgKiBJZiBub3QsIGNhbGxzIHtAbGluayBOZXdzbGV0dGVycy5zaG93U2lnblVwQnV0dG9uc30gb3RoZXJ3aXNlIGlmIGlzXG5cdFx0ICogYE5ld3NsZXR0ZXJzLmlzTmV3c2xldHRlcnNMaXN0UGFnZWAgbG9vcHMgdGhyb3VnaCBhbGwgdGhlIG5ld3NsZXR0ZXJzXG5cdFx0ICogZWxzZSBnZXRzIHRoZSByZWxldmFudCBuZXdzbGV0dGVyIGlkcyBhbmQgY2FsbHMge0BsaW5rIE5ld3NsZXR0ZXJzLnNldE5ld3NsZXR0ZXJTdGF0ZX0uXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IHVzZXJFbWFpbFxuXHRcdCAqL1xuXHRcdHNldFN1YnNjcmlwdGlvblN0YXRlczogZnVuY3Rpb24odXNlckVtYWlsKSB7XG5cdFx0XHROZXdzbGV0dGVycy5nZXRTdWJzY3JpYmVyKHVzZXJFbWFpbClcblx0XHRcdC50aGVuKGZ1bmN0aW9uKCkge1xuXHRcdFx0XHR2YXIgcmVzdWx0cyAgID0gTmV3c2xldHRlcnMuVXNlcjtcblx0XHRcdFx0dmFyIHVzZXJFbWFpbCA9IHJlc3VsdHMuYWRkcmVzcztcblx0XHRcdFx0dmFyIHVzZXJJZCAgICA9IHJlc3VsdHMucmVjaXBpZW50SWQ7XG5cdFx0XHRcdHZhciBzdGF0dXMgICAgPSByZXN1bHRzLnN0YXR1cztcblx0XHRcdFx0XG5cdFx0XHRcdC8vIHVzZXIgSVMgTk9UIGluIFBvc3RVcFxuXHRcdFx0XHRpZiAoIXVzZXJFbWFpbCB8fCB1c2VyRW1haWwgPT0gJ1tdJykge1xuXHRcdFx0XHRcdE5ld3NsZXR0ZXJzLnNob3dTaWduVXBCdXR0b25zKCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0aWYgKE5ld3NsZXR0ZXJzLmlzTmV3c2xldHRlcnNMaXN0UGFnZSkge1xuXHRcdFx0XHRcdFx0Zm9yICh2YXIga2V5IGluIE5ld3NsZXR0ZXJzLmlkcykge1xuXHRcdFx0XHRcdFx0XHR2YXIgbmV3c2xldHRlcklkID0gTmV3c2xldHRlcnMuaWRzW2tleV07XG5cblx0XHRcdFx0XHRcdFx0aWYgKG5ld3NsZXR0ZXJJZCA9PT0gTmV3c2xldHRlcnMuaWRzLmdsb2JhbG9wdG91dCkge1xuXHRcdFx0XHRcdFx0XHRcdE5ld3NsZXR0ZXJzLnNldFVzZXJPcHRPdXQobmV3c2xldHRlcklkLCBzdGF0dXMpO1xuXHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRcdE5ld3NsZXR0ZXJzLnNldE5ld3NsZXR0ZXJTdGF0ZSh1c2VySWQsIG5ld3NsZXR0ZXJJZCk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0JCgnW2RhdGEtbmV3c2xldHRlci1pZF0nKS5lYWNoKGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdFx0XHR2YXIgaWQgPSAkKHRoaXMpLmRhdGEoJ25ld3NsZXR0ZXItaWQnKTtcblx0XHRcdFx0XHRcdFx0TmV3c2xldHRlcnMuc2V0TmV3c2xldHRlclN0YXRlKHVzZXJJZCwgaWQpO1xuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9IFxuXHRcdFx0fSk7XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIFRvZ2dsZXMgbG9hZGluZyBzdGF0ZSBmb3Igc3Vic2NyaWJlIGJ1dHRvbnMuIElmIGBuZXdzbGV0dGVySWRgIGlzIHBhc3NlZFxuXHRcdCAqIHRoZW4gaXQgdGFyZ2V0cyB0aGUgYnV0dG9ucyBmb3IgdGhhdCBuZXdzbGV0dGVyLCBvdGhlcndpc2UgdGFyZ2V0c1xuXHRcdCAqIGFsbCB0aGUgYnV0dG9ucy5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gbmV3c2xldHRlcklkIC0gT3B0aW9uYWwgdG8gdGFyZ2V0IGJ1dHRvbnMgZm9yIHNwZWNpZmljIG5ld3NsZXR0ZXIuXG5cdFx0ICovXG5cdFx0c2hvd1NpZ25VcEJ1dHRvbnM6IGZ1bmN0aW9uKG5ld3NsZXR0ZXJJZCkge1xuXHRcdFx0dmFyICRidXR0b25zID0gbmV3c2xldHRlcklkID8gJCgnLm5ld3NsZXR0ZXItJyArIG5ld3NsZXR0ZXJJZCkuZmluZCgnLmJ1dHRvbnMnKSA6ICQoJy5idXR0b25zJyk7XG5cdFx0XHRcblx0XHRcdCQoJy5sb2FkaW5nLXBsYWNlaG9sZGVyLXNtYWxsZXInKS5oaWRlKCk7XG5cdFx0XHQkYnV0dG9ucy5hbmltYXRlKHtvcGFjaXR5OiAxfSk7XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIFNldHMgdGhlIHN1YnNyaWJlIHN0YXRlIGZvciBhbiBpbmRpdmlkdWFsIG5ld3NsZXR0ZXIgYW5kIHVzZXIuXG5cdFx0ICogQ2FsbHMge0BsaW5rIE5ld3NsZXR0ZXJzLmdldFN1YnNjcmlwdGlvblN0YXR1c30gdG8gZ2V0IHN1YnNjcmlwdGlvbiBzdGF0dXMuXG5cdFx0ICogSWYgdXNlciBpcyBzdWJzY3JpYmVkLCBjYWxscyB7QGxpbmsgTmV3c2xldHRlcnMuc2V0TmV3c2xldHRlcklzU3Vic2NyaWJlZFN0YXRlfS5cblx0XHQgKiBSZXR1cm5zIGJ1dHRvbnMgdG8gbm9uLWxvYWRpbmcgc3RhdGUuXG5cdFx0ICogQHBhcmFtIHtudW1iZXJ9IHVzZXJJZCAtIFRoZSBgcmVjaXBpZW50SWRgIGZyb20gUG9zdFVwLlxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBuZXdzbGV0dGVySWRcblx0XHQgKi9cblx0XHRzZXROZXdzbGV0dGVyU3RhdGU6IGZ1bmN0aW9uKHVzZXJJZCwgbmV3c2xldHRlcklkKSB7XG5cdFx0XHROZXdzbGV0dGVycy5nZXRTdWJzY3JpcHRpb25TdGF0dXModXNlcklkLCBuZXdzbGV0dGVySWQpXG5cdFx0XHQudGhlbihmdW5jdGlvbihyZXNwKSB7XG5cdFx0XHRcdHZhciBuZXdzbGV0dGVyUmVzdWx0cyA9IHJlc3AuZGF0YTtcblxuXHRcdFx0XHQvLyB1c2VyIElTIGFscmVhZHkgc3Vic2NyaWJlZCB0byBuZXdzbGV0dGVyXG5cdFx0XHRcdGlmIChuZXdzbGV0dGVyUmVzdWx0cyAhPT0gMCkge1xuXHRcdFx0XHRcdE5ld3NsZXR0ZXJzLnNldE5ld3NsZXR0ZXJJc1N1YnNjcmliZWRTdGF0ZShuZXdzbGV0dGVySWQpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0TmV3c2xldHRlcnMuc2hvd1NpZ25VcEJ1dHRvbnMobmV3c2xldHRlcklkKTtcblx0XHRcdH0pO1xuXHRcdH0sXG5cblx0XHQvKipcblx0XHQgKiBTZXRzIHRoZSBzdGF0ZSBmb3IgdGhlIG5ld3NsZXR0ZXIgaWYgdXNlciBpcyBzdWJzcmliZWQuXG5cdFx0ICogQ29udGFpbnMgZXh0cmEgY2hlY2tzIGZvciBzcGVjaWZpYyBuZXdzbGV0dGVycyBhbmQgcGFnZSB0eXBlLlxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBuZXdzbGV0dGVySWRcblx0XHQgKi9cblx0XHRzZXROZXdzbGV0dGVySXNTdWJzY3JpYmVkU3RhdGU6IGZ1bmN0aW9uKG5ld3NsZXR0ZXJJZCkge1xuXHRcdFx0Ly8gSW5zaWRlciwgSSBTcHkgc2Vhc29uIDIsIGFuZCBGUEEgQ2xpbWF0ZSAmIFNlY3VyaXR5IHJlcG9ydCBlbWFpbCBsaXN0IHNpZ251cFxuXHRcdFx0dmFyIHNwZWNpYWxJZHMgPSBbJzE2OScsICcyMDUnLCAnMjYxJ107XG5cdFx0XHR2YXIgaXNTcGVjaWFsID0gc3BlY2lhbElkcy5pbmRleE9mKG5ld3NsZXR0ZXJJZC50b1N0cmluZygpKSA+IC0xO1xuXHRcdFx0Ly8gRG8gbm90IGNvbmZpcm0gbmV3c2xldHRlciBzdWJzY3JpcHRpb24gZm9yIHNwZWNpYWwgaWRzXG5cdFx0XHRpZiAoaXNTcGVjaWFsKSB7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0dmFyICRuZXdzbGV0dGVyICA9ICQoJy5uZXdzbGV0dGVyLScgKyBuZXdzbGV0dGVySWQpO1xuXHRcdFxuXHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnLmJ1dHRvbi0tc3Vic2NyaWJlJykuaGlkZSgpO1xuXHRcdFx0XG5cdFx0XHQkbmV3c2xldHRlci5maW5kKCcuYnV0dG9uLmJ1dHRvbi0tc2lnbnVwJykuaGlkZSgpO1xuXHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnLnByaXZhY3ktcG9saWN5LWFja25vd2xlZGdlJykuaGlkZSgpO1xuXHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnLnNpZ25lZC11cCcpLnNob3coKTtcblxuXHRcdFx0aWYgKCcyNDQnID09IG5ld3NsZXR0ZXJJZCkge1xuXHRcdFx0XHQvLyBoaWRlIGluLXBvc3Qgc2lnbnVwIGlmIHVzZXIgaXMgYWxyZWFkeSBzaWduZWQgdXAgXG5cdFx0XHRcdCRuZXdzbGV0dGVyLmZpbmQoJ2lucHV0W3R5cGU9ZW1haWxdJykuaGlkZSgpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoJCgnLm5ld3NsZXR0ZXItdW5pdC1zaWdudXAnKS5sZW5ndGgpIHtcblx0XHRcdFx0JCgnLm5ld3NsZXR0ZXItdW5pdC1zaWdudXAgLm5ld3NsZXR0ZXItJyArIG5ld3NsZXR0ZXJJZCArICcgLmhpZGUtZnJvbS1uZXdzbGV0dGVyLXN1YnNjcmliZXInKS5oaWRlKCk7XG5cdFx0XHR9XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIFNldHMgdGhlIHN0YXRlIGZvciBsb2dnZWQgb3V0IHVzZXJzLlxuXHRcdCAqL1xuXHRcdHNldExvZ2dlZE91dFN0YXRlOiBmdW5jdGlvbigpIHtcblx0XHRcdC8vIFVzZXIgaXMgbm90IGxvZ2dlZCBpblxuXHRcdFx0JCgnLm5ld3NsZXR0ZXJzLXBhZ2UsIC5mcC1tYW5hZ2UtYWxlcnRzLXBhZ2UsIC5uZXdzbGV0dGVycy1saXN0LXBhZ2UnKS5hZGRDbGFzcygnbmV3c2xldHRlcnMtYW5vbicpO1xuXG5cdFx0XHROZXdzbGV0dGVycy5zaG93U2lnblVwQnV0dG9ucygpO1xuXHRcdH0sXG5cdFx0XG5cdFx0LyoqXG5cdFx0ICogQWRkIHRoZSBldmVudCBsaXN0ZW5lcnMgZm9yIHN1YnNjcmlwdGlvbiBtYW5hZ2VtZW50LlxuXHRcdCAqIEBsaW5rIHtOZXdzbGV0dGVycy5oYW5kbGVTdWJzY3JpcHRpb25DbGlja31cblx0XHQgKi9cblx0XHRhZGRFdmVudExpc3RlbmVyczogZnVuY3Rpb24oKSB7XG5cdFx0XHRpZiAoIU5ld3NsZXR0ZXJzLmlzTmV3c2xldHRlcnNMaXN0UGFnZSkge1xuXHRcdFx0XHQvLyBTdWJzY3JpYmUgdG8gbmV3c2xldHRlciBidXR0b24gY2xpY2tzXG5cdFx0XHRcdCQoJy5idXR0b24tLXNpZ251cCwgLmJ1dHRvbi0tdW5zdWJzY3JpYmUnKS5vbignY2xpY2snLCBmdW5jdGlvbihlKSB7XG5cdFx0XHRcdFx0TmV3c2xldHRlcnMuaGFuZGxlU3Vic2NyaXB0aW9uQ2xpY2soZSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHQvLyBTdWJzY3JpYmUgdG8gRlAgYnV0dG9uIGNsaWNrc1xuXHRcdFx0JCgnLmJ1dHRvbi0tc3Vic2NyaWJlJykub24oJ2NsaWNrJywgZnVuY3Rpb24oZSkge1xuXHRcdFx0XHROZXdzbGV0dGVycy5zaG93UGlhbm9TdWJzY3JpcHRpb25Nb2RhbChlKTtcblx0XHRcdH0pO1xuXG5cdFx0XHQvLyBMb2dpbiBsaW5rIGNsaWNrc1xuXHRcdFx0JCgnLmFjY291bnQtbGluayBhJykub24oJ2NsaWNrJywgZnVuY3Rpb24oZSkge1xuXHRcdFx0XHQvLyBUb2dnbGUgZGlzcGxheSBvZiBzaWduIGluIGZvcm1cblx0XHRcdFx0TmV3c2xldHRlcnMucHJvbXB0U2lnbkluKGUpO1xuXHRcdFx0fSk7XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIEFkZCBkeW5hbWljIGV2ZW50IGxpc3RlbmVycyB0aWVkIHRvIHVzZXIgaW5wdXQgZXJyb3JzLlxuXHRcdCAqIEBsaW5rIHtOZXdzbGV0dGVycy5wcm9tcHRDcmVhdGVBY2NvdW50fVxuXHRcdCAqL1xuXHRcdGFkZEV2ZW50TGlzdGVuZXJzRHluYW1pYzogZnVuY3Rpb24oKSB7XG5cdFx0XHQvLyBEaXNwbGF5IGNyZWF0ZSBhY2NvdW50IGZvcm1cblx0XHRcdCQoJy5jcmVhdGUtYWNjb3VudC1saW5rJykub24oJ2NsaWNrJywgZnVuY3Rpb24oZSkge1xuXHRcdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdCQoJy5uZXdzbGV0dGVyLWFjY291bnQtc2NyZWVuLmFjdGl2ZScpLnJlbW92ZUNsYXNzKCdhY3RpdmUgbG9hZGluZycpO1xuXHRcdFx0XHROZXdzbGV0dGVycy5wcm9tcHRDcmVhdGVBY2NvdW50KCk7XG5cdFx0XHR9KTtcblx0XHRcdC8vIFRvZ2dsZSBkaXNwbGF5IG9mIHNpZ24gaW4gZm9ybVxuXHRcdFx0JCgnLnNpZ25pbi1hY2NvdW50LWxpbmsnKS5vbignY2xpY2snLCBmdW5jdGlvbihlKSB7XG5cdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0JCgnLm5ld3NsZXR0ZXItY3JlYXRlLWFjY291bnQuYWN0aXZlJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZSBsb2FkaW5nJyk7XG5cdFx0XHRcdCQoJy5uZXdzbGV0dGVyLXNpZ25pbiBpbnB1dFt0eXBlPWVtYWlsXScpLnZhbCggJCgnLm5ld3NsZXR0ZXItY3JlYXRlLWFjY291bnQgaW5wdXRbdHlwZT1lbWFpbF0nKS52YWwoKSApO1xuXHRcdFx0XHROZXdzbGV0dGVycy5wcm9tcHRTaWduSW4oZSk7XG5cdFx0XHR9KTtcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogVHJpZ2dlciB0aGUgZGlzcGxheSBvZiBQaWFubyBvZmZlcnNcblx0XHQgKiBgdHBgIGlzIGFuIG9iamVjdCBpbnN0YW50aWF0ZWQgaW4gL2Fzc2V0cy9zcmMvc2NyaXB0cy9zaW5nbGV0b25zL3VzZXItcGlhbm8uanNcblx0XHQgKiBXZSBhcmUgYWJsZSBjYWxsIGl0IGhlcmUgZ2l2ZW4gdGhhdCB0aGlzIGNvZGUgb25seSBydW5zIGFmdGVyIFBpYW5vIGhhcyBcblx0XHQgKiBpbnN0YW50aWF0ZWQgYW5kIHJ1biB0aGUgYWNjZXNzIGNoZWNrLCB0cmlnZ2VyaW5nIHRoZSBgcGlhbm9BY2Nlc3NDaGVja0NvbXBsZXRlYCBldmVudFxuXHRcdCAqIEBwYXJhbSB7T2JqZWN0fSBlIC0gZXZlbnQuXG5cdFx0ICovXG5cdFx0c2hvd1BpYW5vU3Vic2NyaXB0aW9uTW9kYWw6IGZ1bmN0aW9uKGUpIHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0Ly8gc2hvdyBzdWJzY3JpcHRpb24gbW9kYWxcblx0XHRcdHRwLnB1c2goW1wiaW5pdFwiLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0dHAub2ZmZXIuc2hvdyh7XG5cdFx0XHRcdFx0b2ZmZXJJZDogJ09GV1VTRlpPRDVJMScsXG5cdFx0XHRcdFx0dGVtcGxhdGVJZDogJ09URlRORVg3TjBNSycsXG5cdFx0XHRcdFx0ZGlzcGxheU1vZGU6ICdtb2RhbCcsXG5cdFx0XHRcdH0pO1xuXHRcdFx0fV0pO1xuXHRcdH0sXG5cblx0XHQvKipcblx0XHQgKiBIYW5kbGVzIHRoZSBjbGljayBldmVudCBvbiBidXR0b24gc2lnbnVwIG9yIHVuc3Vic2NyaWJlLlxuXHRcdCAqIERldGVybWluZXMgd2hldGhlciBgc3Vic2NyaWJlU3RhdHVzYCBpcyBhIGBVTlNVQmAgb3IgYE5PUk1BTGAsIHVwZGF0ZXMgZWxlbWVudFxuXHRcdCAqIHRvIGxvYWRpbmcgc3RhdGUsIGNhbGxzIHtAbGluayBOZXdzbGV0dGVycy5nZXRGb3JtRXJyb3JzfSBhbmQgdGhlbiBlaXRoZXJcblx0XHQgKiBjYWxscyB7QGxpbmsgTmV3c2xldHRlcnMuc2hvd0Vycm9yfSBvciwgaWYgbm8gZXJyb3JzLFxuXHRcdCAqIHtAbGluayBOZXdzbGV0dGVycy5nZXRTdWJzY3JpYmVyfSB0byBzdGFydCB0aGUgc3Vic3JpcHRpb24gY2hhbmdlIGV2ZW50IGJ5IGdldHRpbmcgdGhlIHN1YnNjcmliZXIgYW5kXG5cdFx0ICogdGhlbiBjYWxsaW5nIHtAbGluayBOZXdzbGV0dGVycy5tYW5hZ2VTdWJzY3JpcHRpb259LlxuXHRcdCAqIEBwYXJhbSB7T2JqZWN0fSBlIC0gZXZlbnQuXG5cdFx0ICogQHBhcmFtIHtPYmplY3R9ICRjbGlja2VkRWQgLSBPcHRpb25hbCBqUXVlcnkgZWxlbWVudCBpZiBub3QgdXNpbmcgZS50YXJnZXQuXG5cdFx0ICogQHJldHVybnMge09iamVjdHxmYWxzZX0galF1ZXJ5IGpxWEhSIG9iamVjdCBvciBmYWxzZSBpZiBmb3JtIGhhcyBlcnJvcnMuXG5cdFx0ICovXG5cdFx0aGFuZGxlU3Vic2NyaXB0aW9uQ2xpY2s6IGZ1bmN0aW9uKGUsICRjbGlja2VkRWwpIHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblxuXHRcdFx0dmFyICRjbGlja2VkRWwgICAgICAgICAgICA9ICRjbGlja2VkRWwgPyAkY2xpY2tlZEVsIDogJChlLnRhcmdldCk7XG5cdFx0XHR2YXIgc3Vic2NyaWJlU3RhdHVzICAgICAgID0gJGNsaWNrZWRFbC5oYXNDbGFzcygnYnV0dG9uLS11bnN1YnNjcmliZScpID8gJ1VOU1VCJyA6ICdOT1JNQUwnO1xuXHRcdFx0dmFyIG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCA9ICRjbGlja2VkRWwuaHRtbCgpO1xuXHRcdFxuXHRcdFx0JGNsaWNrZWRFbC5odG1sKCdMb2FkaW5nLi4uJyk7XG5cdFx0XHRcblx0XHRcdHZhciBuZXdzbGV0dGVySWQgICAgID0gJGNsaWNrZWRFbC5kYXRhKCduZXdzbGV0dGVyLWlkJyk7XG5cdFx0XHR2YXIgbmV3c2xldHRlclNvdXJjZSA9ICRjbGlja2VkRWwuZGF0YSgnc291cmNlaWQnKSB8fCAnJztcblx0XHRcdHZhciBpbnB1dEVtYWlsICAgICAgID0gJGNsaWNrZWRFbC5zaWJsaW5ncygnaW5wdXRbdHlwZT1lbWFpbF0nKS52YWwoKSB8fCAkKCcjZW1haWwtJyArIG5ld3NsZXR0ZXJJZCkudmFsKCk7XG5cdFx0XHR2YXIgZm9ybUVycm9ycyAgICAgICA9IE5ld3NsZXR0ZXJzLmdldEZvcm1FcnJvcnMoaW5wdXRFbWFpbCk7XG5cdFx0XHRcblx0XHRcdGlmIChmb3JtRXJyb3JzLmxlbmd0aCkge1xuXHRcdFx0XHROZXdzbGV0dGVycy5zaG93RXJyb3IoJCgnI2Zvcm0tZmVlZGJhY2stJyArIG5ld3NsZXR0ZXJJZCksICRjbGlja2VkRWwsIG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCwgJzxzcGFuIGNsYXNzPVwiZXJyb3ItbWVzc2FnZVwiPicgKyBmb3JtRXJyb3JzLmpvaW4oJyAnKSArICc8L3NwYW4+Jyk7XG5cdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHJldHVybiBOZXdzbGV0dGVycy5nZXRTdWJzY3JpYmVyKGlucHV0RW1haWwpXG5cdFx0XHRcdC50aGVuKGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdHZhciByZXN1bHRzID0gTmV3c2xldHRlcnMuVXNlcjtcblx0XHRcdFx0XHR2YXIgZW1haWwgICA9IHJlc3VsdHMuYWRkcmVzcyB8fCBpbnB1dEVtYWlsO1xuXHRcdFx0XHRcdHZhciBpZCAgICAgID0gcmVzdWx0cy5yZWNpcGllbnRJZDtcblx0XHRcdFx0XHRcblx0XHRcdFx0XHROZXdzbGV0dGVycy5tYW5hZ2VTdWJzY3JpcHRpb24oZW1haWwsIGlkLCBzdWJzY3JpYmVTdGF0dXMsIG5ld3NsZXR0ZXJJZCwgbmV3c2xldHRlclNvdXJjZSwgJGNsaWNrZWRFbCwgb3JpZ2luYWxDbGlja2VkRWxUZXh0KTtcblx0XHRcdFx0fSk7XHRcblx0XHRcdH1cblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogQ2hlY2tzIHNpZ251cCBmb3JtIGZvciBlcnJvcnMuXG5cdFx0ICogVmFsaWRhdGVzIGVtYWlsIGFkZHJlc3Mgc3RyaW5nIHZpYSB7QGxpbmsgTmV3c2xldHRlcnMudmFsaWRhdGVFbWFpbH1cblx0XHQgKiBhbmQgY2hlY2tib3ggdmlhIHtAbGluayBOZXdzbGV0dGVycy52YWxpZGF0ZUNoZWNrYm94Q2hlY2t9LCBpZiBwcmVzZW50LlxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBpbnB1dEVtYWlsXG5cdFx0ICogQHJldHVybnMge2FycmF5fSBBcnJheSBvZiBlcnJvciBtZXNzYWdlcyAoY2FuIGJlIGVtcHR5KS5cblx0XHQgKi9cblx0XHRnZXRGb3JtRXJyb3JzOiBmdW5jdGlvbihpbnB1dEVtYWlsKSB7XG5cdFx0XHR2YXIgZXJyb3JzID0gW107XG5cdFx0XHR2YXIgJGNoZWNrYm94ID0gJCgnLnJlcXVpcmVkLWNoZWNrYm94Jyk7XG5cblx0XHRcdGlmICghTmV3c2xldHRlcnMudmFsaWRhdGVFbWFpbChpbnB1dEVtYWlsKSkge1xuXHRcdFx0XHRlcnJvcnMucHVzaCgnWW91IGVudGVyZWQgYW4gaW52YWxpZCBlbWFpbCBhZGRyZXNzLiBQbGVhc2UgdHJ5IGFnYWluLicpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoJGNoZWNrYm94Lmxlbmd0aCAmJiAhTmV3c2xldHRlcnMudmFsaWRhdGVDaGVja2JveENoZWNrKCRjaGVja2JveCkpIHtcblx0XHRcdFx0ZXJyb3JzLnB1c2goJ1BsZWFzZSBhZ3JlZSB0byB0aGUgUHJpdmFjeSBQb2xpY3kgYW5kIFRlcm1zIG9mIFVzZS4nKTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGVycm9ycztcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogUmV0dXJucyB3aGV0aGVyIG9yIG5vdCB0aGUgY2hlY2tib3ggaXMgY2hlY2tlZC5cblx0XHQgKiBAcGFyYW0ge09iamVjdH0gJGNoZWNrYm94IC0galF1ZXJ5IGNoZWNrYm94IGVsZW1lbnQuXG5cdFx0ICogQHJldHVybnMge2Jvb2xlYW59IElzIGNoZWNrYm94IGNoZWNrZWQuXG5cdFx0ICovXG5cdFx0dmFsaWRhdGVDaGVja2JveENoZWNrOiBmdW5jdGlvbigkY2hlY2tib3gpIHtcblx0XHRcdHJldHVybiAkY2hlY2tib3guaXMoJzpjaGVja2VkJyk7XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIEdldCBzdWJzY3JpYmVyIHVzZXIgZnJvbSBQb3N0VXAgYW5kIHNldCBkYXRhIHRvIE5ld3NsZXR0ZXJzLlVzZXJcblx0XHQgKiBJZiBOZXdzbGV0dGVycy5Vc2VyIGlzIGFscmVhZHkgc2V0LCBza2lwIGdldHRpbmcgdXNlciBmcm9tIHNlcnZlci5cblx0XHQgKiBcblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gZW1haWxcblx0XHQgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkgUHJvbWlzZS5cblx0XHQgKi9cblx0XHRnZXRTdWJzY3JpYmVyOiBmdW5jdGlvbihlbWFpbCkge1xuXHRcdFx0dmFyIGdldFVzZXI7XG5cblx0XHRcdGlmICghTmV3c2xldHRlcnMuVXNlciAmJiBlbWFpbCkge1xuXHRcdFx0XHRnZXRVc2VyID0gJC5hamF4KHtcblx0XHRcdFx0XHR1cmw6ICcvcG9zdHVwLWVtYWlsLWNoZWNrL3Jlc3VsdHMvJyxcblx0XHRcdFx0XHRkYXRhOiB7XG5cdFx0XHRcdFx0XHQncycgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGVtYWlsLFxuXHRcdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcG9zdHVwX2VtYWlsX2NoZWNrJyAgOiAxLFxuXHRcdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcG9zdHVwX2VtYWlsX2FkZHJlc3MnOiAxXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRjYWNoZTogdHJ1ZVxuXHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XG5cdFx0XHRyZXR1cm4gJC53aGVuKGdldFVzZXIpXG5cdFx0XHQuZG9uZShmdW5jdGlvbihyZXNwKSB7XG5cdFx0XHRcdGlmIChyZXNwICYmIHJlc3Auc3VjY2Vzcykge1xuXHRcdFx0XHRcdHZhciBkYXRhID0gcmVzcC5kYXRhO1xuXHRcdFx0XHRcdFxuXHRcdFx0XHRcdE5ld3NsZXR0ZXJzLlVzZXIgPSBkYXRhO1xuXHRcdFx0XHR9XG5cdFx0XHR9KVxuXHRcdH0sXG5cblx0XHQvKipcblx0XHQgKiBDaGVja3MgaWYgdXNlciBpcyBzdWJzY3JpYmVkIHRvIG5ld3NsZXR0ZXIgaW4gUG9zdFVwLlxuXHRcdCAqIEBwYXJhbSB7bnVtYmVyfSB1c2VySWQgLSBgcmVjaXBpZW50SWRgIGZyb20gUG9zdFVwLlxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBuZXdzbGV0dGVySWRcblx0XHQgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkganFYSFIgb2JqZWN0LlxuXHRcdCAqL1xuXHRcdGdldFN1YnNjcmlwdGlvblN0YXR1czogZnVuY3Rpb24odXNlcklkLCBuZXdzbGV0dGVySWQpIHtcblx0XHRcdC8vIElmIHRoaXMgd2FzIGFuIHVuc3ViIGFjdGlvbiB0aGVuIHRoZSBjYWxsIHJldHVybmVkIGZyb20gdGhlIHNlcnZlciB3aWxsXG5cdFx0XHQvLyBiZSBjYWNoZWQgYW5kIG91dCBvZiBzeW5jIHNvIHJldHVybiB3aGF0IGl0IHNob3VsZCBiZVxuXHRcdFx0aWYgKE5ld3NsZXR0ZXJzLmlzVW5zdWIgJiYgTmV3c2xldHRlcnMudW5zdWJJZCA9PT0gbmV3c2xldHRlcklkKSB7XG5cdFx0XHRcdGdldFN0YXR1cyA9ICQuRGVmZXJyZWQoKTtcblx0XHRcdFx0Z2V0U3RhdHVzLnJlc29sdmUoe1xuXHRcdFx0XHRcdHN1Y2Nlc3M6IHRydWUsXG5cdFx0XHRcdFx0ZGF0YTogMFxuXHRcdFx0XHR9KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGdldFN0YXR1cyA9ICQuYWpheCh7XG5cdFx0XHRcdFx0dXJsOiAnL3Bvc3R1cC1uZXdzbGV0dGVyLWNoZWNrL3Jlc3VsdHMvJyxcblx0XHRcdFx0XHRkYXRhOiB7XG5cdFx0XHRcdFx0XHQncycgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHVzZXJJZCxcblx0XHRcdFx0XHRcdCdubF9pZCcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogbmV3c2xldHRlcklkLFxuXHRcdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcG9zdHVwX25ld3NsZXR0ZXJfY2hlY2snOiAxLFxuXHRcdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcG9zdHVwX2VtYWlsX2FkZHJlc3MnICAgOiAxXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRjYWNoZTogdHJ1ZVxuXHRcdFx0XHR9KTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGdldFN0YXR1cztcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogTWFuYWdlcyB0aGUgc3Vic2NyaXB0aW9uIGZvciBgdXNlcklkYCBhbmQgYG5ld3NsZXR0ZXJJZGAuXG5cdFx0ICogSWYgbm8gZW1haWwgc2VudCBvciBgc3Vic2NyaWJlU3RhdHVzYCBpcyBgVU5TVUJgLCBjYWxscyB7QGxpbmsgTmV3c2xldHRlcnMubWFuYWdlVXNlcn0uXG5cdFx0ICogT3RoZXJ3aXNlLCBjaGVja3MgaWYgdXNlciBpcyBhbHJlYWR5IHN1YnNyaWJlZCB2aWEge0BsaW5rIE5ld3NsZXR0ZXJzLmdldFN1YnNjcmlwdGlvblN0YXR1c30uXG5cdFx0ICogSWYgbm90LCBjYWxscyB7QGxpbmsgTmV3c2xldHRlcnMubWFuYWdlVXNlcn0uXG5cdFx0ICogT3RoZXJ3aXNlLCBjYWxscyB7QGxpbmsgTmV3c2xldHRlcnMuY29uZmlybUFscmVhZHlTdWJzY3JpYmVkfSBpZiB1c2VyIGlzIGFscmVhZHkgc3Vic2NyaWJlZC5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gZW1haWxcblx0XHQgKiBAcGFyYW0ge251bWJlcn0gdXNlcklkIC0gYHJlY2lwaWVudElkYCBmcm9tIFBvc3RVcC5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gc3Vic2NyaWJlU3RhdHVzIC0gYFVOU1VCYCBvciBgTk9STUFMYCAoY2hlY2tzIGZvciBgVU5TVUJgKS5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gbmV3c2xldHRlcklkXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IG5ld3NsZXR0ZXJTb3VyY2Vcblx0XHQgKiBAcGFyYW0ge09iamVjdH0gJGNsaWNrZWRFbCAtIGpRdWVyeSBvYmplY3QgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LlxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBvcmlnaW5hbENsaWNrZWRFbFRleHQgLSBUaGUgb3JpZ2luYWwgdGV4dCBvZiBgJGNsaWNrZWRFbGAgYmVmb3JlIGJlaW5nIGNsaWNrZWQuXG5cdFx0ICovXG5cdFx0bWFuYWdlU3Vic2NyaXB0aW9uOiBmdW5jdGlvbihlbWFpbCwgdXNlcklkLCBzdWJzY3JpYmVTdGF0dXMsIG5ld3NsZXR0ZXJJZCwgbmV3c2xldHRlclNvdXJjZSwgJGNsaWNrZWRFbCwgb3JpZ2luYWxDbGlja2VkRWxUZXh0KSB7XHRcdFx0XG5cdFx0XHQvLyB1c2VyIElTIE5PVCBpbiBQb3N0VXBcblx0XHRcdGlmICghdXNlcklkKSB7XG5cdFx0XHRcdC8vIGFkZCB1c2VyIHRvIHBvc3R1cCBhbmQgc3Vic2NyaWJlIHRoZW0gdG8gbmV3c2xldHRlclxuXHRcdFx0XHROZXdzbGV0dGVycy5tYW5hZ2VVc2VyKGVtYWlsLCBuZXdzbGV0dGVySWQsIG5ld3NsZXR0ZXJTb3VyY2UsIHN1YnNjcmliZVN0YXR1cywgJGNsaWNrZWRFbCwgb3JpZ2luYWxDbGlja2VkRWxUZXh0KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGlmICgnVU5TVUInID09PSBzdWJzY3JpYmVTdGF0dXMpIHtcblx0XHRcdFx0XHROZXdzbGV0dGVycy5tYW5hZ2VVc2VyKGVtYWlsLCBuZXdzbGV0dGVySWQsICcnLCBzdWJzY3JpYmVTdGF0dXMsICRjbGlja2VkRWwsIG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0Ly8gY2hlY2sgaWYgdXNlciBpcyBhbHJlYWR5IHN1YnNjcmliZWQgdG8gbmV3c2xldHRlclxuXHRcdFx0XHRcdE5ld3NsZXR0ZXJzLmdldFN1YnNjcmlwdGlvblN0YXR1cyh1c2VySWQsIG5ld3NsZXR0ZXJJZClcblx0XHRcdFx0XHQudGhlbihmdW5jdGlvbihyZXNwKSB7XG5cdFx0XHRcdFx0XHR2YXIgbmV3c2xldHRlclJlc3VsdHMgPSByZXNwLmRhdGE7XG5cblx0XHRcdFx0XHRcdC8vIHVzZXIgSVMgTk9UIGFscmVhZHkgc3Vic2NyaWJlZCB0byBuZXdzbGV0dGVyXG5cdFx0XHRcdFx0XHRpZiAobmV3c2xldHRlclJlc3VsdHMgPT09IDApIHtcblx0XHRcdFx0XHRcdFx0TmV3c2xldHRlcnMubWFuYWdlVXNlcihlbWFpbCwgbmV3c2xldHRlcklkLCBuZXdzbGV0dGVyU291cmNlLCBzdWJzY3JpYmVTdGF0dXMsICRjbGlja2VkRWwsIG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCk7XG5cdFx0XHRcdFx0XHR9IGVsc2UgeyAvLyB1c2VyIElTIGFscmVhZHkgc3Vic2NyaWJlZCB0byBuZXdzbGV0dGVyXG5cdFx0XHRcdFx0XHRcdE5ld3NsZXR0ZXJzLmNvbmZpcm1BbHJlYWR5U3Vic2NyaWJlZChuZXdzbGV0dGVySWQsICRjbGlja2VkRWwsIG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogTWFuYWdlIHRoZSBzdWJzY3JpcHRpb24gaW4gUG9zdFVwIGZvciBgZW1haWxgIGFuZCBgbmV3c2xldHRlcklkYC5cblx0XHQgKiBJZiBzdWNjZXNzZnVsLCBjYWxscyB7QGxpbmsgTmV3c2xldHRlcnMuY29uZmlybVN1YnNjcmlwdGlvbkNoYW5nZX0sXG5cdFx0ICogZWxzZSBjYWxscyB7QGxpbmsgTmV3c2xldHRlcnMuc2hvd0Vycm9yfS5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gZW1haWxcblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gbmV3c2xldHRlcklkXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IG5ld3NsZXR0ZXJTb3VyY2Vcblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gc3Vic2NyaWJlU3RhdHVzIC0gYFVOU1VCYCBvciBgTk9STUFMYC5cblx0XHQgKiBAcGFyYW0ge09iamVjdH0gJGNsaWNrZWRFbCAtIGpRdWVyeSBvYmplY3QgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LlxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBvcmlnaW5hbENsaWNrZWRFbFRleHQgLSBUaGUgb3JpZ2luYWwgdGV4dCBvZiBgJGNsaWNrZWRFbGAgYmVmb3JlIGJlaW5nIGNsaWNrZWQuXG5cdFx0ICogQHJldHVybnMge09iamVjdH0galF1ZXJ5IGpxWEhSIG9iamVjdC5cblx0XHQgKi9cblx0XHRtYW5hZ2VVc2VyOiBmdW5jdGlvbihlbWFpbCwgbmV3c2xldHRlcklkLCBuZXdzbGV0dGVyU291cmNlLCBzdWJzY3JpYmVTdGF0dXMsICRjbGlja2VkRWwsIG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCkgeyBcblx0XHRcdHZhciBpc09wdE91dFVwZGF0ZSA9IChuZXdzbGV0dGVySWQgPT09IE5ld3NsZXR0ZXJzLmlkcy5nbG9iYWxvcHRvdXQpO1xuXHRcdFx0dmFyIG1hbmFnZUFjdGlvbjtcblxuXHRcdFx0aWYgKGlzT3B0T3V0VXBkYXRlKSB7XG5cdFx0XHRcdG1hbmFnZUFjdGlvbiA9IE5ld3NsZXR0ZXJzLnVwZGF0ZVVzZXJPcHRPdXQoZW1haWwsIHN1YnNjcmliZVN0YXR1cyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRtYW5hZ2VBY3Rpb24gPSBOZXdzbGV0dGVycy51cGRhdGVVc2VyU3Vic2NyaXB0aW9uKGVtYWlsLCBuZXdzbGV0dGVySWQsIHN1YnNjcmliZVN0YXR1cywgbmV3c2xldHRlclNvdXJjZSk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBtYW5hZ2VBY3Rpb24udGhlbihmdW5jdGlvbihyZXNwKSB7XG5cdFx0XHRcdHZhciByZXN1bHRzID0gcmVzcC5kYXRhO1xuXHRcdFx0XHR2YXIgc3VjY2VzcyA9IGlzT3B0T3V0VXBkYXRlID8gKHJlc3VsdHMuc3RhdHVzICYmIHJlc3VsdHMuc3RhdHVzICE9PSAnZXJyb3InKSA6IChyZXN1bHRzLm51bU5ld3NsZXR0ZXJzID4gMCk7XG5cdFx0XHRcdFxuXHRcdFx0XHRpZiAoc3VjY2Vzcykge1xuXHRcdFx0XHRcdE5ld3NsZXR0ZXJzLmNvbmZpcm1TdWJzY3JpcHRpb25DaGFuZ2UobmV3c2xldHRlcklkLCBzdWJzY3JpYmVTdGF0dXMsICRjbGlja2VkRWwsIG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0TmV3c2xldHRlcnMuc2hvd0Vycm9yKCQoJyNmb3JtLWZlZWRiYWNrLScgKyBuZXdzbGV0dGVySWQpLCAkY2xpY2tlZEVsLCBvcmlnaW5hbENsaWNrZWRFbFRleHQsIE5ld3NsZXR0ZXJzLm1lc3NhZ2VzLmVycm9yKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fSxcblxuXHRcdHVwZGF0ZVVzZXJPcHRPdXQ6IGZ1bmN0aW9uKGVtYWlsLCBzdWJzY3JpYmVTdGF0dXMpIHtcblx0XHRcdHJldHVybiAkLmFqYXgoe1xuXHRcdFx0XHR1cmw6ICcvcG9zdHVwLXVzZXItc3Vic2NyaWJlL3Jlc3VsdHMvJyxcblx0XHRcdFx0ZGF0YToge1xuXHRcdFx0XHRcdCdzJyAgICAgICAgICAgICAgICAgICAgICAgICAgOiBlbWFpbCxcblx0XHRcdFx0XHQnc3Vic2NyaWJlX3N0YXR1cycgICAgICAgICAgIDogc3Vic2NyaWJlU3RhdHVzLFxuXHRcdFx0XHRcdCdpcCcgICAgICAgICAgICAgICAgICAgICAgICAgOiAnMC4wLjAuMCcsXG5cdFx0XHRcdFx0J2lwX29yZycgICAgICAgICAgICAgICAgICAgICA6ICdub25lJyxcblx0XHRcdFx0XHQnX19mcF9lbmRwb2ludF9wb3N0dXBfb3B0b3V0JzogMVxuXHRcdFx0XHR9LFxuXHRcdFx0XHRjYWNoZTogdHJ1ZVxuXHRcdFx0fSk7XG5cdFx0fSxcblxuXHRcdHNldFVzZXJPcHRPdXQ6IGZ1bmN0aW9uKG5ld3NsZXR0ZXJJZCwgc3RhdHVzKSB7XG5cdFx0XHRpZiAoc3RhdHVzID09PSAnVScpIHtcblx0XHRcdFx0TmV3c2xldHRlcnMuc2V0TmV3c2xldHRlcklzU3Vic2NyaWJlZFN0YXRlKG5ld3NsZXR0ZXJJZCk7XG5cdFx0XHR9XG5cdFx0XHRcblx0XHRcdE5ld3NsZXR0ZXJzLnNob3dTaWduVXBCdXR0b25zKG5ld3NsZXR0ZXJJZCk7XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIFVwZGF0ZSB1c2VyJ3Mgc3Vic2NyaXB0aW9uIGluIFBvc3RVcC5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gZW1haWxcblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gbmV3c2xldHRlcklkXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IHN1YnNjcmliZVN0YXR1cyAtIGBVTlNVQmAgb3IgYE5PUk1BTGAuXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IHNvdXJjZUlkXG5cdFx0ICogQHJldHVybnMge09iamVjdH0galF1ZXJ5IGpxWEhSIG9iamVjdC5cblx0XHQgKi9cblx0XHR1cGRhdGVVc2VyU3Vic2NyaXB0aW9uOiBmdW5jdGlvbihlbWFpbCwgbmV3c2xldHRlcklkLCBzdWJzY3JpYmVTdGF0dXMsIHNvdXJjZUlkKSB7XG5cdFx0XHRyZXR1cm4gJC5hamF4KHtcblx0XHRcdFx0dXJsOiAnL3Bvc3R1cC11c2VyLXN1YnNjcmliZS9yZXN1bHRzLycsXG5cdFx0XHRcdGRhdGE6IHtcblx0XHRcdFx0XHQncycgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBlbWFpbCxcblx0XHRcdFx0XHQnbmxfaWQnICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBuZXdzbGV0dGVySWQsXG5cdFx0XHRcdFx0J3N1YnNjcmliZV9zdGF0dXMnICAgICAgICAgICAgICAgICAgICAgICAgIDogc3Vic2NyaWJlU3RhdHVzLFxuXHRcdFx0XHRcdCdpcCcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICcwLjAuMC4wJyxcblx0XHRcdFx0XHQnaXBfb3JnJyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnbm9uZScsXG5cdFx0XHRcdFx0J3NvdXJjZV9pZCcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogc291cmNlSWQsXG5cdFx0XHRcdFx0J19fZnBfZW5kcG9pbnRfcG9zdHVwX25ld3NsZXR0ZXJfc3Vic2NyaWJlJzogMSxcblx0XHRcdFx0XHQnX19mcF9lbmRwb2ludF9wb3N0dXBfZW1haWxfc3Vic2NyaWJlJyAgICAgOiAxLFxuXHRcdFx0XHR9LFxuXHRcdFx0XHRjYWNoZTogdHJ1ZVxuXHRcdFx0fSk7XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIEhhbmRsZXMgZWxlbWVudCB1cGRhdGVzIGZvciBjb25maXJtaW5nIHVzZXIgaXMgYWxyZWFkeSBzdWJzcmliZWQuXG5cdFx0ICogQ2hlY2tzIGZvciBjZXJ0YWluIG5ld3NsZXR0ZXJzIHRvIGhhbmRsZSBlbGVtZW50cyBkaWZmZXJlbnRseSBjYWxsaW5nXG5cdFx0ICoge0BsaW5rIE5ld3NsZXR0ZXJzLmNvbmZpcm1BbHJlYWR5U3Vic2NyaWJlZFNwZWNpYWx9LlxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBuZXdzbGV0dGVySWRcblx0XHQgKiBAcGFyYW0ge09iamVjdH0gJGNsaWNrZWRFbCAtIGpRdWVyeSBvYmplY3QgdGhhdCB0cmlnZ2VyZWQgdGhlIGV2ZW50LlxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBvcmlnaW5hbENsaWNrZWRFbFRleHQgLSBUaGUgb3JpZ2luYWwgdGV4dCBvZiBgJGNsaWNrZWRFbGAgYmVmb3JlIGJlaW5nIGNsaWNrZWQuXG5cdFx0ICovXHRcblx0XHRjb25maXJtQWxyZWFkeVN1YnNjcmliZWQ6IGZ1bmN0aW9uKG5ld3NsZXR0ZXJJZCwgJGNsaWNrZWRFbCwgb3JpZ2luYWxDbGlja2VkRWxUZXh0KSB7XG5cdFx0XHQvLyBJbnNpZGVyLCBFZGl0b3JzJyBQaWNrcywgSSBTcHkgc2Vhc29uIDIsIFdoaWxlIFlvdSBXZXJlbuKAmXQgTG9va2luZywgYW5kIEZQQSBDbGltYXRlICYgU2VjdXJpdHkgcmVwb3J0IGVtYWlsIGxpc3Qgc2lnbnVwXG5cdFx0XHR2YXIgc3BlY2lhbElkcyA9IFsnMTY5JywgJzE0JywgJzIwNScsICcyNDQnLCAnMjYxJ107XG5cdFx0XHR2YXIgaXNTcGVjaWFsID0gc3BlY2lhbElkcy5pbmRleE9mKG5ld3NsZXR0ZXJJZCkgPiAtMSB8fCAkKCcuY2F0ZWdvcnktbmV3c2xldHRlci1zaWdudXAnKS5sZW5ndGg7XG5cblx0XHRcdC8vIERvbid0IHdvcnJ5IGFib3V0IGRvaW5nIGFueXRoaW5nIHNwZWNpYWwgaGVyZSwgbWFrZSBpdCBsb29rIGxpa2Vcblx0XHRcdC8vIHdoYXQgc2hvdWxkJ3ZlIGhhcHBlbmVkIGhhcHBlbmVkLCBldmVuIGlmIGl0IHdhcyBhbHJlYWR5IHRoZSBjYXNlXG5cdFx0XHRpZiAoTmV3c2xldHRlcnMuaXNOZXdzbGV0dGVyc0xpc3RQYWdlKSB7XG5cdFx0XHRcdE5ld3NsZXR0ZXJzLmNvbmZpcm1TdWJzY3JpcHRpb25DaGFuZ2UobmV3c2xldHRlcklkLCAnTk9STUFMJywgJGNsaWNrZWRFbCwgb3JpZ2luYWxDbGlja2VkRWxUZXh0KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGlmIChpc1NwZWNpYWwpIHtcblx0XHRcdFx0XHROZXdzbGV0dGVycy5jb25maXJtQWxyZWFkeVN1YnNjcmliZWRTcGVjaWFsKG5ld3NsZXR0ZXJJZCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0aWYgKCBOZXdzbGV0dGVycy5pc0hvbWVQYWdlICkge1xuXHRcdFx0XHRcdFx0JGNsaWNrZWRFbC5zaWJsaW5ncyggJy5mb3JtLWZlZWRiYWNrJyApLmh0bWwoIE5ld3NsZXR0ZXJzLm1lc3NhZ2VzLmFscmVhZHlUaGVyZSApLmZhZGVJbiggJ2Zhc3QnICk7XG5cdFx0XHRcdFx0XHRzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHtcblx0XHRcdFx0XHRcdFx0JCggJy5uZXdzbGV0dGVyLScgKyBuZXdzbGV0dGVySWQgKS5mYWRlT3V0KCk7XG5cdFx0XHRcdFx0XHR9LCAxMDAwICk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdCQoJyNmb3JtLWZlZWRiYWNrLScgKyBuZXdzbGV0dGVySWQpLmh0bWwoTmV3c2xldHRlcnMubWVzc2FnZXMuYWxyZWFkeVRoZXJlKS5mYWRlSW4oJ2Zhc3QnKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0JGNsaWNrZWRFbC5odG1sKG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogSGFuZGxlcyBlbGVtZW50IHVwZGF0ZXMgZm9yIGNvbmZpcm1pbmcgc3Vic2NyaXB0aW9uIGNoYW5nZSBvZiBjZXJ0YWluXG5cdFx0ICogbmV3c2xldHRlcnMgYXMgZGV0ZXJtaW5lZCBpbiB7QGxpbmsgTmV3c2xldHRlcnMuY29uZmlybUFscmVhZHlTdWJzY3JpYmVkfS5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gbmV3c2xldHRlcklkXG5cdFx0ICovXHRcdFxuXHRcdGNvbmZpcm1BbHJlYWR5U3Vic2NyaWJlZFNwZWNpYWw6IGZ1bmN0aW9uKG5ld3NsZXR0ZXJJZCkge1xuXHRcdFx0dmFyICRuZXdzbGV0dGVyID0gJCgnLm5ld3NsZXR0ZXItJyArIG5ld3NsZXR0ZXJJZCk7XG5cblx0XHRcdCQoJyNmb3JtLWZlZWRiYWNrLScgKyBuZXdzbGV0dGVySWQpLmhpZGUoKTtcblxuXHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnaW5wdXRbdHlwZT1lbWFpbF0nKS5oaWRlKCk7XG5cdFx0XHQkbmV3c2xldHRlci5maW5kKCcuYnV0dG9uLmJ1dHRvbi0tc2lnbnVwJykuaGlkZSgpO1xuXHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnLnByaXZhY3ktcG9saWN5LWFja25vd2xlZGdlJykuaGlkZSgpO1xuXHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnLnNpZ25lZC11cCcpLnNob3coKTtcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogSGFuZGxlcyBlbGVtZW50IHVwZGF0ZXMgZm9yIGNvbmZpcm1pbmcgc3Vic2NyaXB0aW9uIGNoYW5nZS5cblx0XHQgKiBDYWxscyBlaXRoZXIge0BsaW5rIE5ld3NsZXR0ZXJzLmNvbmZpcm1VbnN1Yn0gb3Ige0BsaW5rIE5ld3NsZXR0ZXJzLmNvbmZpcm1TdWJ9LlxuXHRcdCAqIEBwYXJhbSB7c3RyaW5nfSBuZXdzbGV0dGVySWRcblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gc3Vic2NyaWJlU3RhdHVzIC0gYFVOU1VCYCBvciBgTk9STUFMYFxuXHRcdCAqIEBwYXJhbSB7T2JqZWN0fSAkY2xpY2tlZEVsIC0galF1ZXJ5IG9iamVjdCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCAtIFRoZSBvcmlnaW5hbCB0ZXh0IG9mIGAkY2xpY2tlZEVsYCBiZWZvcmUgYmVpbmcgY2xpY2tlZC5cblx0XHQgKi9cdFx0XG5cdFx0Y29uZmlybVN1YnNjcmlwdGlvbkNoYW5nZTogZnVuY3Rpb24obmV3c2xldHRlcklkLCBzdWJzY3JpYmVTdGF0dXMsICRjbGlja2VkRWwsIG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCkge1xuXHRcdFx0JCgnI2Zvcm0tZmVlZGJhY2stJyArIG5ld3NsZXR0ZXJJZCkuaHRtbCgnJykuZmFkZU91dCgnZmFzdCcpO1xuXG5cdFx0XHRpZiAoJ1VOU1VCJyA9PT0gc3Vic2NyaWJlU3RhdHVzKSB7XG5cdFx0XHRcdE5ld3NsZXR0ZXJzLmNvbmZpcm1VbnN1YihuZXdzbGV0dGVySWQsICRjbGlja2VkRWwsIG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHROZXdzbGV0dGVycy5jb25maXJtU3ViKG5ld3NsZXR0ZXJJZCwgJGNsaWNrZWRFbCwgb3JpZ2luYWxDbGlja2VkRWxUZXh0KTtcblx0XHRcdH1cblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogSGFuZGxlcyBlbGVtZW50IHVwZGF0ZXMgZm9yIGNvbmZpcm1pbmcgdW5zdWJzY3JpYmUuXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IG5ld3NsZXR0ZXJJZFxuXHRcdCAqIEBwYXJhbSB7T2JqZWN0fSAkY2xpY2tlZEVsIC0galF1ZXJ5IG9iamVjdCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCAtIFRoZSBvcmlnaW5hbCB0ZXh0IG9mIGAkY2xpY2tlZEVsYCBiZWZvcmUgYmVpbmcgY2xpY2tlZC5cblx0XHQgKi9cdFx0XHRcblx0XHRjb25maXJtVW5zdWI6IGZ1bmN0aW9uKG5ld3NsZXR0ZXJJZCwgJGNsaWNrZWRFbCwgb3JpZ2luYWxDbGlja2VkRWxUZXh0KSB7XG5cdFx0XHR2YXIgJG5ld3NsZXR0ZXIgPSAkKCcubmV3c2xldHRlci0nICsgbmV3c2xldHRlcklkKTtcblxuXHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnLnNpZ25lZC11cCcpLmZhZGVPdXQoJ2Zhc3QnLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnLmJ1dHRvbi0tc2lnbnVwJykuZmFkZUluKCdmYXN0JykuYWRkQ2xhc3MoJ2FjdGl2ZScpO1xuXG5cdFx0XHRcdCRjbGlja2VkRWwuaHRtbChvcmlnaW5hbENsaWNrZWRFbFRleHQpO1xuXG5cdFx0XHRcdGlmICghRlAuU2luZ2xldG9ucy5Vc2VyLnVzZXJEYXRhLmVtYWlsKSB7XG5cdFx0XHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnaW5wdXRbdHlwZT1lbWFpbF0nKS5mYWRlSW4oJ2Zhc3QnKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIEhhbmRsZXMgZWxlbWVudCB1cGRhdGVzIGZvciBjb25maXJtaW5nIHN1YnNjcmliZS5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gbmV3c2xldHRlcklkXG5cdFx0ICogQHBhcmFtIHtPYmplY3R9ICRjbGlja2VkRWwgLSBqUXVlcnkgb2JqZWN0IHRoYXQgdHJpZ2dlcmVkIHRoZSBldmVudC5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gb3JpZ2luYWxDbGlja2VkRWxUZXh0IC0gVGhlIG9yaWdpbmFsIHRleHQgb2YgYCRjbGlja2VkRWxgIGJlZm9yZSBiZWluZyBjbGlja2VkLlxuXHRcdCAqL1x0XHRcdFx0XG5cdFx0Y29uZmlybVN1YjogZnVuY3Rpb24obmV3c2xldHRlcklkLCAkY2xpY2tlZEVsLCBvcmlnaW5hbENsaWNrZWRFbFRleHQpIHtcblx0XHRcdHZhciAkbmV3c2xldHRlciA9ICQoJy5uZXdzbGV0dGVyLScgKyBuZXdzbGV0dGVySWQpO1xuXG5cdFx0XHQkbmV3c2xldHRlci5maW5kKCdpbnB1dFt0eXBlPWVtYWlsXScpLmZhZGVPdXQoJ2Zhc3QnLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnLmJ1dHRvbi0tc2lnbnVwJykuZmFkZU91dCgnZmFzdCcsIGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdCQoJ2lucHV0W3R5cGU9ZW1haWxdJykudmFsKCRuZXdzbGV0dGVyLmZpbmQoJ2lucHV0W3R5cGU9ZW1haWxdJykudmFsKCkpO1xuXG5cdFx0XHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnLnByaXZhY3ktcG9saWN5LWFja25vd2xlZGdlJykuaGlkZSgpO1xuXG5cdFx0XHRcdFx0JG5ld3NsZXR0ZXIuZmluZCgnLnNpZ25lZC11cCcpLmZhZGVJbignZmFzdCcpO1xuXG5cdFx0XHRcdFx0JGNsaWNrZWRFbC5odG1sKG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCk7XG5cdFx0XHRcdH0pLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcblx0XHRcdH0pO1xuXHRcdH0sXG5cblx0XHQvKipcblx0XHQgKiBIYW5kbGVzIHNob3dpbmcgZXJyb3IgbWVzc2FnZXMuXG5cdFx0ICogQHBhcmFtIHtPYmplY3R9ICRlcnJvckNvbnRhaW5lciAtIGpRdWVyeSBvYmplY3QgdG8gc2hvdyBlcnJvclxuXHRcdCAqIEBwYXJhbSB7T2JqZWN0fSAkY2xpY2tlZEVsIC0galF1ZXJ5IG9iamVjdCB0aGF0IHRyaWdnZXJlZCB0aGUgZXZlbnQuXG5cdFx0ICogQHBhcmFtIHtzdHJpbmd9IG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCAtIFRoZSBvcmlnaW5hbCB0ZXh0IG9mIGAkY2xpY2tlZEVsYCBiZWZvcmUgYmVpbmcgY2xpY2tlZC5cblx0XHQgKiBAcGFyYW0ge3N0cmluZ30gZXJyb3JNc2cgLSBIVE1MIHN0cmluZyBvZiBlcnJvciBtZXNzYWdlIHRvIHNob3cuXG5cdFx0ICovXHRcblx0XHRzaG93RXJyb3I6IGZ1bmN0aW9uKCRlcnJvckNvbnRhaW5lciwgJGNsaWNrZWRFbCwgb3JpZ2luYWxDbGlja2VkRWxUZXh0LCBlcnJvck1zZykge1x0XHRcdFxuXHRcdFx0JGVycm9yQ29udGFpbmVyLmh0bWwoZXJyb3JNc2cpLmZhZGVJbignZmFzdCcpO1xuXG5cdFx0XHRpZiAoJGNsaWNrZWRFbCAmJiBvcmlnaW5hbENsaWNrZWRFbFRleHQpIHtcblx0XHRcdFx0JGNsaWNrZWRFbC5odG1sKG9yaWdpbmFsQ2xpY2tlZEVsVGV4dCk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9O1xuXG5cdEZQLk5ld3NsZXR0ZXJzID0gTmV3c2xldHRlcnM7XG5cdFxuXHRpZiAoIEZQLlNpbmdsZXRvbnMuVXNlciApIHtcblx0XHRpbml0KCk7XG5cdH0gZWxzZSB7XG5cdFx0JCggZG9jdW1lbnQgKS5vbiggJ3BpYW5vQWNjZXNzQ2hlY2tDb21wbGV0ZSB0YWtlb3ZlclJlbmRlcmVkJywgaW5pdCApO1xuXHR9XG5cblx0ZnVuY3Rpb24gaW5pdCgpIHtcblx0XHR2YXIgJGVtYWlsICAgICAgICAgICA9ICQoJ2lucHV0W3R5cGU9ZW1haWxdJyk7XG5cdFx0dmFyIGVtYWlsRm9ybVByZXNlbnQgPSAkZW1haWwubGVuZ3RoIHx8ICQoJy5mb3JtLWZlZWRiYWNrJykubGVuZ3RoO1xuXG5cdFx0aWYgKGVtYWlsRm9ybVByZXNlbnQpIHtcblx0XHRcdE5ld3NsZXR0ZXJzLmluaXQoKTtcblx0XHR9XG5cdH1cblxufShqUXVlcnkpO1xuIl19;
!function(u,o,l){var e={cookiePath:"/",cookieDomain:"foreignpolicy.com",numQualified:1,init:function(){var e=this;e.isLoaded.then(function(){e.validateTakeovers()})},isLoaded:new Promise(function(e,t){var n,i=0;i<=8e3&&(n=setInterval(function(){o&&l&&l.Singletons&&l.Singletons.User&&l.Singletons.User.ipAccessData&&(i+=200,clearInterval(n),e())},200))}),validateTakeovers:function(){var r=this;o.length&&o.forEach(function(o){new Promise(function(e,t){e(!r.hasCookie("takeover_dismissed_"+o.id)&&!r.hasCookie("takeover_submitted_"+o.id)&&!r.hasCookie("takeover_dismissed_session"))}).then(function(e){var t,n;return o.hasOwnProperty("device_targeting")&&(t=!1,n=979<u(window).width(),e=!!(t="all"===o.device_targeting||"desktop"===o.device_targeting&&n||"mobile"===o.device_targeting&&!n?!0:t)&&e),e}).then(function(e){return e=!(o.hasOwnProperty("ip_access_guids")&&Array.isArray(o.ip_access_guids)&&o.ip_access_guids.length&&!o.ip_access_guids.includes(l.Singletons.User.ipAccessData.client_guid))&&e}).then(function(e){var t,n;return o.hasOwnProperty("subscription_level")&&(t=!1,n={FPDIGITAL:l.Singletons.User.isSub,FPPREMIUM:l.Singletons.User.isPrem,FPINSIDER:l.Singletons.User.isInsider,FPISPYPLUS:l.Singletons.User.isISpyPlus,REGISTERED:l.Singletons.User.isReg&&!l.Singletons.User.isSub,NONSUB:!l.Singletons.User.isSub,IPACCESS:l.Singletons.User.isIPAccess},o.subscription_level.forEach(function(e){t=!(t||!n[e])||t}),e=!!t&&e),e}).then(function(i){if(o.hasOwnProperty("integration")&&o.integration&&o.integration.hasOwnProperty("integration_type")&&"none"!==o.integration.integration_type&&"postup"===o.integration.integration_type)if(o.integration.hasOwnProperty("postup_list_id")&&""!==o.integration.postup_list_id&&(r.newsletter(o),l.Singletons.User.userData&&l.Singletons.User.userData.email))return new Promise(function(t,e){var n=o.integration.postup_list_id.split(",");r.checkNewsletterSubscription(n[0]).then(function(e){e||t(i)})});return i}).then(function(e){return e&&r.showTakeover(o),e})})},showTakeover:function(e){var t=this;if(1===t.numQualified){switch(takeoverModal=u.parseHTML(e.takeover_html,document,!0),e.template){case"in-article":if(0<u(".single-podcasts").length)return;u(".post-content-main > .meta-data").before(takeoverModal),0<u(".takeover-audio-content audio").length&&u(".takeover-audio-content audio").mediaelementplayer();break;case"in-article-newsletter":u(".post-content-main > .meta-data").before(takeoverModal),u(document).trigger("takeoverRendered");break;default:u("body").append(takeoverModal),u("body").addClass("takeover-open"),"slider"!==e.template?t.modal(e):t.slider(e)}u.event.trigger("takeoverShown"),t.numQualified++}},closeTakeover:function(e,t){u("body").removeClass("takeover-open");var n=this,i=24*e.cookie_duration;n.setCookie("takeover_dismissed_"+e.id,!0,n.expiryDate(i),n.cookiePath,""),t.remove(),n.setCookie("takeover_dismissed_session",!0,"",n.cookiePath,"")},ctaClicked:function(e,t){var n=this;n.setCookie("takeover_dismissed_"+t.id,!0,n.expiryDate(8760),n.cookiePath,""),window.location.href=e.attr("href")},expiryDate:function(e){var t=new Date;return t.setHours(t.getHours()+e),t},getCookie:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setCookie:function(e,t,n,i,o,r){if(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))return!1;var s="";if(n)switch(n.constructor){case Number:s=n===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+n;break;case String:s="; expires="+n;break;case Date:s="; expires="+n.toUTCString()}e=encodeURIComponent(e)+"="+encodeURIComponent(t)+s+(o?"; domain="+o:"")+(i?"; path="+i:"")+(r?"; secure":"");return document.cookie=e,!0},removeCookie:function(e,t,n){return!(!e||!this.hasItem(e))&&(document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(n?"; domain="+n:"")+(t?"; path="+t:""),!0)},hasCookie:function(e){return new RegExp("(?:^|;\\s*)"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},checkNewsletterSubscription:function(t){l.Newsletters=l.Newsletters||{};var e=l.Singletons.User.userData.email;return getNewsletterResults=l.Newsletters.getSubscriber(e).then(function(){var e=l.Newsletters.User.recipientId;return l.Newsletters.getSubscriptionStatus(e,t).then(function(e){e=e.data;return isSubscribedToNewsletter=0!==e})})},modal:function(t){var n=this,e=u("body");e.css("overflow","hidden"),u(document).on("click",".takeover-close",function(){e.css("overflow","visible"),n.closeTakeover(t,u(this).parents(".takeover").last())}),u(document).on("click",".takeover-cta",function(e){e.preventDefault(),n.ctaClicked(u(this),t)})},slider:function(t){var n=this;u(document).on("click",".takeover-close",function(){n.closeTakeover(t,u(this).parents(".takeover").last())}),u(document).on("click",".takeover-cta",function(e){e.preventDefault(),n.ctaClicked(u(this),t)})},newsletter:function(a){var c=this;u(document).on("takeoverShown",function(){var i=u(".takeover-integration-postup form"),o=i.find(".form-feedback"),r=i.find('[name="email"]'),s=i.find('[name="newsletter_id"]').val();i.on("submit",function(e){e.preventDefault();var t=r.val(),n=i.data("sourceid"),e=s.split(",");e.length&&e.forEach(function(e){l.Newsletters.updateUserSubscription(t,e,"NORMAL",n).done(function(e){e&&e.success?(o.text("Thank you for signing up to receive this newsletter."),i.find(".newsletter-input-submit, .account-link").hide(),u(".takeover").delay(3e3).fadeOut(),c.setCookie("takeover_submitted_"+a.id,!0,c.expiryDate(8760),c.cookiePath,"")):o.text("Sorry, there was a problem, please try again.")})})})})}};u(document).on("pianoAccessCheckComplete",function(){e.init()})}(jQuery,takeoverSettings,FP);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRha2VvdmVycy5qcyJdLCJuYW1lcyI6WyIkIiwidGFrZW92ZXJTZXR0aW5ncyIsIkZQIiwidGFrZW92ZXJzIiwiY29va2llUGF0aCIsImNvb2tpZURvbWFpbiIsIm51bVF1YWxpZmllZCIsImluaXQiLCJzZWxmIiwidGhpcyIsImlzTG9hZGVkIiwidGhlbiIsInZhbGlkYXRlVGFrZW92ZXJzIiwiUHJvbWlzZSIsInN1Y2Nlc3MiLCJlcnJvciIsImludGVydmFsIiwiY3VycmVudFdhaXQiLCJzZXRJbnRlcnZhbCIsIlNpbmdsZXRvbnMiLCJVc2VyIiwiaXBBY2Nlc3NEYXRhIiwiY2xlYXJJbnRlcnZhbCIsImxlbmd0aCIsImZvckVhY2giLCJ0YWtlb3ZlciIsInJlc29sdmUiLCJyZWplY3QiLCJoYXNDb29raWUiLCJpZCIsInF1YWxpZmllZCIsImlzVGFyZ2V0ZWQiLCJpc0Rlc2t0b3AiLCJoYXNPd25Qcm9wZXJ0eSIsIndpbmRvdyIsIndpZHRoIiwiZGV2aWNlX3RhcmdldGluZyIsIkFycmF5IiwiaXNBcnJheSIsImlwX2FjY2Vzc19ndWlkcyIsImluY2x1ZGVzIiwiY2xpZW50X2d1aWQiLCJjaGVja01hcHBpbmdzIiwiRlBESUdJVEFMIiwiaXNTdWIiLCJGUFBSRU1JVU0iLCJpc1ByZW0iLCJGUElOU0lERVIiLCJpc0luc2lkZXIiLCJGUElTUFlQTFVTIiwiaXNJU3B5UGx1cyIsIlJFR0lTVEVSRUQiLCJpc1JlZyIsIk5PTlNVQiIsIklQQUNDRVNTIiwiaXNJUEFjY2VzcyIsInN1YnNjcmlwdGlvbl9sZXZlbCIsInN1YnNjcmlwdGlvbiIsImludGVncmF0aW9uIiwiaW50ZWdyYXRpb25fdHlwZSIsInBvc3R1cF9saXN0X2lkIiwibmV3c2xldHRlciIsInVzZXJEYXRhIiwiZW1haWwiLCJuZXdzbGV0dGVySWRBcnJheSIsInNwbGl0IiwiY2hlY2tOZXdzbGV0dGVyU3Vic2NyaXB0aW9uIiwicmVzcCIsInNob3dUYWtlb3ZlciIsInRha2VvdmVyTW9kYWwiLCJwYXJzZUhUTUwiLCJ0YWtlb3Zlcl9odG1sIiwiZG9jdW1lbnQiLCJ0ZW1wbGF0ZSIsImJlZm9yZSIsIm1lZGlhZWxlbWVudHBsYXllciIsInRyaWdnZXIiLCJhcHBlbmQiLCJhZGRDbGFzcyIsIm1vZGFsIiwic2xpZGVyIiwiZXZlbnQiLCJjbG9zZVRha2VvdmVyIiwiJHRha2VvdmVyIiwicmVtb3ZlQ2xhc3MiLCJjb29raWVFeHBpcmF0aW9uIiwiY29va2llX2R1cmF0aW9uIiwic2V0Q29va2llIiwiZXhwaXJ5RGF0ZSIsInJlbW92ZSIsImN0YUNsaWNrZWQiLCJlbCIsImxvY2F0aW9uIiwiaHJlZiIsImF0dHIiLCJoIiwidG9kYXlzRGF0ZSIsIkRhdGUiLCJzZXRIb3VycyIsImdldEhvdXJzIiwiZ2V0Q29va2llIiwic0tleSIsImRlY29kZVVSSUNvbXBvbmVudCIsImNvb2tpZSIsInJlcGxhY2UiLCJSZWdFeHAiLCJlbmNvZGVVUklDb21wb25lbnQiLCJzVmFsdWUiLCJ2RW5kIiwic1BhdGgiLCJzRG9tYWluIiwiYlNlY3VyZSIsInRlc3QiLCJzRXhwaXJlcyIsImNvbnN0cnVjdG9yIiwiTnVtYmVyIiwiSW5maW5pdHkiLCJTdHJpbmciLCJ0b1VUQ1N0cmluZyIsInJlbW92ZUNvb2tpZSIsImhhc0l0ZW0iLCJuZXdzbGV0dGVySWQiLCJOZXdzbGV0dGVycyIsInVzZXJFbWFpbCIsImdldE5ld3NsZXR0ZXJSZXN1bHRzIiwiZ2V0U3Vic2NyaWJlciIsInVzZXJJZCIsInJlY2lwaWVudElkIiwiZ2V0U3Vic2NyaXB0aW9uU3RhdHVzIiwibmV3c2xldHRlclJlc3VsdHMiLCJkYXRhIiwiaXNTdWJzY3JpYmVkVG9OZXdzbGV0dGVyIiwiJGJvZHkiLCJjc3MiLCJvbiIsInBhcmVudHMiLCJsYXN0IiwiZSIsInByZXZlbnREZWZhdWx0IiwiJGZvcm0iLCIkZmVlZGJhY2siLCJmaW5kIiwiJGVtYWlsIiwidmFsIiwic291cmNlSWQiLCJuZXdzbGV0dGVySWRWYWwiLCJ1cGRhdGVVc2VyU3Vic2NyaXB0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U0FBQSxTQUFBRyxHQUNBQSxFQUFBQyxpQkFFQSxJQUFBM0UsRUFBQStFLEVBQUFDLE1BQ0FDLEVBQUFMLEVBQUFULEtBQUEsWUFFQWxFLEVBQUF5RCxFQUFBeEQsTUFBQSxLQUNBRCxFQUFBekMsUUFDQXlDLEVBQUF4QyxRQUFBLFNBQUF5SCxHQUNBL0ksRUFBQXdILFlBQUF3Qix1QkFBQW5GLEVBQUFrRixFQUFBLFNBQUFELEdBQ0FHLEtBQUEsU0FBQWhGLEdBQ0FBLEdBQUFBLEVBQUFyRCxTQXRCQThILEVBQUFRLEtBQUEsd0RBQ0FULEVBQUFFLEtBQUEsMkNBQUFRLE9BQ0FySixFQUFBLGFBQUFzSixNQUFBLEtBQUFDLFVBRUEvSSxFQUFBK0UsVUFBQSxzQkFBQTlELEVBQUFJLElBQUEsRUFBQXJCLEVBQUFnRixXQURBLE1BQ0FoRixFQUFBSixXQUFBLEtBSUF3SSxFQUFBUSxLQUFBLDJEQTRCQXBKLEVBQUF3RSxVQUFBOEQsR0FBQSwyQkFBQSxXQUNBbkksRUFBQUksU0F2YkEsQ0ErYkFpSixPQUFBdkosaUJBQUFDIiwiZmlsZSI6InRha2VvdmVycy5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvL34gQ29uc29saWRhdGUgdGhlIHRha2VvdmVyIGhhbmRsaW5nXG4hZnVuY3Rpb24oJCwgdGFrZW92ZXJTZXR0aW5ncywgRlAsIHRwKSB7XG5cbiAgdmFyIHRha2VvdmVycyA9IHtcbiAgICBjb29raWVQYXRoICAgOiAnLycsXG4gICAgY29va2llRG9tYWluIDogJ2ZvcmVpZ25wb2xpY3kuY29tJyxcbiAgICBudW1RdWFsaWZpZWQgOiAxLFxuICAgIFxuICAgIGluaXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICBzZWxmLmlzTG9hZGVkLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgIHNlbGYudmFsaWRhdGVUYWtlb3ZlcnMoKTtcbiAgICAgIH0pO1xuICAgIH0sXG5cbiAgICBpc0xvYWRlZDogbmV3IFByb21pc2UoZnVuY3Rpb24oc3VjY2VzcywgZXJyb3IpIHtcbiAgICAgIHZhciBtYXhXYWl0ICAgICA9IDgwMDA7XG4gICAgICB2YXIgY3VycmVudFdhaXQgPSAwO1xuICAgICAgXG4gICAgICAvLyBBZGQgYWxsIG9iamVjdHMgd2UgbmVlZCBmb3IgdGhpcyB0byBmdW5jdGlvbiBoZXJlXG4gICAgICBpZiAoY3VycmVudFdhaXQgPD0gbWF4V2FpdCkge1xuICAgICAgICB2YXIgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHtcbiAgICAgICAgICBpZiAodGFrZW92ZXJTZXR0aW5nc1xuICAgICAgICAgICAgJiYgRlBcbiAgICAgICAgICAgICYmIEZQLlNpbmdsZXRvbnNcbiAgICAgICAgICAgICYmIEZQLlNpbmdsZXRvbnMuVXNlclxuICAgICAgICAgICAgJiYgRlAuU2luZ2xldG9ucy5Vc2VyLmlwQWNjZXNzRGF0YSkge1xuICAgICAgICAgICAgICBjdXJyZW50V2FpdCArPSAyMDA7XG4gICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpO1xuICAgICAgICAgICAgICBzdWNjZXNzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgMjAwKTtcbiAgICAgIH1cbiAgICB9KSxcblxuICAgIHZhbGlkYXRlVGFrZW92ZXJzOiBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBzZWxmID0gdGhpcztcbiAgICBcbiAgICAgIC8vIHJ1biB0aHJvdWdoIGVhY2ggdGFrZW92ZXIgdGhhdCBxdWFsaWZpZWQgaW5pdGlhbCBQSFAgY2hlY2suXG4gICAgICBpZiAodGFrZW92ZXJTZXR0aW5ncy5sZW5ndGgpIHtcbiAgICAgICAgdGFrZW92ZXJTZXR0aW5ncy5mb3JFYWNoKGZ1bmN0aW9uKHRha2VvdmVyKSB7XG5cbiAgICAgICAgICAvL1xuICAgICAgICAgIC8vIFByb21pc2UgdmFsaWRhdG9yLCBzdGFydHMgYnkgY2hlY2tpbmcgY29va2llc1xuICAgICAgICAgIC8vXG4gICAgICAgICAgdmFyIHZhbGlkYXRvciA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgcmVzb2x2ZShcbiAgICAgICAgICAgICAgLy8gc3BlY2lmaWMgdGFrZW92ZXIgaGFzIGJlZW4gY2xvc2VkXG4gICAgICAgICAgICAgICFzZWxmLmhhc0Nvb2tpZSgndGFrZW92ZXJfZGlzbWlzc2VkXycgKyB0YWtlb3Zlci5pZClcbiAgICAgICAgICAgICAgLy8gc3BlY2lmaWMgdGFrZW92ZXIgaGFzIGJlZW4gc3VibWl0dGVkIChlbWFpbCBjYXB0dXJlKVxuICAgICAgICAgICAgICAmJiAhc2VsZi5oYXNDb29raWUoJ3Rha2VvdmVyX3N1Ym1pdHRlZF8nICsgdGFrZW92ZXIuaWQpIFxuICAgICAgICAgICAgICAvLyBhbnkgdGFrZW92ZXIgaGFzIGJlZW4gZGlzbWlzc2VkIGR1cmluZyB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgICAgICAgICAgICYmICFzZWxmLmhhc0Nvb2tpZSgndGFrZW92ZXJfZGlzbWlzc2VkX3Nlc3Npb24nKSBcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSlcblxuICAgICAgICAgIC8vXG4gICAgICAgICAgLy8gQ2hlY2sgZGV2aWNlIHdpZHRoIGZvciB0YWtlb3ZlcnMgd2l0aCBlaXRoZXIgZGVza3RvcCBvciBtb2JpbGUgdGFyZ2V0aW5nIGluIHBsYWNlXG4gICAgICAgICAgLy9cbiAgICAgICAgICAudGhlbihmdW5jdGlvbihxdWFsaWZpZWQpIHtcbiAgICAgICAgICAgIGlmICh0YWtlb3Zlci5oYXNPd25Qcm9wZXJ0eSgnZGV2aWNlX3RhcmdldGluZycpKSB7XG4gICAgICAgICAgICAgIHZhciBpc1RhcmdldGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgIHZhciBpc0Rlc2t0b3AgPSAkKCB3aW5kb3cgKS53aWR0aCgpID4gOTc5O1xuXG4gICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAoICdhbGwnID09PSB0YWtlb3Zlci5kZXZpY2VfdGFyZ2V0aW5nIClcbiAgICAgICAgICAgICAgICB8fCAoICdkZXNrdG9wJyA9PT0gdGFrZW92ZXIuZGV2aWNlX3RhcmdldGluZyAmJiBpc0Rlc2t0b3AgKVxuICAgICAgICAgICAgICAgIHx8ICggJ21vYmlsZScgPT09IHRha2VvdmVyLmRldmljZV90YXJnZXRpbmcgJiYgIWlzRGVza3RvcCApXG4gICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIGlzVGFyZ2V0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgcXVhbGlmaWVkID0gIWlzVGFyZ2V0ZWQgPyBmYWxzZSA6IHF1YWxpZmllZDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHF1YWxpZmllZDsgLy8gZmFpbHNhZmUgYnlwYXNzZXNcbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgLy9cbiAgICAgICAgICAvLyBDaGVjayBJUCBBY2Nlc3NcbiAgICAgICAgICAvL1xuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHF1YWxpZmllZCkge1xuICAgICAgICAgICAgcXVhbGlmaWVkID0gdGFrZW92ZXIuaGFzT3duUHJvcGVydHkoJ2lwX2FjY2Vzc19ndWlkcycpIFxuICAgICAgICAgICAgICAmJiBBcnJheS5pc0FycmF5KHRha2VvdmVyLmlwX2FjY2Vzc19ndWlkcylcbiAgICAgICAgICAgICAgJiYgdGFrZW92ZXIuaXBfYWNjZXNzX2d1aWRzLmxlbmd0aFxuICAgICAgICAgICAgICAmJiAhdGFrZW92ZXIuaXBfYWNjZXNzX2d1aWRzLmluY2x1ZGVzKEZQLlNpbmdsZXRvbnMuVXNlci5pcEFjY2Vzc0RhdGEuY2xpZW50X2d1aWQpID8gZmFsc2UgOiBxdWFsaWZpZWQ7XG5cbiAgICAgICAgICAgIHJldHVybiBxdWFsaWZpZWQ7IC8vIGZhaWxzYWZlIGJ5cGFzc2VzXG4gICAgICAgICAgfSlcbiAgICAgICAgICBcbiAgICAgICAgICAvL1xuICAgICAgICAgIC8vIENoZWNrIHN1YnNjcmlwdGlvbnNcbiAgICAgICAgICAvL1xuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHF1YWxpZmllZCkge1xuICAgICAgICAgICAgaWYgKHRha2VvdmVyLmhhc093blByb3BlcnR5KCdzdWJzY3JpcHRpb25fbGV2ZWwnKSkge1xuICAgICAgICAgICAgICB2YXIgaXNUYXJnZXRlZCAgICA9IGZhbHNlO1xuXG4gICAgICAgICAgICAgIHZhciBjaGVja01hcHBpbmdzID0ge1xuICAgICAgICAgICAgICAgICdGUERJR0lUQUwnICA6IEZQLlNpbmdsZXRvbnMuVXNlci5pc1N1YixcbiAgICAgICAgICAgICAgICAnRlBQUkVNSVVNJyAgOiBGUC5TaW5nbGV0b25zLlVzZXIuaXNQcmVtLFxuICAgICAgICAgICAgICAgICdGUElOU0lERVInICA6IEZQLlNpbmdsZXRvbnMuVXNlci5pc0luc2lkZXIsXG4gICAgICAgICAgICAgICAgJ0ZQSVNQWVBMVVMnIDogRlAuU2luZ2xldG9ucy5Vc2VyLmlzSVNweVBsdXMsXG4gICAgICAgICAgICAgICAgJ1JFR0lTVEVSRUQnIDogRlAuU2luZ2xldG9ucy5Vc2VyLmlzUmVnICYmICFGUC5TaW5nbGV0b25zLlVzZXIuaXNTdWIsXG4gICAgICAgICAgICAgICAgJ05PTlNVQicgICAgIDogIUZQLlNpbmdsZXRvbnMuVXNlci5pc1N1YixcbiAgICAgICAgICAgICAgICAnSVBBQ0NFU1MnICAgOiBGUC5TaW5nbGV0b25zLlVzZXIuaXNJUEFjY2Vzc1xuICAgICAgICAgICAgICB9XG4gIFxuICAgICAgICAgICAgICB0YWtlb3Zlci5zdWJzY3JpcHRpb25fbGV2ZWwuZm9yRWFjaCggZnVuY3Rpb24oIHN1YnNjcmlwdGlvbiApIHtcbiAgICAgICAgICAgICAgICBpc1RhcmdldGVkID0gIWlzVGFyZ2V0ZWQgJiYgY2hlY2tNYXBwaW5nc1tzdWJzY3JpcHRpb25dID8gdHJ1ZSA6IGlzVGFyZ2V0ZWQ7XG4gICAgICAgICAgICAgIH0pO1xuICBcbiAgICAgICAgICAgICAgcXVhbGlmaWVkID0gIWlzVGFyZ2V0ZWQgPyBmYWxzZSA6IHF1YWxpZmllZDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHF1YWxpZmllZDsgLy8gZmFpbHNhZmUgYnlwYXNzZXNcbiAgICAgICAgICB9KVxuICAgICAgICAgIFxuICAgICAgICAgIC8vXG4gICAgICAgICAgLy8gQ2hlY2sgTmV3c2xldHRlciBTdWJzY3JpcHRpb25cbiAgICAgICAgICAvL1xuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHF1YWxpZmllZCkge1xuICAgICAgICAgICAgaWYgKHRha2VvdmVyLmhhc093blByb3BlcnR5KCdpbnRlZ3JhdGlvbicpXG4gICAgICAgICAgICAgICYmIHRha2VvdmVyLmludGVncmF0aW9uXG4gICAgICAgICAgICAgICYmIHRha2VvdmVyLmludGVncmF0aW9uLmhhc093blByb3BlcnR5KCdpbnRlZ3JhdGlvbl90eXBlJykgXG4gICAgICAgICAgICAgICYmIHRha2VvdmVyLmludGVncmF0aW9uLmludGVncmF0aW9uX3R5cGUgIT09ICdub25lJykge1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHN3aXRjaCAodGFrZW92ZXIuaW50ZWdyYXRpb24uaW50ZWdyYXRpb25fdHlwZSkge1xuICAgICAgICAgICAgICAgICAgY2FzZSAncG9zdHVwJzpcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRha2VvdmVyLmludGVncmF0aW9uLmhhc093blByb3BlcnR5KCdwb3N0dXBfbGlzdF9pZCcpICYmIHRha2VvdmVyLmludGVncmF0aW9uLnBvc3R1cF9saXN0X2lkICE9PSAnJykge1xuICAgICAgICAgICAgICAgICAgICAgIHNlbGYubmV3c2xldHRlcih0YWtlb3Zlcik7XG5cbiAgICAgICAgICAgICAgICAgICAgICBpZiAoRlAuU2luZ2xldG9ucy5Vc2VyLnVzZXJEYXRhICYmIEZQLlNpbmdsZXRvbnMuVXNlci51c2VyRGF0YS5lbWFpbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKCByZXNvbHZlLCByZWplY3QgKSB7XG5cbi8vXG4vLyBUTy1ETyBcbi8vIC0gQWRkIGVuaGFuY2VkIGZ1bmN0aW9uYWxpdHkgZm9yIG11bHRpcGxlIG5ld3NsZXR0ZXIgaWRzIGhlcmU/IFxuLy8gLSBTaG91bGQgd2UgaXRlcmF0ZSB0aHJvdWdoIGFsbCBuZXdzbGV0dGVyIGlkcz9cbi8vXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld3NsZXR0ZXJJZEFycmF5ID0gdGFrZW92ZXIuaW50ZWdyYXRpb24ucG9zdHVwX2xpc3RfaWQuc3BsaXQoXCIsXCIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY2hlY2tOZXdzbGV0dGVyU3Vic2NyaXB0aW9uKCBuZXdzbGV0dGVySWRBcnJheVswXSApXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoIHF1YWxpZmllZCApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgY2FzZSAnc2FsZXNfZm9yY2UnOlxuICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBzYWxlc2ZvcmNlIHF1YWxpZmllcnNcblxuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBxdWFsaWZpZWQ7IC8vIGZhaWxzYWZlIGJ5cGFzc2VzXG4gICAgICAgICAgfSlcbiAgICAgICAgICBcbiAgICAgICAgICAvL1xuICAgICAgICAgIC8vIEZpbmFsIGRlY2lzaW9uXG4gICAgICAgICAgLy9cbiAgICAgICAgICAudGhlbihmdW5jdGlvbihxdWFsaWZpZWQpIHtcbiAgICAgICAgICAgIGlmIChxdWFsaWZpZWQpIHtcbiAgICAgICAgICAgICAgc2VsZi5zaG93VGFrZW92ZXIodGFrZW92ZXIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcXVhbGlmaWVkOyAvLyBmb3IgY29udGludWF0aW9uIGlmIG5lZWRlZFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9LCBcblxuICAgIHNob3dUYWtlb3ZlcjogZnVuY3Rpb24odGFrZW92ZXIpIHtcbiAgICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgICAgaWYgKHNlbGYubnVtUXVhbGlmaWVkID09PSAxKSB7XG4gICAgICAgIHRha2VvdmVyTW9kYWwgPSAkLnBhcnNlSFRNTCh0YWtlb3Zlci50YWtlb3Zlcl9odG1sLCBkb2N1bWVudCwgdHJ1ZSk7XG5cbiAgICAgICAgc3dpdGNoICggdGFrZW92ZXIudGVtcGxhdGUgKSB7XG4gICAgICAgICAgY2FzZSAnaW4tYXJ0aWNsZSc6XG4gICAgICAgICAgICAvLyBEbyBub3Qgc2hvdyBpbiBhcnRpY2xlIHRha2VvdmVycyBvbiBwb2RjYXN0c1xuICAgICAgICAgICAgaWYoICQoJy5zaW5nbGUtcG9kY2FzdHMnKS5sZW5ndGggPiAwICkgcmV0dXJuO1xuXG4gICAgICAgICAgICAvLyBTcGVjaWFsIHBsYWNlbWVudCBmb3IgaW4tYXJ0aWNsZVxuICAgICAgICAgICAgJCgnLnBvc3QtY29udGVudC1tYWluID4gLm1ldGEtZGF0YScpLmJlZm9yZSh0YWtlb3Zlck1vZGFsKTtcbiAgICAgICAgICAgIC8vIEN1c3RvbSBhdWRpbyBwbGF5ZXIgaGFuZGxpbmdcbiAgICAgICAgICAgIGlmKCAkKCcudGFrZW92ZXItYXVkaW8tY29udGVudCBhdWRpbycpLmxlbmd0aCA+IDAgKSB7XG4gICAgICAgICAgICAgIC8vIGluaXRpYWxpemUgY3VzdG9tIHBsYXllclxuICAgICAgICAgICAgICAkKCcudGFrZW92ZXItYXVkaW8tY29udGVudCBhdWRpbycpLm1lZGlhZWxlbWVudHBsYXllcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnaW4tYXJ0aWNsZS1uZXdzbGV0dGVyJzpcbiAgICAgICAgICAgIC8vIFNwZWNpYWwgcGxhY2VtZW50IGZvciBpbi1hcnRpY2xlIG5ld3NsZXR0ZXJcbiAgICAgICAgICAgICQoJy5wb3N0LWNvbnRlbnQtbWFpbiA+IC5tZXRhLWRhdGEnKS5iZWZvcmUodGFrZW92ZXJNb2RhbCk7XG4gICAgICAgICAgICAkKCBkb2N1bWVudCApLnRyaWdnZXIoICd0YWtlb3ZlclJlbmRlcmVkJyApO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIC8vIFBsYWNlbWVudCBmb3IgYWxsIG90aGVyIHRlbXBsYXRlIHR5cGVzXG4gICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKHRha2VvdmVyTW9kYWwpO1xuXG4gICAgICAgICAgICAkKCdib2R5JykuYWRkQ2xhc3MoJ3Rha2VvdmVyLW9wZW4nKTtcblxuICAgICAgICAgICAgaWYoICdzbGlkZXInICE9PSB0YWtlb3Zlci50ZW1wbGF0ZSApIHtcbiAgICAgICAgICAgICAgc2VsZi5tb2RhbCh0YWtlb3Zlcik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBzZWxmLnNsaWRlcih0YWtlb3Zlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgICQuZXZlbnQudHJpZ2dlcigndGFrZW92ZXJTaG93bicpO1xuXG4gICAgICAgIHNlbGYubnVtUXVhbGlmaWVkKys7XG4gICAgICB9XG4gICAgfSxcblxuICAgIGNsb3NlVGFrZW92ZXI6IGZ1bmN0aW9uKHRha2VvdmVyLCAkdGFrZW92ZXIpIHtcbiAgICAgICQoJ2JvZHknKS5yZW1vdmVDbGFzcygndGFrZW92ZXItb3BlbicpO1xuXG4gICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICB2YXIgY29va2llRXhwaXJhdGlvbiA9IHRha2VvdmVyLmNvb2tpZV9kdXJhdGlvbiAqIDI0OyAvLyB0YWtlb3Zlci5jb29raWVfZHVyYXRpb24gaW4gZGF5cyAqIDI0IGhvdXJzIHBlciBkYXlcbiAgICAgIHNlbGYuc2V0Q29va2llKCd0YWtlb3Zlcl9kaXNtaXNzZWRfJyArIHRha2VvdmVyLmlkLCB0cnVlLCBzZWxmLmV4cGlyeURhdGUoY29va2llRXhwaXJhdGlvbiksIHNlbGYuY29va2llUGF0aCwgJycpOyAvLyBjYW4gdXNlIHNlbGYuY29va2llRG9tYWluIGFzIHRoZSBsYXN0IHBhcmFtZXRlciBpZiB3ZSB3YW50IHRvIHNwZWNpZmljYWxseSByZXN0cmljdCB0byBhIGRvbWFpblxuICAgICAgJHRha2VvdmVyLnJlbW92ZSgpO1xuXG4gICAgICBzZWxmLnNldENvb2tpZSgndGFrZW92ZXJfZGlzbWlzc2VkX3Nlc3Npb24nLCB0cnVlLCAnJywgc2VsZi5jb29raWVQYXRoLCAnJyk7IC8vIGNhbiB1c2Ugc2VsZi5jb29raWVEb21haW4gYXMgdGhlIGxhc3QgcGFyYW1ldGVyIGlmIHdlIHdhbnQgdG8gc3BlY2lmaWNhbGx5IHJlc3RyaWN0IHRvIGEgZG9tYWluXG4gICAgfSxcblxuICAgIGN0YUNsaWNrZWQ6IGZ1bmN0aW9uKGVsLCB0YWtlb3Zlcikge1xuICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgICAgdmFyIGNvb2tpZUV4cGlyYXRpb24gPSAzNjUgKiAyNDsgLy8gMzY1ICogMjQgaG91cnMgcGVyIGRheVxuICAgICAgc2VsZi5zZXRDb29raWUoJ3Rha2VvdmVyX2Rpc21pc3NlZF8nICsgdGFrZW92ZXIuaWQsIHRydWUsIHNlbGYuZXhwaXJ5RGF0ZShjb29raWVFeHBpcmF0aW9uKSwgc2VsZi5jb29raWVQYXRoLCAnJyk7IC8vIGNhbiB1c2Ugc2VsZi5jb29raWVEb21haW4gYXMgdGhlIGxhc3QgcGFyYW1ldGVyIGlmIHdlIHdhbnQgdG8gc3BlY2lmaWNhbGx5IHJlc3RyaWN0IHRvIGEgZG9tYWluXG4gICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IGVsLmF0dHIoJ2hyZWYnKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRGVzY3JpcHRpb24uIFJldHVybnMgYSBkYXRlIG9iamVjdCB0byBiZSB1c2VkIGluIGNvb2tpZSBjcmVhdGlvbi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7aW50fSBoIE51bWJlciBvZiBob3VycyBmcm9tIG1vbWVudCBvZiBmaXJpbmcuXG4gICAgICovXG4gICAgZXhwaXJ5RGF0ZTogZnVuY3Rpb24oaCkge1xuICAgICAgdmFyIHRvZGF5c0RhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgdG9kYXlzRGF0ZS5zZXRIb3Vycyh0b2RheXNEYXRlLmdldEhvdXJzKCkgKyBoKTtcbiAgICAgIHJldHVybiB0b2RheXNEYXRlO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBEZXNjcmlwdGlvbi4gUmV0cmlldmVzIGEgY29va2llLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHNLZXkgQ29va2llIGtleVxuICAgICAqL1xuICAgIGdldENvb2tpZTogZnVuY3Rpb24oc0tleSkge1xuICAgICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChkb2N1bWVudC5jb29raWUucmVwbGFjZShuZXcgUmVnRXhwKFwiKD86KD86XnwuKjspXFxcXHMqXCIgKyBlbmNvZGVVUklDb21wb25lbnQoc0tleSkucmVwbGFjZSgvW1xcLVxcLlxcK1xcKl0vZywgXCJcXFxcJCZcIikgKyBcIlxcXFxzKlxcXFw9XFxcXHMqKFteO10qKS4qJCl8Xi4qJFwiKSwgXCIkMVwiKSkgfHwgbnVsbDtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRGVzY3JpcHRpb24uIENyZWF0ZXMgYSBjb29raWUuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc0tleSBDb29raWUga2V5XG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHNWYWx1ZSBDb29raWUgdmFsdWVcbiAgICAgKiBAcGFyYW0ge051bWJlcnxTdHJpbmd8RGF0ZX0gdkVuZCBDb29raWUgZXhwaXJhdGlvbiBkYXRlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHNQYXRoIENvb2tpZSBQYXRoXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHNEb21haW4gQ29va2llIGRvbWFpblxuICAgICAqIEBwYXJhbSB7Ym9vbH0gYlNlY3VyZSBTdG9yZSBjb29raWUgYXMgc2VjdXJlXG4gICAgICovXG4gICAgc2V0Q29va2llOiBmdW5jdGlvbihzS2V5LCBzVmFsdWUsIHZFbmQsIHNQYXRoLCBzRG9tYWluLCBiU2VjdXJlKSB7XG4gICAgICBpZiAoIXNLZXkgfHwgL14oPzpleHBpcmVzfG1heFxcLWFnZXxwYXRofGRvbWFpbnxzZWN1cmUpJC9pLnRlc3Qoc0tleSkpIHsgcmV0dXJuIGZhbHNlOyB9XG4gICAgICB2YXIgc0V4cGlyZXMgPSBcIlwiO1xuICAgICAgaWYgKHZFbmQpIHtcbiAgICAgICAgc3dpdGNoICh2RW5kLmNvbnN0cnVjdG9yKSB7XG4gICAgICAgICAgY2FzZSBOdW1iZXI6XG4gICAgICAgICAgICBzRXhwaXJlcyA9IHZFbmQgPT09IEluZmluaXR5ID8gXCI7IGV4cGlyZXM9RnJpLCAzMSBEZWMgOTk5OSAyMzo1OTo1OSBHTVRcIiA6IFwiOyBtYXgtYWdlPVwiICsgdkVuZDtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgU3RyaW5nOlxuICAgICAgICAgICAgc0V4cGlyZXMgPSBcIjsgZXhwaXJlcz1cIiArIHZFbmQ7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIERhdGU6XG4gICAgICAgICAgICBzRXhwaXJlcyA9IFwiOyBleHBpcmVzPVwiICsgdkVuZC50b1VUQ1N0cmluZygpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgdmFyIGNvb2tpZSA9IGVuY29kZVVSSUNvbXBvbmVudChzS2V5KSArIFwiPVwiICsgZW5jb2RlVVJJQ29tcG9uZW50KHNWYWx1ZSkgKyBzRXhwaXJlcyArIChzRG9tYWluID8gXCI7IGRvbWFpbj1cIiArIHNEb21haW4gOiBcIlwiKSArIChzUGF0aCA/IFwiOyBwYXRoPVwiICsgc1BhdGggOiBcIlwiKSArIChiU2VjdXJlID8gXCI7IHNlY3VyZVwiIDogXCJcIik7XG4gICAgICBkb2N1bWVudC5jb29raWUgPSBjb29raWU7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRGVzY3JpcHRpb24uIFJlbW92ZXMgYSBjb29raWUuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc0tleSBDb29raWUga2V5XG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHNQYXRoIENvb2tpZSBwYXRoXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHNEb21haW4gQ29va2llIGRvbWFpblxuICAgICAqL1xuICAgIHJlbW92ZUNvb2tpZTogZnVuY3Rpb24oc0tleSwgc1BhdGgsIHNEb21haW4pIHtcbiAgICAgIGlmICghc0tleSB8fCAhdGhpcy5oYXNJdGVtKHNLZXkpKSB7IHJldHVybiBmYWxzZTsgfVxuICAgICAgZG9jdW1lbnQuY29va2llID0gZW5jb2RlVVJJQ29tcG9uZW50KHNLZXkpICsgXCI9OyBleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UXCIgKyAoc0RvbWFpbiA/IFwiOyBkb21haW49XCIgKyBzRG9tYWluIDogXCJcIikgKyAoc1BhdGggPyBcIjsgcGF0aD1cIiArIHNQYXRoIDogXCJcIik7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRGVzY3JpcHRpb24uIENoZWNrcyBpZiBhIGNvb2tpZSBleGlzdHMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc0tleSBDb29raWUga2V5XG4gICAgICovXG4gICAgaGFzQ29va2llOiBmdW5jdGlvbihzS2V5KSB7XG4gICAgICByZXR1cm4gKG5ldyBSZWdFeHAoXCIoPzpefDtcXFxccyopXCIgKyBlbmNvZGVVUklDb21wb25lbnQoc0tleSkucmVwbGFjZSgvW1xcLVxcLlxcK1xcKl0vZywgXCJcXFxcJCZcIikgKyBcIlxcXFxzKlxcXFw9XCIpKS50ZXN0KGRvY3VtZW50LmNvb2tpZSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIERlc2NyaXB0aW9uLiBDaGVja3Mgd2hldGhlciB1c2VyIChpZiBsb2dnZWQgaW4pIGlzIGFscmVhZHkgc3Vic2NyaWJlZCBcbiAgICAgKiB0byB0aGUgbmV3c2xldHRlciAoaWYgUG9zdFVwIGludGVncmF0ZWQgbW9kYWwpIHByZXNlbnQgaW4gdGhlIG1vZGFsLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtpbnR9IG5ld3NsZXR0ZXJJZCBQb3N0VXAgbmV3c2xldHRlciBpZFxuICAgICAqL1xuICAgIGNoZWNrTmV3c2xldHRlclN1YnNjcmlwdGlvbjogZnVuY3Rpb24oIG5ld3NsZXR0ZXJJZCApIHtcbiAgICAgIC8vIENoZWNrIGZvciBGUC5OZXdzbGV0dGVycyBpbnN0YW5jZVxuICAgICAgRlAuTmV3c2xldHRlcnMgPSBGUC5OZXdzbGV0dGVycyB8fCB7fTtcbiAgICAgIFxuICAgICAgdmFyIHVzZXJFbWFpbCA9IEZQLlNpbmdsZXRvbnMuVXNlci51c2VyRGF0YS5lbWFpbDtcblxuICAgICAgcmV0dXJuIGdldE5ld3NsZXR0ZXJSZXN1bHRzID0gRlAuTmV3c2xldHRlcnMuZ2V0U3Vic2NyaWJlcih1c2VyRW1haWwpXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHZhciByZXN1bHRzICAgPSBGUC5OZXdzbGV0dGVycy5Vc2VyO1xuICAgICAgICAgIHZhciB1c2VySWQgICAgPSByZXN1bHRzLnJlY2lwaWVudElkO1xuXG4gICAgICAgICAgcmV0dXJuIEZQLk5ld3NsZXR0ZXJzLmdldFN1YnNjcmlwdGlvblN0YXR1cyh1c2VySWQsIG5ld3NsZXR0ZXJJZClcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3ApIHtcbiAgICAgICAgICAgICAgdmFyIG5ld3NsZXR0ZXJSZXN1bHRzID0gcmVzcC5kYXRhO1xuXG4gICAgICAgICAgICAgIC8vIHVzZXIgSVMgYWxyZWFkeSBzdWJzY3JpYmVkIHRvIG5ld3NsZXR0ZXJcbiAgICAgICAgICAgICAgaWYgKG5ld3NsZXR0ZXJSZXN1bHRzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgaXNTdWJzY3JpYmVkVG9OZXdzbGV0dGVyID0gZmFsc2U7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaXNTdWJzY3JpYmVkVG9OZXdzbGV0dGVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIHJldHVybiBpc1N1YnNjcmliZWRUb05ld3NsZXR0ZXI7XG4gICAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBEZXNjcmlwdGlvbi4gU3BlY2lhbCBoYW5kbGluZyBmb3IgZnVsbCBzY3JlZW4gbW9kYWxzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtvYmp9IHRha2VvdmVyIFRha2VvdmVyIG9iamVjdFxuICAgICAqL1xuICAgIG1vZGFsOiBmdW5jdGlvbih0YWtlb3Zlcikge1xuICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICB2YXIgJGJvZHkgPSAkKCdib2R5Jyk7XG4gICAgICAkYm9keS5jc3MoJ292ZXJmbG93JywgJ2hpZGRlbicpO1xuXG4gICAgICAkKGRvY3VtZW50KS5vbignY2xpY2snLCAnLnRha2VvdmVyLWNsb3NlJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICRib2R5LmNzcygnb3ZlcmZsb3cnLCAndmlzaWJsZScpO1xuICAgICAgICBzZWxmLmNsb3NlVGFrZW92ZXIodGFrZW92ZXIsICQodGhpcykucGFyZW50cygnLnRha2VvdmVyJykubGFzdCgpKTtcbiAgICAgIH0pO1xuXG4gICAgICAkKGRvY3VtZW50KS5vbignY2xpY2snLCAnLnRha2VvdmVyLWN0YScsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBzZWxmLmN0YUNsaWNrZWQoJCh0aGlzKSwgdGFrZW92ZXIpO1xuICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIERlc2NyaXB0aW9uLiBTcGVjaWFsIGhhbmRsaW5nIGZvciBzbGlkZXJzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtvYmp9IHRha2VvdmVyIFRha2VvdmVyIG9iamVjdFxuICAgICAqL1xuICAgIHNsaWRlcjogZnVuY3Rpb24odGFrZW92ZXIpIHtcbiAgICAgIHZhciBzZWxmID0gdGhpcztcbiAgICAgIFxuICAgICAgJChkb2N1bWVudCkub24oJ2NsaWNrJywgJy50YWtlb3Zlci1jbG9zZScsIGZ1bmN0aW9uKCkge1xuICAgICAgICBzZWxmLmNsb3NlVGFrZW92ZXIodGFrZW92ZXIsICQodGhpcykucGFyZW50cygnLnRha2VvdmVyJykubGFzdCgpKTtcbiAgICAgIH0pO1xuXG4gICAgICAkKGRvY3VtZW50KS5vbignY2xpY2snLCAnLnRha2VvdmVyLWN0YScsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBzZWxmLmN0YUNsaWNrZWQoJCh0aGlzKSwgdGFrZW92ZXIpO1xuICAgICAgfSk7XG4gICAgfSxcblxuICAgIG5ld3NsZXR0ZXI6IGZ1bmN0aW9uKHRha2VvdmVyKSB7XG4gICAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICAgICQoZG9jdW1lbnQpLm9uKCd0YWtlb3ZlclNob3duJywgZnVuY3Rpb24oKSB7IFxuICAgICAgICB2YXIgJGZvcm0gICAgICAgID0gJCgnLnRha2VvdmVyLWludGVncmF0aW9uLXBvc3R1cCBmb3JtJyk7XG4gICAgICAgIHZhciAkZmVlZGJhY2sgICAgPSAkZm9ybS5maW5kKCcuZm9ybS1mZWVkYmFjaycpO1xuICAgICAgICB2YXIgJGVtYWlsICAgICAgID0gJGZvcm0uZmluZCgnW25hbWU9XCJlbWFpbFwiXScpO1xuICAgICAgICB2YXIgbmV3c2xldHRlcklkID0gJGZvcm0uZmluZCgnW25hbWU9XCJuZXdzbGV0dGVyX2lkXCJdJykudmFsKCk7XG5cbi8vXG4vLyBUTy1ET1xuLy8gLSBhZGQgY29va2llIGFmdGVyIG5ld3NsZXR0ZXJTdWNjZXNzIHJ1bnMgc28gdXNlciBkb2Vzbid0IHNlZSB0aGlzIHNpZ251cCBhZ2Fpbj9cbi8vXG5cbiAgICAgICAgdmFyIG5ld3NsZXR0ZXJTdWNjZXNzID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgJGZlZWRiYWNrLnRleHQoXCJUaGFuayB5b3UgZm9yIHNpZ25pbmcgdXAgdG8gcmVjZWl2ZSB0aGlzIG5ld3NsZXR0ZXIuXCIpO1xuICAgICAgICAgICRmb3JtLmZpbmQoJy5uZXdzbGV0dGVyLWlucHV0LXN1Ym1pdCwgLmFjY291bnQtbGluaycpLmhpZGUoKTtcbiAgICAgICAgICAkKCcudGFrZW92ZXInKS5kZWxheSgzMDAwKS5mYWRlT3V0KCk7XG4gICAgICAgICAgdmFyIGNvb2tpZUV4cGlyYXRpb24gPSAzNjUgKiAyNDsgLy8gMzY1IGRheXMgKiAyNCBob3VycyBwZXIgZGF5XG4gICAgICAgICAgc2VsZi5zZXRDb29raWUoJ3Rha2VvdmVyX3N1Ym1pdHRlZF8nICsgdGFrZW92ZXIuaWQsIHRydWUsIHNlbGYuZXhwaXJ5RGF0ZShjb29raWVFeHBpcmF0aW9uKSwgc2VsZi5jb29raWVQYXRoLCAnJyk7IC8vIGNhbiB1c2Ugc2VsZi5jb29raWVEb21haW4gYXMgdGhlIGxhc3QgcGFyYW1ldGVyIGlmIHdlIHdhbnQgdG8gc3BlY2lmaWNhbGx5IHJlc3RyaWN0IHRvIGEgZG9tYWluXG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIG5ld3NsZXR0ZXJFcnJvciA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICRmZWVkYmFjay50ZXh0KCdTb3JyeSwgdGhlcmUgd2FzIGEgcHJvYmxlbSwgcGxlYXNlIHRyeSBhZ2Fpbi4nKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICRmb3JtLm9uKCdzdWJtaXQnLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgICAgdmFyIGVtYWlsID0gJGVtYWlsLnZhbCgpO1xuICAgICAgICAgIHZhciBzb3VyY2VJZCA9ICRmb3JtLmRhdGEoJ3NvdXJjZWlkJyk7XG5cbiAgICAgICAgICB2YXIgbmV3c2xldHRlcklkQXJyYXkgPSBuZXdzbGV0dGVySWQuc3BsaXQoXCIsXCIpO1xuICAgICAgICAgIGlmIChuZXdzbGV0dGVySWRBcnJheS5sZW5ndGgpIHtcbiAgICAgICAgICAgIG5ld3NsZXR0ZXJJZEFycmF5LmZvckVhY2goZnVuY3Rpb24obmV3c2xldHRlcklkVmFsKSB7XG4gICAgICAgICAgICAgIEZQLk5ld3NsZXR0ZXJzLnVwZGF0ZVVzZXJTdWJzY3JpcHRpb24oZW1haWwsIG5ld3NsZXR0ZXJJZFZhbCwgJ05PUk1BTCcsIHNvdXJjZUlkKVxuICAgICAgICAgICAgICAuZG9uZShmdW5jdGlvbihyZXNwKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3AgJiYgcmVzcC5zdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICBuZXdzbGV0dGVyU3VjY2VzcygpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBuZXdzbGV0dGVyRXJyb3IoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSxcbiAgfTtcblxuICAkKGRvY3VtZW50KS5vbigncGlhbm9BY2Nlc3NDaGVja0NvbXBsZXRlJywgZnVuY3Rpb24oKSB7XG4gICAgdGFrZW92ZXJzLmluaXQoKTtcbiAgfSk7XG5cbiAgLy9+IFByZXZpZXdzIGFsd2F5cyBmaXJlIGFuZCBibG9jayBldmVyeXRoaW5nIGVsc2VcbiAgLy8gaWYgKG51bGwgIT09IHdpbmRvdy5GUE1hcmtldGluZ1NldHRpbmdzLl9wcmV2aWV3KSB7XG4gIC8vICAgc2V0VGltZW91dChnZXRUYWtlb3ZlckhhbmRsZXIoJ19wcmV2aWV3JyksIDMwMCk7XG4gIC8vICAgcmV0dXJuO1xuICAvLyB9XG59KGpRdWVyeSwgdGFrZW92ZXJTZXR0aW5ncywgRlApO1xuIl19;
//~Chartbear
//
// Helper funcs for interacting with Chartbeat
!function ($) {

  $( document ).ready(function() {
    if ( FP.Singletons.User ) {
      init();
    } else {
      $( document ).on( 'pianoAccessCheckComplete', init );
    }

    function init() {

      window.dataLayer = window.dataLayer || [];

      var userStatus = 'anon';

      if(FP.Singletons.User.isSub) {
        userStatus = 'paid';
      } else if(FP.Singletons.User.isPrem) { 
        userStatus = 'paid';
      } else if(FP.Singletons.User.isInsider) { 
        userStatus = 'paid';
      } else if(FP.Singletons.User.isReg) {
        userStatus = 'lgdin';
      }

      dataLayer.push({
        'sections': chartbeatData.category_name,
        'authors': chartbeatData.author_list,
        'userStatus': userStatus
      });

    };
      
  });

}(jQuery);
;
!function ($) {
  var timestamps = $('[data-datetimeago]');
  if (timestamps.length < 1) {
    return;
  }
  var SEC_IN_MIN = 60;
  var MIN_IN_HR = 60;
  var HR_IN_DAY = 24;
  var ts = Math.floor(Date.now() / 1e3); // 1e3 = 1000 - this converts milliseconds to seconds
  ts = ts - 14400; // account for 4 hour difference between EST and UTC

  function getTimeAgoPhrase (ago) {
    var diff = ts - ago;
    if (diff < 60) {
      if(diff < 2) return diff + ' second ago';
      return diff + ' seconds ago';
    }
    var min = Math.floor(diff / SEC_IN_MIN);
    if (min < 60) {
      if(min < 2) return min + ' minute ago';
      return min + ' minutes ago';
    }
    var hr = Math.floor(min / MIN_IN_HR);
    if (hr < 49) {
      if(hr < 2) return hr + ' hour ago';
      return hr + ' hours ago';
    }
    var days = Math.floor(hr / HR_IN_DAY);
    if(days < 2) return days + ' day ago';
    return days + ' days ago';
  }
  $('[data-datetimeago]').each(function () {
    var el = $(this);
    el
      .text(getTimeAgoPhrase(el.data('datetimeago'))) // get seconds since "1 January 1970 00:00:00 UTC"
      .addClass('-calculated');
  });
}(cash);
;
/**
 * Function timing helpers
 *
 * This isn't really a vendor plugin as we wrote it, but
 * oh well -- it get's loaded before the `lib` JavaScript
 */

(function($, undefined){

  /**
   * Delay the execution of a function until the event
   * prompting it has not fired for a set amount of
   * time (delay)
   *
   * @param {Function} fn
   * @param {Number} delay
   */

  $.debounce = function(fn, delay){
    var handle;

    delay = undefined === delay ? 15 : delay;

    return function(){
      var that = this
        , args = arguments;

      clearTimeout(handle);

      handle = setTimeout(
        function(){
          fn.apply(that, args);
        },
        delay
      );
    };
  };

  /**
   * Postpone the execution of a function. Unlike
   * debouncing the function will not get cleared
   * if invoked again (e.g., 2 calls, 2 executions)
   *
   * @param {Function} fn
   * @param {Number} delay
   */

  $.postpone = function(fn, delay){
    delay = undefined === delay ? 100 : delay;

    return function(){
      var that = this
        , args = arguments;

      return setTimeout(
        function(){
          fn.apply(that, args);
        },
        delay
      );
    };
  };

})(jQuery);
;
/**
 * History helper
 *
 * Similar to the debounce helper, this neither really
 * a vendor module or jQuery plugin but it's easy to piggyback
 * the `$` global...
 */

(function(w, d, $, undefined){

  /**
   * Boolean indicating whether state variable is present
   */

  var h = w.history;

  var supported = !!h;

  /**
   * Stub function in case browser does not support
   *
   * @api private
   */

  function noop(){
    // Empty
  }

  /**
   * Pushstate wrapper
   *
   * @param {Object} data
   * @param {String} title
   * @param {String} absolute url
   * @api private
   */

  function pushState(data, title, url) {

    try {
      h.pushState(data, title, url);
      d.title = title;
    } catch (err) {
      /**
       * Even if supported, due to all subdomains, a security
       * error can occur. In that case, we will just forget
       * about it -- hopefully it's not too common
       */
    }
  }

  /**
   * Replacestate wrapper
   *
   * @param {Object} data
   * @param {String} title
   * @param {String} absolute url
   * @api private
   */

  function replaceState(data, title, url) {

    try {
      h.replaceState(data, title, url);
    } catch (err) {
      // Pass
    }
  }

  /**
   * Returns `history.state` object
   *
   * @return {Object} state
   * @api private
   */

  function state() {
    return h.state;
  }

  /**
   * History static plugin
   */

  $.historyfp = {};

  $.historyfp.pushState = supported && h.pushState
    ? pushState
    : noop;

  $.historyfp.replaceState = supported && h.replaceState
    ? replaceState
    : noop;

  $.historyfp.state = supported
    ? state
    : noop;

})(window, document, jQuery);
;
/*
 * SimpleModal 1.4.4 - jQuery Plugin
 * http://simplemodal.com/
 * Copyright (c) 2013 Eric Martin
 * Licensed under MIT and GPL
 * Date: Sun, Jan 20 2013 15:58:56 -0800
 */
(function(b){"function"===typeof define&&define.amd?define(["jquery"],b):b(jQuery)})(function(b){var j=[],n=b(document),k=navigator.userAgent.toLowerCase(),l=b(window),g=[],o=null,p=/msie/.test(k)&&!/opera/.test(k),q=/opera/.test(k),m,r;m=p&&/msie 6./.test(k)&&"object"!==typeof window.XMLHttpRequest;r=p&&/msie 7.0/.test(k);b.modal=function(a,h){return b.modal.impl.init(a,h)};b.modal.close=function(){b.modal.impl.close()};b.modal.focus=function(a){b.modal.impl.focus(a)};b.modal.setContainerDimensions=
function(){b.modal.impl.setContainerDimensions()};b.modal.setPosition=function(){b.modal.impl.setPosition()};b.modal.update=function(a,h){b.modal.impl.update(a,h)};b.fn.modal=function(a){return b.modal.impl.init(this,a)};b.modal.defaults={appendTo:"body",focus:!0,opacity:50,overlayId:"simplemodal-overlay",overlayCss:{},containerId:"simplemodal-container",containerCss:{},dataId:"simplemodal-data",dataCss:{},minHeight:null,minWidth:null,maxHeight:null,maxWidth:null,autoResize:!1,autoPosition:!0,zIndex:1E3,
close:!0,closeHTML:'<a class="modalCloseImg" title="Close"></a>',closeClass:"simplemodal-close",escClose:!0,overlayClose:!1,fixed:!0,position:null,persist:!1,modal:!0,onOpen:null,onShow:null,onClose:null};b.modal.impl={d:{},init:function(a,h){if(this.d.data)return!1;o=p&&!b.support.boxModel;this.o=b.extend({},b.modal.defaults,h);this.zIndex=this.o.zIndex;this.occb=!1;if("object"===typeof a){if(a=a instanceof b?a:b(a),this.d.placeholder=!1,0<a.parent().parent().size()&&(a.before(b("<span></span>").attr("id",
"simplemodal-placeholder").css({display:"none"})),this.d.placeholder=!0,this.display=a.css("display"),!this.o.persist))this.d.orig=a.clone(!0)}else if("string"===typeof a||"number"===typeof a)a=b("<div></div>").html(a);else return alert("SimpleModal Error: Unsupported data type: "+typeof a),this;this.create(a);this.open();b.isFunction(this.o.onShow)&&this.o.onShow.apply(this,[this.d]);return this},create:function(a){this.getDimensions();if(this.o.modal&&m)this.d.iframe=b('<iframe src="javascript:false;"></iframe>').css(b.extend(this.o.iframeCss,
{display:"none",opacity:0,position:"fixed",height:g[0],width:g[1],zIndex:this.o.zIndex,top:0,left:0})).appendTo(this.o.appendTo);this.d.overlay=b("<div></div>").attr("id",this.o.overlayId).addClass("simplemodal-overlay").css(b.extend(this.o.overlayCss,{display:"none",opacity:this.o.opacity/100,height:this.o.modal?j[0]:0,width:this.o.modal?j[1]:0,position:"fixed",left:0,top:0,zIndex:this.o.zIndex+1})).appendTo(this.o.appendTo);this.d.container=b("<div></div>").attr("id",this.o.containerId).addClass("simplemodal-container").css(b.extend({position:this.o.fixed?
"fixed":"absolute"},this.o.containerCss,{display:"none",zIndex:this.o.zIndex+2})).append(this.o.close&&this.o.closeHTML?b(this.o.closeHTML).addClass(this.o.closeClass):"").appendTo(this.o.appendTo);this.d.wrap=b("<div></div>").attr("tabIndex",-1).addClass("simplemodal-wrap").css({height:"100%",outline:0,width:"100%"}).appendTo(this.d.container);this.d.data=a.attr("id",a.attr("id")||this.o.dataId).addClass("simplemodal-data").css(b.extend(this.o.dataCss,{display:"none"})).appendTo("body");this.setContainerDimensions();
this.d.data.appendTo(this.d.wrap);(m||o)&&this.fixIE()},bindEvents:function(){var a=this;b("."+a.o.closeClass).bind("click.simplemodal",function(b){b.preventDefault();a.close()});a.o.modal&&a.o.close&&a.o.overlayClose&&a.d.overlay.bind("click.simplemodal",function(b){b.preventDefault();a.close()});n.bind("keydown.simplemodal",function(b){a.o.modal&&9===b.keyCode?a.watchTab(b):a.o.close&&a.o.escClose&&27===b.keyCode&&(b.preventDefault(),a.close())});l.bind("resize.simplemodal orientationchange.simplemodal",
function(){a.getDimensions();a.o.autoResize?a.setContainerDimensions():a.o.autoPosition&&a.setPosition();m||o?a.fixIE():a.o.modal&&(a.d.iframe&&a.d.iframe.css({height:g[0],width:g[1]}),a.d.overlay.css({height:j[0],width:j[1]}))})},unbindEvents:function(){b("."+this.o.closeClass).unbind("click.simplemodal");n.unbind("keydown.simplemodal");l.unbind(".simplemodal");this.d.overlay.unbind("click.simplemodal")},fixIE:function(){var a=this.o.position;b.each([this.d.iframe||null,!this.o.modal?null:this.d.overlay,
"fixed"===this.d.container.css("position")?this.d.container:null],function(b,e){if(e){var f=e[0].style;f.position="absolute";if(2>b)f.removeExpression("height"),f.removeExpression("width"),f.setExpression("height",'document.body.scrollHeight > document.body.clientHeight ? document.body.scrollHeight : document.body.clientHeight + "px"'),f.setExpression("width",'document.body.scrollWidth > document.body.clientWidth ? document.body.scrollWidth : document.body.clientWidth + "px"');else{var c,d;a&&a.constructor===
Array?(c=a[0]?"number"===typeof a[0]?a[0].toString():a[0].replace(/px/,""):e.css("top").replace(/px/,""),c=-1===c.indexOf("%")?c+' + (t = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + "px"':parseInt(c.replace(/%/,""))+' * ((document.documentElement.clientHeight || document.body.clientHeight) / 100) + (t = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + "px"',a[1]&&(d="number"===typeof a[1]?
a[1].toString():a[1].replace(/px/,""),d=-1===d.indexOf("%")?d+' + (t = document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft) + "px"':parseInt(d.replace(/%/,""))+' * ((document.documentElement.clientWidth || document.body.clientWidth) / 100) + (t = document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft) + "px"')):(c='(document.documentElement.clientHeight || document.body.clientHeight) / 2 - (this.offsetHeight / 2) + (t = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + "px"',
d='(document.documentElement.clientWidth || document.body.clientWidth) / 2 - (this.offsetWidth / 2) + (t = document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft) + "px"');f.removeExpression("top");f.removeExpression("left");f.setExpression("top",c);f.setExpression("left",d)}}})},focus:function(a){var h=this,a=a&&-1!==b.inArray(a,["first","last"])?a:"first",e=b(":input:enabled:visible:"+a,h.d.wrap);setTimeout(function(){0<e.length?e.focus():h.d.wrap.focus()},
10)},getDimensions:function(){var a="undefined"===typeof window.innerHeight?l.height():window.innerHeight;j=[n.height(),n.width()];g=[a,l.width()]},getVal:function(a,b){return a?"number"===typeof a?a:"auto"===a?0:0<a.indexOf("%")?parseInt(a.replace(/%/,""))/100*("h"===b?g[0]:g[1]):parseInt(a.replace(/px/,"")):null},update:function(a,b){if(!this.d.data)return!1;this.d.origHeight=this.getVal(a,"h");this.d.origWidth=this.getVal(b,"w");this.d.data.hide();a&&this.d.container.css("height",a);b&&this.d.container.css("width",
b);this.setContainerDimensions();this.d.data.show();this.o.focus&&this.focus();this.unbindEvents();this.bindEvents()},setContainerDimensions:function(){var a=m||r,b=this.d.origHeight?this.d.origHeight:q?this.d.container.height():this.getVal(a?this.d.container[0].currentStyle.height:this.d.container.css("height"),"h"),a=this.d.origWidth?this.d.origWidth:q?this.d.container.width():this.getVal(a?this.d.container[0].currentStyle.width:this.d.container.css("width"),"w"),e=this.d.data.outerHeight(!0),f=
this.d.data.outerWidth(!0);this.d.origHeight=this.d.origHeight||b;this.d.origWidth=this.d.origWidth||a;var c=this.o.maxHeight?this.getVal(this.o.maxHeight,"h"):null,d=this.o.maxWidth?this.getVal(this.o.maxWidth,"w"):null,c=c&&c<g[0]?c:g[0],d=d&&d<g[1]?d:g[1],i=this.o.minHeight?this.getVal(this.o.minHeight,"h"):"auto",b=b?this.o.autoResize&&b>c?c:b<i?i:b:e?e>c?c:this.o.minHeight&&"auto"!==i&&e<i?i:e:i,c=this.o.minWidth?this.getVal(this.o.minWidth,"w"):"auto",a=a?this.o.autoResize&&a>d?d:a<c?c:a:f?
f>d?d:this.o.minWidth&&"auto"!==c&&f<c?c:f:c;this.d.container.css({height:b,width:a});this.d.wrap.css({overflow:e>b||f>a?"auto":"visible"});this.o.autoPosition&&this.setPosition()},setPosition:function(){var a,b;a=g[0]/2-this.d.container.outerHeight(!0)/2;b=g[1]/2-this.d.container.outerWidth(!0)/2;var e="fixed"!==this.d.container.css("position")?l.scrollTop():0;this.o.position&&"[object Array]"===Object.prototype.toString.call(this.o.position)?(a=e+(this.o.position[0]||a),b=this.o.position[1]||b):
a=e+a;this.d.container.css({left:b,top:a})},watchTab:function(a){if(0<b(a.target).parents(".simplemodal-container").length){if(this.inputs=b(":input:enabled:visible:first, :input:enabled:visible:last",this.d.data[0]),!a.shiftKey&&a.target===this.inputs[this.inputs.length-1]||a.shiftKey&&a.target===this.inputs[0]||0===this.inputs.length)a.preventDefault(),this.focus(a.shiftKey?"last":"first")}else a.preventDefault(),this.focus()},open:function(){this.d.iframe&&this.d.iframe.show();b.isFunction(this.o.onOpen)?
this.o.onOpen.apply(this,[this.d]):(this.d.overlay.show(),this.d.container.show(),this.d.data.show());this.o.focus&&this.focus();this.bindEvents()},close:function(){if(!this.d.data)return!1;this.unbindEvents();if(b.isFunction(this.o.onClose)&&!this.occb)this.occb=!0,this.o.onClose.apply(this,[this.d]);else{if(this.d.placeholder){var a=b("#simplemodal-placeholder");this.o.persist?a.replaceWith(this.d.data.removeClass("simplemodal-data").css("display",this.display)):(this.d.data.hide().remove(),a.replaceWith(this.d.orig))}else this.d.data.hide().remove();
this.d.container.hide().remove();this.d.overlay.hide();this.d.iframe&&this.d.iframe.hide().remove();this.d.overlay.remove();this.d={}}}}});
;
/**
 * FP CORS helper
 *
 * Some of the ajax requests, particularly the endless scroll, were
 * relative; however, with all the subdomains that may be causing
 * an issue for caching
 *
 * Some assumptions
 * (1) URL parameters passed in will be absolute
 */

(function(w, $, undefined){

  /**
   * Detect native CORS support
   * Note: really the only polyfill will be for IE 8 and 9
   */

  var IEWithoutCORS = !$.support.cors && !!w.XDomainRequest;

  /**
   * Regular expression for absolute URL beginning
   */

  var absRgx = /^https?:\/\//;

  /**
   * XDR preparation before sending to response handler
   *
   * @param {String} res
   * @param {String} resType
   * @return {Mixed} data
   * @api private
   */

  function xdrPrep(res, resType) {
    if ('json' === resType) {
      return $.parseJSON(res);
    }

    return $.trim(res);
  }

  /**
   * XDR polyfill
   *
   * @param {String} method
   * @param {String} url
   * @param {Function} success (optional)
   * @param {String} resType (optional)
   * @return {Object} deferred (promise)
   * @api private
   */

  function xdrReq(method, url, success, resType) {

    /**
     * Create xdr instance and a promise object
     */

    var xdr = new XDomainRequest()
      , def = $.Deferred();

    var res;
    
    xdr.open(method, url);

    /**
     * Success callback
     */

    xdr.onload = function(){
      res = xdrPrep(xdr.responseText, resType);

      /**
       * If a success callback is provided, pass the response
       * to it
       */

      if (success) {
        success(res);
      }

      /**
       * Resolve the deferred
       */

      def.resolve(res);
    };

    xdr.onprogress = function(){

      /**
       * Empty, but all handlers must be defined
       * [see bug](http://stackoverflow.com/a/18392382/1858091)
       */
    };

    xdr.ontimeout = function(){
      def.reject();
    };
    xdr.onerror = function(){
      def.reject();
    };

    /**
     * Not sure if completely necessary but it is working (and
     * from one of the sources in the SO answer)
     */

    setTimeout(
      function(){
        xdr.send();
      },
      0
    );

    return def;
  }

  /**
   * Public interface
   */

  $.corsfp = {};

  /**
   * Ajax get request
   *
   * @param {String} url
   * @param {Function} success
   * @param {String} resType
   * @return {Object} deferred (promise)
   * @api public
   */

  $.corsfp.get = function(url, success, resType){
    return IEWithoutCORS && absRgx.test(url) && location.host !== url.split('/')[2]
      ? xdrReq('get', url, success, resType)
      : $.get(url, undefined, success, resType);
  };

  /**
   * Ajax get request
   *
   * @param {String} url
   * @param {Function} success
   * @return {Object} deferred (promise)
   * @api public
   */

  $.corsfp.getJSON = function(url, success){
    return $.corsfp.get(url, success, 'json');
  };

  /**
   * Tell whether IE 8 or 9
   *
   * @return {Boolean} isOldIE
   * @api public
   */

  $.corsfp.isOldIE = function(){
    return IEWithoutCORS;
  };

})(window, jQuery);
;
/*!
 * jQuery-ajaxTransport-XDomainRequest - v1.0.4 - 2015-03-05
 * https://github.com/MoonScript/jQuery-ajaxTransport-XDomainRequest
 * Copyright (c) 2015 Jason Moon (@JSONMOON)
 * Licensed MIT (/blob/master/LICENSE.txt)
 */
(function(factory) {
  if (typeof define === 'function' && define.amd) {
    // AMD. Register as anonymous module.
    define(['jquery'], factory);
  } else if (typeof exports === 'object') {
    // CommonJS
    module.exports = factory(require('jquery'));
  } else {
    // Browser globals.
    factory(jQuery);
  }
}(function($) {

// Only continue if we're on IE8/IE9 with jQuery 1.5+ (contains the ajaxTransport function)
if ($.support.cors || !$.ajaxTransport || !window.XDomainRequest) {
  return $;
}

var httpRegEx = /^(https?:)?\/\//i;
var getOrPostRegEx = /^get|post$/i;
var sameSchemeRegEx = new RegExp('^(\/\/|' + location.protocol + ')', 'i');

// ajaxTransport exists in jQuery 1.5+
$.ajaxTransport('* text html xml json', function(options, userOptions, jqXHR) {

  // Only continue if the request is: asynchronous, uses GET or POST method, has HTTP or HTTPS protocol, and has the same scheme as the calling page
  if (!options.crossDomain || !options.async || !getOrPostRegEx.test(options.type) || !httpRegEx.test(options.url) || !sameSchemeRegEx.test(options.url)) {
    return;
  }

  var xdr = null;

  return {
    send: function(headers, complete) {
      var postData = '';
      var userType = (userOptions.dataType || '').toLowerCase();

      xdr = new XDomainRequest();
      if (/^\d+$/.test(userOptions.timeout)) {
        xdr.timeout = userOptions.timeout;
      }

      xdr.ontimeout = function() {
        complete(500, 'timeout');
      };

      xdr.onload = function() {
        var allResponseHeaders = 'Content-Length: ' + xdr.responseText.length + '\r\nContent-Type: ' + xdr.contentType;
        var status = {
          code: 200,
          message: 'success'
        };
        var responses = {
          text: xdr.responseText
        };
        try {
          if (userType === 'html' || /text\/html/i.test(xdr.contentType)) {
            responses.html = xdr.responseText;
          } else if (userType === 'json' || (userType !== 'text' && /\/json/i.test(xdr.contentType))) {
            try {
              responses.json = $.parseJSON(xdr.responseText);
            } catch(e) {
              status.code = 500;
              status.message = 'parseerror';
              //throw 'Invalid JSON: ' + xdr.responseText;
            }
          } else if (userType === 'xml' || (userType !== 'text' && /\/xml/i.test(xdr.contentType))) {
            var doc = new ActiveXObject('Microsoft.XMLDOM');
            doc.async = false;
            try {
              doc.loadXML(xdr.responseText);
            } catch(e) {
              doc = undefined;
            }
            if (!doc || !doc.documentElement || doc.getElementsByTagName('parsererror').length) {
              status.code = 500;
              status.message = 'parseerror';
              throw 'Invalid XML: ' + xdr.responseText;
            }
            responses.xml = doc;
          }
        } catch(parseMessage) {
          throw parseMessage;
        } finally {
          complete(status.code, status.message, responses, allResponseHeaders);
        }
      };

      // set an empty handler for 'onprogress' so requests don't get aborted
      xdr.onprogress = function(){};
      xdr.onerror = function() {
        complete(500, 'error', {
          text: xdr.responseText
        });
      };

      if (userOptions.data) {
        postData = ($.type(userOptions.data) === 'string') ? userOptions.data : $.param(userOptions.data);
      }
      xdr.open(options.type, options.url);
      xdr.send(postData);
    },
    abort: function() {
      if (xdr) {
        xdr.abort();
      }
    }
  };
});

return $;

}));;
/**
 *
 * isMobile Detection Library 0.4.1
 * 
 * ( un-minified )
 * https://cdnjs.cloudflare.com/ajax/libs/ismobilejs/0.4.1/isMobile.js
 */


(function () {var f=/iPhone/i,j=/iPod/i,p=/iPad/i,g=/\bAndroid(?:.+)Mobile\b/i,i=/Android/i,d=/\bAndroid(?:.+)SD4930UR\b/i,e=/\bAndroid(?:.+)(?:KF[A-Z]{2,4})\b/i,c=/Windows Phone/i,h=/\bWindows(?:.+)ARM\b/i,k=/BlackBerry/i,l=/BB10/i,m=/Opera Mini/i,n=/\b(CriOS|Chrome)(?:.+)Mobile/i,o=/Mobile(?:.+)Firefox\b/i;function b($,a){return $.test(a)}function a($){var a=($=$||("undefined"!=typeof navigator?navigator.userAgent:"")).split("[FBAN");void 0!==a[1]&&($=a[0]),void 0!==(a=$.split("Twitter"))[1]&&($=a[0]);var r={apple:{phone:b(f,$)&&!b(c,$),ipod:b(j,$),tablet:!b(f,$)&&b(p,$)&&!b(c,$),device:(b(f,$)||b(j,$)||b(p,$))&&!b(c,$)},amazon:{phone:b(d,$),tablet:!b(d,$)&&b(e,$),device:b(d,$)||b(e,$)},android:{phone:!b(c,$)&&b(d,$)||!b(c,$)&&b(g,$),tablet:!b(c,$)&&!b(d,$)&&!b(g,$)&&(b(e,$)||b(i,$)),device:!b(c,$)&&(b(d,$)||b(e,$)||b(g,$)||b(i,$))||b(/\bokhttp\b/i,$)},windows:{phone:b(c,$),tablet:b(h,$),device:b(c,$)||b(h,$)},other:{blackberry:b(k,$),blackberry10:b(l,$),opera:b(m,$),firefox:b(o,$),chrome:b(n,$),device:b(k,$)||b(l,$)||b(m,$)||b(o,$)||b(n,$)},any:!1,phone:!1,tablet:!1};return r.any=r.apple.device||r.android.device||r.windows.device||r.other.device,r.phone=r.apple.phone||r.android.phone||r.windows.phone,r.tablet=r.apple.tablet||r.android.tablet||r.windows.tablet,r}window.isMobile=a();})();;
!function($){

	if( $('.post-content').find('iframe').length > 0 ) {

		function getAspectRatio(width, height) {
			var ratio = width / height;
			return ( Math.abs( ratio - 4 / 3 ) < Math.abs( ratio - 16 / 9 ) ) ? '4:3' : '16:9';
		}

		$('.post-content iframe[src*="youtube.com"], .post-content iframe[src*="vimeo.com"]').each(function(){

			var _this = $(this);

			var iframe_width = _this.attr('width');
			var iframe_height = _this.attr('height');

			var aspect_ratio = getAspectRatio(iframe_width, iframe_height);

			if( !_this.parent().hasClass('video-container') ) {
				if( aspect_ratio == '4:3' ) {
					_this.wrap('<div class="video-container video-container-4x3"></div>');
				} else {
					_this.wrap('<div class="video-container video-container-16x9"></div>');
				}
			}

		});
	}

}(jQuery);
;
