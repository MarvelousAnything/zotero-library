/*! vidora-client 1.5.2 03-09-2022 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self)["vidora-client"]=t()}(this,function(){"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _construct(e,t,r){return(_construct=_isNativeReflectConstruct()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&_setPrototypeOf(i,r.prototype),i}).apply(null,arguments)}function _isNativeFunction(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function _wrapNativeSuper(e){var r="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function(e){if(null===e||!_isNativeFunction(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return _construct(e,arguments,_getPrototypeOf(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(t,e)})(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _createSuper(n){var i=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(n);if(i){var r=_getPrototypeOf(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return _possibleConstructorReturn(this,e)}}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _get(e,t,r){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=_superPropBase(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(r):i.value}})(e,t,r||e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,o=[],a=!0,u=!1;try{for(r=r.call(e);!(a=(n=r.next()).done)&&(o.push(n.value),!t||o.length!==t);a=!0);}catch(e){u=!0,i=e}finally{try{a||null==r.return||r.return()}finally{if(u)throw i}}return o}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,u=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){u=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(u)throw o}}}}var CORE_WINDOW_OBJECT=window,CORE_DOCUMENT_OBJECT=document,CORE_NAVIGATOR_OBJECT=navigator;function getCoreWindowObject(){return CORE_WINDOW_OBJECT}function setCoreWindowObject(e){CORE_WINDOW_OBJECT=e}function getCoreDocumentObject(){return CORE_DOCUMENT_OBJECT}function setCoreDocumentObject(e){CORE_DOCUMENT_OBJECT=e}function getCoreNavigatorObject(){return CORE_NAVIGATOR_OBJECT}function logInfo(e){getCoreWindowObject().console&&console.log&&console.log(e)}function logError(e){getCoreWindowObject().console&&console.error&&console.error(e)}function errorEvent(e){throw new Error(e)}function isUndefined(e){return void 0===e}function isNull(e){return null===e}function isUndefinedOrNull(e){return isUndefined(e)||isNull(e)}function isObject(e){return!isNull(e)&&"object"===_typeof(e)}function isArray(e){return!isUndefinedOrNull(e)&&e.constructor===Array}function isFunction(e){return"function"==typeof e}function defaulted(e,t){return isUndefinedOrNull(e)?t:e}function extend(e,t){var r=defaulted(e,{}),n=defaulted(t,{});for(var i in n)r[i]=n[i];return r}function createOptions(e){var t=defaulted(e,{});return isObject(t)||errorEvent("Options should be an object."),t}function jsonDecode(e){return JSON.parse(e)}function jsonEncode(e){return JSON.stringify(e)}function encodeRFC3986(e){return encodeURIComponent(e).replace(/!/g,"%21").replace(/\*/g,"%2A").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29")}function stringCompare(e,t){return e<t?-1:t<e?1:0}function encodeQueryParams(e){var t=[];for(var r in e){var n=e[r],i=isUndefined(n)?[r]:[r,n];t.push(i)}return t.sort(function(e,t){return stringCompare(e,t)}),t.map(function(e){return e.map(encodeRFC3986).join("=")}).join("&")}function getCurrentMilliseconds(){return(new Date).getTime()}var SEND_BEACON_CALL_NAME="sendBeacon";function isBeaconSupported(){return!isUndefinedOrNull(getCoreNavigatorObject()[SEND_BEACON_CALL_NAME])}function sendBeacon(e,t){return getCoreNavigatorObject()[SEND_BEACON_CALL_NAME](e,t)}function writeCookie(e,t,r,n){var i=[];if(i.push(e+"="+encodeURIComponent(t)),r){var o=new Date;o.setTime(o.getTime()+1e3*r);var a="expires="+o.toUTCString();i.push(a)}i.push("path=/"),n&&i.push("domain="+n);var u=i.join("; ");getCoreDocumentObject().cookie=u}function readCookie(e){for(var t=getCoreDocumentObject().cookie.split("; "),r=0;r<t.length;r++){var n=t[r],i=n.indexOf("=");if(-1!==i)if(n.slice(0,i)===e){var o=n.slice(i+1);return decodeURIComponent(o)}}return null}var XHR_REQUEST_LOADED=4;function _xhrDefaultSuccessCallback(e,t,r){logInfo("XHR Request Succeded: "+r.url)}function _xhrDefaultErrorCallback(e,t,r){logError("XHR Request Failed: "+r.url+" "+e)}function _xhrDefaultTimeoutCallback(e,t,r){logError("XHR Timeout: "+r.url)}function _xhrDefaultUnmarshall(e){return e}function _xhrDefaultMarshall(e){return e}function _xhrCreateRequest(e,t,r){var n=new XMLHttpRequest;n.open(e,t.url,r);var i="onSuccess"in t?t.onSuccess:_xhrDefaultSuccessCallback,o="onError"in t?t.onError:_xhrDefaultErrorCallback,a="onTimeout"in t?t.onTimeout:_xhrDefaultTimeoutCallback,u="unmarshall"in t?t.unmarshall:_xhrDefaultUnmarshall;return"crossDomainCredentials"in t&&(n.withCredentials=!0===t.crossDomainCredentials),"timeoutMs"in t&&(n.timeout=t.timeoutMs,n.ontimeout=function(){a.call({},t)}),n.onload=function(){n.readyState===XHR_REQUEST_LOADED&&200<=n.status&&n.status<300?i.call({},u(n.responseText),n.status,t):o.call({},n.statusText,n.status,n.readyState,t)},n.onerror=function(){var e="Unknown Error.";isUndefinedOrNull(n.status)&&isUndefinedOrNull(n.statusText)?e="Unknown Error.":"statusText"in n&&(e=n.statusText),o.call({},e,n.status,n.readyState,t)},n}function _xhrAsyncRequest(e,t){var r=_xhrCreateRequest(e,t,!0);if("data"in t){var n="marshall"in t?t.marshall:_xhrDefaultMarshall;"dataType"in t&&r.setRequestHeader("Content-type",t.dataType),r.send(n(t.data))}else r.send();return r}function httpGet(e){_xhrAsyncRequest("GET",e)}function httpPost(e){_xhrAsyncRequest("POST",e)}function createTimeAndSizeBoundedQueue(e,t,r){var n=[],i=setTimeout(function(){},0);function o(){e(n),n=[]}return{add:function(e){clearTimeout(i),n.push(e),n.length>=r?o():i=setTimeout(o,t)},flush:function(){clearTimeout(i),o()}}}function getCryptoRandomUInt16Array(e){var t=new Uint16Array(e);crypto.getRandomValues(t);for(var r=[],n=0;n<t.length;n++)r.push(t[n]);return r}function getMathRandom(){return Math.random()}function getMathRandomUInt16(){return Math.floor(65536*getMathRandom())}var RANDOM_ENTROPY_MERGE_COUNT=1;function getMathRandomUInt16Array(e){for(var t=[],r=0;r<RANDOM_ENTROPY_MERGE_COUNT&&r<e;r++)t.push(65535&(getMathRandomUInt16()^getCurrentMilliseconds()));for(;r<e;r++)t.push(getMathRandomUInt16());return t}var HAS_WEBCRYPTO=!isUndefined(getCoreWindowObject().Uint16Array)&&!isUndefined(getCoreWindowObject().crypto),getRandomUInt16Array=HAS_WEBCRYPTO?getCryptoRandomUInt16Array:getMathRandomUInt16Array,RANDOM_ZERO_PADDING_3="000",SESSION_STORAGE_OBJECT,LOCAL_STORAGE_OBJECT;function getVidoraUserUUID(){return getRandomUInt16Array(10).map(function(e){var t=(e>>1).toString(32);return RANDOM_ZERO_PADDING_3.slice(t.length)+t}).join("")}try{SESSION_STORAGE_OBJECT=getCoreWindowObject().sessionStorage,LOCAL_STORAGE_OBJECT=getCoreWindowObject().localStorage}catch(e){}function _isStorageObjectSupported(e){if(e){var t="string"==typeof e.setItem;return!isUndefinedOrNull(e)&&!t}return!1}function _setStorageItem(e,t,r){try{return e.setItem(t,jsonEncode(r)),!0}catch(e){return logInfo(e),!1}}function _getStorageItem(e,t){var r=e.getItem(t);return isUndefinedOrNull(r)?null:jsonDecode(r)}function _deleteStorageItem(e,t){e.removeItem(t)}function _forEachStorageKey(e,t){for(var r=0;r<e.length;r++){t(e.key(r))}}function isLocalStorageSupported(){return _isStorageObjectSupported(LOCAL_STORAGE_OBJECT)}function setLocalStorageItem(e,t){return isLocalStorageSupported()&&_setStorageItem(LOCAL_STORAGE_OBJECT,e,t)}function getLocalStorageItem(e){if(isLocalStorageSupported())return _getStorageItem(LOCAL_STORAGE_OBJECT,e)}function deleteLocalStorageItem(e){isLocalStorageSupported()&&_deleteStorageItem(LOCAL_STORAGE_OBJECT,e)}function forEachLocalStorageKey(e){isLocalStorageSupported()&&_forEachStorageKey(LOCAL_STORAGE_OBJECT,e)}var REQUEST_MAX_COUNT=50,REQUEST_RESET_COUNT=REQUEST_MAX_COUNT,REQUEST_MAX_RETRY=3,REQUEST_CLOCK_PERIOD=5,REQUEST_HOLD_DELAY=3*REQUEST_CLOCK_PERIOD,REQUEST_KEY_PREFIX="vidoraRequest:",REQUEST_CLOCK_SUFFIX=".clock";function _randomDateSortableKeyString(){return getCurrentMilliseconds()+":"+getMathRandom()}function _clockKeyForKey(e){return e+REQUEST_CLOCK_SUFFIX}function _isRequestClockKey(e){return 0===e.indexOf(REQUEST_KEY_PREFIX)&&-1!==e.indexOf(REQUEST_CLOCK_SUFFIX)}function _isRequestKey(e){return 0===e.indexOf(REQUEST_KEY_PREFIX)&&-1===e.indexOf(REQUEST_CLOCK_SUFFIX)}function _createClockIntervalForKey(e){var t=_clockKeyForKey(e),r=0;return setInterval(function(){setLocalStorageItem(t,r+=1)},REQUEST_CLOCK_PERIOD)}function _getClockValueForClockKey(e){return getLocalStorageItem(e)}function _deleteClockForClockKey(e){deleteLocalStorageItem(e),setTimeout(function(){deleteLocalStorageItem(e)},100)}function _stopClockInterval(e,t){var r=_clockKeyForKey(e);t&&clearInterval(t),_deleteClockForClockKey(r)}function _getRequestDataForKey(e){return getLocalStorageItem(e)}function _setRequestDataForKey(e,t){setLocalStorageItem(e,t)}function _deleteRequestForKey(e){var t=_clockKeyForKey(e);deleteLocalStorageItem(e),_deleteClockForClockKey(t)}function _localStorageCreateRequest(e,t,r){var n=REQUEST_KEY_PREFIX+_randomDateSortableKeyString(),i=_createClockIntervalForKey(n);return _setRequestDataForKey(n,{data:e,guid:r,retry:0}),{key:n,guid:r,clock:i}}function requestLocalStorageBegin(e){return _localStorageCreateRequest(e,0,_randomDateSortableKeyString())}function requestLocalStorageEnd(e){var t=e.key;_stopClockInterval(t,e.clock),_deleteRequestForKey(t)}function _deleteOverflowRequests(e){if(e.length>REQUEST_MAX_COUNT){e.sort();for(var t=e.length-REQUEST_RESET_COUNT,r=0;r<t;r++){_deleteRequestForKey(e.shift())}}}function _removeDeadClocks(e){for(var t in e){var r=e[t],n=_getClockValueForClockKey(t);!isUndefinedOrNull(n)&&n!==r||(delete e[t],_deleteClockForClockKey(t))}}function _collectDeadRequestKeys(t,e){var r=[];return e.forEach(function(e){_clockKeyForKey(e)in t||r.push(e)}),r}function _resumeDeadRequests(e,r){var i=[];e.forEach(function(e){var t=_getRequestDataForKey(e);if(!isUndefinedOrNull(t)){var r=t.retry+1;if(r<REQUEST_MAX_RETRY){var n=_localStorageCreateRequest(t.data,r,t.guid);i.push(n)}}_deleteRequestForKey(e)}),i.forEach(function(e){var t=_getRequestDataForKey(e.key);r(e,t.data,t.guid)})}function _getClockTimes(){var t={};return forEachLocalStorageKey(function(e){_isRequestClockKey(e)&&(t[e]=_getClockValueForClockKey(e))}),t}function _getRequestKeys(){var t=[];return forEachLocalStorageKey(function(e){_isRequestKey(e)&&t.push(e)}),t}var _requestGlobalCleanupLock=!1;function requestLocalStorageCleanupZombies(e,t){if(!_requestGlobalCleanupLock){_requestGlobalCleanupLock=!0;var r=_getRequestKeys(),n=_getClockTimes();_deleteOverflowRequests(r);setTimeout(function(){_removeDeadClocks(n),_resumeDeadRequests(_collectDeadRequestKeys(n,r),e),_requestGlobalCleanupLock=!1,t&&t()},REQUEST_HOLD_DELAY)}}var BUILD_CONFIG={version:"1.5.2",rev:"fec0cba3ce9add57ee4a31237258273d933bd0f1"},CURRENT_SCRIPT=document.currentScript||document.scripts[document.scripts.length-1],sourceUrl=CURRENT_SCRIPT&&CURRENT_SCRIPT.src||"",matches=sourceUrl.match(/:(\/\/[^\/?#]+)(?:[\/?#]|$)/i),sourceDomain=matches&&matches[1]||"//alloy.vidora.com",ANALYTICS_HOST="https:"+sourceDomain,API_HOST=sourceDomain,MARSHALLING_JSON_ENCODER={marshall:jsonEncode,dataType:"text/plain"},SEND_COALESCE=0,SEND_IMMEDIATE=1;function REQUEST_NOOP(){}var _beginRequest=REQUEST_NOOP,_endRequest=REQUEST_NOOP,_cleanupZombieRequests=REQUEST_NOOP;function _sendRequest(e,t){if(!isUndefinedOrNull(e))if(extend(t,MARSHALLING_JSON_ENCODER),t.data.guid=e.guid,t.data.user_agent=window.navigator.userAgent,t.data.url=window.location.href,isBeaconSupported()&&isUndefinedOrNull(t.onSuccess)){sendBeacon(t.url,t.marshall(t.data))&&_endRequest(e)}else{var r=t.onSuccess||REQUEST_NOOP;t.onSuccess=function(){_endRequest(e),r()},httpPost(t)}}function _sendEvents(e,t,r){var n=createOptions(r),i=extend({api_key:e.token},n._params),o={url:defaulted(n._baseURI,e._analyticsHost)+"/"+e.apiVersion+"/validate?"+encodeQueryParams(i),data:{data:t}},a=_beginRequest(o);"success"in n&&(o.onSuccess=n.success),_sendRequest(a,o)}function _sendEventCallbackObjs(e,t){var r=t.map(function(e){return e[0]}),n={};0<t.length&&2<t[0].length&&(n=t[0][2]),_sendEvents(e,r,n)}function _setIfExists(e,t,r){e in r&&(t[e]=r[e])}isLocalStorageSupported()&&(_beginRequest=requestLocalStorageBegin,_endRequest=requestLocalStorageEnd,_cleanupZombieRequests=requestLocalStorageCleanupZombies);var EXPIRE_DURATION_SECONDS=5256e3,VIDORA_USER_COOKIE_NAME="vidoraUserId",VIDORA_SESSION_ID=getVidoraUserUUID().slice(0,10),APIv1=function(){function n(e){_classCallCheck(this,n),isUndefinedOrNull(e)?errorEvent("Vidora API constructed without any options."):isObject(e)?"apiKey"in e||errorEvent("Vidora API constructed without an API Key"):errorEvent("Vidora API should be constructed with an option object.");var t=extend({},e);this.token=t.apiKey,this.globalName=t.globalName,this.apiVersion="v1";var r=this;this._queue=createTimeAndSizeBoundedQueue(function(e){_sendEventCallbackObjs(r,e)},500,30),this._analyticsHost=ANALYTICS_HOST,this._apiHost=API_HOST,this._sendMode=SEND_COALESCE,this._build=BUILD_CONFIG,this._userId=null,_cleanupZombieRequests(_sendRequest)}return _createClass(n,[{key:"config",value:function(e){var t=createOptions(e);"analyticsHost"in t&&(this._analyticsHost=t.analyticsHost),"apiHost"in t&&(this._apiHost=t.apiHost)}},{key:"send",value:function(e,t,r){for(var n=isArray(t)?t:[t],i=this.getUserId(),o=this.getSessionId(),a=[],u=0;u<n.length;u++){var s=n[u],c=createOptions(r),l={type:String(e),user_id:String(i),session_id:String(o),timestamp:Math.floor(Date.now()/1e3),timestamp_ms:Date.now()};isUndefinedOrNull(s)||(l.content_id=String(s)),extend(l,c.params);var f={};_setIfExists("success",f,c),_setIfExists("error",f,c),_setIfExists("timeout",f,c);var p=this._sendMode;switch("click"!==l.type&&!c.quicksend||(p=SEND_IMMEDIATE),p){case SEND_IMMEDIATE:this._queue.add([l,f,c]),this._queue.flush();break;case SEND_COALESCE:this._queue.add([l,f,c]);break;default:errorEvent()}a.push(l)}return a}},{key:"getUUID",value:function(){var e=readCookie(VIDORA_USER_COOKIE_NAME);return isNull(e)&&(e=getVidoraUserUUID(),writeCookie(VIDORA_USER_COOKIE_NAME,e,EXPIRE_DURATION_SECONDS)),e}},{key:"setUUID",value:function(e){writeCookie(VIDORA_USER_COOKIE_NAME,e,EXPIRE_DURATION_SECONDS)}},{key:"getSessionId",value:function(){return VIDORA_SESSION_ID}},{key:"setUserId",value:function(e){this._userId=e}},{key:"getUserId",value:function(){return!isUndefinedOrNull(this._userId)&&""!==this._userId||(this._userId=this.getUUID()),this._userId}}]),n}(),clientReportApiKey="vidora_client_reports.A8E73214DD4B0739B34885EA8DA2C229",getAllInheritedPropertyNames=function(e){for(var t=new Set,r=e;r&&r!=Object.prototype;r=Object.getPrototypeOf(r)){var n,i=_createForOfIteratorHelper(Object.getOwnPropertyNames(r));try{for(i.s();!(n=i.n()).done;){var o=n.value;t.add(o)}}catch(e){i.e(e)}finally{i.f()}}return Array.from(t)},sampledBeacon=function(r){return function(e,t){Math.random()<r&&sendBeacon(e,t)}};function apimon(i,o,e){var a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"https://a.vidora.com/v1/validate?api_key=".concat(clientReportApiKey),u=4<arguments.length&&void 0!==arguments[4]?arguments[4]:.01,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:.1,c=e&&e.split(".")[0],l={};return getAllInheritedPropertyNames(o).forEach(function(n){"function"==typeof o[n]?l[n]=function(){try{var e=Date.now(),t=o[n].apply(l,arguments),r=Date.now();return sampledBeacon(u)(a,JSON.stringify({data:[{type:"js_sdk_perf_report",operator:c,version:BUILD_CONFIG.version,rev:BUILD_CONFIG.rev,object_name:i,function_name:n,time_taken:r-e}]})),t}catch(e){throw sampledBeacon(s)(a,JSON.stringify({data:[{type:"js_sdk_error",operator:c,version:BUILD_CONFIG.version,rev:BUILD_CONFIG.rev,object_name:i,function_name:n,error_name:e.name,message:e.message,stack:e.stack}]})),e}}:Object.defineProperty(l,n,{get:function(){return o[n]},set:function(e){o[n]=e}})}),l}var LOADER_CLIENT_NAME="vidora-client",LOADER_API=APIv1,LOADER_NAMESPACES="vidora_ns",DEFAULT_NAMESPACE="vidora",globalNameToLoaderApi={},loaderPrivateApi={};function immediateApiCallBuilder(t){return function(e){e.call({},globalNameToLoaderApi[t],loaderPrivateApi)}}function immediatePushCallBuilder(i){return function(e){var t=e[0],r=e.slice(1),n=globalNameToLoaderApi[i];t in n||errorEvent("Invalid api call '"+t+"'"),n[t].apply(n,r)}}function dequeueCallBuilder(t){return function(e){isArray(e)?immediatePushCallBuilder(t)(e):isFunction(e)?immediateApiCallBuilder(t)(e):errorEvent("typeof call item '"+_typeof(e)+"' not supported.")}}function loadApi(e,t){LOADER_API=2<arguments.length&&void 0!==arguments[2]?arguments[2]:APIv1,LOADER_NAMESPACES in e?e[LOADER_NAMESPACES].includes(DEFAULT_NAMESPACE)||e[LOADER_NAMESPACES].push(DEFAULT_NAMESPACE):e[LOADER_NAMESPACES]=[DEFAULT_NAMESPACE];for(var r=0;r<e[LOADER_NAMESPACES].length;r++){var n=e[LOADER_NAMESPACES][r];if(e[n]&&!0===e[n]._init)logError(LOADER_CLIENT_NAME+": "+n+" included twice!");else{setCoreWindowObject(e),setCoreDocumentObject(t);var i=e[n];n in e||(e[n]={}),e[n].push=immediatePushCallBuilder(n),e[n].ready=immediateApiCallBuilder(n),e[n]._init=!0,i&&(i.ready=immediateApiCallBuilder(n),i.push=immediatePushCallBuilder(n),i._q.forEach(dequeueCallBuilder(n)),i=null)}}}function getBuiltinStaticProperties(e){var t=getCoreWindowObject(),r=getCoreNavigatorObject(),n=r.connection||{},i=t.screen||{};return{userAgent:r.userAgent,networkRtt:n.rtt,networkDownlink:n.downlink,screenWidth:i.width,screenHeight:i.height,orientation:i.orientation&&i.orientation.type,userId:e.getUserId(),sessionId:e.getSessionId()}}loaderPrivateApi._i=function(e,t,r){var n=extend({apiKey:e,globalName:t},r),i=apimon("api",new LOADER_API(n),e);isUndefinedOrNull(t)&&(t=DEFAULT_NAMESPACE),globalNameToLoaderApi[t]=i,logInfo(LOADER_CLIENT_NAME+" "+i._build.version+" "+i._build.rev)};var EVENT_SCHEMA_VERSION="3",EventStore=function(){function r(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:259200;_classCallCheck(this,r),this.id=e,this._localStorageKey="vidoraEventStore/".concat(EVENT_SCHEMA_VERSION,"/").concat(e),this._eventsTTLInSeconds=t}return _createClass(r,[{key:"_getTruncatedAnnotatedEvents",value:function(){var e=JSON.parse(getLocalStorageItem(this._localStorageKey)||"[]"),t=Date.now()-1e3*this._eventsTTLInSeconds;return e.filter(function(e){return e.timestamp>=t})}},{key:"_storeAnnotatedEvents",value:function(e){setLocalStorageItem(this._localStorageKey,JSON.stringify(e))}},{key:"persistEvent",value:function(e){this.persistEvents([e])}},{key:"persistEvents",value:function(e){var t=this._getTruncatedAnnotatedEvents();t=t.concat(e.map(function(e){return{timestamp:Date.now(),data:e}})),this._storeAnnotatedEvents(t)}},{key:"getEvents",value:function(){var e=this._getTruncatedAnnotatedEvents();return this._storeAnnotatedEvents(e),e.map(function(e){return e.data})}}]),r}(),truthy=function(e){var t=getType(e);return"array"===t?!!e.length:"object"===t?!!getProperties(e).length:!!e},getProperties=function(e){if("object"!==getType(e))return[];var t=[];for(var r in e)t.push(r);return t.sort()},castToString=function(e){var t=getType(e);if("string"===t)return e;if("regex"===t||"function"==typeof e)throw new Error("Cannot cast type "+t+" to string");return JSON.stringify(e)},validNumberFormat=/^\s*-?(0|([1-9][0-9]*))(\.[0-9]*)?([eE][+-]?[0-9]+)?\s*$/,castToFloat=function(e){var t=getType(e);if("string"===t){if(e.match(validNumberFormat))return parseFloat(e);throw new Error("Cannot cast string to float: "+e)}if("regex"===t||"function"==typeof e||"object"==t||"array"===t)throw new Error("Cannot cast type "+t+" to float");return+e},getType=function(e){return Array.isArray(e)?"array":null===e?"null":e instanceof RegExp?"regex":"object"===_typeof(e)?"object":_typeof(e)},compare=function(e,t){var r=getType(e);if(r!==getType(t))throw new Error("Comparison ill-defined between different variable types");if("array"===r)throw new Error("Comparison between arrays not permitted");if("object"===r)throw new Error("Comparison between objects not permitted");if("regex"===r)throw new Error("Comparison between regexes not permitted");return"number"===r||"boolean"===r?t-e:"string"!==r||e===t?0:e<t?1:-1},equal$1=function e(t,r){var n=getType(t);if(n!==getType(r))return!1;var i=n;if("array"===i){if(t.length!==r.length)return!1;for(var o=0;o<t.length;o++)if(!e(t[o],r[o]))return!1;return!0}if("object"!==i)return"regex"===i?t.flags===r.flags&&t.source===r.source:t===r;var a=getProperties(t),u=getProperties(r);if(a.length!==u.length)return!1;for(var s=0;s<a.length;s++){if(a[s]!==u[s])return!1;var c=a[s];if(!e(t[c],r[c]))return!1}return!0},makeIndicator=function(e,t){var r=e.substring(0,t).replace(/[^\s]/g," ").split("\n"),n=e.split("\n"),i=r.length-1,o=r.slice(-1)[0]+"^";return[].concat(n.slice(0,1+i),[o],n.slice(1+i)).join("\n")},makeMessage=function(e,t,r){return"".concat(e," at position ").concat(t,"\n---\n").concat(makeIndicator(r,t),"\n---\n")},PositionableError=function(){_inherits(i,_wrapNativeSuper(Error));var n=_createSuper(i);function i(e,t,r){return _classCallCheck(this,i),n.call(this,makeMessage(e,t,r))}return i}(),LexError=function(){_inherits(t,PositionableError);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return t}(),ParseError=function(){_inherits(t,PositionableError);var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return t}(),UnpositionableParseError=function(){_inherits(t,_wrapNativeSuper(Error));var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return t}(),RuntimeError=function(){_inherits(t,_wrapNativeSuper(Error));var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return t}(),OpenAnIssueIfThisOccursError=function(){_inherits(t,_wrapNativeSuper(Error));var e=_createSuper(t);function t(){return _classCallCheck(this,t),e.apply(this,arguments)}return t}(),seqHelper=function e(t,r){for(var n=1<arguments.length&&void 0!==r?r:0,i=t[0],o=[],a=n;a<i.length;a++)if(i[a])if(1===t.length)o.push([a]);else for(var u=e(t.slice(1),a+1),s=0;s<u.length;s++)o.push([a].concat(u[s]));return o},arity=function(n,i){return function(e,t,r){if(!("number"==typeof n?n===e.length:-1!==n.indexOf(e.length)))throw new RuntimeError("Expected "+n+" arguments, got "+e.length);return i(e,t,r)}},validateType=function(e,t){if(getType(t)!==e)throw new RuntimeError("Expected type "+e+", got "+getType(t));return t},and=arity(2,function(e,t,r){var n=r(e[0],t),i=r(e[1],t);return truthy(n)?i:n}),refRegex=/^[a-zA-Z_][a-zA-Z_0-9]*$/,pushRuntimeValueToStack=function(t,e){var r={"@":t};getProperties(t).forEach(function(e){refRegex.test(e)&&(r[e]=t[e])});var n=e.slice();return n.push(r),n},map$1=arity(2,function(e,t,r){var n=r(e[1],t),i=pushRuntimeValueToStack(n,t);return r(e[0],i)}),count=arity(1,function(e,t,r){return validateType("array",r(e[0],t)).length}),entries=arity(1,function(e,t,r){var n=r(e[0],t);return getProperties(n).map(function(e){return[e,n[e]]})}),equal=arity(2,function(e,t,r){var n=r(e[0],t),i=r(e[1],t);return equal$1(n,i)}),filter=arity(2,function(r,n,i){return validateType("array",i(r[1],n)).filter(function(e){var t=pushRuntimeValueToStack(e,n);return truthy(i(r[0],t))})}),filterkeys=arity(2,function(e,t,r){var n=r(e[1],t),i={};for(var o in n)n.hasOwnProperty(o)&&truthy(r(e[0],pushRuntimeValueToStack(o,t)))&&(i[o]=n[o]);return i}),filtervalues=arity(2,function(e,t,r){var n=r(e[1],t),i={};for(var o in n)n.hasOwnProperty(o)&&truthy(r(e[0],pushRuntimeValueToStack(n[o],t)))&&(i[o]=n[o]);return i}),find=function(e,t,r){var n;return null!==(n=filter(e,t,r)[0])&&void 0!==n?n:null},flatten=arity(1,function(e,t,r){return validateType("array",r(e[0],t)).reduce(function(e,t){return e.concat(validateType("array",t))},[])}),float=arity(1,function(e,t,r){return castToFloat(r(e[0],t))}),fromentries=arity(1,function(e,t,r){var n=validateType("array",r(e[0],t)),a={};return n.forEach(function(e){var t=_slicedToArray(validateType("array",e),2),r=t[0],n=void 0===r?null:r,i=t[1],o=void 0===i?null:i;a[castToString(n)]=o}),a}),groupby=arity(2,function(n,i,o){var e=validateType("array",o(n[1],i)),a={};return e.forEach(function(e){var t=pushRuntimeValueToStack(e,i),r=castToString(o(n[0],t));a[r]=(a[r]||[]).concat([e])}),a}),objectIndexer=function(e,t,r){var n;if(void 0!==r)throw new RuntimeError("Index ranges not supported for objects");return validateType("string",t),null!==(n=e[t])&&void 0!==n?n:null},arrayOrStringIndexer=function(e,t,r){var n;if(t<0&&(t+=e.length),r<0&&(r+=e.length),t&&t%1!=0||r&&r%1!=0)throw new RuntimeError("Index must be an integer");return void 0===r?(validateType("number",t),null!==(n=e[t])&&void 0!==n?n:null):null===r?(validateType("number",t),e.slice(t)):null===t?(validateType("number",r),e.slice(0,r)):(validateType("number",t),validateType("number",r),e.slice(t,r))},nullIndexer=function(e,t,r){if(void 0!==r)throw new RuntimeError("Index ranges not supported for null");if("number"!==getType(t)&&"string"!==getType(t))throw new RuntimeError("Index must be a number or string");return null},indexers={object:objectIndexer,array:arrayOrStringIndexer,string:arrayOrStringIndexer,null:nullIndexer},indexInner=function(e,t,r){var n=getType(e),i=indexers[n];if(!i)throw new RuntimeError("Cannot get index of type "+n);return i(e,t,r)},index=arity([2,3],function(e,t,r){var n,i,o=r(e[0],t);return i=2===e.length?(n=void 0,r(e[1],t)):(n=r(e[1],t),r(e[2],t)),indexInner(i,o,n)}),split$1=arity(2,function(e,t,r){var n=validateType("string",r(e[0],t));return validateType("array",r(e[1],t)).map(castToString).join(n)}),keys=arity(1,function(e,t,r){return getProperties(r(e[0],t))}),log=arity(1,function(e,t,r){var n=r(e[0],t);return console.log("MistQL: "+JSON.stringify(n,null,2)),n}),map=arity(2,function(r,n,i){return validateType("array",i(r[1],n)).map(function(e){var t=pushRuntimeValueToStack(e,n);return i(r[0],t)})}),mapkeys=arity(2,function(r,n,i){var o=i(r[1],n),a={};return getProperties(o).forEach(function(e){var t=castToString(i(r[0],pushRuntimeValueToStack(e,n)));a[t]=o[e]}),a}),mapvalues=arity(2,function(t,r,n){var i=n(t[1],r),o={};return getProperties(i).forEach(function(e){o[e]=n(t[0],pushRuntimeValueToStack(i[e],r))}),o}),match=arity(2,function(e,t,r){var n=r(e[0],t),i=validateType("string",r(e[1],t));if("regex"===getType(n))return n.test(i);if("string"===getType(n))return new RegExp(n).test(i);throw new RuntimeError("Matching only works with strings or regexes")}),not=arity(1,function(e,t,r){return!truthy(r(e[0],t))}),notequal=function(e,t,r){return!equal(e,t,r)},or=arity(2,function(e,t,r){var n=r(e[0],t),i=r(e[1],t);return truthy(n)?n:i}),plus=arity(2,function(e,t,r){var n=r(e[0],t),i=r(e[1],t),o=getType(n);if(o!==getType(i))throw new RuntimeError("Cannot add values of different types");if("array"===o)return[].concat(n,i);if("string"!==o&&"number"!==o)throw new RuntimeError("Cannot add values of type "+o);return n+i}),reduce=arity(3,function(n,i,o){return validateType("array",o(n[2],i)).reduce(function(e,t){var r=pushRuntimeValueToStack([e,t],i);return o(n[0],r)},o(n[1],i))}),validFlags=/^[gims]*$/,regex=arity([1,2],function(e,t,r){var n,i=validateType("string",r(e[0],t));if(1===e.length)n="";else if(n=validateType("string",r(e[1],t)),!validFlags.test(n))throw new RuntimeError("Invalid flags passed to replace: "+n);return new RegExp(i,n)}),replace=arity(3,function(e,t,r){var n=r(e[0],t),i=validateType("string",r(e[1],t)),o=validateType("string",r(e[2],t));if("regex"===getType(n)||"string"===getType(n))return o.replace(n,i);throw new RuntimeError("Replacing only works with strings or regexes")}),reverse=arity(1,function(e,t,r){return validateType("array",r(e[0],t)).slice().reverse()}),sequence=function(e,r,n){if(e.length<3)throw new RuntimeError("Expected at least 3 arguments, got "+e.length);var i=validateType("array",n(e[e.length-1],r)),t=e.slice(0,e.length-1).map(function(t){return i.map(function(e){return truthy(n(t,pushRuntimeValueToStack(e,r)))})});return seqHelper(t).map(function(e){return e.map(function(e){return i[e]})})},sort=arity(1,function(e,t,r){return validateType("array",r(e[0],t)).slice().sort(function(e,t){return compare(t,e)})}),sortby=arity(2,function(t,r,n){return validateType("array",n(t[1],r)).slice().map(function(e){return{sortValue:n(t[0],pushRuntimeValueToStack(e,r)),item:e}}).sort(function(e,t){var r=e.sortValue,n=t.sortValue;return compare(n,r)}).map(function(e){return e.item})}),split=arity(2,function(e,t,r){var n=r(e[0],t),i=validateType("string",r(e[1],t));if(-1===["string","regex"].indexOf(getType(n)))throw new RuntimeError("Expected string or regex as second argument to split");return i.split(n)}),string=arity(1,function(e,t,r){return castToString(r(e[0],t))}),sum=arity(1,function(e,t,r){return validateType("array",r(e[0],t)).reduce(function(e,t){return e+validateType("number",t)},0)}),_getMean=function(e){return e.reduce(function(e,t){return e+t},0)/e.length},_getMedian=function(e){var t=e.length/2;return t%1?e[t-.5]:(e[t-1]+e[t])/2},_getVariance=function(e){var t=_getMean(e),r=e.map(function(e){return Math.pow(e-t,2)});return r.reduce(function(e,t){return e+t},0)/(r.length-1)},_getStandardDeviation=function(e){return Math.sqrt(_getVariance(e))},summarize=arity(1,function(e,t,r){var n=validateType("array",r(e[0],t));return n.sort(function(e,t){return e-t}),n.forEach(function(e){return validateType("number",e)}),{max:Math.max.apply(null,n),min:Math.min.apply(null,n),mean:_getMean(n),median:_getMedian(n),variance:_getVariance(n),stddev:_getStandardDeviation(n)}}),unaryMinus=arity(1,function(e,t,r){return-validateType("number",r(e[0],t))}),values=arity(1,function(e,t,r){var n=r(e[0],t);return getProperties(n).map(function(e){return n[e]})}),withindices=arity(1,function(e,t,r){return validateType("array",r(e[0],t)).map(function(e,t){return[t,e]})}),numericBinaryOperator=function(o){return arity(2,function(e,t,r){var n=validateType("number",r(e[0],t)),i=validateType("number",r(e[1],t));return o(n,i)})},binaryCompareFunction=function(a){return arity(2,function(e,t,r){var n=r(e[0],t),i=r(e[1],t),o=compare(n,i);return o<0?a[0]:0===o?a[1]:0<o?a[2]:void 0})},dotAccessor=arity(2,function(e,t,r){var n=r(e[0],t),i=e[1];if("reference"!==i.type)throw new Error("Only references are allowed as rhs to dot access");return indexInner(n,i.ref,void 0)}),ifFunction=arity(3,function(e,t,r){return truthy(r(e[0],t))?r(e[1],t):r(e[2],t)}),matchBinaryOp=arity(2,function(e,t,r){return match(e.slice().reverse(),t,r)}),builtins={apply:map$1,count:count,entries:entries,filter:filter,filterkeys:filterkeys,filtervalues:filtervalues,find:find,flatten:flatten,float:float,fromentries:fromentries,groupby:groupby,if:ifFunction,index:index,join:split$1,stringjoin:split$1,keys:keys,log:log,match:match,map:map,mapkeys:mapkeys,mapvalues:mapvalues,reduce:reduce,regex:regex,replace:replace,reverse:reverse,sequence:sequence,sort:sort,sortby:sortby,split:split,string:string,sum:sum,summarize:summarize,values:values,withindices:withindices,"!/unary":not,"-/unary":unaryMinus,".":dotAccessor,"+":plus,"-":numericBinaryOperator(function(e,t){return e-t}),"*":numericBinaryOperator(function(e,t){return e*t}),"/":numericBinaryOperator(function(e,t){return e/t}),"%":numericBinaryOperator(function(e,t){return e%t}),"||":or,"&&":and,"==":equal,"!=":notequal,">":binaryCompareFunction([!0,!1,!1]),"<":binaryCompareFunction([!1,!1,!0]),">=":binaryCompareFunction([!0,!0,!1]),"<=":binaryCompareFunction([!1,!0,!0]),"=~":matchBinaryOp},inputGardenWall=function t(e){if(-1<["number","boolean","string"].indexOf(_typeof(e)))return e;if(e instanceof Number||e instanceof Boolean||e instanceof String)return e.valueOf();if(e instanceof Date)return e.toISOString();if(e instanceof Symbol)return e.toString();if(null==e)return null;if(Array.isArray(e))return e.map(function(e){return t(e)});var r={};for(var n in e)e.hasOwnProperty(n)&&(r[n]=t(e[n]));return r},outputGardenWall=function(e){var t=getType(e);if("function"===t||"regex"===t)throw new RuntimeError('Return value of query is "'.concat(t,'", aborting!'));return inputGardenWall(e)},execute=function(e,t){var r=inputGardenWall(t),n=[builtins,{$:Object.assign({},builtins,{"@":r})}],i=executeInner(e,pushRuntimeValueToStack(r,n));return outputGardenWall(i)},executeInner=function e(t,r){switch(t.type){case"literal":return executeLiteral(t,r);case"reference":return executeReference(t,r);case"application":return executeApplication(t,r);case"pipeline":for(var n=e(t.stages[0],r),i=1;i<t.stages.length;i++){var o=t.stages[i],a=void 0,u={type:"reference",ref:"@"};a="application"===o.type?{type:"application",function:o.function,arguments:o.arguments.concat(u)}:{type:"application",function:o,arguments:[u]},n=executeApplication(a,pushRuntimeValueToStack(n,r))}return n}},executeLiteral=function(t,r){switch(t.valueType){case"string":case"number":case"boolean":case"null":return t.value;case"array":return t.value.map(function(e){return executeInner(e,r)});case"object":var n={};return getProperties(t.value).forEach(function(e){n[e]=executeInner(t.value[e],r)}),n}},executeReference=function(e,t){for(var r=e.internal?[builtins]:t,n=void 0,i=r.length-1;0<=i;i--)if(void 0!==r[i][e.ref]){n=r[i][e.ref];break}if(void 0===n)throw new RuntimeError("Could not find referenced variable "+e.ref);return n},executeApplication=function(e,t){var r=executeInner(e.function,t),n=getType(r);if("function"!==n)throw new RuntimeError('Attempted to call a variable of type "'.concat(n,'". Only functions are callable'));return r(e.arguments,t,executeInner)},amalgamatingBinaryOperators=[" ","|"],simpleBinaryOperators=[["."],["*","/","%"],["+","-"],["<",">","<=",">="],["==","!=","=~"],["&&"],["||"]],binaryExpressionStrings=[].concat(simpleBinaryOperators.reduce(function(e,t){return[].concat(e,t)},[]),amalgamatingBinaryOperators),specials=binaryExpressionStrings.concat(["(",")","[","]","{","}",":",","]),unaryExpressions=["-","!"],builtinValues={true:!0,false:!1,null:null},whitespaceBehavior={l:")}]".split(""),r:"({[".split(""),rl:".:|,".split("").concat(binaryExpressionStrings)};function endsWithOddNumberOfSlashes(e){return(e.match(/\\+$/)||[""])[0].length%2==1}var vaccumsWhitespace=function(e,t){return-1<whitespaceBehavior.rl.indexOf(e)||-1<whitespaceBehavior[t].indexOf(e)},refStarter=/[a-zA-Z_]/,refContinuer=/[a-zA-Z_0-9]/,numStarter=/[0-9]/,numIsValid=/^(0|([1-9][0-9]*))(\.[0-9]+)?([eE][+-]?[0-9]+)?/,whitespace=/\s/;function lex(o){for(var a=[],u=o.split(""),e=function(t){var r=t,n=u[t];if(numStarter.test(n||"")){var e=_slicedToArray(o.substring(t).match(numIsValid),1)[0];a.push({token:"value",value:parseFloat(e),position:r}),t+=e.length-1}else if(whitespace.test(n||"")){for(;whitespace.test(u[t+1]);)t++;a.push({token:"special",value:" ",position:r})}else if(0<specials.filter(function(e){return e.startsWith(n)}).length){for(;0<specials.filter(function(e){return e.startsWith(n+u[t+1])}).length;)n+=u[++t];if(vaccumsWhitespace(n,"r"))for(;whitespace.test(u[t+1]);)t++;vaccumsWhitespace(n,"l")&&0<a.length&&"special"===a[a.length-1].token&&" "===a[a.length-1].value&&a.pop(),a.push({token:"special",value:n,position:r})}else if(refStarter.test(n||"")){for(;refContinuer.test(u[t+1]||"");)n+=u[++t];void 0!==builtinValues[n]?a.push({token:"value",value:builtinValues[n],position:r}):a.push({token:"ref",value:n,position:r})}else if("@"===n||"$"===n)a.push({token:"ref",value:n,position:r});else{if('"'!==n)throw new LexError("Unexpected character '".concat(u[t],"'"),t,o);for(n="";'"'!==u[t+1];){if(void 0===u[++t])throw new LexError("Unterminated string literal",r,o);"\\"!==u[t]||'"'!==u[t+1]||endsWithOddNumberOfSlashes(n)?n+=u[t]:(n+="\\u0022",t++)}var i="";try{i=JSON.parse('"'.concat(n,'"'))}catch(e){throw new LexError("Invalid string literal",r,o)}a.push({token:"value",value:i,position:r}),t++}s=t},s=0;s<u.length;s++)e(s);var t=a[0];t&&"special"===t.token&&" "===t.value&&a.shift();var r=a[a.length-1];return r&&"special"===r.token&&" "===r.value&&a.pop(),a}var amalgamationTechniques={" ":function(e){return{type:"application",function:e[0],arguments:e.slice(1)}},"|":function(e){return{type:"pipeline",stages:e}}},tmatch=function(e,t,r){return void 0!==r&&r.token===e&&r.value===t},buildTMatchThrower=function(n){return function(e,t,r){if(!tmatch(e,t,r))throw new n("Expected "+t+", got "+r.value)}},tmatchOrThrow=buildTMatchThrower(ParseError),tmatchOrThrowBad=buildTMatchThrower(OpenAnIssueIfThisOccursError),isBinExp=function(e){return"special"===e.token&&-1<binaryExpressionStrings.indexOf(e.value)},isUnExp=function(e){return"special"===e.token&&-1<unaryExpressions.indexOf(e.value)},consumeParenthetical=function(e,t){tmatchOrThrowBad("special","(",e[0]);var r=e.slice(1),n=consumeExpression(r,t),i=n.result;if(!(r=n.remaining)[0])throw new ParseError("Unexpected EOF",t.rawQuery.length-1,t.rawQuery);return tmatchOrThrow("special",")",r[0]),{result:i,remaining:r=r.slice(1)}},consumeArray=function(e,t){tmatchOrThrowBad("special","[",e[0]);for(var r=e.slice(1),n=[];;){if(tmatch("special","]",r[0])){r=r.slice(1);break}var i=consumeExpression(r,t),o=i.result,a=i.remaining;if(n.push(o),!tmatch("special",",",(r=a)[0])){if(tmatch("special","]",r[0])){r=r.slice(1);break}throw new ParseError("Unexpected token "+r[0].value,r[0].position,t.rawQuery)}r=r.slice(1)}return{result:{type:"literal",valueType:"array",value:n},remaining:r}},consumeIndexer=function(e,t){tmatchOrThrowBad("special","[",e[0]);for(var r=e.slice(1),n=[];;)if(tmatch("special",":",r[0]))r=r.slice(1),n.push({type:"literal",valueType:"null",value:null});else{if(tmatch("special","]",r[0])){r=r.slice(1),n.push({type:"literal",valueType:"null",value:null});break}var i=consumeExpression(r,t),o=i.result,a=i.remaining;if(n.push(o),!tmatch("special",":",(r=a)[0])){if(tmatch("special","]",r[0])){r=r.slice(1);break}throw new ParseError("Unexpected token "+r[0].value,r[0].position,t.rawQuery)}r=r.slice(1)}return{result:{type:"application",function:{type:"reference",ref:"index",internal:!0},arguments:n},remaining:r}},consumeStruct=function(e,t){tmatchOrThrowBad("special","{",e[0]);for(var r=e.slice(1),n={};;){if(tmatch("special","}",r[0])){r=r.slice(1);break}if(void 0===r[0])throw new ParseError("Unexpected EOF",t.rawQuery.length,t.rawQuery);var i=void 0;if("ref"!==r[0].token&&"value"!==r[0].token)throw new ParseError("Unexpected token "+r[0].value,r[0].position,t.rawQuery);i=r[0].value.toString(),r=r.slice(1),tmatchOrThrow("special",":",r[0]),r=r.slice(1);var o=consumeExpression(r,t),a=o.result,u=o.remaining;if(n[i]=a,!tmatch("special",",",(r=u)[0])){if(tmatch("special","}",r[0])){r=r.slice(1);break}throw new ParseError("Unexpected token "+r[0].value,r[0].position,t.rawQuery)}r=r.slice(1)}return{result:{type:"literal",valueType:"object",value:n},remaining:r}},consumeDotAccess=function(e,t,r){tmatchOrThrowBad("special",".",t[0]);var n=t.slice(1);if(0===n.length||"ref"!==n[0].token)throw new ParseError("Unexpected token "+n[0].value+", expected :",n[0].position,r.rawQuery);return{result:{type:"application",function:{type:"reference",ref:".",internal:!0},arguments:[e,{type:"reference",ref:n[0].value}]},remaining:n=n.slice(1)}},turnBinaryExpressionSequenceIntoASTExpression=function(e){if(0===e.items.length)throw new UnpositionableParseError("Tried to parse empty expression!");if(1===e.items.length&&0===e.joiners.length)return e.items[0];if(e.items.length-1!==e.joiners.length)throw new UnpositionableParseError("Invalid sequence of binary expressions!");for(var s=e,t=0;t<simpleBinaryOperators.length;t++){for(var r=simpleBinaryOperators[t],n=[s.items[0]],i=[],o=0;o<s.joiners.length;o++)if(n.push(s.items[o+1]),-1<r.indexOf(s.joiners[o])){var a=n[n.length-2],u=n[n.length-1];n[n.length-2]={type:"application",function:{type:"reference",ref:s.joiners[o],internal:!0},arguments:[a,u]},n.length=n.length-1}else i.push(s.joiners[o]);s={items:n,joiners:i}}for(var c=function(e){for(var t=amalgamatingBinaryOperators[e],r=[s.items[0]],n=[],i=amalgamationTechniques[t],o=[],a=function(){0<o.length&&(r.push(i(o)),o=[])},u=0;u<s.joiners.length;u++)s.joiners[u]===t?(0===o.length&&(o.push(s.items[u]),r.pop()),o.push(s.items[u+1])):(a(),r.push(s.items[u+1]),n.push(s.joiners[u]));a(),s={items:r,joiners:n}},l=0;l<amalgamatingBinaryOperators.length;l++)c(l);if(0!==s.joiners.length)throw new UnpositionableParseError("Expected expression following binary expression "+s.joiners[0]);return s.items[0]},consumeExpression=function(e,t){for(var r=e,n=[],i=[],o=function(e){if(i.length!==n.length)throw new ParseError("Unexpected Token "+e.value,e.position,t.rawQuery)},a=function(){return i.length+1!==n.length},u=function(e){if(a())throw new ParseError("Unexpected Token "+e.value,e.position,t.rawQuery)};0<r.length;){var s=r[0],c=void 0;if(isUnExp(s)&&a()&&function(){for(var e=0;e<r.length&&isUnExp(r[e]);e++);var t=r.slice(0,e);r=r.slice(e),s=r[0],c=function(e){return t.reduceRight(function(e,t){return{type:"application",function:{type:"reference",ref:t.value+"/unary",internal:!0},arguments:[e]}},e)}}(),tmatch("special","(",s)){o(s);var l=consumeParenthetical(r,t),f=l.result,p=l.remaining;n.push(f),r=p}else if(tmatch("special",".",s)){if(0===n.length)throw new ParseError("Unexpected Token .",s.position,t.rawQuery);var d=consumeDotAccess(n.pop(),r,t),h=d.result,g=d.remaining;n.push(h),r=g}else if(tmatch("special","[",s))if(i.length===n.length){var v=consumeArray(r,t),_=v.result,y=v.remaining;n.push(_),r=y}else{var m=consumeIndexer(r,t),E=m.result,S=m.remaining;n[n.length-1]={type:"application",function:E.function,arguments:E.arguments.concat([n[n.length-1]])},r=S}else if(tmatch("special","{",s)){o(s);var T=consumeStruct(r,t),O=T.result,C=T.remaining;n.push(O),r=C}else if("value"===s.token)o(s),n.push({type:"literal",valueType:null!==s.value?_typeof(s.value):"null",value:s.value}),r=r.slice(1);else if("ref"===s.token)o(s),n.push({type:"reference",ref:s.value}),r=r.slice(1);else{if(!isBinExp(s)||c)break;u(s),i.push(s),r=r.slice(1)}c&&(n[n.length-1]=c(n[n.length-1]))}var R=turnBinaryExpressionSequenceIntoASTExpression({items:n,joiners:i.map(function(e){return e.value})});if(tmatch("special","[",r[0])){var b=consumeIndexer(r,t),w=b.result,A=b.remaining;R={type:"application",function:w.function,arguments:w.arguments.concat([R])},r=A}return{result:turnBinaryExpressionSequenceIntoASTExpression({items:n,joiners:i.map(function(e){return e.value})}),remaining:r.slice()}};function parseQuery(e,t){var r=consumeExpression(e,t),n=r.result,i=r.remaining;if(0!==i.length)throw new ParseError("Unexpected token "+i[0].value+", expected EOF",t.rawQuery.length,t.rawQuery);return n}function parse(e){return parseQuery(lex(e),{rawQuery:e})}var parseOrThrow=parse,query=function(e,t){return execute(parseOrThrow(e),t)};function computeFeature(featureDef,userState){var feature;if("jsFunction"===featureDef.type){var jsFunction=eval("(".concat(featureDef.functionData,");"));feature=jsFunction(userState)}else{if("mistql"!==featureDef.type)throw new Error("Unknown feature definition type: ".concat(feature));feature=query(featureDef.query,userState)}return feature}function computeFeatures(e,t){var i={};return e.forEach(function(r){var n=computeFeature(r,t);r.featureNames?r.featureNames.forEach(function(e){var t=n[e];null==t&&(t=r.defaultValue),i[e]=t}):(null==n&&(n=r.defaultValue),i[r.featureName]=n)}),i}var md5$1={exports:{}},crypt={exports:{}},ur,vr;ur="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",vr={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&vr.rotl(e,8)|4278255360&vr.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=vr.endian(e[t]);return e},randomBytes:function(e){for(var t=[];0<e;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],r=0,n=0;r<e.length;r++,n+=8)t[n>>>5]|=e[r]<<24-n%32;return t},wordsToBytes:function(e){for(var t=[],r=0;r<32*e.length;r+=8)t.push(e[r>>>5]>>>24-r%32&255);return t},bytesToHex:function(e){for(var t=[],r=0;r<e.length;r++)t.push((e[r]>>>4).toString(16)),t.push((15&e[r]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],r=0;r<e.length;r+=2)t.push(parseInt(e.substr(r,2),16));return t},bytesToBase64:function(e){for(var t=[],r=0;r<e.length;r+=3)for(var n=e[r]<<16|e[r+1]<<8|e[r+2],i=0;i<4;i++)8*r+6*i<=8*e.length?t.push(ur.charAt(n>>>6*(3-i)&63)):t.push("=");return t.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var t=[],r=0,n=0;r<e.length;n=++r%4)0!=n&&t.push((ur.indexOf(e.charAt(r-1))&Math.pow(2,-2*n+8)-1)<<2*n|ur.indexOf(e.charAt(r))>>>6-2*n);return t}},crypt.exports=vr;var charenc={utf8:{stringToBytes:function(e){return charenc.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(charenc.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],r=0;r<e.length;r++)t.push(255&e.charCodeAt(r));return t},bytesToString:function(e){for(var t=[],r=0;r<e.length;r++)t.push(String.fromCharCode(e[r]));return t.join("")}}},charenc_1=charenc,isBuffer_1=function(e){return null!=e&&(isBuffer(e)||isSlowBuffer(e)||!!e._isBuffer)},xs,ys,zs,As;function isBuffer(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}function isSlowBuffer(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&isBuffer(e.slice(0,0))}function Bs(e,t){e.constructor==String?e=t&&"binary"===t.encoding?As.stringToBytes(e):ys.stringToBytes(e):zs(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||e.constructor===Uint8Array||(e=e.toString());for(var r=xs.bytesToWords(e),n=8*e.length,i=1732584193,o=-271733879,a=-1732584194,u=271733878,s=0;s<r.length;s++)r[s]=16711935&(r[s]<<8|r[s]>>>24)|4278255360&(r[s]<<24|r[s]>>>8);r[n>>>5]|=128<<n%32,r[14+(64+n>>>9<<4)]=n;var c=Bs._ff,l=Bs._gg,f=Bs._hh,p=Bs._ii;for(s=0;s<r.length;s+=16){var d=i,h=o,g=a,v=u;i=c(i,o,a,u,r[s+0],7,-680876936),u=c(u,i,o,a,r[s+1],12,-389564586),a=c(a,u,i,o,r[s+2],17,606105819),o=c(o,a,u,i,r[s+3],22,-1044525330),i=c(i,o,a,u,r[s+4],7,-176418897),u=c(u,i,o,a,r[s+5],12,1200080426),a=c(a,u,i,o,r[s+6],17,-1473231341),o=c(o,a,u,i,r[s+7],22,-45705983),i=c(i,o,a,u,r[s+8],7,1770035416),u=c(u,i,o,a,r[s+9],12,-1958414417),a=c(a,u,i,o,r[s+10],17,-42063),o=c(o,a,u,i,r[s+11],22,-1990404162),i=c(i,o,a,u,r[s+12],7,1804603682),u=c(u,i,o,a,r[s+13],12,-40341101),a=c(a,u,i,o,r[s+14],17,-1502002290),i=l(i,o=c(o,a,u,i,r[s+15],22,1236535329),a,u,r[s+1],5,-165796510),u=l(u,i,o,a,r[s+6],9,-1069501632),a=l(a,u,i,o,r[s+11],14,643717713),o=l(o,a,u,i,r[s+0],20,-373897302),i=l(i,o,a,u,r[s+5],5,-701558691),u=l(u,i,o,a,r[s+10],9,38016083),a=l(a,u,i,o,r[s+15],14,-660478335),o=l(o,a,u,i,r[s+4],20,-405537848),i=l(i,o,a,u,r[s+9],5,568446438),u=l(u,i,o,a,r[s+14],9,-1019803690),a=l(a,u,i,o,r[s+3],14,-187363961),o=l(o,a,u,i,r[s+8],20,1163531501),i=l(i,o,a,u,r[s+13],5,-1444681467),u=l(u,i,o,a,r[s+2],9,-51403784),a=l(a,u,i,o,r[s+7],14,1735328473),i=f(i,o=l(o,a,u,i,r[s+12],20,-1926607734),a,u,r[s+5],4,-378558),u=f(u,i,o,a,r[s+8],11,-2022574463),a=f(a,u,i,o,r[s+11],16,1839030562),o=f(o,a,u,i,r[s+14],23,-35309556),i=f(i,o,a,u,r[s+1],4,-1530992060),u=f(u,i,o,a,r[s+4],11,1272893353),a=f(a,u,i,o,r[s+7],16,-155497632),o=f(o,a,u,i,r[s+10],23,-1094730640),i=f(i,o,a,u,r[s+13],4,681279174),u=f(u,i,o,a,r[s+0],11,-358537222),a=f(a,u,i,o,r[s+3],16,-722521979),o=f(o,a,u,i,r[s+6],23,76029189),i=f(i,o,a,u,r[s+9],4,-640364487),u=f(u,i,o,a,r[s+12],11,-421815835),a=f(a,u,i,o,r[s+15],16,530742520),i=p(i,o=f(o,a,u,i,r[s+2],23,-995338651),a,u,r[s+0],6,-198630844),u=p(u,i,o,a,r[s+7],10,1126891415),a=p(a,u,i,o,r[s+14],15,-1416354905),o=p(o,a,u,i,r[s+5],21,-57434055),i=p(i,o,a,u,r[s+12],6,1700485571),u=p(u,i,o,a,r[s+3],10,-1894986606),a=p(a,u,i,o,r[s+10],15,-1051523),o=p(o,a,u,i,r[s+1],21,-2054922799),i=p(i,o,a,u,r[s+8],6,1873313359),u=p(u,i,o,a,r[s+15],10,-30611744),a=p(a,u,i,o,r[s+6],15,-1560198380),o=p(o,a,u,i,r[s+13],21,1309151649),i=p(i,o,a,u,r[s+4],6,-145523070),u=p(u,i,o,a,r[s+11],10,-1120210379),a=p(a,u,i,o,r[s+2],15,718787259),o=p(o,a,u,i,r[s+9],21,-343485551),i=i+d>>>0,o=o+h>>>0,a=a+g>>>0,u=u+v>>>0}return xs.endian([i,o,a,u])}xs=crypt.exports,ys=charenc_1.utf8,zs=isBuffer_1,As=charenc_1.bin,Bs._ff=function(e,t,r,n,i,o,a){var u=e+(t&r|~t&n)+(i>>>0)+a;return(u<<o|u>>>32-o)+t},Bs._gg=function(e,t,r,n,i,o,a){var u=e+(t&n|r&~n)+(i>>>0)+a;return(u<<o|u>>>32-o)+t},Bs._hh=function(e,t,r,n,i,o,a){var u=e+(t^r^n)+(i>>>0)+a;return(u<<o|u>>>32-o)+t},Bs._ii=function(e,t,r,n,i,o,a){var u=e+(r^(t|~n))+(i>>>0)+a;return(u<<o|u>>>32-o)+t},Bs._blocksize=16,Bs._digestsize=16,md5$1.exports=function(e,t){if(null==e)throw new Error("Illegal argument "+e);var r=xs.wordsToBytes(Bs(e,t));return t&&t.asBytes?r:t&&t.asString?As.bytesToString(r):xs.bytesToHex(r)};var md5=md5$1.exports,MAX_HASH=Math.pow(2,32),Decision$1=function(){function g(e){var t=e.api,r=e.pipeline,n=e.prediction,i=e.action,o=e.explorationCohort,a=e.cohort;_classCallCheck(this,g),this._api=t,this._pipeline=r,this._prediction=n,this.action=i,this.explorationCohort=o,this.cohort=a;var u=window.TIE_TO_EVENT_WATCHDOG_TIMEOUT||1e4;this.tieToEventWatchdog=setTimeout(function(){var e="Vidora: tieEventToPrediction not called within ".concat(u,"ms of")+" prediction! Did you forget to tie the prediction to a treatment event after prediction?";console.warn(e)},u)}return _createClass(g,[{key:"_getAddProperties",value:function(){return extend(this._prediction._getAddProperties(),{action:this.action,exploration_cohort:this.explorationCohort,cohort:this.cohort})}},{key:"tieEventToPrediction",value:function(e){var t=0<arguments.length&&void 0!==e?e:{};clearTimeout(this.tieToEventWatchdog);var r={};return extend(r,this._getAddProperties()),extend(r,t),r}}],[{key:"_getProposedAction",value:function(e,t){var r=e.actionRule;if(r){var n=r.method;if("threshold"!==n)throw new Error("Unsupported actionRule method "+n);var i=r.parameter,o=r.comparator,a=r.value;return+{lt:function(e,t){return e<t},gt:function(e,t){return t<e}}[o](t[i],a)}}},{key:"_getUserHash",value:function(e,t){if(!e.explorationRule)return null;var r=e.explorationRule.salt;return md5(t+r),parseInt(md5(t+r).substring(0,8),16)%MAX_HASH}},{key:"_getCohort",value:function(e,t,r,n){var i,o=3<arguments.length&&void 0!==n&&n,a=e.explorationRule,u=a.exploreFraction,s=void 0===u?0:u,c=a.delegateFraction,l=void 0===c?0:c,f=g._getUserHash(e,r),p=MAX_HASH*s,d=MAX_HASH*(l+s),h=null===t.score?"delegate":"exploit";return"delegate"!==(i=e.explorationRule?f<p?"explore":f<d?"delegate":h:h)||o||(i="explore"),i}},{key:"_getExplorationAction",value:function(e,t){var r=e.explorationRule.treatmentSelectionMethod;if("per-prediction"===r)return Math.floor(2*Math.random());if("per-user"===r)return g._getUserHash(e,t)%2;throw new Error("Unsupported treatment selection method "+r)}},{key:"build",value:function(e){var t,r=e.api,n=e.pipeline,i=e.config,o=e.prediction,a=e.initialModel,u=r.getUserId(),s=g._getCohort(i,o,u,!!a),c=null;return"exploit"===s?t=g._getProposedAction(i,o):"explore"===s?c=t=g._getExplorationAction(i,u):"delegate"===s&&(t=a(u)),new g({api:r,pipeline:n,prediction:o,action:t,explorationCohort:c,cohort:s})}}]),g}(),Prediction=function(){function a(e){var t=e.api,r=e.pipeline,n=e.score,i=e.percentile,o=e.predictionId;_classCallCheck(this,a),this._api=t,this._pipeline=r,this.score=n,this.percentile=i,this.id=o}return _createClass(a,[{key:"_getAddProperties",value:function(){return{prediction_id:this.id,prediction_score:this.score,prediction_percentile:this.percentile,prediction_score_missing:null===this.score||void 0===this.score}}},{key:"tieEventToPrediction",value:function(e){var t=0<arguments.length&&void 0!==e?e:{},r={};return extend(r,this._getAddProperties()),extend(r,t),r}}]),a}(),getDefaultConfigUrl$1=function(e){return"https://ml-client-configs.vidora.com/production/pipelines/".concat(e,".json")},Pipeline=function(){function n(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;_classCallCheck(this,n),this._api=e,this.id=t,this._pendingConfigRequests=[],this._config=null,"string"==typeof r?(this._configUrl=r,this._fetchConfig()):"object"===_typeof(r)?this._config=r:(this._configUrl=getDefaultConfigUrl$1(t),this._fetchConfig())}return _createClass(n,[{key:"_fetchConfig",value:function(){var t=this;httpGet({url:this._configUrl,onSuccess:function(e){t._config=JSON.parse(e),t._pendingConfigRequests.forEach(function(e){return e(t._config)})}})}},{key:"_buildPrediction",value:function(e){var t=e.score,r=e.percentile,n=e.request_id,i=e.prediction_id;return new Prediction({api:this._api,pipeline:this,score:t,percentile:r,predictionId:i||n})}},{key:"getConfig",value:function(e){this._config?e(this._config):this._pendingConfigRequests.push(e)}},{key:"getPrediction",value:function(e,t){var r=this,n=t||e,i=t?e:{},o=Date.now();this._getPredictionInner(i,function(e){r._api.send("vidora_prediction_record",null,{params:e.tieEventToPrediction({vidora_internal:!0,vidora_e2e_duration_ms:Math.max(Date.now()-o,5)})}),n(e)})}},{key:"_getPredictionInner",value:function(c,l){var f=this;this.getConfig(function(r){var n=c.onError||function(){},e=c._makePredictionRequest,t=void 0===e?function(e,t,r){httpPost({url:t,data:JSON.stringify(e),dataType:"application/json",onSuccess:function(e){r(JSON.parse(e))},onError:n})}:e,i=c.additionalFeatures,o=void 0===i?{}:i,a=f._api.getUserState(),u=computeFeatures(r.features,a);for(var s in o)u[s]=o[s];t({user_state:a,realtime_features:u,fallback_batch_pipeline_id:r.fallbackBatchPipelineId},r.predictionPath.replace(":item_id",f._api.getUserId()).replace(":pipeline_id",f.id)+"?"+encodeQueryParams({api_key:f._api.token}),function(e){var t;if("uplift-classification-realtime"!==r.type&&"classification-future-events-realtime"!==r.type)throw new Error("Unsupported configuration type: "+r.type);t=f._buildPrediction(e),l(t)})})}},{key:"getDecision",value:function(e,t){var n=this,i=t||e,o=t?e:{},a=Date.now();this._getPredictionInner(o,function(e){var t=n._config,r=Decision$1.build({api:n._api,pipeline:n,config:t,prediction:e,initialModel:o.initialModel});n._api.send("vidora_decision_record",null,{params:r.tieEventToPrediction({vidora_internal:!0,vidora_e2e_duration_ms:Math.max(Date.now()-a,5)})}),i(r)})}}]),n}(),Decision=function(){function a(e){var t=e.predictionId,r=e.projectId,n=e.actions,i=e.cohort,o=e.behavior_id;_classCallCheck(this,a),this._projectId=r,this._predictionId=t,this._vidora_internal_cohort=i,this._vidora_internal_behavior_id=o,this.id=t,this.actions=n}return _createClass(a,[{key:"_getAddProperties",value:function(){return{actions:this.actions,prediction_id:this._predictionId,project_id:this._projectId,cohort:this._vidora_internal_cohort,behavior_id:this._vidora_internal_behavior_id}}},{key:"tieEventToDecision",value:function(e){var t=0<arguments.length&&void 0!==e?e:{};clearTimeout(this.tieToEventWatchdog);var r={};return extend(r,this._getAddProperties()),extend(r,t),r}}]),a}(),getDefaultConfigUrl=function(e){return"https://ml-client-configs.vidora.com/production/projects/".concat(e,".json")},Project=function(){function n(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;_classCallCheck(this,n),this._api=e,this.id=t,this._pendingConfigRequests=[],this._config=null,"string"==typeof r?(this._configUrl=r,this._fetchConfig()):"object"===_typeof(r)?this._config=r:(this._configUrl=getDefaultConfigUrl(t),this._fetchConfig())}return _createClass(n,[{key:"_fetchConfig",value:function(){var t=this;httpGet({url:this._configUrl,onSuccess:function(e){t._config=JSON.parse(e),t._pendingConfigRequests.forEach(function(e){return e(t._config)})}})}},{key:"getConfig",value:function(e){this._config?e(this._config):this._pendingConfigRequests.push(e)}},{key:"_getDecisionInner",value:function(c,l){var f=this;this.getConfig(function(e){var n=c.onError||function(){},t=c._makePredictionRequest,r=void 0===t?function(e,t,r){httpPost({url:t,data:JSON.stringify(e),dataType:"application/json",onSuccess:function(e){r(JSON.parse(e))},onError:n})}:t,i=c.additionalFeatures,o=void 0===i?{}:i,a=f._api.getUserState(),u=computeFeatures(e.features,a);for(var s in o)u[s]=o[s];r({user_state:a,realtime_features:u},e.predictionPath.replace(":object_id",f._api.getUserId()).replace(":project_id",f.id)+"?"+encodeQueryParams({api_key:f._api.token}),function(e){l(e)})})}},{key:"getDecision",value:function(e,t){var r=this,n=t||e,i=t?e:{},o=Date.now();this._getDecisionInner(i,function(e){var t=new Decision({projectId:r.id,predictionId:e.prediction_id,actions:e.actions,cohort:e.vidora_internal&&e.vidora_internal.cohort,behavior_id:e.vidora_internal&&e.vidora_internal.behavior_id});r._api.send("vidora_clientside_decision_record",null,{params:t.tieEventToDecision({vidora_internal:!0,vidora_e2e_duration_ms:Math.max(Date.now()-o,5)})}),n(t)})}}]),n}(),preconnectTagInitKey="_vidora_preconnects_initialized",preconnects=["https://ml-client-configs.vidora.com/","https://api.vidora.com/"],RealtimeApi=function(){_inherits(i,APIv1);var r=_createSuper(i);function i(e){var t;if(_classCallCheck(this,i),(t=r.call(this,e))._eventStore=new EventStore(t.globalName),!(e||{}).skipInsertingPreconnectTags)try{t._putPreconnectTags()}catch(e){console.error(e)}return t}return _createClass(i,[{key:"getPipeline",value:function(e,t){return apimon("pipeline",new Pipeline(this,e,t),this.token)}},{key:"getProject",value:function(e,t){return apimon("project",new Project(this,e,t),this.token)}},{key:"send",value:function(e,t,r){var n=_get(_getPrototypeOf(i.prototype),"send",this).call(this,e,t,r);return this._eventStore.persistEvents(n),n}},{key:"getUserState",value:function(){var e=getBuiltinStaticProperties(this);for(var t in this.customStaticProperties)e[t]=this.customStaticProperties[t];return{snapshotTimestamp:Math.floor(Date.now()/1e3),snapshotTimestampMs:Date.now(),staticProperties:e,events:this._eventStore.getEvents()}}},{key:"setCustomStaticProperites",value:function(e){this.customStaticProperties=e}},{key:"_putPreconnectTags",value:function(){window[preconnectTagInitKey]||(window[preconnectTagInitKey]=!0,preconnects.forEach(function(e){var t=document.createElement("link");t.rel="preconnect",t.href=e,t.crossOrigin="anonymous",document.head.appendChild(t)}))}}]),i}();return loadApi(window,document,RealtimeApi),RealtimeApi});